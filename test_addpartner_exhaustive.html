<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Exhaustif Add Partner</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
        .info { background: #d1ecf1; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        h2 { color: #333; }
    </style>
</head>
<body>
    <h1>üîç Test Exhaustif - Add Partner</h1>
    <div id="results"></div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="build/pedigreejs.v4.0.0-rc1.js"></script>

    <script>
        const results = document.getElementById('results');
        let testNum = 0;

        function log(title, content, status = 'info') {
            testNum++;
            const div = document.createElement('div');
            div.className = 'test ' + status;
            div.innerHTML = `<h3>Test ${testNum}: ${title}</h3><pre>${JSON.stringify(content, null, 2)}</pre>`;
            results.appendChild(div);
        }

        function assertEqual(actual, expected, message) {
            if (JSON.stringify(actual) === JSON.stringify(expected)) {
                log(message, {actual, expected}, 'pass');
                return true;
            } else {
                log(message + ' FAILED', {actual, expected}, 'fail');
                return false;
            }
        }

        // Test utilities
        const utils = window.pedigreejs.pedigreejs_utils;
        const widgets_add = window.pedigreejs.pedigreejs;

        console.log('=== D√âBUT TESTS EXHAUSTIFS ===');

        // ============================================
        // TEST 1: Structure de base dataset
        // ============================================
        log('Structure dataset initial', {
            test: 'V√©rifier la structure de base',
            dataset: [
                {name: 'father', sex: 'M', top_level: true},
                {name: 'mother', sex: 'F', top_level: true},
                {name: 'me', sex: 'F', mother: 'mother', father: 'father'}
            ]
        });

        // ============================================
        // TEST 2: Fonction get_partners
        // ============================================
        let testDataset = [
            {name: 'father', sex: 'M', top_level: true},
            {name: 'mother', sex: 'F', top_level: true},
            {name: 'me', sex: 'F', mother: 'mother', father: 'father'},
            {name: 'child1', sex: 'M', mother: 'me', father: 'partner1'}
        ];

        let me = utils.getNodeByName(testDataset, 'me');
        let partners_before = utils.get_partners(testDataset, me);
        log('get_partners AVANT ajout partner', {
            person: 'me',
            partners_found: partners_before,
            expected: ['partner1']
        }, partners_before.includes('partner1') ? 'pass' : 'fail');

        // ============================================
        // TEST 3: Simulation addpartner √©tape par √©tape
        // ============================================
        log('SIMULATION addpartner - √âtapes d√©taill√©es', {
            description: 'Simulation compl√®te sans appeler la vraie fonction'
        });

        // Copie du dataset pour simulation
        let simDataset = JSON.parse(JSON.stringify(testDataset));
        log('Dataset AVANT addpartner', simDataset);

        // √âtape 1: D√©terminer sexe partner
        let tree_node_data = {name: 'me', sex: 'F', mother: 'mother', father: 'father'};
        let partner_sex = tree_node_data.sex === 'F' ? 'M' : 'F';
        log('√âtape 1: Sexe partner d√©termin√©', {
            person_sex: tree_node_data.sex,
            partner_sex: partner_sex,
            expected: 'M'
        }, partner_sex === 'M' ? 'pass' : 'fail');

        // √âtape 2: Cr√©er partner
        let partner = {
            name: 'partner_test',
            sex: partner_sex,
            display_name: 'Partner',
            mother: 'mother',
            father: 'father',
            noparents: true
        };
        log('√âtape 2: Partner cr√©√©', partner);

        // √âtape 3: Calculer index insertion
        let person_idx = utils.getIdxByName(simDataset, 'me');
        log('√âtape 3: Index personne', {
            person: 'me',
            index: person_idx,
            expected: 2
        }, person_idx === 2 ? 'pass' : 'fail');

        // √âtape 4: Ins√©rer partner
        let insert_idx = person_idx; // F donc idx reste le m√™me
        log('√âtape 4: Index insertion calcul√©', {
            person_sex: 'F',
            insert_idx: insert_idx,
            expected: 2
        });

        simDataset.splice(insert_idx, 0, partner);
        log('√âtape 5: Dataset APR√àS insertion partner', simDataset);

        // √âtape 6: V√©rifier ordre
        let order_check = simDataset.map((p, i) => i + ': ' + p.name);
        log('√âtape 6: Ordre dataset', order_check);

        // √âtape 7: Cr√©er enfant
        let child = {
            name: 'child_test',
            sex: 'M',
            mother: 'me',
            father: 'partner_test'
        };
        log('√âtape 7: Enfant cr√©√©', child);

        // √âtape 8: Calculer index enfant
        let new_person_idx = utils.getIdxByName(simDataset, 'me');
        let new_partner_idx = utils.getIdxByName(simDataset, 'partner_test');
        let child_idx = Math.max(new_person_idx, new_partner_idx) + 1;
        log('√âtape 8: Index enfant calcul√©', {
            person_idx: new_person_idx,
            partner_idx: new_partner_idx,
            child_idx: child_idx,
            expected: Math.max(2, 3) + 1  // = 4
        });

        // √âtape 9: Ins√©rer enfant
        simDataset.splice(child_idx, 0, child);
        log('√âtape 9: Dataset APR√àS insertion enfant', simDataset);

        // √âtape 10: V√©rifier ordre final
        let final_order = simDataset.map((p, i) => i + ': ' + p.name);
        log('√âtape 10: Ordre FINAL dataset', final_order);

        // ============================================
        // TEST 4: V√©rifier get_partners apr√®s ajout
        // ============================================
        let me_updated = utils.getNodeByName(simDataset, 'me');
        let partners_after = utils.get_partners(simDataset, me_updated);
        log('get_partners APR√àS ajout partner', {
            person: 'me',
            partners_found: partners_after,
            expected: ['partner1', 'partner_test'],
            pass: partners_after.length === 2
        }, partners_after.length === 2 ? 'pass' : 'fail');

        // ============================================
        // TEST 5: V√©rifier structure pour rendu
        // ============================================
        log('Structure pr√™te pour rendu', {
            partners_detected: partners_after,
            children: simDataset.filter(p => p.mother === 'me' || p.father === 'me').map(p => p.name)
        });

        // ============================================
        // TEST 6: Cas limite - Sexe U (unspecified)
        // ============================================
        let personU = {name: 'personU', sex: 'U', top_level: true};
        let partner_sex_U = personU.sex === 'F' ? 'M' : (personU.sex === 'M' ? 'F' : 'U');
        log('Cas sexe U (unspecified)', {
            person_sex: 'U',
            partner_sex: partner_sex_U,
            expected: 'U',
            pass: partner_sex_U === 'U'
        }, partner_sex_U === 'U' ? 'pass' : 'fail');

        // ============================================
        // TEST 7: V√©rifier mother/father assignment
        // ============================================
        log('V√©rification mother/father dans enfant', {
            child: child,
            mother_correct: child.mother === 'me',
            father_correct: child.father === 'partner_test',
            pass: child.mother === 'me' && child.father === 'partner_test'
        }, (child.mother === 'me' && child.father === 'partner_test') ? 'pass' : 'fail');

        // ============================================
        // TEST 8: V√©rifier noparents flag
        // ============================================
        log('V√©rification noparents flag', {
            partner: partner,
            has_noparents: partner.noparents === true,
            has_mother: 'mother' in partner,
            has_father: 'father' in partner,
            pass: partner.noparents === true && partner.mother && partner.father
        }, (partner.noparents === true && partner.mother && partner.father) ? 'pass' : 'fail');

        console.log('=== FIN TESTS EXHAUSTIFS ===');
        log('R√âSUM√â', {
            total_tests: testNum,
            message: 'Voir r√©sultats d√©taill√©s ci-dessus'
        });

    </script>
</body>
</html>
