{"version":3,"file":"pedigreejs.v4.0.0-rc1.min.js","sources":["../es/validation.js","../es/dom.js","../es/pedcache.js","../es/tree-utils.js","../es/utils.js","../es/zoom.js","../es/pbuttons.js","../es/canrisk_file.js","../es/io.js","../es/twins.js","../es/popup_form.js","../es/widgets-add.js","../es/widgets-delete.js","../es/widgets.js","../es/rendering-constants.js","../es/labels.js","../es/dragging.js","../es/pedigree.js","../es/extras.js"],"sourcesContent":["/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// Pedigree validation functions\n\nexport function create_err(err) {\n\tconsole.error(err);\n\treturn new Error(err);\n}\n\n/**\n * Validate age and yob is consistent with current year. The sum of age and\n * yob should not be greater than or equal to current year. If alive the\n * absolute difference between the sum of age and year of birth and the\n * current year should be <= 1.\n * @param age\t- age in years.\n * @param yob\t- year of birth.\n * @param status - 0 = alive, 1 = dead.\n * @return true if age and yob are consistent with current year otherwise false.\n */\nexport function validate_age_yob(age, yob, status) {\n\tlet year = new Date().getFullYear();\n\tlet sum = parseInt(age) + parseInt(yob);\n\t// check status is an expected string\n\tif (status !== \"1\" && status !== \"0\")\n\t\treturn false\n\n\tif(status === \"1\") {   // deceased\n\t\treturn year >= sum;\n\t}\n\t// Phase 3.3.1: Assouplir validation pour éviter faux positifs (anniversaire non encore passé)\n\treturn Math.abs(year - sum) <= 2 && year >= sum;\n}\n\n/**\n * Validate pedigree dataset for consistency and completeness\n * Checks for:\n * - Consistent parent sex (mothers=F, fathers=M)\n * - Unique IndivIDs (names)\n * - Required fields (name, sex)\n * - Single family (no multiple famids)\n * - Warns about unconnected individuals\n * @param {Object} opts - Options object containing dataset and validation settings\n * @param {Array} opts.dataset - Array of person objects to validate\n * @param {boolean|function} opts.validate - Validation mode: true (default validation), false (skip), or custom function\n * @param {boolean} [opts.DEBUG=false] - Enable debug logging\n * @throws {Error} If validation fails with specific error message\n * @example\n * validate_pedigree({\n *   dataset: [...],\n *   validate: true\n * });\n */\nexport function validate_pedigree(opts){\n\t// Import needed functions dynamically to avoid circular dependencies\n\tconst getIdxByName = (arr, name) => {\n\t\tlet idx = -1;\n\t\t$.each(arr, function(i, p) {\n\t\t\tif (name === p.name) {\n\t\t\t\tidx = i;\n\t\t\t\treturn idx;\n\t\t\t}\n\t\t});\n\t\treturn idx;\n\t};\n\n\tif(opts.validate) {\n\t\tif (typeof opts.validate == 'function') {\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log('CALLING CONFIGURED VALIDATION FUNCTION');\n\t\t\treturn opts.validate.call(this, opts);\n\t\t}\n\n\t\t// check consistency of parents sex\n\t\tlet uniquenames = [];\n\t\tlet famids = [];\n\t\tlet display_name;\n\t\tfor(let p=0; p<opts.dataset.length; p++) {\n\t\t\tif(!p.hidden) {\n\t\t\t\tif(opts.dataset[p].mother || opts.dataset[p].father) {\n\t\t\t\t\tdisplay_name = opts.dataset[p].display_name;\n\t\t\t\t\tif(!display_name)\n\t\t\t\t\t\tdisplay_name = 'unnamed';\n\t\t\t\t\tdisplay_name += ' (IndivID: '+opts.dataset[p].name+')';\n\t\t\t\t\tlet mother = opts.dataset[p].mother;\n\t\t\t\t\tlet father = opts.dataset[p].father;\n\t\t\t\t\tif(!mother || !father) {\n\t\t\t\t\t\tthrow create_err('Missing parent for '+display_name);\n\t\t\t\t\t}\n\n\t\t\t\t\tlet midx = getIdxByName(opts.dataset, mother);\n\t\t\t\t\tlet fidx = getIdxByName(opts.dataset, father);\n\t\t\t\t\tif(midx === -1)\n\t\t\t\t\t\tthrow create_err('The mother (IndivID: '+mother+') of family member '+\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\n\t\t\t\t\tif(fidx === -1)\n\t\t\t\t\t\tthrow create_err('The father (IndivID: '+father+') of family member '+\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\n\t\t\t\t\tif(opts.dataset[midx].sex !== \"F\")\n\t\t\t\t\t\tthrow create_err(\"The mother of family member \"+display_name+\n\t\t\t\t\t\t\t\t\" is not specified as female. All mothers in the pedigree must have sex specified as 'F'.\");\n\t\t\t\t\tif(opts.dataset[fidx].sex !== \"M\")\n\t\t\t\t\t\tthrow create_err(\"The father of family member \"+display_name+\n\t\t\t\t\t\t\t\t\" is not specified as male. All fathers in the pedigree must have sex specified as 'M'.\");\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\tif(!opts.dataset[p].name)\n\t\t\t\tthrow create_err(display_name+' has no IndivID.');\n\t\t\tif($.inArray(opts.dataset[p].name, uniquenames) > -1)\n\t\t\t\tthrow create_err('IndivID for family member '+display_name+' is not unique.');\n\t\t\tuniquenames.push(opts.dataset[p].name);\n\n\t\t\tif($.inArray(opts.dataset[p].famid, famids) === -1 && opts.dataset[p].famid) {\n\t\t\t\tfamids.push(opts.dataset[p].famid);\n\t\t\t}\n\t\t}\n\n\t\tif(famids.length > 1) {\n\t\t\tthrow create_err('More than one family found: '+famids.join(\", \")+'.');\n\t\t}\n\t\t// warn if there is a break in the pedigree\n\t\tlet uc = unconnected(opts.dataset);\n\t\tif(uc.length > 0)\n\t\t\tconsole.warn(\"individuals unconnected to pedigree \", uc);\n\t}\n}\n\n//combine arrays ignoring duplicates\nfunction combineArrays(arr1, arr2) {\n\tfor(let i=0; i<arr2.length; i++)\n\t\tif($.inArray( arr2[i], arr1 ) === -1) arr1.push(arr2[i]);\n}\n\nfunction include_children(connected, p, dataset) {\n\t// Import needed functions\n\tconst get_partners = (dataset, anode) => {\n\t\tlet ptrs = [];\n\t\tfor(let i=0; i<dataset.length; i++) {\n\t\t\tlet bnode = dataset[i];\n\t\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) === -1)\n\t\t\t\tptrs.push(bnode.father);\n\t\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) === -1)\n\t\t\t\tptrs.push(bnode.mother);\n\t\t}\n\t\treturn ptrs;\n\t};\n\n\tconst getAllChildren = (dataset, person, sex) => {\n\t\treturn $.map(dataset, function(p, _i){\n\t\t\treturn !('noparents' in p) &&\n\t\t\t\t   (p.mother === person.name || p.father === person.name) &&\n\t\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t\t});\n\t};\n\n\tif($.inArray( p.name, connected ) === -1)\n\t\treturn;\n\tcombineArrays(connected, get_partners(dataset, p));\n\tlet children = getAllChildren(dataset, p);\n\t$.each(children, function( _child_idx, child ) {\n\t\tif($.inArray( child.name, connected ) === -1) {\n\t\t\tconnected.push(child.name);\n\t\t\tcombineArrays(connected, get_partners(dataset, child));\n\t\t}\n\t});\n}\n\n//return a list of individuals that aren't connected to the target\nexport function unconnected(dataset){\n\t// Import needed functions\n\tconst getProbandIndex = (dataset) => {\n\t\tconst isProband = (obj) => {\n\t\t\treturn typeof $(obj).attr('proband') !== typeof undefined && $(obj).attr('proband') !== false;\n\t\t};\n\t\tlet proband;\n\t\t$.each(dataset, function(i, val) {\n\t\t\tif (isProband(val)) {\n\t\t\t\tproband = i;\n\t\t\t\treturn proband;\n\t\t\t}\n\t\t});\n\t\treturn proband;\n\t};\n\n\tconst getNodeByName = (nodes, name) => {\n\t\tfor (let i = 0; i < nodes.length; i++) {\n\t\t\tif(nodes[i].data && name === nodes[i].data.name)\n\t\t\t\treturn nodes[i];\n\t\t\telse if (name === nodes[i].name)\n\t\t\t\treturn nodes[i];\n\t\t}\n\t};\n\n\tconst get_partners = (dataset, anode) => {\n\t\tlet ptrs = [];\n\t\tfor(let i=0; i<dataset.length; i++) {\n\t\t\tlet bnode = dataset[i];\n\t\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) === -1)\n\t\t\t\tptrs.push(bnode.father);\n\t\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) === -1)\n\t\t\t\tptrs.push(bnode.mother);\n\t\t}\n\t\treturn ptrs;\n\t};\n\n\tlet target = dataset[ getProbandIndex(dataset) ];\n\tif(!target){\n\t\tconsole.warn(\"No target defined\");\n\t\tif(dataset.length === 0) {\n\t\t\tthrow new Error(\"empty pedigree data set\");\n\t\t}\n\t\ttarget = dataset[0];\n\t}\n\tlet connected = [target.name];\n\tlet change = true;\n\tlet ii = 0;\n\twhile(change && ii < 200) {\n\t\tii++;\n\t\tlet nconnect = connected.length;\n\t\t$.each(dataset, function( _idx, p ) {\n\t\t\tif($.inArray( p.name, connected ) !== -1) {\n\t\t\t\t// check if this person or a partner has a parent\n\t\t\t\tlet ptrs = get_partners(dataset, p);\n\t\t\t\tlet has_parent = (p.name === target.name || !p.noparents);\n\t\t\t\tfor(let i=0; i<ptrs.length; i++){\n\t\t\t\t\tif(!getNodeByName(dataset, ptrs[i]).noparents)\n\t\t\t\t\t\thas_parent = true;\n\t\t\t\t}\n\n\t\t\t\tif(has_parent){\n\t\t\t\t\tif(p.mother && $.inArray( p.mother, connected ) === -1)\n\t\t\t\t\t\tconnected.push(p.mother);\n\t\t\t\t\tif(p.father && $.inArray( p.father, connected ) === -1)\n\t\t\t\t\t\tconnected.push(p.father);\n\t\t\t\t}\n\t\t\t} else if( !p.noparents &&\n\t\t\t\t\t  ((p.mother && $.inArray( p.mother, connected ) !== -1) ||\n\t\t\t\t\t   (p.father && $.inArray( p.father, connected ) !== -1))){\n\t\t\t\tconnected.push(p.name);\n\t\t\t}\n\t\t\t// include any children\n\t\t\tinclude_children(connected, p, dataset);\n\t\t});\n\t\tchange = (nconnect !== connected.length);\n\t}\n\tlet names = $.map(dataset, function(val, _i){return val.name;});\n\treturn $.map(names, function(name, _i){return $.inArray(name, connected) === -1 ? name : null;});\n}\n\n/**\n * Determine if the sex of a person can be changed.\n * Sex cannot be changed if the person is already a parent (referenced as mother/father)\n * by other people in the dataset, unless the current sex is 'U' (unknown).\n *\n * Phase 3.1.5 - Unified sex change rules\n *\n * @param node - The person node to check\n * @param dataset - The full pedigree dataset\n * @return true if sex can be changed, false otherwise\n */\nexport function canChangeSex(node, dataset) {\n\t// Validation des paramètres\n\tif(!node || !dataset) {\n\t\treturn true; // Par défaut, autoriser le changement si données manquantes\n\t}\n\n\t// On peut toujours changer de 'U' (unknown) vers un sexe défini\n\t// Car 'U' n'a pas de contraintes de cohérence mère/père\n\tif(node.sex === 'U') {\n\t\treturn true;\n\t}\n\n\t// Vérifier si ce nœud est référencé comme parent (mother ou father)\n\t// par d'autres personnes dans le dataset\n\tconst isReferencedAsParent = dataset.some(person => {\n\t\t// Un nœud est parent s'il est référencé comme mother ou father\n\t\treturn person.mother === node.name || person.father === node.name;\n\t});\n\n\t// Si le nœud est déjà parent et a un sexe défini (M ou F),\n\t// on ne peut pas changer le sexe car cela casserait la cohérence\n\t// (ex: une mother doit être 'F', un father doit être 'M')\n\tif(isReferencedAsParent && node.sex !== 'U') {\n\t\treturn false;\n\t}\n\n\t// Dans tous les autres cas, autoriser le changement\n\treturn true;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// DOM manipulation and UI functions\n\nexport function isIE() {\n\t let ua = navigator.userAgent;\n\t /* MSIE used to detect old browsers and Trident used to newer ones*/\n\t return ua.indexOf(\"MSIE \") > -1 || ua.indexOf(\"Trident/\") > -1;\n}\n\nexport function isEdge() {\n\t return navigator.userAgent.match(/Edge/g);\n}\n\nfunction showDialog(title, msg, onConfirm, opts, dataset) {\n\tconst errModalEl = document.getElementById('errModal');\n\tconst modalTitle = errModalEl.querySelector('.modal-title');\n\tconst modalBodyInput = errModalEl.querySelector('.modal-body');\n\tif(onConfirm) {\n\t\t$('#errModal button.hidden').removeClass(\"hidden\");\n\t\t$('#errModal button:contains(\"OK\")').on( \"click\", function() {\n\t\t\tonConfirm(opts, dataset);\n\t\t\t$('#errModal button:contains(\"OK\")').off('click');\n\t\t});\n\t} else {\n\t\tconst cancelBtn = $('#errModal button:contains(\"CANCEL\")');\n\t\tif(!cancelBtn.hasClass(\"hidden\")) cancelBtn.addClass(\"hidden\");\n\t\t$('#errModal button:contains(\"OK\")').off('click');\n\t}\n\n\tmodalTitle.textContent = title;\n\tmodalBodyInput.textContent = msg;\n\t$(\"#errModal\").modal(\"show\");\n}\n\n/**\n * Show message or confirmation dialog.\n * @param title\t - dialog window title\n * @param msg\t   - message to diasplay\n * @param onConfirm - function to call in a confirmation dialog\n * @param opts\t  - pedigreejs options\n * @param dataset\t- pedigree dataset\n */\nexport function messages(title, msg, onConfirm, opts, dataset) {\n\ttry {\n\t\tif(onConfirm) {\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t\t\t\t\tmodal: true,\n\t\t\t\t\ttitle: title,\n\t\t\t\t\twidth: 350,\n\t\t\t\t\tbuttons: {\n\t\t\t\t\t\t\"Yes\": function () {\n\t\t\t\t\t\t\t$(this).dialog('close');\n\t\t\t\t\t\t\tonConfirm(opts, dataset);\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"No\": function () {\n\t\t\t\t\t\t\t$(this).dialog('close');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t} else {\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t\t\t\ttitle: title,\n\t\t\t\twidth: 350,\n\t\t\t\tbuttons: [{\n\t\t\t\t\ttext: \"OK\",\n\t\t\t\t\tclick: function() { $( this ).dialog( \"close\" );}\n\t\t\t\t}]\n\t\t\t});\n\t\t}\n\t} catch(err) {\n\t\tshowDialog(title, msg, onConfirm, opts, dataset);\n\t}\n}\n\n// print options and dataset\nexport function print_opts(opts){\n\t$(\"#pedigree_data\").remove();\n\t$(\"body\").append(\"<div id='pedigree_data'></div>\" );\n\tlet key;\n\tfor(let i=0; i<opts.dataset.length; i++) {\n\t\tlet person = \"<div class='row'><strong class='col-md-1 text-right'>\"+opts.dataset[i].name+\"</strong><div class='col-md-11'>\";\n\t\tfor(key in opts.dataset[i]) {\n\t\t\tif(key === 'name') continue;\n\t\t\tif(key === 'parent')\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key].name+\"; </span>\";\n\t\t\telse if (key === 'children') {\n\t\t\t\tif (opts.dataset[i][key][0] !== undefined)\n\t\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key][0].name+\"; </span>\";\n\t\t\t} else\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key]+\"; </span>\";\n\t\t}\n\t\t$(\"#pedigree_data\").append(person + \"</div></div>\");\n\n\t}\n\t$(\"#pedigree_data\").append(\"<br /><br />\");\n\tfor(key in opts) {\n\t\tif(key === 'dataset') continue;\n\t\t$(\"#pedigree_data\").append(\"<span>\"+key + \":\" + opts[key]+\"; </span>\");\n\t}\n}\n\nexport function is_fullscreen(){\n\treturn !!(document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement);\n}\n\nexport function get_svg_dimensions(opts) {\n\treturn {'width' : (is_fullscreen()? window.innerWidth  : opts.width),\n\t\t\t'height': (is_fullscreen()? window.innerHeight : opts.height)};\n}\n\nexport function get_tree_dimensions(opts) {\n\t// Import needed function\n\tconst getDepth = (dataset, name) => {\n\t\tconst getIdxByName = (arr, name) => {\n\t\t\tlet idx = -1;\n\t\t\t$.each(arr, function(i, p) {\n\t\t\t\tif (name === p.name) {\n\t\t\t\t\tidx = i;\n\t\t\t\t\treturn idx;\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn idx;\n\t\t};\n\n\t\tlet idx = getIdxByName(dataset, name);\n\t\tlet depth = 1;\n\n\t\twhile(idx >= 0 && ('mother' in dataset[idx] || dataset[idx].top_level)){\n\t\t\tidx = getIdxByName(dataset, dataset[idx].mother);\n\t\t\tdepth++;\n\t\t}\n\t\treturn depth;\n\t};\n\n\tconst getAllChildren = (dataset, person, sex) => {\n\t\treturn $.map(dataset, function(p, _i){\n\t\t\treturn !('noparents' in p) &&\n\t\t\t\t   (p.mother === person.name || p.father === person.name) &&\n\t\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t\t});\n\t};\n\n\t// / get score at each depth used to adjust node separation\n\tlet svg_dimensions = get_svg_dimensions(opts);\n\tlet maxscore = 0;\n\tlet generation = {};\n\tfor(let i=0; i<opts.dataset.length; i++) {\n\t\tlet depth = getDepth(opts.dataset, opts.dataset[i].name);\n\t\tlet children = getAllChildren(opts.dataset, opts.dataset[i]);\n\n\t\t// score based on no. of children and if parent defined\n\t\tlet score = 1 + (children.length > 0 ? 0.55+(children.length*0.25) : 0) + (opts.dataset[i].father ? 0.25 : 0);\n\t\tif(depth in generation)\n\t\t\tgeneration[depth] += score;\n\t\telse\n\t\t\tgeneration[depth] = score;\n\n\t\tif(generation[depth] > maxscore)\n\t\t\tmaxscore = generation[depth];\n\t}\n\n\tlet max_depth = Object.keys(generation).length*opts.symbol_size*3.5;\n\tlet tree_width =  (svg_dimensions.width - opts.symbol_size > maxscore*opts.symbol_size*1.65 ?\n\t\t\t\t\t   svg_dimensions.width - opts.symbol_size : maxscore*opts.symbol_size*1.65);\n\tlet tree_height = (svg_dimensions.height - opts.symbol_size > max_depth ?\n\t\t\t\t\t   svg_dimensions.height - opts.symbol_size : max_depth);\n\treturn {'width': tree_width, 'height': tree_height};\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n//store a history of pedigree\n\nimport {copy_dataset} from './utils.js';\n\nlet max_limit = 25;\nlet dict_cache = {};\n\n// Helper function to serialize dataset by stripping transient/circular refs first\nfunction serialize_dataset(dataset) {\n\tlet cleanData = copy_dataset(dataset || []);\n\treturn JSON.stringify(cleanData);\n}\n\n// test if browser storage is supported\nfunction has_browser_storage(opts) {\n\ttry {\n\t\tif(opts.store_type === 'array')\n\t\t\treturn false;\n\n\t\tif(opts.store_type !== 'local' && opts.store_type !== 'session' && opts.store_type !== undefined)\n\t\t\treturn false;\n\n\t\tlet mod = 'test';\n\t\tlocalStorage.setItem(mod, mod);\n\t\tlocalStorage.removeItem(mod);\n\t\treturn true;\n\t} catch(e) {\n\t\treturn false;\n\t}\n}\n\nfunction get_prefix(opts) {\n\treturn \"PEDIGREE_\"+opts.btn_target+\"_\";\n}\n\n// use dict_cache to store cache as an array\nfunction get_arr(opts) {\n\treturn dict_cache[get_prefix(opts)];\n}\n\nfunction get_browser_store(opts, item) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.getItem(item);\n\telse\n\t\treturn sessionStorage.getItem(item);\n}\n\nfunction set_browser_store(opts, name, item) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.setItem(name, item);\n\telse\n\t\treturn sessionStorage.setItem(name, item);\n}\n\n// clear all storage items\nfunction clear_browser_store(opts) {\n\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\n\tlet prefix = get_prefix(opts);\n\tlet items = [];\n\tfor(let i = 0; i < store.length; i++){\n\t\tlet key = store.key(i);\n\t\tif(key && key.indexOf(prefix) === 0)\n\t\t\titems.push(key);\n\t}\n\tfor(let i = 0; i < items.length; i++)\n\t\tstore.removeItem(items[i]);\n}\n\n// remove all storage items with keys that have the pedigree history prefix\nexport function clear_pedigree_data(opts) {\n\tlet prefix = get_prefix(opts);\n\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\n\tlet items = [];\n\tfor(let i = 0; i < store.length; i++){\n\t\tif(store.key(i).indexOf(prefix) === 0)\n\t\t\titems.push(store.key(i));\n\t}\n\tfor(let i = 0; i < items.length; i++)\n\t\tstore.removeItem(items[i]);\n}\n\nexport function get_count(opts) {\n\tlet count;\n\tif (has_browser_storage(opts))\n\t\tcount = get_browser_store(opts, get_prefix(opts)+'COUNT');\n\telse\n\t\tcount = dict_cache[get_prefix(opts)+'COUNT'];\n\tif(count !== null && count !== undefined)\n\t\treturn count;\n\treturn 0;\n}\n\nfunction set_count(opts, count) {\n\tif (has_browser_storage(opts))\n\t\tset_browser_store(opts, get_prefix(opts)+'COUNT', count);\n\telse\n\t\tdict_cache[get_prefix(opts)+'COUNT'] = count;\n}\n\nexport function init_cache(opts) {\n\tif(!opts.dataset)\n\t\treturn;\n\tlet count = get_count(opts);\n\tif (has_browser_storage(opts)) {   // local storage\n\t\tset_browser_store(opts, get_prefix(opts)+count, serialize_dataset(opts.dataset));\n\t} else {   // array cache with LRU eviction\n\t\tconsole.warn('Local storage not found/supported for this browser!', opts.store_type);\n\t\tmax_limit = 500;\n\t\tif(get_arr(opts) === undefined)\n\t\t\tdict_cache[get_prefix(opts)] = [];\n\n\t\tlet arr = get_arr(opts);\n\t\t// LRU eviction: if array is at max capacity, remove oldest (first) element\n\t\tif(arr.length >= max_limit) {\n\t\t\tarr.shift(); // Remove oldest entry (FIFO = simple LRU)\n\t\t\t// Adjust count since we removed an element\n\t\t\tif(count > 0)\n\t\t\t\tcount--;\n\t\t}\n\t\tarr.push(serialize_dataset(opts.dataset));\n\t}\n\tif(count < max_limit)\n\t\tcount++;\n\telse\n\t\tcount = 0;\n\tset_count(opts, count);\n}\n\nexport function nstore(opts) {\n\tif(has_browser_storage(opts)) {\n\t\tfor(let i=max_limit; i>0; i--) {\n\t\t\tif(get_browser_store(opts, get_prefix(opts)+(i-1)) !== null)\n\t\t\t\treturn i;\n\t\t}\n\t} else {\n\t\treturn (get_arr(opts) && get_arr(opts).length > 0 ? get_arr(opts).length : -1);\n\t}\n\treturn -1;\n}\n\nexport function current(opts) {\n\tlet current = get_count(opts)-1;\n\tif(current === -1)\n\t\tcurrent = max_limit;\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+current));\n\telse if(get_arr(opts))\n\t\treturn JSON.parse(get_arr(opts)[current]);\n}\n\nexport function last(opts) {\n\tif(has_browser_storage(opts)) {\n\t\tfor(let i=max_limit; i>0; i--) {\n\t\t\tlet it = get_browser_store(opts, get_prefix(opts)+(i-1));\n\t\t\tif(it !== null) {\n\t\t\t\tset_count(opts, i);\n\t\t\t\treturn JSON.parse(it);\n\t\t\t}\n\t\t}\n\t} else {\n\t\tlet arr = get_arr(opts);\n\t\tif(arr)\n\t\t\treturn JSON.parse(arr[arr.length-1]);\n\t}\n\treturn undefined;\n}\n\nexport function previous(opts, previous) {\n\tif(previous === undefined)\n\t\tprevious = get_count(opts) - 2;\n\n\tif(previous < 0) {\n\t\tlet nst = nstore(opts);\n\t\tif(nst < max_limit)\n\t\t\tprevious = nst - 1;\n\t\telse\n\t\t\tprevious = max_limit - 1;\n\t}\n\tset_count(opts, previous + 1);\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+previous));\n\telse\n\t\treturn JSON.parse(get_arr(opts)[previous]);\n}\n\nexport function next(opts, next) {\n\tif(next === undefined)\n\t\tnext = get_count(opts);\n\tif(next >= max_limit)\n\t\tnext = 0;\n\n\tset_count(opts, parseInt(next) + 1);\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+next));\n\telse\n\t\treturn JSON.parse(get_arr(opts)[next]);\n}\n\nexport function clear(opts) {\n\tif(opts) {\n\t\tif(has_browser_storage(opts))\n\t\t\tclear_browser_store(opts);\n\n\t\tlet prefix = get_prefix(opts);\n\t\tObject.keys(dict_cache).forEach(function(key){\n\t\t\tif(key.indexOf(prefix) === 0)\n\t\t\t\tdelete dict_cache[key];\n\t\t});\n\t} else {\n\t\ttry {\n\t\t\tlocalStorage.clear();\n\t\t} catch (err) {\n\t\t\t// ignore when unavailable\n\t\t}\n\t\ttry {\n\t\t\tsessionStorage.clear();\n\t\t} catch (err2) {\n\t\t\t// ignore when unavailable\n\t\t}\n\t\tdict_cache = {};\n\t}\n}\n\n// zoom - store translation coords\nexport function setposition(opts, x, y, zoom) {\n\tif(has_browser_storage(opts)) {\n\t\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\n\t\tif(x !== null && x !== undefined && y !== null && y !== undefined) {\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_X', x);\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_Y', y);\n\t\t} else {\n\t\t\tstore.removeItem(get_prefix(opts)+'_X');\n\t\t\tstore.removeItem(get_prefix(opts)+'_Y');\n\t\t}\n\n\t\tlet zoomName = get_prefix(opts)+'_ZOOM';\n\t\tif(zoom !== null && zoom !== undefined)\n\t\t\tset_browser_store(opts, zoomName, zoom);\n\t\telse\n\t\t\tstore.removeItem(zoomName);\n\t} else {\n\t\t// Array cache fallback for position storage\n\t\tif(x !== null && x !== undefined && y !== null && y !== undefined) {\n\t\t\tdict_cache[get_prefix(opts)+'_X'] = x;\n\t\t\tdict_cache[get_prefix(opts)+'_Y'] = y;\n\t\t} else {\n\t\t\tdelete dict_cache[get_prefix(opts)+'_X'];\n\t\t\tdelete dict_cache[get_prefix(opts)+'_Y'];\n\t\t}\n\n\t\tlet zoomName = get_prefix(opts)+'_ZOOM';\n\t\tif(zoom !== null && zoom !== undefined)\n\t\t\tdict_cache[zoomName] = zoom;\n\t\telse\n\t\t\tdelete dict_cache[zoomName];\n\t}\n}\n\nexport function getposition(opts) {\n\tif(has_browser_storage(opts)) {\n\t\tif(localStorage.getItem(get_prefix(opts)+'_X') === null &&\n\t\t   sessionStorage.getItem(get_prefix(opts)+'_X') === null)\n\t\t\treturn [null, null];\n\t\tlet pos = [ parseInt(get_browser_store(opts, get_prefix(opts)+'_X')),\n\t\t\t\t\tparseInt(get_browser_store(opts, get_prefix(opts)+'_Y')) ];\n\t\tif(get_browser_store(opts, get_prefix(opts)+'_ZOOM') !== null)\n\t\t\tpos.push(parseFloat(get_browser_store(opts, get_prefix(opts)+'_ZOOM')));\n\t\treturn pos;\n\t} else {\n\t\t// Array cache fallback for position retrieval\n\t\tif(dict_cache[get_prefix(opts)+'_X'] === null ||\n\t\t   dict_cache[get_prefix(opts)+'_X'] === undefined)\n\t\t\treturn [null, null];\n\t\tlet pos = [ parseInt(dict_cache[get_prefix(opts)+'_X']),\n\t\t\t\t\tparseInt(dict_cache[get_prefix(opts)+'_Y']) ];\n\t\tif(dict_cache[get_prefix(opts)+'_ZOOM'] !== null &&\n\t\t   dict_cache[get_prefix(opts)+'_ZOOM'] !== undefined)\n\t\t\tpos.push(parseFloat(dict_cache[get_prefix(opts)+'_ZOOM']));\n\t\treturn pos;\n\t}\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// Tree navigation, construction, and geometry functions\nimport * as pedcache from './pedcache.js';\n\n/**\n * Find the array index of a person by their name\n * @param {Array} arr - Array of person objects\n * @param {string} name - The name (IndivID) to search for\n * @returns {number} Index of the person in the array, or -1 if not found\n * @example\n * let idx = getIdxByName(dataset, 'person1');\n */\nexport function getIdxByName(arr, name) {\n\tlet idx = -1;\n\t$.each(arr, function(i, p) {\n\t\tif (name === p.name) {\n\t\t\tidx = i;\n\t\t\treturn idx;\n\t\t}\n\t});\n\treturn idx;\n}\n\n/**\n * Find a D3 tree node by person name\n * @param {Array|Object} nodes - Array of D3 nodes or nodes object with dataset property\n * @param {string} name - The name (IndivID) to search for\n * @returns {Object|undefined} The D3 node object with data property, or undefined if not found\n * @example\n * let node = getNodeByName(flattened_tree, 'person1');\n */\nexport function getNodeByName(nodes, name) {\n\tfor (let i = 0; i < nodes.length; i++) {\n\t\tif(nodes[i].data && name === nodes[i].data.name)\n\t\t\treturn nodes[i];\n\t\telse if (name === nodes[i].name)\n\t\t\treturn nodes[i];\n\t}\n\tif(nodes && nodes.dataset) {\n\t\tfor(let j=0; j<nodes.dataset.length; j++) {\n\t\t\tif(name === nodes.dataset[j].name)\n\t\t\t\treturn {data: nodes.dataset[j]};\n\t\t}\n\t}\n}\n\n/**\n * Check if an object has the proband attribute set\n * @param {Object} obj - Person object or jQuery element\n * @returns {boolean} True if proband attribute is set and not false\n */\nexport function isProband(obj) {\n\treturn typeof $(obj).attr('proband') !== typeof undefined && $(obj).attr('proband') !== false;\n}\n\n/**\n * Set or unset a person as the proband (index case)\n * Only one person can be proband at a time - this removes proband status from all others\n * @param {Array} dataset - Array of person objects\n * @param {string} name - Name (IndivID) of person to set as proband\n * @param {boolean} is_proband - True to set as proband, false to unset\n * @example\n * setProband(dataset, 'person1', true);\n */\nexport function setProband(dataset, name, is_proband) {\n\t$.each(dataset, function(_i, p) {\n\t\tif (name === p.name)\n\t\t\tp.proband = is_proband;\n\t\telse\n\t\t\tdelete p.proband;\n\t});\n}\n\n/**\n * Find the index of the proband in the dataset\n * @param {Array} dataset - Array of person objects\n * @returns {number|undefined} Index of the proband, or undefined if no proband is set\n */\nexport function getProbandIndex(dataset) {\n\tlet proband;\n\t$.each(dataset, function(i, val) {\n\t\tif (isProband(val)) {\n\t\t\tproband = i;\n\t\t\treturn proband;\n\t\t}\n\t});\n\treturn proband;\n}\n\n/**\n * Check if an individual exists in the cached dataset\n * @param {Object} opts - Options object\n * @param {string} name - Name (IndivID) to check\n * @returns {boolean} True if individual exists in cache\n */\nexport function exists(opts, name){\n\treturn getNodeByName(pedcache.current(opts), name) !== undefined;\n}\n\n/**\n * Get all partners (spouses) of a given person\n * A partner is someone who shares children with the person\n * @param {Array} dataset - Array of person objects\n * @param {Object} anode - Person object to find partners for\n * @returns {Array} Array of partner names (IndivIDs)\n * @example\n * let partners = get_partners(dataset, person);\n * // Returns ['spouse1', 'spouse2']\n */\nexport function get_partners(dataset, anode) {\n\tlet ptrs = [];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet bnode = dataset[i];\n\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) === -1)\n\t\t\tptrs.push(bnode.father);\n\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) === -1)\n\t\t\tptrs.push(bnode.mother);\n\t}\n\treturn ptrs;\n}\n\n/**\n * Get children of a mother and optional father\n * Excludes children with noparents flag (visually disconnected)\n * @param {Array} dataset - Array of person objects\n * @param {Object} mother - Mother person object (must have sex='F')\n * @param {Object} [father] - Optional father person object to filter by\n * @returns {Array} Array of child person objects\n * @example\n * let children = getChildren(dataset, mother, father);\n */\nexport function getChildren(dataset, mother, father) {\n\tlet children = [];\n\tlet names = [];\n\tif(mother.sex === 'F')\n\t\t$.each(dataset, function(_i, p) {\n\t\t\tif(mother.name === p.mother)\n\t\t\t\tif(!father || father.name === p.father) {\n\t\t\t\t\tif($.inArray(p.name, names) === -1 && !p.noparents){\n\t\t\t\t\t\tchildren.push(p);\n\t\t\t\t\t\tnames.push(p.name);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t});\n\treturn children;\n}\n\n/**\n * Get all children of a person, including those with noparents flag\n * @param {Array} dataset - Array of person objects\n * @param {Object} person - Person object to find children for\n * @param {string} [sex] - Optional sex filter ('M' or 'F')\n * @returns {Array} Array of child person objects\n */\nexport function getAllChildren(dataset, person, sex) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn !('noparents' in p) &&\n\t\t\t   (p.mother === person.name || p.father === person.name) &&\n\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t});\n}\n\n/**\n * Get monozygotic or dizygotic twin(s) of a person\n * @param {Array} dataset - Array of person objects\n * @param {Object} person - Person object to find twins for\n * @returns {Array} Array of twin person objects (excludes the person themselves)\n */\nexport function getTwins(dataset, person) {\n\tlet sibs = getSiblings(dataset, person);\n\tlet twin_type = (person.mztwin ? \"mztwin\" : \"dztwin\");\n\treturn $.map(sibs, function(p, _i){\n\t\treturn p.name !== person.name && p[twin_type] === person[twin_type] ? p : null;\n\t});\n}\n\n/**\n * Get siblings of a person with optional sex filter\n * Excludes the person themselves and those with noparents flag\n * @param {Array} dataset - Array of person objects\n * @param {Object} person - Person object to find siblings for\n * @param {string} [sex] - Optional sex filter ('M' for brothers, 'F' for sisters)\n * @returns {Array} Array of sibling person objects\n * @example\n * let brothers = getSiblings(dataset, person, 'M');\n */\nexport function getSiblings(dataset, person, sex) {\n\tif(person === undefined || !person.mother || person.noparents)\n\t\treturn [];\n\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\n\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t});\n}\n\n// get the siblings + adopted siblings - sex is an optional parameter\n// for only returning brothers or sisters\nexport function getAllSiblings(dataset, person, sex) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\n\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t});\n}\n\n// get the adopted siblings of a given individual\nexport function getAdoptedSiblings(dataset, person) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && 'noparents' in p &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) ? p : null;\n\t});\n}\n\n// get the depth of the given person from the root\nexport function getDepth(dataset, name) {\n\tlet idx = getIdxByName(dataset, name);\n\tlet depth = 1;\n\n\twhile(idx >= 0 && ('mother' in dataset[idx] || dataset[idx].top_level)){\n\t\tidx = getIdxByName(dataset, dataset[idx].mother);\n\t\tdepth++;\n\t}\n\treturn depth;\n}\n\n// get the nodes at a given depth sorted by their x position\nexport function getNodesAtDepth(fnodes, depth, exclude_names) {\n\treturn $.map(fnodes, function(p, _i){\n\t\treturn p.depth === depth && !p.data.hidden && $.inArray(p.data.name, exclude_names) === -1 ? p : null;\n\t}).sort(function (a,b) {return a.x - b.x;});\n}\n\n// convert the partner names into corresponding tree nodes\nexport function linkNodes(flattenNodes, partners) {\n\tlet links = [];\n\tfor(let i=0; i< partners.length; i++) {\n\t\tlet motherName = partners[i].mother?.data?.name || partners[i].mother?.name;\n\t\tlet fatherName = partners[i].father?.data?.name || partners[i].father?.name;\n\t\tif(!motherName || !fatherName)\n\t\t\tcontinue;\n\t\tlet motherNode = getNodeByName(flattenNodes, motherName);\n\t\tlet fatherNode = getNodeByName(flattenNodes, fatherName);\n\t\tif(motherNode && fatherNode)\n\t\t\tlinks.push({'mother': motherNode, 'father': fatherNode});\n\t}\n\treturn links;\n}\n\n// get ancestors of a node\nexport function ancestors(dataset, node) {\n\tlet ancestors = [];\n\tfunction recurse(node) {\n\t\tif(node.data) node = node.data;\n\t\tif('mother' in node && 'father' in node && !('noparents' in node)){\n\t\t\trecurse(getNodeByName(dataset, node.mother));\n\t\t\trecurse(getNodeByName(dataset, node.father));\n\t\t}\n\t\tancestors.push(node);\n\t}\n\trecurse(node);\n\treturn ancestors;\n}\n\n// test if two nodes are consanguinous partners\nexport function consanguity(node1, node2, opts) {\n\tif(node1.depth !== node2.depth) // parents at different depths\n\t\treturn true;\n\tlet ancestors1 = ancestors(opts.dataset, node1);\n\tlet ancestors2 = ancestors(opts.dataset, node2);\n\tlet names1 = $.map(ancestors1, function(ancestor, _i){return ancestor.name;});\n\tlet names2 = $.map(ancestors2, function(ancestor, _i){return ancestor.name;});\n\tlet consanguity = false;\n\t$.each(names1, function( _index, name ) {\n\t\tif($.inArray(name, names2) !== -1){\n\t\t\tconsanguity = true;\n\t\t\treturn false;\n\t\t}\n\t});\n\treturn consanguity;\n}\n\n// return a flattened representation of the tree\nexport function flatten(root) {\n\tlet flat = [];\n\tfunction recurse(node) {\n\t\tif(node.children)\n\t\t\tnode.children.forEach(recurse);\n\t\tflat.push(node);\n\t}\n\trecurse(root);\n\tif(root && root._dataset)\n\t\tflat.dataset = root._dataset;\n\treturn flat;\n}\n\n// test if x position overlaps a node at the same depth\nexport function overlap(opts, nodes, xnew, depth, exclude_names) {\n\tfor(let n=0; n<nodes.length; n++) {\n\t\tif(depth === nodes[n].depth && $.inArray(nodes[n].data.name, exclude_names) === -1){\n\t\t\tif(Math.abs(xnew - nodes[n].x) < (opts.symbol_size*1.15))\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\n// test if moving siblings by diff overlaps with other nodes\nfunction nodesOverlap(opts, node, diff, root) {\n\tlet descendants = node.descendants();\n\tlet descendantsNames = $.map(descendants, function(descendant, _i){return descendant.data.name;});\n\tlet nodes = root.descendants();\n\tfor(let i=0; i<descendants.length; i++){\n\t\tlet descendant = descendants[i];\n\t\tif(node.data.name !== descendant.data.name){\n\t\t\tlet xnew = descendant.x - diff;\n\t\t\tif(overlap(opts, nodes, xnew, descendant.depth, descendantsNames))\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\n// Adjust D3 layout positioning.\n// Position hidden parent node centring them between father and mother nodes. Remove kinks\n// from links - e.g. where there is a single child plus a hidden child\nexport function adjust_coords(opts, root, flattenNodes) {\n\tfunction recurse(node) {\n\t\tif (node.children) {\n\t\t\tnode.children.forEach(recurse);\n\n\t\t\tif(node.data.father !== undefined && node.data.mother !== undefined) { \t// hidden nodes\n\t\t\t\tlet fatherName = (typeof node.data.father === 'string' ? node.data.father : node.data.father.name);\n\t\t\t\tlet motherName = (typeof node.data.mother === 'string' ? node.data.mother : node.data.mother.name);\n\t\t\t\tif(!fatherName || !motherName)\n\t\t\t\t\treturn;\n\t\t\t\tlet father = getNodeByName(flattenNodes, fatherName);\n\t\t\t\tlet mother = getNodeByName(flattenNodes, motherName);\n\t\t\t\tif(!father || !mother)\n\t\t\t\t\treturn;\n\t\t\t\tlet xmid = (father.x + mother.x) /2;\n\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.depth, [node.data.name])) {\n\t\t\t\t\tnode.x = xmid;   // centralise parent nodes\n\t\t\t\t\tlet diff = node.x - xmid;\n\t\t\t\t\tif(node.children.length === 2 && (node.children[0].data.hidden || node.children[1].data.hidden)) {\n\t\t\t\t\t\tif(!(node.children[0].data.hidden && node.children[1].data.hidden)) {\n\t\t\t\t\t\t\tlet child1 = (node.children[0].data.hidden ? node.children[1] : node.children[0]);\n\t\t\t\t\t\t\tlet child2 = (node.children[0].data.hidden ? node.children[0] : node.children[1]);\n\t\t\t\t\t\t\tif( ((child1.x < child2.x && xmid < child2.x) || (child1.x > child2.x && xmid > child2.x)) &&\n\t\t\t\t\t\t\t\t!overlap(opts, root.descendants(), xmid, child1.depth, [child1.data.name])){\n\t\t\t\t\t\t\t\tchild1.x = xmid;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if(node.children.length === 1 && !node.children[0].data.hidden) {\n\t\t\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.children[0].depth, [node.children[0].data.name]))\n\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif(diff !== 0 && !nodesOverlap(opts, node, diff, root)){\n\t\t\t\t\t\t\tif(node.children.length === 1) {\n\t\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tlet descendants = node.descendants();\n\t\t\t\t\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\t\t\t\t\tconsole.log('ADJUSTING '+node.data.name+' NO. DESCENDANTS '+descendants.length+' diff='+diff);\n\t\t\t\t\t\t\t\tfor(let i=0; i<descendants.length; i++) {\n\t\t\t\t\t\t\t\t\tif(node.data.name !== descendants[i].data.name)\n\t\t\t\t\t\t\t\t\t\tdescendants[i].x -= diff;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else if((node.x < father.x && node.x < mother.x) || (node.x > father.x && node.x > mother.x)){\n\t\t\t\t\t\tnode.x = xmid;   // centralise parent nodes if it doesn't lie between mother and father\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\trecurse(root);\n\trecurse(root);\n}\n\nfunction contains_parent(arr, m, f) {\n\tfor(let i=0; i<arr.length; i++)\n\t\tif(arr[i].mother === m && arr[i].father === f)\n\t\t\treturn true;\n\treturn false;\n}\n\n// get grandparents index\nfunction get_grandparents_idx(dataset, midx, fidx) {\n\tlet gmidx = midx;\n\tlet gfidx = fidx;\n\twhile(  'mother' in dataset[gmidx] && 'mother' in dataset[gfidx] &&\n\t\t  !('noparents' in dataset[gmidx]) && !('noparents' in dataset[gfidx])){\n\t\tgmidx = getIdxByName(dataset, dataset[gmidx].mother);\n\t\tgfidx = getIdxByName(dataset, dataset[gfidx].mother);\n\t}\n\treturn {'midx': gmidx, 'fidx': gfidx};\n}\n\n// update parent node and sort twins\nfunction updateParent(p, parent, id, nodes, opts) {\n\t// add to parent node\n\tif('parent_node' in p)\n\t\tp.parent_node.push(parent);\n\telse\n\t\tp.parent_node = [parent];\n\n\t// check twins lie next to each other\n\tif(p.mztwin || p.dztwins) {\n\t\tlet twins = getTwins(opts.dataset, p);\n\t\tfor(let i=0; i<twins.length; i++) {\n\t\t\tlet twin = getNodeByName(nodes, twins[i].name);\n\t\t\tif(twin)\n\t\t\t\ttwin.id = id++;\n\t\t}\n\t}\n\treturn id;\n}\n\nfunction setChildrenId(children, id) {\n\t// sort twins to lie next to each other\n\tchildren.sort(function(a, b) {\n\t\tif(a.mztwin && b.mztwin && a.mztwin === b.mztwin)\n\t\t\treturn 0;\n\t\telse if(a.dztwin && b.dztwin && a.dztwin === b.dztwin)\n\t\t\treturn 0;\n\t\telse if(a.mztwin || b.mztwin || a.dztwin || b.dztwin)\n\t\t\treturn 1;\n\t\treturn 0;\n\t});\n\n\t$.each(children, function(_i, p) {\n\t\tif(p.id === undefined) p.id = id++;\n\t});\n\treturn id;\n}\n\nexport function makeid(len) {\n\tlet text = \"\";\n\tlet possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\n\tfor( let i=0; i < len; i++ )\n\t\ttext += possible.charAt(Math.floor(Math.random() * possible.length));\n\treturn text;\n}\n\nexport function buildTree(opts, person, root, partnerLinks, id) {\n\tif (typeof person.children === typeof undefined)\n\t\tperson.children = getChildren(opts.dataset, person);\n\n\tif (typeof partnerLinks === typeof undefined) {\n\t\tpartnerLinks = [];\n\t\tid = 1;\n\t}\n\n\tlet nodes = flatten(root);\n\t//console.log('NAME='+person.name+' NO. CHILDREN='+person.children.length);\n\tlet partners = [];\n\t$.each(person.children, function(_i, child) {\n\t\t$.each(opts.dataset, function(_j, p) {\n\t\t\tif (((child.name === p.mother) || (child.name === p.father)) && child.id === undefined) {\n\t\t\t\tlet m = getNodeByName(nodes, p.mother);\n\t\t\t\tlet f = getNodeByName(nodes, p.father);\n\t\t\t\tm = (m !== undefined? m : getNodeByName(opts.dataset, p.mother));\n\t\t\t\tf = (f !== undefined? f : getNodeByName(opts.dataset, p.father));\n\t\t\t\tif(!contains_parent(partners, m, f))\n\t\t\t\t\tpartners.push({'mother': m, 'father': f});\n\t\t\t}\n\t\t});\n\t});\n\t$.merge(partnerLinks, partners);\n\n\t$.each(partners, function(_i, ptr) {\n\t\tlet mother = ptr.mother;\n\t\tlet father = ptr.father;\n\t\tmother.children = [];\n\t\tlet parent = {\n\t\t\t\tname : makeid(4),\n\t\t\t\thidden : true,\n\t\t\t\tparent : null,\n\t\t\t\tfather : father,\n\t\t\t\tmother : mother,\n\t\t\t\tchildren : getChildren(opts.dataset, mother, father)\n\t\t};\n\n\t\tlet midx = getIdxByName(opts.dataset, mother.name);\n\t\tlet fidx = getIdxByName(opts.dataset, father.name);\n\t\tif(!('id' in father) && !('id' in mother))\n\t\t\tid = setChildrenId(person.children, id);\n\n\t\t// look at grandparents index\n\t\tlet gp = get_grandparents_idx(opts.dataset, midx, fidx);\n\t\tif(gp.fidx < gp.midx) {\n\t\t\tfather.id = id++;\n\t\t\tparent.id = id++;\n\t\t\tmother.id = id++;\n\t\t} else {\n\t\t\tmother.id = id++;\n\t\t\tparent.id = id++;\n\t\t\tfather.id = id++;\n\t\t}\n\t\tid = updateParent(mother, parent, id, nodes, opts);\n\t\tid = updateParent(father, parent, id, nodes, opts);\n\t\tperson.children.push(parent);\n\t});\n\tid = setChildrenId(person.children, id);\n\n\t$.each(person.children, function(_i, p) {\n\t\tid = buildTree(opts, p, root, partnerLinks, id)[1];\n\t});\n\treturn [partnerLinks, id];\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// General utility functions\n\n// Re-export functions from new modules for backward compatibility\nexport {validate_pedigree, validate_age_yob, create_err, unconnected} from './validation.js';\nexport {messages, print_opts, is_fullscreen, get_svg_dimensions, get_tree_dimensions, isIE, isEdge} from './dom.js';\nexport {\n\tgetIdxByName, getNodeByName, isProband, setProband, getProbandIndex, exists,\n\tget_partners, getChildren, getAllChildren, getTwins, getSiblings, getAllSiblings,\n\tgetAdoptedSiblings, getDepth, getNodesAtDepth, linkNodes, ancestors, consanguity,\n\tflatten, overlap, adjust_coords, buildTree, makeid\n} from './tree-utils.js';\n\n// Global state (to be refactored later)\nexport let roots = {};\n\nconst globalScope = (function() {\n\ttry {\n\t\t// eslint-disable-next-line no-new-func\n\t\treturn Function('return this')() || {};\n\t} catch (err) {\n\t\treturn {};\n\t}\n})();\nconst globalStructuredClone = (typeof globalScope.structuredClone === 'function') ? globalScope.structuredClone : null;\nconst canStructuredClone = typeof globalStructuredClone === 'function';\n\nexport function deepClone(value) {\n\tif(value === null || value === undefined || typeof value !== 'object')\n\t\treturn value;\n\n\tif(canStructuredClone) {\n\t\ttry {\n\t\t\treturn globalStructuredClone(value);\n\t\t} catch (err) {\n\t\t\t// Fallback to manual clone when structuredClone cannot handle the payload (e.g. functions).\n\t\t}\n\t}\n\treturn cloneValue(value);\n}\n\nexport function copy_dataset(dataset) {\n\tif(!Array.isArray(dataset) || dataset.length === 0)\n\t\treturn [];\n\n\tlet disallowed = new Set([\"id\", \"parent_node\"]);\n\treturn dataset.map(function(person){\n\t\tif(!person || typeof person !== 'object')\n\t\t\treturn {};\n\n\t\tlet clone = {};\n\t\tfor(let key in person) {\n\t\t\tif(!Object.prototype.hasOwnProperty.call(person, key) || disallowed.has(key))\n\t\t\t\tcontinue;\n\t\t\tclone[key] = deepClone(person[key]);\n\t\t}\n\t\treturn clone;\n\t});\n}\n\nfunction cloneValue(value) {\n\tif(Array.isArray(value))\n\t\treturn value.map(deepClone);\n\tif(value instanceof Date)\n\t\treturn new Date(value.getTime());\n\tif(value && typeof value === 'object') {\n\t\tlet clonedObj = {};\n\t\tfor(let key in value) {\n\t\t\tif(Object.prototype.hasOwnProperty.call(value, key)) {\n\t\t\t\tclonedObj[key] = deepClone(value[key]);\n\t\t\t}\n\t\t}\n\t\treturn clonedObj;\n\t}\n\treturn value;\n}\n\n// check if the object contains a key with a given prefix\nexport function prefixInObj(prefix, obj) {\n\tlet found = false;\n\tif(obj)\n\t\t$.each(obj, function(k, _n){\n\t\t\tif(k.indexOf(prefix+\"_\") === 0 || k === prefix) {\n\t\t\t\tfound = true;\n\t\t\t\treturn found;\n\t\t\t}\n\t\t});\n\treturn found;\n}\n\n/**\n *  Get formatted time or data & time\n */\nexport function getFormattedDate(time){\n\tlet d = new Date();\n\tif(time)\n\t\treturn ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\n\telse\n\t\treturn d.getFullYear() + \"-\" + ('0' + (d.getMonth() + 1)).slice(-2) + \"-\" + ('0' + d.getDate()).slice(-2) + \" \" + ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\n }\n\nexport function capitaliseFirstLetter(string) {\n\treturn string.charAt(0).toUpperCase() + string.slice(1);\n}\n\n// given the name of a url param get the value\nexport function urlParam(name){\n\tlet results = new RegExp('[?&]' + name + '=([^&#]*)').exec(window.location.href);\n\tif (results===null)\n\t   return null;\n\telse\n\t   return results[1] || 0;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport {getposition, setposition} from './pedcache.js';\n\nlet zm;\n\n/**\n * Initialize zoom and pan behavior on SVG element\n * Sets up D3 zoom with configurable scale extent and source filters\n * Restores cached position from previous session if available\n * @param {Object} opts - Pedigree options object\n * @param {number} opts.zoomIn - Minimum zoom scale (e.g., 0.1)\n * @param {number} opts.zoomOut - Maximum zoom scale (e.g., 10)\n * @param {Array} [opts.zoomSrc] - Array of zoom sources to enable ('wheel', 'button')\n * @param {number} opts.symbol_size - Size of person symbols for positioning\n * @param {Object} svg - D3 selection of SVG element\n */\nexport function init_zoom(opts, svg) {\n\t// offsets\n\tlet xi = opts.symbol_size/2;\n\tlet yi = -opts.symbol_size*2.5;\n\n\tzm = d3.zoom()\n\t  .scaleExtent([opts.zoomIn, opts.zoomOut])\n\t  .filter(function(e) {\n\t\t\tif(!opts.zoomSrc || opts.zoomSrc.indexOf('wheel') === -1) {\n\t\t\t\tif(e.type && e.type === 'wheel') return false\n\t\t\t}\n\t\t\t// ignore dblclick & secondary mouse buttons\n\t\t\treturn (e.type !== 'dblclick') && !e.button})\n\t  .on('zoom', function(e) { zooming(e, opts); });\n\tsvg.call(zm);\n\n\t// set initial position & scale\n\tlet xyk = getposition(opts);\t\t// cached position\n\tlet k = (xyk.length === 3 ? xyk[2] : 1);\n\tlet x = (xyk[0] !== null ? xyk[0]/k: (xi*k));\n\tlet y = (xyk[1] !== null ? xyk[1]/k: (yi*k));\n\n\tvar transform = d3.zoomIdentity\n      .scale(k)\n      .translate(x, y);\n    svg.call(zm.transform, transform);\n}\n\n/**\n * Zoom in or out by a scale factor using button controls\n * @param {Object} opts - Pedigree options object\n * @param {string} opts.targetDiv - ID of the container div\n * @param {number} scale - Scale factor (>1 zooms in, <1 zooms out, e.g., 1.2 or 0.8)\n * @example\n * btn_zoom(opts, 1.5); // Zoom in by 50%\n * btn_zoom(opts, 0.8); // Zoom out by 20%\n */\nexport function btn_zoom(opts, scale) {\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\n\tsvg.transition().duration(50).call(zm.scaleBy, scale);\n}\n\n/**\n * Scale and center the pedigree to fit within the viewport\n * Calculates optimal scale and position to show entire pedigree\n * Uses animated transition for smooth scaling\n * @param {Object} opts - Pedigree options object\n * @param {string} opts.targetDiv - ID of the container div\n * @param {number} opts.zoomIn - Minimum zoom scale\n * @param {number} opts.zoomOut - Maximum zoom scale\n * @param {number} opts.symbol_size - Size of person symbols\n */\nexport function scale_to_fit(opts) {\n\tlet d = get_dimensions(opts);\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\n\tlet size = get_svg_size(svg);\n\tlet f = 1;\n\tlet k = (f / Math.max(d.wid/size.w, d.hgt/size.h));\n\n\tif(k < opts.zoomIn) zm.scaleExtent([k, opts.zoomOut]);\n\n\tlet ped = get_pedigree_center(opts);\n\tsvg.call(zm.translateTo, ped.x-(opts.symbol_size), ped.y-(opts.symbol_size));\n\tsetTimeout(function(){svg.transition().duration(700).call(zm.scaleTo, k)}, 400);\n}\n\nfunction zooming(e, opts) {\n\t(opts.DEBUG && console.log(\"zoom\", e.transform));\n\tlet t = e.transform;\n\tlet k = (t.k && t.k !== 1 ? t.k : undefined);\n\tsetposition(opts, t.x, t.y, k);\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\n\tped.attr('transform', 'translate(' + t.x + ',' + t.y + ')' + (k ? ' scale(' + k + ')' : ''));\n\tif(typeof opts._updateWarningOverlay === 'function') {\n\t\topts._updateWarningOverlay(t);\n\t}\n}\n\nfunction get_pedigree_center(opts) {\n\tlet b = get_bounds(opts);\n\treturn {x: b.xmin+((b.xmax-b.xmin)/2), y: b.ymin+((b.ymax-b.ymin)/2)};\n}\n\n// find width/height of pedigree graphic\nfunction get_dimensions(opts) {\n\tlet b = get_bounds(opts);\n\treturn {wid: Math.abs(b.xmax-b.xmin), hgt: Math.abs(b.ymax-b.ymin)};\n}\n\n/**\n * Get the bounding box coordinates of the visible pedigree\n * Calculates min/max x and y coordinates of all visible nodes\n * Excludes hidden nodes and hidden_root from calculations\n * @param {Object} opts - Pedigree options object\n * @param {string} opts.targetDiv - ID of the container div\n * @param {number} opts.symbol_size - Size of person symbols for padding\n * @returns {Object} Bounding box with {xmin, xmax, ymin, ymax} properties\n * @example\n * let bounds = get_bounds(opts);\n * console.log(bounds.xmin, bounds.xmax, bounds.ymin, bounds.ymax);\n */\nexport function get_bounds(opts) {\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\n\tlet xmin = Number.MAX_VALUE;\n\tlet xmax = -1000000;\n\tlet ymin = Number.MAX_VALUE;\n\tlet ymax = -1000000;\n\tlet sym = opts.symbol_size;\n\tped.selectAll('g').each(function(d, _i) {\n\t\tif(d.x && d.data.name !== 'hidden_root' && !d.data.hidden) {\n\t\t\tlet n = getNodeSize(opts, this, sym);\n\t\t\tif(d.x-sym < xmin) xmin = d.x-sym;\n\t\t\tif(d.x+n.w+sym > xmax) xmax = d.x+n.w+sym;\n\t\t\tif(d.y < ymin) ymin = d.y;\n\t\t\tif(d.y+n.h+sym > ymax) ymax = d.y+n.h+sym;\n\t\t}\n\t});\n\treturn {xmin:xmin, xmax:xmax, ymin:ymin, ymax:ymax};\n}\n\n/**\n * Get the size of an individual's graphical representation\n */\nfunction getNodeSize(opts, g_elm, sym) {\n\tlet node = d3.select(g_elm).node();\n\tlet dg = node.getBBox();\n\tlet w = dg.width;\n\tlet h = dg.height;\n\tif(w === 0 && h === 0) {\t// pedigree not shown yet (family history section not opened)\n\t\ttry {\n\t\t\tw = sym*2;\n\t\t\th = sym*2;\n\t\t\tlet text_elements = d3.select(g_elm).selectAll(\".indi_details\"); // get individuals details\n\t\t\tfor(let i=0; i<text_elements._groups[0].length; i++) {\n\t\t\t\tlet txt = text_elements._groups[0][i].firstChild.nodeValue;\n\t\t\t\tlet txtsize = getTextSize(txt, opts.font_family, opts.font_size);\n\t\n\t\t\t\tw = Math.max(txtsize.w+(sym/2), w);\n\t\t\t\th = Math.max((sym*2)+(i*txtsize.h), h);\n\t\t\t}\n\t\t} catch(err) {\n\t\t\tconsole.error(err);\n\t\t\tw = sym*2;\n\t\t\th = sym*2;\n\t\t}\n\t}\n\treturn {w:w, h:h};\n}\n\n/**\n * Calculate width and height of text\n */\nfunction getTextSize(txt, font, fontSize) {\n\t  let o = $('<div></div>')\n\t            .text(txt)\n\t            .css(\n\t\t\t\t\t{'position': 'absolute',\n\t\t\t\t\t 'float': 'left', 'white-space': 'nowrap', 'visibility': 'hidden',\n\t\t\t\t\t 'font': font || 'Helvetica',\n\t\t\t\t\t 'fontSize': fontSize || '1em'})\n\t            .appendTo($('body'));\n\t  let s = {w: o.width(), h:o.height()};\n\t  o.remove();\n\t  return s;\n}\n\nfunction get_svg_size(svg) {\n\treturn {w: svg.node().clientWidth, h:svg.node().clientHeight};\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// undo, redo, reset buttons\nimport * as pedcache from './pedcache.js';\nimport {btn_zoom, scale_to_fit} from './zoom.js';\nimport {copy_dataset, getProbandIndex, is_fullscreen, messages} from './utils.js';\n\nexport function addButtons(options) {\n\tlet opts = $.extend({\n        // defaults\n\t\tbtn_target: 'pedigree_history'\n    }, options );\n\n\tlet btns = [{\"fa\": \"fa-file-image\", \"title\": \"download PNG image\"},\n\t\t\t\t{\"fa\": \"fa-undo\", \"title\": \"undo\"},\n\t\t\t\t{\"fa\": \"fa-redo\", \"title\": \"redo\"},\n\t\t\t\t{\"fa\": \"fa-refresh\", \"title\": \"reset\"}];\n\n\tbtns.push({\"fa\": \"fa-crosshairs\", \"title\": \"scale-to-fit\"});\n\t// Phase 3.3.3: Toujours afficher les boutons zoom, mais les griser si désactivés\n\tif(opts.zoomSrc && (opts.zoomSrc.indexOf('button') > -1)) {\n\t\tbtns.push({\"fa\": \"fa-minus-circle\", \"title\": opts.zoomOut === 1 ? \"zoom-out (disabled: already at minimum)\" : \"zoom-out\", \"disabled\": opts.zoomOut === 1});\n\t\tbtns.push({\"fa\": \"fa-plus-circle\", \"title\": opts.zoomIn === 1 ? \"zoom-in (disabled: already at maximum)\" : \"zoom-in\", \"disabled\": opts.zoomIn === 1});\n\t}\n\tbtns.push({\"fa\": \"fa-arrows-alt\", \"title\": \"fullscreen\"});\n\n\tlet lis = \"\";\n\tfor(let i=0; i<btns.length; i++) {\n\t\tlis += '<span>';\n\t\tlis += '<i class=\"fa fa-lg ' + btns[i].fa + ' pe-2' + (btns[i].disabled ? ' disabled-btn' : '') + '\" ' +\n\t\t'aria-hidden=\"true\" title=\"'+ btns[i].title + '\" ' +\n\t\t(btns[i].fa === \"fa-arrows-alt\" ? 'id=\"fullscreen\" ' : '') +\n\t\t(btns[i].disabled ? 'style=\"opacity: 0.3; cursor: not-allowed;\" ' : '') +\n\t\t'></i>';\n\n\t\tlis += '</span>';\n\t}\n\t$( \"#\"+opts.btn_target ).append(lis);\n\taddPbuttonEvents(opts);\n}\n\nfunction addPbuttonEvents(opts) {\n\t// fullscreen\n    $(document).on('webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange', function(_e)  {\n\t\tlet local_dataset = pedcache.current(opts);\n\t\tif (local_dataset !== undefined && local_dataset !== null) {\n\t\t\topts.dataset = local_dataset;\n\t\t}\n\t\t$(document).trigger('rebuild', [opts]);\n\t\t// Phase 3.2.3: Preserve zoom/pan position in fullscreen\n\t\t// scale_to_fit(opts) was called here, but it resets the zoom\n\t\t// The rebuild automatically restores the cached position via init_zoom()\n    });\n\n\t$('#fullscreen').on('click', function(_e) {\n\t\t// toggle fullscreen\n\t\tif (!is_fullscreen()) {\n\t\t\tlet target = $(\"#\"+opts.targetDiv)[0];\n\t\t\tif (target.requestFullscreen) {\n                target.requestFullscreen();\n            } else if (document.documentElement.mozRequestFullScreen) {\n\t\t\t\ttarget.mozRequestFullScreen(); // Firefox\n            } else if (document.documentElement.webkitRequestFullscreen) {\n                target.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT); // Chrome and Safari\n            } else if (document.documentElement.msRequestFullscreen) {\n                target.msRequestFullscreen(); // IE\n            }\n\t\t} else {\n            if (document.exitFullscreen) {\n                document.exitFullscreen();\n            } else if (document.msExitFullscreen) {\n                document.msExitFullscreen();\n            } else if (document.mozCancelFullScreen) {\n                document.mozCancelFullScreen();\n            } else if (document.webkitExitFullscreen) {\n                document.webkitExitFullscreen();\n            }\n\t\t}\n\t});\n\n\t// press and hold to zoom in/out\n\tlet timeoutId = 0;\n\tfunction zoomIn() {btn_zoom(opts, 1.05);}\n\tfunction zoomOut() {btn_zoom(opts, 0.95);}\n\t$('.fa-plus-circle, .fa-minus-circle').on('mousedown', function() {\n\t\t// Phase 3.3.3: Ignorer les clics sur les boutons désactivés\n\t\tif($(this).hasClass('disabled-btn')) return;\n\t    timeoutId = setInterval(($( this ).hasClass( \"fa-plus-circle\" ) ? zoomIn : zoomOut), 50);\n\t}).on('mouseup mouseleave', function() {\n\t    clearInterval(timeoutId);\n\t});\n\n\t// undo/redo/reset\n\t$( \"#\"+opts.btn_target ).on( \"click\", function(e) {\n\t\te.stopPropagation();\n\t\tif($(e.target).hasClass(\"fg-grey\"))\n\t\t\treturn false;\n\n\t\tif($(e.target).hasClass('fa-undo')) {\n\t\t\topts.dataset = pedcache.previous(opts);\n\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\t$(document).trigger('build', [opts]);\n\t\t} else if ($(e.target).hasClass('fa-redo')) {\n\t\t\topts.dataset = pedcache.next(opts);\n\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\t$(document).trigger('build', [opts]);\n\t\t} else if ($(e.target).hasClass('fa-refresh')) {\n\t\t\tmessages(\"Pedigree Reset\",\n\t\t\t         \"This may result in loss of some data. Reset now?\",\n\t\t\t         reset, opts);\n\t\t} else if ($(e.target).hasClass('fa-crosshairs')) {\n\t\t\tscale_to_fit(opts);\n\t\t} else if ($(e.target).hasClass('fa-file-image')) {\n\t\t\treturn;\n\t\t} \n\n\t\t// trigger fhChange event\n\t\t$(document).trigger('fhChange', [opts]);\n\t});\n}\n\n// reset pedigree and clear the history\nfunction reset(opts) {\n\tlet proband;\n\tif(opts.keep_proband_on_reset) {\n\t\tlet local_dataset = pedcache.current(opts);\n\t\tlet newdataset =  copy_dataset(local_dataset);\n\t\tproband = newdataset[getProbandIndex(newdataset)];\n\t\t//let children = pedigree_util.getChildren(newdataset, proband);\n\t\t// Phase 3.2.5: Preserve proband.name to maintain external references\n\t\t// proband.name = \"ch1\";  // REMOVED: This was resetting the name incorrectly\n\t\tproband.mother = \"f21\";\n\t\tproband.father = \"m21\";\n\t\t// clear pedigree data but keep proband data and risk factors\n\t\tpedcache.clear_pedigree_data(opts)\n\t} else {\n\t\tproband = {\n\t\t\t\"name\":\"ch1\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"proband\":true,\"status\":\"0\",\"display_name\":\"me\"\n\t\t};\n\t\tpedcache.clear(opts); // clear all storage data\n\t}\n\tdelete opts.dataset;\n\n\tlet selected = $(\"input[name='default_fam']:checked\");\n\tif(selected.length > 0 && selected.val().indexOf(\"extended\") > -1) {\n\t\tlet partner = {\"name\":\"Spj\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"};\n\t\tlet daughter = {\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"};\n\t\tlet son     = {\"name\":\"Knx\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"son\"};\n\t\tpartner.sex    = (proband.sex === \"F\" ?\"M\":\"F\");\n\t\tdaughter.mother = (proband.sex === \"F\" ? proband.name: partner.name);\n\t\tdaughter.father = (proband.sex === \"F\" ? partner.name: proband.name);\n\t\tson.mother      = (proband.sex === \"F\" ? proband.name: partner.name);\n\t\tson.father      = (proband.sex === \"F\" ? partner.name: proband.name);\n\t\topts.dataset    = [proband, partner, daughter, son];\n\t}\n\n\tif(selected.length > 0 && selected.val() === 'extended2') {    // secondary relatives\n\t\topts.dataset.push(\n\t\t\t{\"name\":\"wZA\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandfather\"},\n\t\t\t{\"name\":\"MAk\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandmother\"},\n\t\t\t{\"name\":\"zwB\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandfather\"},\n\t\t\t{\"name\":\"dOH\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandmother\"},\n\t\t\t{\"name\":\"MKg\",\"sex\":\"F\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal aunt\"},\n\t\t\t{\"name\":\"xsm\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal uncle\"},\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"father\"},\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\",\"display_name\":\"mother\"},\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\n\t\t\t{\"name\":\"uuc\",\"display_name\":\"maternal aunt\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"},\n\t\t\t{\"name\":\"xIw\",\"display_name\":\"maternal uncle\",\"sex\":\"M\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"});\n\t} else if(selected.length > 0 && selected.val() === 'extended1') {    // primary relatives\n\t\topts.dataset.push(\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"father\",\"noparents\":true},\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"mother\",\"noparents\":true},\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"});\n\t} else {\n\t\topts.dataset = [\n\t\t\t{\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n\t\t\t{\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n\t\t\tproband];\n\t}\n\t$(document).trigger('rebuild', [opts]);\n}\n\nexport function updateButtons(opts) {\n\tlet current = pedcache.get_count(opts);\n\tlet nstore = pedcache.nstore(opts);\n\tlet id = \"#\"+opts.btn_target;\n\tif(nstore <= current)\n\t\t$(id+\" .fa-redo\").addClass('fg-grey');\n\telse\n\t\t$(id+\" .fa-redo\").removeClass('fg-grey');\n\n\tif(current > 1)\n\t\t$(id+\" .fa-undo\").removeClass('fg-grey');\n\telse\n\t\t$(id+\" .fa-undo\").addClass('fg-grey');\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport * as pedigree_util from './utils.js';\n\n// cancers, genetic & pathology tests\nexport let cancers = {\n\t\t'breast_cancer': 'breast_cancer_diagnosis_age',\n\t\t'breast_cancer2': 'breast_cancer2_diagnosis_age',\n\t\t'ovarian_cancer': 'ovarian_cancer_diagnosis_age',\n\t\t'prostate_cancer': 'prostate_cancer_diagnosis_age',\n\t\t'pancreatic_cancer': 'pancreatic_cancer_diagnosis_age'\n\t};\nexport let genetic_test1 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'rad51d', 'rad51c', 'brip1'];\nexport let genetic_test2 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1'];\nexport let genetic_test4 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1', 'hoxb13'];\n\nexport let pathology_tests = ['er', 'pr', 'her2', 'ck14', 'ck56'];\n\n// risk factor to storage\nlet RISK_FACTOR_STORE = {};\n\n// get surgical ops and PRS for canrisk header\nexport function get_meta() {\n\tlet meta = get_surgical_ops();\n\tlet prs;\n\ttry {\n\t\tprs = get_prs_values();\n\t\tif(prs.breast_cancer_prs && prs.breast_cancer_prs.alpha !== 0 && prs.breast_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_BC=alpha=\"+prs.breast_cancer_prs.alpha+\",zscore=\"+prs.breast_cancer_prs.zscore;\n\t\t}\n\n\t\tif(prs.ovarian_cancer_prs && prs.ovarian_cancer_prs.alpha !== 0 && prs.ovarian_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_OC=alpha=\"+prs.ovarian_cancer_prs.alpha+\",zscore=\"+prs.ovarian_cancer_prs.zscore;\n\t\t}\n\n\t\tif(prs.prostate_cancer_prs && prs.prostate_cancer_prs.alpha !== 0 && prs.prostate_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_PC=alpha=\"+prs.prostate_cancer_prs.alpha+\",zscore=\"+prs.prostate_cancer_prs.zscore;\n\t\t}\n\t} catch(err) { console.warn(\"PRS\", prs); }\n\treturn meta;\n}\n\n// return a non-anonimised pedigree format\nexport function get_non_anon_pedigree(dataset, meta, version=2, ethnicity=undefined) {\n\treturn get_pedigree(dataset, undefined, meta, false, version, ethnicity);\n}\n\n//check if input has a value\nexport function hasInput(id) {\n\tconst v = $('#'+id).val();\n\treturn v && v.trim().length !== 0;\n}\n\n//return true if the object is empty\nlet isEmpty = function(myObj) {\n\tfor(let key in myObj) {\n\t\tif (Object.prototype.hasOwnProperty.call(myObj, key)) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn true;\n}\n\n//get breast and ovarian PRS values\nexport function get_prs_values() {\n\tlet prs = {};\n\tif(hasInput(\"breast_prs_a\") && hasInput(\"breast_prs_z\")) {\n\t\tprs['breast_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#breast_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#breast_prs_z').val()),\n\t\t\t'percent': parseFloat($('#breast_prs_percent').val())\n\t\t};\n\t}\n\tif(hasInput(\"ovarian_prs_a\") && hasInput(\"ovarian_prs_z\")) {\n\t\tprs['ovarian_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#ovarian_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#ovarian_prs_z').val()),\n\t\t\t'percent': parseFloat($('#ovarian_prs_percent').val())\n\t\t};\n\t}\n\tif(hasInput(\"prostate_prs_a\") && hasInput(\"prostate_prs_z\")) {\n\t\tprs['prostate_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#prostate_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#prostate_prs_z').val()),\n\t\t\t'percent': parseFloat($('#prostate_prs_percent').val())\n\t\t};\n\t}\n\tconsole.log(prs);\n\treturn (isEmpty(prs) ? 0 : prs);\n}\n\nfunction get_surgical_ops() {\n\tlet meta = \"\";\n\tif(!$('#A6_4_3_check').parent().hasClass(\"off\")) {\n\t\tmeta += \";OVARY2=y\";\n\t}\n\tif(!$('#A6_4_7_check').parent().hasClass(\"off\")) {\n\t\tmeta += \";MAST2=y\";\n\t}\n\treturn meta;\n}\n\n/**\n * Get genetic test genes based on CanRisk version\n */\nfunction getGeneticTest(version) {\n\tversion = parseInt(version);\n\tif(version === 1)\n\t\treturn genetic_test1;\n\telse if(version === 2)\n\t\treturn genetic_test2;\n\telse if(version === 3)\n\t\treturn genetic_test2;\n\treturn genetic_test4;\n}\n\nexport function readCanRisk(boadicea_lines) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\tlet hdr = [];  // collect risk factor header lines\n\tconst regexp = /([0-9])/;\n\tlet version = 3;\n\tlet gt = getGeneticTest(version);\n\tlet ncol = [26, 27, 27, 28];\t// number of columns - v1, v2, v3, v4\n\t// assumes two line header\n\tfor(let i = 0;i < lines.length;i++){\n\t\tlet ln = lines[i].trim();\n\t\tif(ln.indexOf(\"##\") === 0) {\n\t\t\tif(ln.indexOf(\"##CanRisk\") === 0) {\n\t\t\t\tconst match = ln.match(regexp);\n\t\t\t\tversion = parseInt(match[1]);\n\t\t\t\tgt = getGeneticTest(version);\n\t\t\t\tconsole.log(\"CanRisk File Format version \"+version);\n\n\t\t\t\tif(ln.indexOf(\";\") > -1) {   // contains surgical op data\n\t\t\t\t\tlet ops = ln.split(\";\");\n\t\t\t\t\tfor(let j=1; j<ops.length; j++) {\n\t\t\t\t\t\tlet opdata = ops[j].split(\"=\");\n\t\t\t\t\t\tif(opdata.length === 2) {\n\t\t\t\t\t\t\thdr.push(ops[j]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(ln.indexOf(\"CanRisk\") === -1 && ln.indexOf(\"##FamID\") !== 0) {\n\t\t\t\thdr.push(ln.replace(\"##\", \"\"));\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\n\t\tlet delim = /\\t/;\n\t\tif(ln.indexOf('\\t') < 0) {\n\t\t\tdelim = /\\s+/;\n\t\t\tconsole.log(\"NOT TAB DELIM\");\n\t\t}\n\t\tlet attr = $.map(ln.split(delim), function(val, _i){return val.trim();});\n\n\t\tif(attr.length > 1) {\n\t\t\tif(attr.length !== ncol[version-1]) {\n\t\t\t\tconsole.error(ln, attr);\n\t\t\t\tthrow new Error('Found number of columns '+attr.length+'; expected '+ncol[version-1]+' for CanRisk version '+version);\n\t\t\t}\n\t\t\tlet indi = {\n\t\t\t\t'famid': attr[0],\n\t\t\t\t'display_name': attr[1],\n\t\t\t\t'name':\tattr[3],\n\t\t\t\t'sex': attr[6],\n\t\t\t\t'status': attr[8]\n\t\t\t};\n\t\t\tif(attr[2] === \"1\") indi.proband = true;\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\n\n\t\t\tlet idx = 11;\n\t\t\t$.each(cancers, function(cancer, diagnosis_age) {\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\t\tif(attr[idx] !== \"0\") {\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t});\n\n\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2, .... genetic tests\n\t\t\t// genetic test type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t// genetic test result, 0 = untested, P = positive, N = negative\n\t\t\tfor(let j=0; j<gt.length; j++) {\n\t\t\t\tlet gene_test = attr[idx].split(\":\");\n\t\t\t\tif(gene_test[0] !== '0') {\n\t\t\t\t\tif((gene_test[0] === 'S' || gene_test[0] === 'T') && (gene_test[1] === 'P' || gene_test[1] === 'N' ||\n\t\t\t\t\t    gene_test[1] === 'HOM' || gene_test[1] === 'HET'))\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + gene_test[0] + \" \" + gene_test[1]);\n\t\t\t\t} else {\n\t\t\t\t\tif(gene_test[1] === 'P' || gene_test[1] === 'N')\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t}\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tlet path_test = attr[idx].split(\":\");\n\t\t\tfor(let j=0; j<path_test.length; j++) {\n\t\t\t\tif(path_test[j] !== '0') {\n\t\t\t\t\tif(path_test[j] === 'N' || path_test[j] === 'P')\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = path_test[j];\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +path_test[j]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tped.push(indi);\n\t\t}\n\t}\n\n\t// group mztwins\n\tped.sort(function(a, b) {\n\t\treturn a.mztwin !== undefined ? a.mztwin.localeCompare(b.mztwin) : 0;\n\t});\n\n\treturn [hdr, ped];\n}\n\n/**\n * Get the mammographic density formatted CanRisk data file line\n */\nexport function get_mdensity(mdensity) {\n\tconst regexp = /^(birads|Volpara|Stratus)=/i;\n\tif(regexp.test(mdensity))\n\t\treturn \"\\n##\"+mdensity;\n\t\t\n\tconst birads = /^(1|2|3|4|a|b|c|d)$/i\n\tif(birads.test(mdensity))\n\t\treturn \"\\n##birads=\"+mdensity;\n\n\tconsole.error(\"Unrecognised mammographic density format :: \" + mdensity);\n\treturn \"\"\n}\n\n/**\n * Get CanRisk formated pedigree.\n */\nexport function get_pedigree(dataset, famid, meta, isanon, version=3, ethnicity=undefined) {\n\tlet v = (Number.isInteger(version) ? version+\".0\" : version.toString());\n\tlet msg = \"##CanRisk \" + v;\n\tif(!famid) {\n\t\tfamid = \"XXXX\";\n\t}\n\tif(meta) {\n\t\tmsg += meta;\n\t}\n\tif(typeof isanon === 'undefined') {\n\t\tisanon = true;\n\t}\n\t// array of individuals excluded from the calculation\n\tlet excl = $.map(dataset, function(p, _i){return 'exclude' in p && p.exclude ? p.name : null;});\n\n\t// female risk factors\n\tlet probandIdx  = pedigree_util.getProbandIndex(dataset);\n\tlet sex = 'F';\n\tif(probandIdx) {\n\t\tsex = dataset[probandIdx].sex;\n\t}\n\n\tif(sex !== 'M') {\n\t\tlet menarche    = get_risk_factor('menarche_age');\n\t\tlet parity      = get_risk_factor('parity');\n\t\tlet first_birth = get_risk_factor('age_of_first_live_birth');\n\t\tlet oc_use      = get_risk_factor('oral_contraception');\n\t\tlet mht_use     = get_risk_factor('mht');\n\t\tlet bmi         = get_risk_factor('bmi');\n\t\tlet alcohol     = get_risk_factor('alcohol_intake');\n\t\tlet menopause   = get_risk_factor('age_of_menopause');\n\t\tlet mdensity    = get_risk_factor('mammographic_density');\n\t\tlet hgt         = get_risk_factor('height');\n\t\tlet tl          = get_risk_factor('Age_Tubal_ligation');\n\t\tlet endo        = get_risk_factor('endometriosis');\n\n\t\tif(menarche !== undefined)\n\t\t\tmsg += \"\\n##menarche=\"+menarche;\n\t\tif(parity !== undefined)\n\t\t\tmsg += \"\\n##parity=\"+parity;\n\t\tif(first_birth !== undefined)\n\t\t\tmsg += \"\\n##first_live_birth=\"+first_birth;\n\t\tif(oc_use !== undefined)\n\t\t\tmsg += \"\\n##oc_use=\"+oc_use;\n\t\tif(mht_use !== undefined)\n\t\t\tmsg += \"\\n##mht_use=\"+mht_use;\n\t\tif(bmi !== undefined)\n\t\t\tmsg += \"\\n##BMI=\"+bmi;\n\t\tif(alcohol !== undefined)\n\t\t\tmsg += \"\\n##alcohol=\"+alcohol;\n\t\tif(menopause !== undefined)\n\t\t\tmsg += \"\\n##menopause=\"+menopause;\n\t\tif(mdensity !== undefined)\n\t\t\tmsg += get_mdensity(mdensity);\n\t\tif(hgt !== undefined)\n\t\t\tmsg += \"\\n##height=\"+hgt;\n\t\tif(tl !== undefined)\n\t\t\tif(tl !== \"n\" && tl !== \"N\")\n\t\t\t\tmsg += \"\\n##TL=Y\";\n\t\t\telse\n\t\t\t\tmsg += \"\\n##TL=N\";\n\n\t\tif(endo !== undefined)\n\t\t\tmsg += \"\\n##endo=\"+endo;\n\t}\n\t\n\tif(version > 2 && ethnicity !== undefined) {\n\t\tmsg += \"\\n##ethnicity=\"+ethnicity;\n\t}\n\tmsg += \"\\n##FamID\\tName\\tTarget\\tIndivID\\tFathID\\tMothID\\tSex\\tMZtwin\\tDead\\tAge\\tYob\\tBC1\\tBC2\\tOC\\tPRO\\tPAN\\tAshkn\"\n\n\tlet gt = getGeneticTest(version);\n\tfor(let i=0; i<gt.length; i++) {\n\t\tmsg += \"\\t\"+gt[i].toUpperCase();\n\t}\n\tmsg += \"\\tER:PR:HER2:CK14:CK56\";\n\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet p = dataset[i];\n\t\tif($.inArray(p.name, excl) !== -1) {\n\t\t\tconsole.log('EXCLUDE: '+p.name);\n\t\t\tcontinue;\n\t\t}\n\n\t\tmsg += '\\n'+famid+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t// max 13 chars\n\t\tif(isanon)\n\t\t\tmsg += i+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// display_name (ANONIMISE) max 8 chars\n\t\telse\n\t\t\tmsg += (p.display_name ? p.display_name : \"NA\")+'\\t';\n\t\tmsg += ('proband' in p ? '1' : 0)+'\\t';\n\t\tmsg += p.name+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// max 7 chars\n\t\tmsg += ('father' in p && !('noparents' in p) && ($.inArray(p.mother, excl) === -1)? p.father : 0)+'\\t';\t// max 7 chars\n\t\tmsg += ('mother' in p && !('noparents' in p) && ($.inArray(p.mother, excl) === -1)? p.mother : 0)+'\\t';\t// max 7 chars\n\t\tmsg += p.sex+'\\t';\n\t\tmsg += ('mztwin' in p ? p.mztwin : 0)+'\\t'; \t\t\t\t\t\t// MZtwin\n\t\tmsg += ('status' in p ? p.status : 0)+'\\t';\t\t\t\t\t\t\t// current status: 0 = alive, 1 = dead\n\t\tmsg += ('age' in p ? p.age : 0)+'\\t';\t\t\t\t\t\t\t\t// Age at last follow up or 0 = unspecified\n\t\tmsg += ('yob' in p ? p.yob : 0)+'\\t';\t\t\t\t\t\t\t\t// YOB or 0 = unspecified\n\n\t\tlet cmsg = \"\";\n\t\t$.each(cancers, function(cancer, diagnosis_age) {\n\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\tif(diagnosis_age in p)\n\t\t\t\tcmsg += (diagnosis_age in p ? p[diagnosis_age] : 'AU')+'\\t';\n\t\t\telse\n\t\t\t\tcmsg += '0\\t';\n\t\t});\n\t\tmsg+=cmsg;\n\n\t\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\t\tmsg += ('ashkenazi' in p ? p.ashkenazi : 0)+'\\t';\n\n\t\tfor(let j=0; j<gt.length; j++) {\n\t\t\tif(gt[j]+'_gene_test' in p &&\n\t\t\t   p[gt[j]+'_gene_test']['type'] !== '-' &&\n\t\t\t   p[gt[j]+'_gene_test']['result'] !== '-') {\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['type'] + ':';\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['result'] + '\\t';\n\t\t\t} else {\n\t\t\t\tmsg += '0:0\\t';\t\t// type, 0=untested, S=mutation search, T=direct gene test\n\t\t\t\t\t\t\t\t\t// result, 0=untested, P=positive, N=negative\n\t\t\t}\n\t\t}\n\n\t\tfor(let j=0; j<pathology_tests.length; j++) {\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tif(pathology_tests[j]+'_bc_pathology' in p) {\n\t\t\t\tmsg += p[pathology_tests[j]+'_bc_pathology'];\n\t\t\t\tconsole.log('pathology '+p[pathology_tests[j]+'_bc_pathology']+' for '+p.display_name);\n\t\t\t} else {\n\t\t\t\tmsg += '0';\n\t\t\t}\n\t\t\tif(j<(pathology_tests.length-1))\n\t\t\t\tmsg += \":\";\n\t\t}\n\t}\n\tconsole.log(msg, RISK_FACTOR_STORE);\n\treturn msg;\n}\n\nexport function show_risk_factor_store() {\n\tconsole.log(\"RISK_FACTOR_STORE::\");\n\t$.each(RISK_FACTOR_STORE, function(name, val){\n\t\tconsole.log(name + \" : \" + val);\n\t});\n}\n\nexport function save_risk_factor(risk_factor_name, val) {\n\tRISK_FACTOR_STORE[store_name(risk_factor_name)] = val;\n}\n\nexport function get_risk_factor(risk_factor_name) {\n\tlet key = store_name(risk_factor_name);\n\tif(key in RISK_FACTOR_STORE) {\n\t\treturn RISK_FACTOR_STORE[key];\n\t}\n\treturn undefined;\n}\n\n// remove risk factor from storage\nexport function remove_risk_factor(risk_factor_name) {\n\tdelete RISK_FACTOR_STORE[store_name(risk_factor_name)];\n}\n\n// prefix risk factor name with the app/page name\nexport function store_name(risk_factor_name) {\n\treturn window.location.pathname.split('/').filter(function(el){ return !!el; }).pop() +\n\t       '::' + risk_factor_name;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// pedigree I/O\nimport * as utils from './utils.js';\nimport * as pedcache from './pedcache.js';\nimport {readCanRisk, cancers, genetic_test1, pathology_tests} from './canrisk_file.js';\nimport {get_bounds} from './zoom.js';\n\n\nexport function addIO(opts) {\n\t$('#load').on('change', function(e) {\n\t\tload(e, opts);\n\t});\n\n\t$('#save').on('click', function() {\n\t\tsave(opts);\n\t});\n\n\t$('#print').on('click', function() {\n\t\tprint(get_printable_svg(opts));\n\t});\n\n\t$('#svg_download').on('click', function() {\n\t\tsvg_download(get_printable_svg(opts));\n\t});\n\n\t$('#png_download, .fa-file-image').on('click', function() {\n\t\tlet resolution = 4;\n\t\timg_download(opts, resolution, \"image/png\");\n\t});\n}\n\n/**\n * Get object from array by the name attribute.\n */\nfunction getByName(arr, name) {\n\treturn $.grep(arr, function(o){ return o && o.name === name; })[0];\n}\n\n/**\n * Provide font style to svg\n */\nfunction copyStylesInline(destinationNode, sourceNode) {\n\tlet containerElements = [\"svg\",\"g\"];\n\tlet destChildNodes = destinationNode.childNodes;\n\tlet srcChildNodes = sourceNode.childNodes;\n\tfor (let cd = 0; cd < destChildNodes.length; cd++) {\n\t\tlet child = destChildNodes[cd];\n\t\tif (containerElements.indexOf(child.tagName) !== -1) {\n\t\t\tcopyStylesInline(child, srcChildNodes[cd]);\n\t\t\tcontinue;\n\t\t}\n\t\ttry {\n\t\t\tlet style = srcChildNodes[cd].currentStyle || window.getComputedStyle(srcChildNodes[cd]);\n\t\t\tif (style === \"undefined\" || style === null) continue;\n\n\t\t\tlet styleLength = style.length;\n\t\t\tlet childStyle = child.style;\n\t\t\tfor (let st = 0; st < styleLength; st++){\n\t\t\t\tlet mySt = style[st];\n\t\t\t\tif(mySt.indexOf(\"text-\") > -1 || mySt.indexOf(\"font-\") > -1) childStyle.setProperty(mySt, style.getPropertyValue(mySt));\n\t\t\t}\n\t\t} catch(err) { continue; }\n   }\n}\n\n/**\n * Export pedigree as image, e.g. PNG\n */\nexport function img_download(opts, resolution, img_type) {\n\tlet deferred = svg2img($('#'+opts.targetDiv).find('svg'), \"pedigree\", {resolution: resolution, img_type: img_type});\n\t$.when.apply($,[deferred]).done(function() {\n\t\tlet obj = getByName(arguments, \"pedigree\");\n\t\tif(utils.isEdge() || utils.isIE()) {\n\t\t\tlet html=\"<img src='\"+obj.img+\"' alt='canvas image'/>\";\n\t\t\tlet newTab = window.open();\t\t// pop-ups need to be enabled\n\t\t\tnewTab.document.write(html);\n\t\t} else {\n\t\t\tlet a\t  = document.createElement('a');\n\t\t\ta.href\t = obj.img;\n\t\t\ta.download = 'plot.png';\n\t\t\ta.target   = '_blank';\n\t\t\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\n\t\t}\n\t});\n}\n\n/** Get SVG data URL from svg element */\nfunction get_svg_as_data_url(svg) {\n\tlet svgCopy = svg.get(0).cloneNode(true);\n\t// remove unused elements\n\td3.select(svgCopy).selectAll(\"text\").filter(function(){\n\t\t return d3.select(this).text().length === 0 || \n\t\t        d3.select(this), d3.select(this).attr('font-family') === \"FontAwesome\"\n\t }).remove();\n\tcopyStylesInline(svgCopy, svg.get(0));\n\tlet svgStr = (new XMLSerializer()).serializeToString(svgCopy);\n\treturn 'data:image/svg+xml;base64,'+ window.btoa(unescape(encodeURIComponent(svgStr))); // convert SVG string to data URL\n}\n/**\n * Given a SVG document element convert to image (e.g. jpeg, png - default png).\n */\nexport function svg2img(svg, deferred_name, options) {\n\tlet defaults = {iscanvg: false, resolution: 1, img_type: \"image/png\"};\n\tif(!options) options = defaults;\n\t$.each(defaults, function(key, value) {\n\t\tif(!(key in options)) {options[key] = value;}\n\t});\n\n\tlet deferred = $.Deferred();\n\tlet imgsrc = get_svg_as_data_url(svg); // convert SVG string to data URL\n\tlet canvas = document.createElement(\"canvas\");\n\tcanvas.width = svg.width()*options.resolution;\n\tcanvas.height = svg.height()*options.resolution;\n\tlet context = canvas.getContext(\"2d\");\n\t// provide a white background\n\tcontext.fillStyle = \"white\";\n\tcontext.fillRect(0, 0, canvas.width, canvas.height);\n\t\n\tlet img = document.createElement(\"img\");\n\timg.onload = function() {\n\t\tcontext.drawImage(img, 0, 0, canvas.width, canvas.height);\n\t\t// console.log(deferred_name, options.img_type);\n\t\tdeferred.resolve(\n\t\t\t{'name': deferred_name,\n\t\t\t'resolution': options.resolution,\n\t\t\t'img':canvas.toDataURL(options.img_type, 1),\n\t\t\t'w':canvas.width,\n\t\t\t'h':canvas.height});\n\t\tcontext.clearRect(0, 0, canvas.width, canvas.height);\n\t};\n\timg.src = imgsrc;\n\treturn deferred.promise();\n}\n\nfunction getMatches(str, myRegexp) {\n\tlet matches = [];\n\tlet c = 0;\n\tmyRegexp.lastIndex = 0;\n\tlet match = myRegexp.exec(str);\n\twhile (match) {\n\t\tc++;\n\t\tif(c > 400) {\n\t\t\tconsole.error(\"getMatches: counter exceeded 400\");\n\t\t\treturn -1;\n\t\t}\n\t\tmatches.push(match);\n\t\tif (myRegexp.lastIndex === match.index) {\n\t\t\tmyRegexp.lastIndex++;\n\t\t}\n\t\tmatch = myRegexp.exec(str);\n\t}\n\treturn matches;\n}\n\n// find all url's to make unique\nfunction unique_urls(svg_html) {\n\tlet matches = getMatches(svg_html, /url\\((&quot;|\"|'){0,1}#(.*?)(&quot;|\"|'){0,1}\\)/g);\n\tif(matches === -1)\n\t\treturn \"ERROR DISPLAYING PEDIGREE\"\n\n\t$.each(matches, function(_index, match) {\n\t\tlet quote = (match[1] ? match[1] : \"\");\n\t\tlet val = match[2];\n\t\tlet m1 = \"id=\\\"\" + val + \"\\\"\";\n\t\tlet m2 = \"url\\\\(\" + quote + \"#\" + val + quote + \"\\\\)\";\n\n\t\tlet newval = val+utils.makeid(2);\n\t\tsvg_html = svg_html.replace(new RegExp(m1, 'g'), \"id=\\\"\"+newval+\"\\\"\" );\n\t\tsvg_html = svg_html.replace(new RegExp(m2, 'g'), \"url(#\"+newval+\")\" );\n   });\n\treturn svg_html;\n}\n\n// return a copy pedigree svg\nexport function copy_svg(opts) {\n\tlet svg_node = get_printable_svg(opts);\n\tlet d3obj = d3.select(svg_node.get(0));\n\n\t// remove unused elements\n\td3obj.selectAll(\"text\")\n\t  .filter(function(){\n\t\treturn d3.select(this).text().length === 0 || d3.select(this), d3.select(this).attr('font-family') === \"FontAwesome\"\n\t}).remove();\n\t// remove inline styles\n\td3obj.selectAll('[style]').attr(\"style\", null);\n\treturn $(unique_urls(svg_node.html()));\n}\n\n// get printable svg div, adjust size to tree dimensions and scale to fit\nfunction get_printable_svg(opts) {\n\tlet local_dataset = pedcache.current(opts); // get current dataset\n\tif (local_dataset !== undefined && local_dataset !== null) {\n\t\topts.dataset = local_dataset;\n\t}\n\n\tlet svg_div = $('<div></div>');  \t\t\t\t// create a new div\n\tlet svg = $('#'+opts.targetDiv).find('svg').clone().appendTo(svg_div);\n\n\tlet a4 = {w: (595-40), h: (842-50)};\n\t\n\tlet b = get_bounds(opts);\n\tlet d = {w: Math.abs(b.xmax-b.xmin), h: Math.abs(b.ymax-b.ymin)};\n\tlet f = 1;\n\tlet k = (f / Math.max(d.w/a4.w, d.h/a4.h));\n\n\tlet xi = -(b.xmin-(opts.symbol_size))*k;\n\tlet yi = -(b.ymin-(opts.symbol_size))*k;\n\n\tsvg.attr('width', a4.w);\n\tsvg.attr('height', d.h*k);\t\n\n\tsvg.find(\".diagram\").attr(\"transform\", \"translate(\"+xi+\", \"+yi+\") scale(\"+k+\")\");\n\treturn svg_div;\n}\n\n// download the SVG to a file\nexport function svg_download(svg){\n\tlet a\t   = document.createElement('a');\n\ta.href\t   = get_svg_as_data_url(svg);\n\ta.download = 'plot.svg';\n\ta.target   = '_blank';\n\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\n}\n\n// open print window for a given element\nexport function print(el, id){\n\tif(el.constructor !== Array)\n\t\tel = [el];\n\n\tlet width = $(window).width()*0.9;\n\tlet height = $(window).height()-10;\n\tlet cssFiles = [\n\t\t'/static/css/canrisk.css',\n\t\t'https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css'\n\t];\n\tlet printWindow = window.open('', 'PrintMap', 'width=' + width + ',height=' + height);\n\tlet headContent = '';\n\tfor(let i=0; i<cssFiles.length; i++)\n\t\theadContent += '<link href=\"'+cssFiles[i]+'\" rel=\"stylesheet\" type=\"text/css\" media=\"all\">';\n\theadContent += \"<style>body {font-size: \" + $(\"body\").css('font-size') + \";}</style>\";\n\n\tlet html = \"\";\n\tfor(let i=0; i<el.length; i++) {\n\t\tif(i === 0 && id)\n\t\t\thtml += id;\n\t\thtml += $(el[i]).html();\n\t\tif(i < el.length-1)\n\t\t\thtml += '<div class=\"page-break\"> </div>';\n\t}\n\n\tprintWindow.document.write(headContent);\n\tprintWindow.document.write(html);\n\tprintWindow.document.close();\n\n\tprintWindow.focus();\n\tsetTimeout(function() {\n\t\tprintWindow.print();\n\t\tprintWindow.close();\n\t}, 300);\n}\n\n// save content to a file\nexport function save_file(opts, content, filename, type){\n\tif(opts.DEBUG)\n\t\tconsole.log(content);\n\tif(!filename) filename = \"ped.txt\";\n\tif(!type) type = \"text/plain\";\n\n   let file = new Blob([content], {type: type});\n   if (window.navigator.msSaveOrOpenBlob) \t// IE10+\n\t   window.navigator.msSaveOrOpenBlob(file, filename);\n   else { \t\t\t\t\t\t\t\t\t// other browsers\n\t   let a = document.createElement(\"a\");\n\t   let url = URL.createObjectURL(file);\n\t   a.href = url;\n\t   a.download = filename;\n\t   document.body.appendChild(a);\n\t   a.click();\n\t   setTimeout(function() {\n\t\t   document.body.removeChild(a);\n\t\t   window.URL.revokeObjectURL(url);\n\t\t}, 0);\n\t}\n}\n\nfunction save(opts){\n\tlet content = JSON.stringify(pedcache.current(opts));\n\tsave_file(opts, content);\n}\n\nfunction canrisk_validation(opts) {\n\t$.each(opts.dataset, function(_idx, p) {\n\t\tif(!p.hidden && p.sex === 'M' && !utils.isProband(p)) {\n\t\t\tif(p[cancers['breast_cancer2']]) {\n\t\t\t\tlet msg = 'Male family member ('+p.display_name+') with contralateral breast cancer found. '+\n\t\t\t\t\t\t  'Please note that as the risk models do not take this into account the second '+\n\t\t\t\t\t\t  'breast cancer is ignored.'\n\t\t\t\tconsole.error(msg);\n\t\t\t\tdelete p[cancers['breast_cancer2']];\n\t\t\t\tutils.messages(\"Warning\", msg);\n\t\t\t}\n\t\t}\n\t});\n}\n\n/** Read and load pedigree data string */\nexport function load_data(d, opts) {\n\tif(opts.DEBUG) console.log(d);\n\tlet risk_factors;\n\ttry {\n\t\tif(d.indexOf(\"BOADICEA import pedigree file format 4.0\") === 0) {\n\t\t\topts.dataset = readBoadiceaV4(d, 4);\n\t\t\tcanrisk_validation(opts);\n\t\t} else if(d.indexOf(\"BOADICEA import pedigree file format 2.0\") === 0) {\n\t\t\topts.dataset = readBoadiceaV4(d, 2);\n\t\t\tcanrisk_validation(opts);\n\t\t} else if(d.indexOf(\"##\") === 0 && d.indexOf(\"CanRisk\") !== -1) {\n\t\t\tlet canrisk_data = readCanRiskFile(d);\n\t\t\trisk_factors = canrisk_data[0];\n\t\t\topts.dataset = canrisk_data[1];\n\t\t\tcanrisk_validation(opts);\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tlet ped = JSON.parse(d);\n\t\t\t\tlet to_process = true;\n\t\t\t\tfor(let i=0;i<ped.length;i++) {\n\t\t\t\t\tif(ped[i].top_level) {\n\t\t\t\t\t\tto_process = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\topts.dataset = (to_process ? process_ped(ped) : ped);\n\t\t\t} catch(err) {\n\t\t\t\topts.dataset = readLinkage(d);\n\t\t\t}\n\t\t}\n\t\tutils.validate_pedigree(opts);\n\t} catch(err1) {\n\t\tconsole.error(err1, d);\n\t\tutils.messages(\"File Error\", ( err1.message ? err1.message : err1));\n\t\treturn;\n\t}\n\tif(opts.DEBUG) console.log(opts.dataset);\n\ttry{\n\t\tpedcache.setposition(opts);\t\t// clear position\n\t\t$(document).trigger('rebuild', [opts]);\n\t\tconsole.log(risk_factors);\n\t\t// load risk factors - fire riskfactorChange event\n\t\t$(document).trigger('riskfactorChange', [opts, risk_factors]);\n\t\t$(document).trigger('fhChange', [opts]); \t// trigger fhChange event\n\t\n\t\ttry {\n\t\t\t// update FH section\n\t\t\tacc_FamHist_ticked();\t\t\t\t// eslint-disable-line no-undef\n\t\t\tacc_FamHist_Leave();\t\t\t\t// eslint-disable-line no-undef\n\t\t\tRESULT.FLAG_FAMILY_MODAL = true;\t// eslint-disable-line no-undef\n\t\t} catch(err3) {\n\t\t\t// ignore error\n\t\t}\n\t} catch(err2) {\n\t\tutils.messages(\"File Error\", ( err2.message ? err2.message : err2));\n\t}\n}\n\nfunction load(e, opts) {\n\tlet f = e.target.files[0];\n\tif(f) {\n\t\tlet reader = new FileReader();\n\t\treader.onload = function(e) {\n\t\t\tload_data(e.target.result, opts);\n\t\t};\n\t\treader.onerror = function() {\n\t\t\tutils.messages(\"File Error\", \"File could not be read! Code \" + reader.error);\n\t\t};\n\t\treader.readAsText(f);\n\t} else {\n\t\tconsole.error(\"File could not be read!\");\n\t}\n\t$(\"#load\")[0].value = ''; // reset value\n}\n\n//\n// https://www.cog-genomics.org/plink/1.9/formats#ped\n// https://www.cog-genomics.org/plink/1.9/formats#fam\n//\t1. Family ID ('FID')\n//\t2. Within-family ID ('IID'; cannot be '0')\n//\t3. Within-family ID of father ('0' if father isn't in dataset)\n//\t4. Within-family ID of mother ('0' if mother isn't in dataset)\n//\t5. Sex code ('1' = male, '2' = female, '0' = unknown)\n//\t6. Phenotype value ('1' = control, '2' = case, '-9'/'0'/non-numeric = missing data if case/control)\n//  7. Genotypes (column 7 onwards);\n//\t columns 7 & 8 are allele calls for first variant ('0' = no call); colummns 9 & 10 are calls for second variant etc.\nexport function readLinkage(boadicea_lines) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\tlet famid;\n\tfor(let i = 0;i < lines.length;i++){\n\t   let attr = $.map(lines[i].trim().split(/\\s+/), function(val, _i){return val.trim();});\n\t   if(attr.length < 5)\n\t\t   throw new Error('unknown format');\n\t   let sex = (attr[4] === '1' ? 'M' : (attr[4] === '2' ? 'F' : 'U'));\n\t   let indi = {\n\t\t\t'famid': attr[0],\n\t\t\t'display_name': attr[1],\n\t\t\t'name':\tattr[1],\n\t\t\t'sex': sex\n\t\t};\n\t\tif(attr[2] !== \"0\") indi.father = attr[2];\n\t\tif(attr[3] !== \"0\") indi.mother = attr[3];\n\n\t\tif (typeof famid != 'undefined' && famid !== indi.famid) {\n\t\t\tconsole.error('multiple family IDs found only using famid = '+famid);\n\t\t\tbreak;\n\t\t}\n\t\tif(attr[5] === \"2\") indi.affected = 2;\n\t\t// add genotype columns\n\t\tif(attr.length > 6) {\n\t\t\tindi.alleles = \"\";\n\t\t\tfor(let j=6; j<attr.length; j+=2) {\n\t\t\t\tindi.alleles += attr[j] + \"/\" + attr[j+1] + \";\";\n\t\t\t}\n\t\t}\n\n\t\tped.unshift(indi);\n\t\tfamid = attr[0];\n\t}\n\treturn process_ped(ped);\n}\n\nexport function readCanRiskFile(boadicea_lines) {\n\tlet [hdr, ped] = readCanRisk(boadicea_lines);\n\ttry {\n\t\treturn [hdr, process_ped(ped)];\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\treturn [hdr, ped];\n\t}\n}\n\n// read boadicea format v4 & v2\nexport function readBoadiceaV4(boadicea_lines, version) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\t// assumes two line header\n\tfor(let i = 2;i < lines.length;i++){\n\t   let attr = $.map(lines[i].trim().split(/\\s+/), function(val, _i){return val.trim();});\n\t\tif(attr.length > 1) {\n\t\t\tlet indi = {\n\t\t\t\t'famid': attr[0],\n\t\t\t\t'display_name': attr[1],\n\t\t\t\t'name':\tattr[3],\n\t\t\t\t'sex': attr[6],\n\t\t\t\t'status': attr[8]\n\t\t\t};\n\t\t\tif(attr[2] === \"1\") indi.proband = true;\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\n\n\t\t\tlet idx = 11;\n\t\t\t$.each(cancers, function(_cancer, diagnosis_age) {\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\t\tif(attr[idx] !== \"0\") {\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t});\n\n\t\t\tif(version === 4) {\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2 genetic tests\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t\t// result, 0 = untested, P = positive, N = negative\n\t\t\t\tfor(let j=0; j<5; j++) {\n\t\t\t\t\tidx+=2;\n\t\t\t\t\tif(attr[idx-2] !== '0') {\n\t\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T') && (attr[idx-1] === 'P' || attr[idx-1] === 'N'))\n\t\t\t\t\t\t\tindi[genetic_test1[j] + '_gene_test'] = {'type': attr[idx-2], 'result': attr[idx-1]};\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (version === 2) {\n\t\t\t\t// genetic test BRCA1, BRCA2\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t\t// result, 0 = untested, N = no mutation, 1 = BRCA1 positive, 2 = BRCA2 positive, 3 = BRCA1/2 positive\n\t\t\t\tidx+=2; \t// gtest\n\t\t\t\tif(attr[idx-2] !== '0') {\n\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T')) {\n\t\t\t\t\t\tif(attr[idx-1] === 'N') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t} else if(attr[idx-1] === '1') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t} else if(attr[idx-1] === '2') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t} else if(attr[idx-1] === '3') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t}\n\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tfor(let j=0; j<pathology_tests.length; j++) {\n\t\t\t\tif(attr[idx] !== '0') {\n\t\t\t\t\tif(attr[idx] === 'N' || attr[idx] === 'P')\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = attr[idx];\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +attr[idx]);\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t}\n\t\t\tped.unshift(indi);\n\t\t}\n\t}\n\n\ttry {\n\t\treturn process_ped(ped);\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\treturn ped;\n\t}\n}\n\nfunction process_ped(ped) {\n\t// find the level of individuals in the pedigree\n\tfor(let j=0;j<2;j++) {\n\t\tfor(let i=0;i<ped.length;i++) {\n\t\t\tgetLevel(ped, ped[i].name);\n\t\t}\n\t}\n\n\tfix_n_balance_levels(ped);\n\n\t// find the max level (i.e. top_level)\n\tlet max_level = 0;\n\tfor(let i=0;i<ped.length;i++) {\n\t\tif(ped[i].level && ped[i].level > max_level)\n\t\t\tmax_level = ped[i].level;\n\t}\n\n\t// identify top_level and other nodes without parents\n\tfor(let i=0;i<ped.length;i++) {\n\t\tif(utils.getDepth(ped, ped[i].name) === 1) {\n\t\t\tif(ped[i].level && ped[i].level === max_level) {\n\t\t\t\tped[i].top_level = true;\n\t\t\t} else {\n\t\t\t\tped[i].noparents = true;\n\n\t\t\t\t// 1. look for partners parents\n\t\t\t\tlet pidx = getPartnerIdx(ped, ped[i]);\n\t\t\t\tif(pidx > -1) {\n\t\t\t\t\tif(ped[pidx].mother) {\n\t\t\t\t\t\tped[i].mother = ped[pidx].mother;\n\t\t\t\t\t\tped[i].father = ped[pidx].father;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// 2. or adopt parents from level above\n\t\t\t\tif(!ped[i].mother){\n\t\t\t\t\tfor(let j=0; j<ped.length; j++) {\n\t\t\t\t\t\tif(ped[i].level === (ped[j].level-1)) {\n\t\t\t\t\t\t\tpidx = getPartnerIdx(ped, ped[j]);\n\t\t\t\t\t\t\tif(pidx > -1 && i !== pidx) {\n\t\t\t\t\t\t\t\tped[i].mother = (ped[j].sex === 'F' ? ped[j].name : ped[pidx].name);\n\t\t\t\t\t\t\t\tped[i].father = (ped[j].sex === 'M' ? ped[j].name : ped[pidx].name);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tdelete ped[i].top_level;\n\t\t}\n\t}\n\treturn ped;\n}\n\n// get the partners for a given node\nfunction getPartnerIdx(dataset, anode) {\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet bnode = dataset[i];\n\t\tif(anode.name === bnode.mother)\n\t\t\treturn utils.getIdxByName(dataset, bnode.father);\n\t\telse if(anode.name === bnode.father)\n\t\t\treturn utils.getIdxByName(dataset, bnode.mother);\n\t}\n\treturn -1;\n}\n\n// for a given individual assign levels to a parents ancestors\nfunction getLevel(dataset, name) {\n\tlet idx = utils.getIdxByName(dataset, name);\n\tlet level = (dataset[idx].level ? dataset[idx].level : 0);\n\tupdate_parents_level(idx, level, dataset);\n}\n\n// recursively update parents levels\nfunction update_parents_level(idx, level, dataset) {\n\tlet parents = ['mother', 'father'];\n\tlevel++;\n\tfor(let i=0; i<parents.length; i++) {\n\t\tlet pidx = utils.getIdxByName(dataset, dataset[idx][parents[i]]);\n\t\tif(pidx >= 0) {\n\t\t\tlet ma = dataset[utils.getIdxByName(dataset, dataset[idx].mother)];\n\t\t\tlet pa = dataset[utils.getIdxByName(dataset, dataset[idx].father)];\n\t\t\tif(!dataset[pidx].level || dataset[pidx].level < level) {\n\t\t\t\tma.level = level;\n\t\t\t\tpa.level = level;\n\t\t\t}\n\n\t\t\tif(ma.level < pa.level) {\n\t\t\t\tma.level = pa.level;\n\t\t\t} else if(pa.level < ma.level) {\n\t\t\t\tpa.level = ma.level;\n\t\t\t}\n\t\t\tupdate_parents_level(pidx, level, dataset);\n\t\t}\n\t}\n}\n\n// for a pedigree fix the levels of children nodes to be consistent with parent\nfunction fix_n_balance_levels(ped) {\n\tlet updated = false;\n\tlet l = ped.length;\n\n\tfor(let i=0;i<l;i++) {\n\t\tlet children = utils.getChildren(ped, ped[i]);\n\t\tlet prt_lvl = ped[i].level;\n\t\tfor(let j=0;j<children.length;j++){\n\t\t\tif(prt_lvl - children[j].level > 1) {\n\t\t\t\tchildren[j].level = prt_lvl-1;\n\t\t\t\tlet ptrs = utils.get_partners(ped, children[j]);\n\n\t\t\t\tfor(let k=0;k<ptrs.length;k++){\n\t\t\t\t\tlet p = utils.getNodeByName(ped, ptrs[k])\n\t\t\t\t\tp.level = prt_lvl-1;\n\n\t\t\t\t\tlet m = utils.getNodeByName(ped, p.mother);\n\t\t\t\t\tlet f = utils.getNodeByName(ped, p.father);\n\t\t\t\t\tif(m) m.level = prt_lvl;\n\t\t\t\t\tif(f) f.level = prt_lvl;\n\t\t\t\t}\n\t\t\t\tupdated = true;\n\t\t\t}\n\t\t}\n\t}\n\treturn updated;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n/**\n * Mark two siblings as twins (monozygotic or dizygotic)\n * Assigns matching twin IDs and synchronizes age/yob between twins\n * @param {Array} dataset - Array of person objects\n * @param {Object} d1 - First twin person object\n * @param {Object} d2 - Second twin person object\n * @param {string} twin_type - Type of twin relationship: 'mztwin' or 'dztwin'\n * @returns {boolean} True if successful, false if no twin ID available (max 10 twin pairs)\n * @example\n * setMzTwin(dataset, person1, person2, 'mztwin');\n */\nexport function setMzTwin(dataset, d1, d2, twin_type) {\n\tif(!d1[twin_type]) {\n\t\td1[twin_type] = getUniqueTwinID(dataset, twin_type);\n\t\tif(!d1[twin_type])\n\t\t\treturn false;\n\t}\n\td2[twin_type] = d1[twin_type];\n\tif(d1.yob)\n\t\td2.yob = d1.yob;\n\tif(d1.age && (d1.status === \"0\" || !d1.status))\n\t\td2.age = d1.age;\n\treturn true;\n}\n\n/**\n * Get the next available unique twin ID\n * Twin IDs are: 1-9 and 'A', supporting up to 10 twin pairs per pedigree\n * @param {Array} dataset - Array of person objects\n * @param {string} twin_type - Type of twin: 'mztwin' or 'dztwin'\n * @returns {number|string|undefined} Next available twin ID (1-9 or 'A'), or undefined if all used\n */\nexport function getUniqueTwinID(dataset, twin_type) {\n\tlet mz = [1, 2, 3, 4, 5, 6, 7, 8, 9, \"A\"];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tif(dataset[i][twin_type]) {\n\t\t\tlet idx = mz.indexOf(dataset[i][twin_type]);\n\t\t\tif (idx > -1)\n\t\t\t\tmz.splice(idx, 1);\n\t\t}\n\t}\n\tif(mz.length > 0)\n\t\treturn mz[0];\n\treturn undefined;\n}\n\n/**\n * Synchronize attributes between twins after changes\n * For monozygotic twins: syncs sex, yob, and age (if alive)\n * For dizygotic twins: syncs yob and age (if alive) only\n * @param {Array} dataset - Array of person objects\n * @param {Object} d1 - The twin whose attributes should be copied to their twin(s)\n */\nexport function syncTwins(dataset, d1) {\n\tif(!d1.mztwin && !d1.dztwin)\n\t\treturn;\n\tlet twin_type = (d1.mztwin ? \"mztwin\" : \"dztwin\");\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet d2 = dataset[i];\n\t\tif(d2[twin_type] && d1[twin_type] === d2[twin_type] && d2.name !== d1.name) {\n\t\t\tif(twin_type === \"mztwin\")\n\t\t\t  d2.sex = d1.sex;\n\t\t\tif(d1.yob)\n\t\t\t\td2.yob = d1.yob;\n\t\t\tif(d1.age && (d1.status === 0 || !d1.status))\n\t\t\t\td2.age = d1.age;\n\t\t}\n\t}\n}\n\n/**\n * Validate twin relationships and remove orphaned twin markers\n * Removes twin IDs from individuals who don't have at least one twin partner\n * Supports multiplets (triplets, quadruplets, etc.)\n * @param {Array} dataset - Array of person objects to validate\n */\nexport function checkTwins(dataset) {\n\tlet twin_types = [\"mztwin\", \"dztwin\"];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tfor(let j=0; j<twin_types.length; j++) {\n\t\t\tlet twin_type = twin_types[j];\n\t\t\tif(dataset[i][twin_type]) {\n\t\t\t\tlet count = 0;\n\t\t\t\tfor(let j=0; j<dataset.length; j++) {\n\t\t\t\t\tif(dataset[j][twin_type] === dataset[i][twin_type])\n\t\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t\tif(count < 2)\n\t\t\t\t\tdelete dataset[i][twin_type];\n\t\t\t}\n\t\t}\n\t}\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// pedigree form\nimport {syncTwins} from './twins.js';\nimport * as utils from './utils.js';\nimport {current as pedcache_current} from './pedcache.js';\nimport {canChangeSex} from './validation.js';\n\n\n// handle family history change events (undo/redo/delete)\n$(document).on('fhChange', function(e, opts){\n\ttry {\n\t\tlet id = $('#id_name').val();  // get name from hidden field\n\t\tlet node = utils.getNodeByName(pedcache_current(opts), id)\n\t\tif(node === undefined)\n\t\t\t$('form > fieldset').prop(\"disabled\", true);\n\t\telse\n\t\t\t$('form > fieldset').prop('disabled', false);\n\t} catch(err) {\n\t\tconsole.warn(err);\n\t}\n})\n\n// Phase 3.2.1: Auto-enable pathology fields when breast cancer diagnosis age is entered\n$(document).on('change input', \"[id^='id_breast_cancer_diagnosis_age']\", function() {\n\tlet value = $(this).val();\n\tlet sexInput = $(\"input[name='sex']:checked\");\n\n\t// Only enable pathology for females with a diagnosis age\n\tif(value && value !== '' && sexInput.val() === 'F') {\n\t\t$(\"select[id$='_bc_pathology']\").prop(\"disabled\", false);\n\t}\n})\n\n// update status field and age label - 0 = alive, 1 = dead\nexport function updateStatus(status) {\n\t$('#age_yob_lock').removeClass('fa-lock fa-unlock-alt');\n\t(status === \"1\" ? $('#age_yob_lock').addClass('fa-unlock-alt') : $('#age_yob_lock').addClass('fa-lock'));\n\t$('#id_age_'+status).removeClass(\"hidden\");\n\t$('#id_age_'+(status === \"1\" ? '0' : '1')).addClass(\"hidden\");\n}\n\nexport function nodeclick(node) {\n\t$('form > fieldset').prop('disabled', false);\n\t// clear values\n\t$('#person_details').find(\"input[type=text], input[type=number]\").val(\"\");\n\t$('#person_details select').val('').prop('selected', true);\n\n\t// assign values to input fields in form\n\tif(node.sex === 'M' || node.sex === 'F')\n\t\t$('input[name=sex][value=\"'+node.sex+'\"]').prop('checked', true);\n\telse\n\t\t$('input[name=sex]').prop('checked', false);\n\tupdate_cancer_by_sex(node);\n\n\tif(!('status' in node))\n\t\tnode.status = 0;\n\t$('input[name=status][value=\"'+node.status+'\"]').prop('checked', true);\n\t// show lock symbol for age and yob synchronisation\n\tupdateStatus(node.status);\n\n\tif('proband' in node) {\n\t\t$('#id_proband').prop('checked', node.proband);\n\t\t$('#id_proband').prop(\"disabled\", true);\n\t} else {\n\t\t$('#id_proband').prop('checked', false);\n\t\t$('#id_proband').prop(\"disabled\", !('yob' in node))\n\t}\n\n\tif('exclude' in node) {\n\t\t$('#id_exclude').prop('checked', node.exclude);\n\t} else {\n\t\t$('#id_exclude').prop('checked', false);\n\t}\n\n/*\t\tif('ashkenazi' in node) {\n\t\t\t$('#id_ashkenazi').prop('checked', (node.proband == 1 ? true: false));\n\t\t} else {\n\t\t\t$('#id_ashkenazi').prop('checked', false);\n\t\t}*/\n\n\t// year of birth\n\tif('yob' in node) {\n\t\t$('#id_yob_0').val(node.yob);\n\t} else {\n\t\t$('#id_yob_0').val('-');\n\t}\n\n\t// clear pathology\n\t$('select[name$=\"_bc_pathology\"]').val('-');\n\t// clear gene tests\n\t$('select[name*=\"_gene_test\"]').val('-');\n\n\t// disable sex radio buttons if the person is already a parent (Phase 3.1.5)\n\t// Note: récupère le dataset depuis les utils.roots car opts n'est pas disponible dans nodeclick\n\tlet dataset = null;\n\ttry {\n\t\t// Essayer de récupérer le dataset depuis le premier pedigree chargé\n\t\tlet targetDivs = Object.keys(utils.roots || {});\n\t\tif(targetDivs.length > 0) {\n\t\t\tdataset = utils.roots[targetDivs[0]]._dataset;\n\t\t}\n\t} catch(e) {\n\t\t// Si erreur, autoriser le changement par défaut\n\t}\n\tlet sexCanChange = canChangeSex(node, dataset);\n\t$(\"input[id^='id_sex_']\").prop(\"disabled\", !sexCanChange);\n\n\t// disable pathology for male relatives (as not used by model)\n\t// and if no breast cancer age of diagnosis\n\t$(\"select[id$='_bc_pathology']\").prop(\"disabled\",\n\t\t\t(node.sex === 'M' || (node.sex === 'F' && !('breast_cancer_diagnosis_age' in node)) ? true : false));\n\n\t// approximate diagnosis age\n\t$('#id_approx').prop('checked', (node.approx_diagnosis_age ? true: false));\n\tupdate_diagnosis_age_widget();\n\n\tfor(let key in node) {\n\t\tif(key !== 'proband' && key !== 'sex') {\n\t\t\tif($('#id_'+key).length) {\t// input value\n\t\t\t\tif(key.indexOf('_gene_test')  !== -1 && node[key] !== null && typeof node[key] === 'object') {\n\t\t\t\t\t$('#id_'+key).val(node[key].type);\n\t\t\t\t\t$('#id_'+key+'_result').val(node[key].result);\n\t\t\t\t} else {\n\t\t\t\t\t$('#id_'+key).val(node[key]);\n\t\t\t\t}\n\t\t\t} else if(key.indexOf('_diagnosis_age') !== -1) {\n\t\t\t\tif($(\"#id_approx\").is(':checked')) {\n\t\t\t\t\t$('#id_'+key+'_1').val(round5(node[key])).prop('selected', true);\n\t\t\t\t} else {\n\t\t\t\t\t$('#id_'+key+'_0').val(node[key]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\ttry {\n\t\t$('#person_details').find('form').valid();\n\t} catch(err) {\n\t\tconsole.warn('valid() not found');\n\t}\n}\n\nfunction update_ashkn(newdataset) {\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\tif($('#orig_ashk').is(':checked')) {\n\t\t$.each(newdataset, function(_i, p) {\n\t\t\tif(p.proband)\n\t\t\t\tp.ashkenazi = 1;\n\t\t});\n\t} else {\n\t\t$.each(newdataset, function(_i, p) {\n\t\t\tdelete p.ashkenazi;\n\t\t});\n\t}\n}\n\n// Save Ashkenazi status\nexport function save_ashkn(opts) {\n\tlet dataset = pedcache_current(opts);\n\tlet newdataset = utils.copy_dataset(dataset);\n\tupdate_ashkn(newdataset);\n\topts.dataset = newdataset;\n\t$(document).trigger('rebuild', [opts]);\n}\n\nexport function save(opts) {\n\tlet dataset = pedcache_current(opts);\n\tlet name = $('#id_name').val();\n\tlet newdataset = utils.copy_dataset(dataset);\n\tlet person = utils.getNodeByName(newdataset, name);\n\tif(!person) {\n\t\tconsole.warn('person not found when saving details');\n\t\treturn;\n\t}\n\t$(\"#\"+opts.targetDiv).empty();\n\n\t// individual's personal and clinical details\n\tlet yob = $('#id_yob_0').val();\n\tif(yob && yob !== '') {\n\t\tperson.yob = yob;\n\t} else {\n\t\tdelete person.yob;\n\t}\n\n\t// current status: 0 = alive, 1 = dead\n\tlet status = $('#id_status').find(\"input[type='radio']:checked\");\n\tif(status.length > 0){\n\t\tperson.status = status.val();\n\t}\n\n\t// booleans switches\n\tlet switches = [\"miscarriage\", \"adopted_in\", \"adopted_out\", \"termination\", \"stillbirth\"];\n\tfor(let iswitch=0; iswitch<switches.length; iswitch++){\n\t\tlet attr = switches[iswitch];\n\t\tlet s = $('#id_'+attr);\n\t\tif(s.length > 0){\n\t\t\tconsole.log(s.is(\":checked\"));\n\t\t\tif(s.is(\":checked\"))\n\t\t\t\tperson[attr] = true;\n\t\t\telse\n\t\t\t\tdelete person[attr];\n\t\t}\n\t}\n\n\t// current sex\n\tlet sex = $('#id_sex').find(\"input[type='radio']:checked\");\n\tif(sex.length > 0){\n\t\tperson.sex = sex.val();\n\t\tupdate_cancer_by_sex(person);\n\t}\n\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\tupdate_ashkn(newdataset);\n\n\tif($('#id_approx').is(':checked')) // approximate diagnosis age\n\t\tperson.approx_diagnosis_age = true;\n\telse\n\t\tdelete person.approx_diagnosis_age;\n\n\t$(\"#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible\").each(function() {\n\t\tlet name = (this.name.indexOf(\"_diagnosis_age\")>-1 ? this.name.substring(0, this.name.length-2): this.name);\n\n\t\tif($(this).val()) {\n\t\t\tlet val = $(this).val();\n\t\t\tif(name.indexOf(\"_diagnosis_age\") > -1 && $(\"#id_approx\").is(':checked')) {\n\t\t\t\tval = round5(val);\n\t\t\t\t// check if approximate diagnosis age val is greater than age by 5 or less\n\t\t\t\tlet age = parseInt($(\"#id_age\").val());\n\t\t\t\tif(val > age && (val - age) <= 5) val = age;\n\t\t\t}\n\t\t\tperson[name] = val;\n\t\t} else {\n\t\t\tdelete person[name];\n\t\t}\n\t});\n\n\t// cancer checkboxes\n\t$('#person_details input[type=\"checkbox\"][name$=\"cancer\"],input[type=\"checkbox\"][name$=\"cancer2\"]').each(function() {\n\t\tif(this.checked)\n\t\t\tperson[$(this).attr('name')] = true;\n\t\telse\n\t\t\tdelete person[$(this).attr('name')];\n\t});\n\n\t// pathology tests\n\t$('#person_details select[name$=\"_bc_pathology\"]').each(function() {\n\t\tif($(this).val() !== '-') {\n\t\t\tperson[$(this).attr('name')] = $(this).val();\n\t\t} else {\n\t\t\tdelete person[$(this).attr('name')];\n\t\t}\n\t});\n\n\t// genetic tests\n\t$('#person_details select[name$=\"_gene_test\"]').each(function() {\n\t\tif($(this).val() !== '-') {\n\t\t\tlet tres = $('select[name=\"'+$(this).attr('name')+'_result\"]');\n\t\t\tperson[$(this).attr('name')] = {'type': $(this).val(), 'result': $(tres).val()};\n\t\t} else {\n\t\t\tdelete person[$(this).attr('name')];\n\t\t}\n\t});\n\n\t// record HOXB13 genetic test\n\tlet hoxb13_result = $('#person_details select[name=\"hoxb13_gene_test_result\"]').val();\n\tif(hoxb13_result !== undefined && hoxb13_result !== '-') {\n\t\tperson[\"hoxb13_gene_test\"] = {'type': 'T', 'result': hoxb13_result};\t// assume direct test\n\t} else {\n\t\tdelete person[\"hoxb13_gene_test\"];\n\t}\n\n\ttry {\n\t\t$('#person_details').find('form').valid();\n\t} catch(err) {\n\t\tconsole.warn('valid() not found');\n\t}\n\n\tsyncTwins(newdataset, person);\n\topts.dataset = newdataset;\n\t$(document).trigger('rebuild', [opts]);\n}\n\nexport function update_diagnosis_age_widget() {\n\tif($(\"#id_approx\").is(':checked')) {\n\t\t$(\"[id$='_diagnosis_age_0']\").each(function( _i ) {\n\t\t\tif($(this).val() !== '') {\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\n\t\t\t\t$(\"#id_\"+name+\"_1\").val(round5($(this).val())).prop('selected', true);\n\t\t\t}\n\t\t});\n\n\t\t$(\"[id$='_diagnosis_age_0']\").hide();\n\t\t$(\"[id$='_diagnosis_age_1']\").show();\n\t} else {\n\t\t$(\"[id$='_diagnosis_age_1']\").each(function( _i ) {\n\t\t\tif($(this).val() !== '') {\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\n\t\t\t\t$(\"#id_\"+name+\"_0\").val($(this).val());\n\t\t\t}\n\t\t});\n\n\t\t$(\"[id$='_diagnosis_age_0']\").show();\n\t\t$(\"[id$='_diagnosis_age_1']\").hide();\n\t}\n}\n\n// males should not have ovarian cancer and females should not have prostate cancer\nfunction update_cancer_by_sex(node) {\n\t$('#cancer .row').show();\n\tif(node.sex === 'M') {\n\t\tdelete node.ovarian_cancer_diagnosis_age;\n\t\t$(\"[id^='id_ovarian_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', true);\n\t} else if(node.sex === 'F') {\n\t\tdelete node.prostate_cancer_diagnosis_age;\n\t\t$(\"[id^='id_prostate_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', false);\n\t}\n}\n\n// round to 5, 15, 25, 35 ....\nfunction round5(x1) {\n\tlet x2 = (Math.round((x1-1) / 10) * 10);\n\treturn (x1 < x2 ? x2 - 5 : x2 + 5);\n}\n\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// Helpers for adding relatives (children, siblings, parents, partners)\nimport * as utils from './utils.js';\nimport {getUniqueTwinID, setMzTwin} from './twins.js';\n\nfunction determineParentRoles(personA, personB) {\n\tlet motherName, fatherName;\n\tif(personA.sex === 'F') motherName = personA.name;\n\tif(personA.sex === 'M') fatherName = personA.name;\n\tif(!motherName && personB.sex === 'F') motherName = personB.name;\n\tif(!fatherName && personB.sex === 'M') fatherName = personB.name;\n\tif(!motherName) motherName = personA.name;\n\tif(!fatherName) fatherName = personB.name === motherName ? personA.name : personB.name;\n\treturn {mother: motherName, father: fatherName};\n}\n\nfunction createPartnerPlaceholderChild(person, partner) {\n\tlet roles = determineParentRoles(person, partner);\n\treturn {\n\t\tname: utils.makeid(4),\n\t\tsex: 'U',\n\t\tmother: roles.mother,\n\t\tfather: roles.father\n\t};\n}\n\nfunction removePlaceholderChildren(dataset, motherName, fatherName) {\n\tfor(let i = dataset.length - 1; i >= 0; i--) {\n\t\tlet child = dataset[i];\n\t\tif(child.partner_placeholder &&\n\t\t   child.mother === motherName &&\n\t\t   child.father === fatherName) {\n\t\t\tdataset.splice(i, 1);\n\t\t}\n\t}\n}\n\nfunction getTreeNode(flat_tree, dataset, name) {\n\tif(!name)\n\t\treturn undefined;\n\tlet node = flat_tree && flat_tree.length ? utils.getNodeByName(flat_tree, name) : undefined;\n\tif(node)\n\t\treturn node;\n\tlet dataNode = utils.getNodeByName(dataset, name);\n\tif(!dataNode)\n\t\treturn undefined;\n\tif(dataNode.id === undefined)\n\t\tdataNode.id = utils.getIdxByName(dataset, name);\n\treturn {\n\t\tdata: dataNode,\n\t\tdepth: utils.getDepth(dataset, name)\n\t};\n}\n\nexport function addchild(dataset, node, sex, nchild, twin_type) {\n\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\n\n\tif (typeof nchild === typeof undefined)\n\t\tnchild = 1;\n\tlet children = utils.getAllChildren(dataset, node);\n\tlet ptr_name, idx;\n\tif (children.length === 0) {\n\t\tlet partner = addsibling(dataset, node, node.sex === 'F' ? 'M': 'F', node.sex === 'F');\n\t\tpartner.noparents = true;\n\t\tptr_name = partner.name;\n\t\tidx = utils.getIdxByName(dataset, node.name)+1;\n\t} else {\n\t\tlet c = children[0];\n\t\tptr_name = (c.father === node.name ? c.mother : c.father);\n\t\tidx = utils.getIdxByName(dataset, c.name);\n\t}\n\n\tlet twin_id;\n\tif(twin_type)\n\t\ttwin_id = getUniqueTwinID(dataset, twin_type);\n\tlet newchildren = [];\n\tfor (let i = 0; i < nchild; i++) {\n\t\tlet child = {\"name\": utils.makeid(4), \"sex\": sex,\n\t\t\t\t\t \"mother\": (node.sex === 'F' ? node.name : ptr_name),\n\t\t\t\t\t \"father\": (node.sex === 'F' ? ptr_name : node.name)};\n\t\tdataset.splice(idx, 0, child);\n\n\t\tif(twin_type)\n\t\t\tchild[twin_type] = twin_id;\n\t\tnewchildren.push(child);\n\t\tremovePlaceholderChildren(dataset, child.mother, child.father);\n\t}\n\treturn newchildren;\n}\n\nexport function addsibling(dataset, node, sex, add_lhs, twin_type, skip_parent_copy = false) {\n\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\n\n\tlet newbie = {\"name\": utils.makeid(4), \"sex\": sex};\n\tif(node.top_level) {\n\t\tnewbie.top_level = true;\n\t} else if (!skip_parent_copy) {\n\t\tnewbie.mother = node.mother;\n\t\tnewbie.father = node.father;\n\t}\n\tlet idx = utils.getIdxByName(dataset, node.name);\n\n\tif(twin_type) {\n\t\tsetMzTwin(dataset, dataset[idx], newbie, twin_type);\n\t}\n\n\tif(add_lhs) {\n\t\tif(idx > 0) idx--;\n\t} else\n\t\tidx++;\n\tdataset.splice(idx, 0, newbie);\n\treturn newbie;\n}\n\nexport function addparents(opts, dataset, name) {\n\tlet mother, father;\n\tlet root = utils.roots[opts.targetDiv];\n\tlet flat_tree = root ? utils.flatten(root) : [];\n\tlet tree_node = getTreeNode(flat_tree, dataset, name);\n\tif(!tree_node)\n\t\tthrow utils.create_err('Person '+name+' not found when adding parents');\n\tlet node  = tree_node.data;\n\tlet depth = tree_node.depth || utils.getDepth(dataset, node.name);\n\n\tlet pid = -101;\n\tlet ptr_name;\n\tlet children = utils.getAllChildren(dataset, node);\n\tif(children.length > 0){\n\t\tptr_name = children[0].mother === node.name ? children[0].father : children[0].mother;\n\t\tlet ptr_node_meta = getTreeNode(flat_tree, dataset, ptr_name);\n\t\tpid = ptr_node_meta && ptr_node_meta.data.id !== undefined ? ptr_node_meta.data.id : utils.getIdxByName(dataset, ptr_name);\n\t}\n\n\tlet i;\n\tif(depth === 1) {\n\t\tmother = {\"name\": utils.makeid(4), \"sex\": \"F\", \"top_level\": true};\n\t\tfather = {\"name\": utils.makeid(4), \"sex\": \"M\", \"top_level\": true};\n\t\tdataset.splice(0, 0, mother);\n\t\tdataset.splice(0, 0, father);\n\n\t\tfor(i=0; i<dataset.length; i++){\n\t\t\tif( (dataset[i].top_level || utils.getDepth(dataset, dataset[i].name) === 2) &&\n\t\t\t     dataset[i].name !== mother.name && dataset[i].name !== father.name){\n\t\t\t\tdelete dataset[i].top_level;\n\t\t\t\tdataset[i].noparents = true;\n\t\t\t\tdataset[i].mother = mother.name;\n\t\t\t\tdataset[i].father = father.name;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tlet motherName = typeof tree_node.data.mother === 'string' ? tree_node.data.mother : tree_node.data.mother;\n\t\tmotherName = motherName && motherName.name ? motherName.name : motherName;\n\t\tlet fatherName = typeof tree_node.data.father === 'string' ? tree_node.data.father : tree_node.data.father;\n\t\tfatherName = fatherName && fatherName.name ? fatherName.name : fatherName;\n\t\tlet node_mother = getTreeNode(flat_tree, dataset, motherName);\n\t\tlet node_father = getTreeNode(flat_tree, dataset, fatherName);\n\t\tlet node_sibs = utils.getAllSiblings(dataset, node);\n\n\t\tlet rid = 10000;\n\t\tlet lid = tree_node.data.id;\n\t\tfor(i=0; i<node_sibs.length; i++){\n\t\t\tlet sibNode = getTreeNode(flat_tree, dataset, node_sibs[i].name);\n\t\t\tlet sid = (sibNode && sibNode.data.id !== undefined) ? sibNode.data.id : utils.getIdxByName(dataset, node_sibs[i].name);\n\t\t\tif(sid < rid && sid > tree_node.data.id)\n\t\t\t\trid = sid;\n\t\t\tif(sid < lid)\n\t\t\t\tlid = sid;\n\t\t}\n\t\tlet add_lhs = (lid >= tree_node.data.id || (pid === lid && rid < 10000));\n\t\tif(opts.DEBUG)\n\t\t\tconsole.log('lid='+lid+' rid='+rid+' nid='+tree_node.data.id+' ADD_LHS='+add_lhs);\n\t\tlet midx;\n\t\tif( (!add_lhs && node_father.data.id > node_mother.data.id) ||\n\t\t\t(add_lhs && node_father.data.id < node_mother.data.id) )\n\t\t\tmidx = utils.getIdxByName(dataset, node.father);\n\t\telse\n\t\t\tmidx = utils.getIdxByName(dataset, node.mother);\n\n\t\tlet parent = dataset[midx];\n\t\tfather = addsibling(dataset, parent, 'M', add_lhs);\n\t\tmother = addsibling(dataset, parent, 'F', add_lhs);\n\n\t\tlet faidx = utils.getIdxByName(dataset, father.name);\n\t\tlet moidx = utils.getIdxByName(dataset, mother.name);\n\t\tif(faidx > moidx) {\n\t\t\tlet tmpfa = dataset[faidx];\n\t\t\tdataset[faidx] = dataset[moidx];\n\t\t\tdataset[moidx] = tmpfa;\n\t\t}\n\n\t\tlet orphans = utils.getAdoptedSiblings(dataset, node);\n\t\tlet nid = tree_node.data.id;\n\t\tfor(i=0; i<orphans.length; i++){\n\t\t\tlet orphan_meta = getTreeNode(flat_tree, dataset, orphans[i].name);\n\t\t\tlet oid = orphan_meta && orphan_meta.data.id !== undefined ? orphan_meta.data.id : utils.getIdxByName(dataset, orphans[i].name);\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log('ORPHAN='+i+' '+orphans[i].name+' '+(nid < oid && oid < rid)+' nid='+nid+' oid='+oid+' rid='+rid);\n\t\t\tif((add_lhs || nid < oid) && oid < rid){\n\t\t\t\tlet oidx = utils.getIdxByName(dataset, orphans[i].name);\n\t\t\t\tdataset[oidx].mother = mother.name;\n\t\t\t\tdataset[oidx].father = father.name;\n\t\t\t}\n\t\t}\n\t}\n\n\tif(depth === 2) {\n\t\tmother.top_level = true;\n\t\tfather.top_level = true;\n\t}\n\tlet idx = utils.getIdxByName(dataset, node.name);\n\tdataset[idx].mother = mother.name;\n\tdataset[idx].father = father.name;\n\tdelete dataset[idx].noparents;\n\n\tif('parent_node' in node) {\n\t\tlet ptr_node = dataset[utils.getIdxByName(dataset, ptr_name)];\n\t\tif('noparents' in ptr_node) {\n\t\t\tptr_node.mother = mother.name;\n\t\t\tptr_node.father = father.name;\n\t\t}\n\t}\n}\n\n/**\n * Add a partner to a person in the pedigree\n *\n * @param {Object} opts - Pedigree options\n * @param {Array} dataset - Pedigree dataset\n * @param {string} name - Name of person to add partner to\n * @param {Object} config - Optional configuration\n * @param {string} config.partner_sex - Sex of partner ('M', 'F', 'U'). Auto-detected if not provided.\n * @param {boolean} config.create_child - Whether to create a child (default: true for D3 layout)\n * @param {string} config.child_sex - Sex of child if created ('M', 'F', 'U'). Default: 'U'.\n * @returns {Object} Created partner object\n *\n * BUGFIXES (2025-11-19):\n * - FIX 1: Correct child index calculation (was incorrect for females)\n * - FIX 2: Allow child gender selection (was always 'M')\n * - FIX 3: Make child creation optional via config\n * - FIX 4: Add validation for opposite sex (warn if same sex)\n * - FIX 5: Unified positioning logic (females left, males right)\n */\nexport function addpartner(opts, dataset, name, config) {\n\t// Default configuration\n\tconfig = config || {};\n\tlet create_child = (config.create_child !== undefined) ? config.create_child : true;\n\tlet child_sex = config.child_sex || 'U';  // Unknown by default (was 'M')\n\n\tlet root = utils.roots[opts.targetDiv];\n\tlet flat_tree = root ? utils.flatten(root) : [];\n\tlet tree_node = getTreeNode(flat_tree, dataset, name);\n\tif(!tree_node)\n\t\tthrow utils.create_err('Person '+name+' not found when adding partner');\n\n\t// FIX 4: Determine partner sex with validation\n\tlet partner_sex;\n\tif(config.partner_sex) {\n\t\tpartner_sex = config.partner_sex;\n\t} else {\n\t\t// Auto-detect opposite sex\n\t\tif(tree_node.data.sex === 'M') {\n\t\t\tpartner_sex = 'F';\n\t\t} else if(tree_node.data.sex === 'F') {\n\t\t\tpartner_sex = 'M';\n\t\t} else {\n\t\t\t// If person is 'U', default to 'U' for partner (user should specify)\n\t\t\tpartner_sex = 'U';\n\t\t\tif(opts.DEBUG) {\n\t\t\t\tconsole.warn('Person has unknown sex (U), partner also set to U. Consider specifying partner_sex explicitly.');\n\t\t\t}\n\t\t}\n\t}\n\n\t// Validation: Warn if same sex (but allow it for modern families)\n\tif(partner_sex === tree_node.data.sex && tree_node.data.sex !== 'U') {\n\t\tif(opts.DEBUG) {\n\t\t\tconsole.warn('Partner has same sex as person (' + partner_sex + '). This is allowed but may indicate a data error.');\n\t\t}\n\t}\n\n\tlet partner = {\"name\": utils.makeid(4), \"sex\": partner_sex};\n\tlet motherExists = tree_node.data.mother && utils.getIdxByName(dataset, tree_node.data.mother) !== -1;\n\tlet fatherExists = tree_node.data.father && utils.getIdxByName(dataset, tree_node.data.father) !== -1;\n\tif(tree_node.data.top_level || (!tree_node.data.mother && !tree_node.data.father)) {\n\t\tpartner.top_level = true;\n\t} else {\n\t\t// Copy existing parents so the partner is rendered at the same depth,\n\t\t// while still hiding the visual parent links via the noparents flag.\n\t\tif(motherExists)\n\t\t\tpartner.mother = tree_node.data.mother;\n\t\tif(fatherExists)\n\t\t\tpartner.father = tree_node.data.father;\n\t\t// If parents are missing in the dataset, fall back to top_level to keep the partner visible\n\t\tif(!partner.mother && !partner.father)\n\t\t\tpartner.top_level = true;\n\t}\n\tpartner.noparents = true;\n\n\t// FIX 5: Unified positioning logic\n\t// Convention: Females (mothers) on left, Males (fathers) on right\n\tlet idx = utils.getIdxByName(dataset, tree_node.data.name);\n\n\tif(tree_node.data.sex === 'F') {\n\t\t// Person is female (mother): partner (male) goes to the right (after)\n\t\tidx++;\n\t} else if(tree_node.data.sex === 'M') {\n\t\t// Person is male (father): partner (female) goes to the left (before)\n\t\tif(idx > 0) idx--;\n\t} else {\n\t\t// Person is unknown: default to after\n\t\tidx++;\n\t}\n\n\tdataset.splice(idx, 0, partner);\n\n\t// FIX 2 & FIX 3: Optional child creation with configurable sex\n\tif(create_child) {\n\t\tlet child = createPartnerPlaceholderChild(tree_node.data, partner);\n\t\tchild.sex = child_sex;\n\n\t\t// FIX 1: Correct index calculation - after BOTH parents\n\t\tlet partner_idx = utils.getIdxByName(dataset, partner.name);\n\t\tlet person_idx = utils.getIdxByName(dataset, tree_node.data.name);\n\t\tlet child_idx = Math.max(partner_idx, person_idx) + 1;\n\t\tdataset.splice(child_idx, 0, child);\n\t}\n\n\treturn partner;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// Helpers for deleting nodes and descendants from the dataset\nimport * as utils from './utils.js';\nimport {checkTwins} from './twins.js';\n\nfunction purgePlaceholderChildren(dataset) {\n\tfor(let i = dataset.length - 1; i >= 0; i--) {\n\t\tlet node = dataset[i];\n\t\tif(node && node.partner_placeholder) {\n\t\t\tlet motherExists = !!utils.getNodeByName(dataset, node.mother);\n\t\t\tlet fatherExists = !!utils.getNodeByName(dataset, node.father);\n\t\t\tif(!motherExists || !fatherExists)\n\t\t\t\tdataset.splice(i, 1);\n\t\t}\n\t}\n}\n\nfunction adjacent_nodes(root, node, excludes) {\n\tlet dnodes = utils.getNodesAtDepth(utils.flatten(root), node.depth, excludes);\n\tlet lhs_node, rhs_node;\n\tfor(let i=0; i<dnodes.length; i++) {\n\t\tif(dnodes[i].x < node.x)\n\t\t\tlhs_node = dnodes[i];\n\t\tif(!rhs_node && dnodes[i].x > node.x)\n\t\t\trhs_node = dnodes[i];\n\t}\n\treturn [lhs_node, rhs_node];\n}\n\nexport function delete_node_dataset(dataset, node, opts, onDone) {\n\tlet root = utils.roots[opts.targetDiv];\n\tlet fnodes = utils.flatten(root);\n\tlet deletes = [];\n\tlet i, j;\n\n\tif(node.id === undefined) {\n\t\tlet d3node = utils.getNodeByName(fnodes, node.name);\n\t\tif(d3node !== undefined)\n\t\t\tnode = d3node.data;\n\t}\n\n\tif(node.parent_node) {\n\t\tfor(i=0; i<node.parent_node.length; i++){\n\t\t\tlet parent = node.parent_node[i];\n\t\t\tlet ps = [utils.getNodeByName(dataset, parent.mother.name),\n\t\t\t\t\t  utils.getNodeByName(dataset, parent.father.name)];\n\t\t\tfor(j=0; j<ps.length; j++) {\n\t\t\t\tif(ps[j].name === node.name || ps[j].noparents !== undefined || ps[j].top_level) {\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ps[j].name), 1);\n\t\t\t\t\tdeletes.push(ps[j]);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet children = parent.children;\n\t\t\tlet children_names = $.map(children, function(p, _i){return p.name;});\n\t\t\tfor(j=0; j<children.length; j++) {\n\t\t\t\tlet child = utils.getNodeByName(dataset, children[j].name);\n\t\t\t\tif(child){\n\t\t\t\t\tchild.noparents = true;\n\t\t\t\t\tlet ptrs = utils.get_partners(dataset, child);\n\t\t\t\t\tlet ptr;\n\t\t\t\t\tif(ptrs.length > 0)\n\t\t\t\t\t\tptr = utils.getNodeByName(dataset, ptrs[0]);\n\t\t\t\t\tif(ptr && ptr.mother !== child.mother) {\n\t\t\t\t\t\tchild.mother = ptr.mother;\n\t\t\t\t\t\tchild.father = ptr.father;\n\t\t\t\t\t} else if(ptr) {\n\t\t\t\t\t\tlet child_node  = utils.getNodeByName(fnodes, child.name);\n\t\t\t\t\t\tlet adj = adjacent_nodes(root, child_node, children_names);\n\t\t\t\t\t\tchild.mother = adj[0] ? adj[0].data.mother : (adj[1] ? adj[1].data.mother : null);\n\t\t\t\t\t\tchild.father = adj[0] ? adj[0].data.father : (adj[1] ? adj[1].data.father : null);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, child.name), 1);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\tlet idxToRemove = utils.getIdxByName(dataset, node.name);\n\t\tif(idxToRemove >= 0)\n\t\t\tdataset.splice(idxToRemove, 1);\n\t}\n\n\tfor(i=0; i<deletes.length; i++) {\n\t\tlet del = deletes[i];\n\t\tlet sibs = utils.getAllSiblings(dataset, del);\n\t\tif(sibs.length < 1) {\n\t\t\tlet data_node  = utils.getNodeByName(fnodes, del.name);\n\t\t\tlet ancestors = [];\n\t\t\tif(data_node && typeof data_node.ancestors === 'function')\n\t\t\t\tancestors = data_node.ancestors();\n\t\t\telse\n\t\t\t\tancestors = utils.ancestors(dataset, del);\n\t\t\tfor(j=0; j<ancestors.length; j++) {\n\t\t\t\tlet ancestor = ancestors[j];\n\t\t\t\tlet ancestorData = ancestor && ancestor.data ? ancestor.data : ancestor;\n\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\tconsole.log(ancestorData);\n\t\t\t\tlet motherName = ancestorData && ancestorData.mother ? (ancestorData.mother.name ? ancestorData.mother.name : ancestorData.mother) : null;\n\t\t\t\tlet fatherName = ancestorData && ancestorData.father ? (ancestorData.father.name ? ancestorData.father.name : ancestorData.father) : null;\n\t\t\t\tif(motherName && fatherName) {\n\t\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\t\tconsole.log('DELETE ', motherName, fatherName);\n\t\t\t\t\tlet mIdx = utils.getIdxByName(dataset, motherName);\n\t\t\t\t\tlet fIdx = utils.getIdxByName(dataset, fatherName);\n\t\t\t\t\tif(mIdx >= 0)\n\t\t\t\t\t\tdataset.splice(mIdx, 1);\n\t\t\t\t\tif(fIdx >= 0)\n\t\t\t\t\t\tdataset.splice(fIdx, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tcheckTwins(dataset);\n\tpurgePlaceholderChildren(dataset);\n\n\tlet uc;\n\tlet baselineDisconnected = [];\n\ttry\t{\n\t\tlet newopts = $.extend({}, opts);\n\t\tnewopts.dataset = utils.copy_dataset(dataset);\n\t\tutils.validate_pedigree(newopts);\n\t\tuc = utils.unconnected(dataset);\n\t\tif(opts && opts.dataset)\n\t\t\tbaselineDisconnected = utils.unconnected(opts.dataset);\n\t} catch(err) {\n\t\tutils.messages('Warning', 'Deletion of this pedigree member is disallowed.')\n\t\tthrow err;\n\t}\n\tlet hadDisconnectedBefore = baselineDisconnected.length > 0;\n\tif(uc.length > 0) {\n\t\tif(!hadDisconnectedBefore) {\n\t\t\tconsole.error(\"individuals unconnected to pedigree \", uc);\n\t\t\tlet confirmCallback = onDone ? function(localOpts, localDataset){\n\t\t\t\tonDone(localOpts, localDataset);\n\t\t\t} : null;\n\t\t\tutils.messages(\"Warning\", \"Deleting this will split the pedigree. Continue?\", confirmCallback, opts, dataset);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tif(onDone) {\n\t\tonDone(opts, dataset);\n\t}\n\treturn dataset;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// pedigree widgets\nimport * as utils from './utils.js';\nimport {save} from './popup_form.js';\nimport {current as pedcache_current} from './pedcache.js';\n// import {checkTwins} from './twins.js';  // Unused in this file (used in widgets-delete.js)\nimport {canChangeSex} from './validation.js';\nimport {addchild, addsibling, addparents, addpartner} from './widgets-add.js';\nimport {delete_node_dataset} from './widgets-delete.js';\n\nexport {addchild, addsibling, addparents, addpartner, delete_node_dataset};\n\n\nlet dragging;\nlet last_mouseover;\nlet shiftKeyPressed = false;  // Phase 3.2.2: Track Shift key for consanguineous drag feedback\n\n// Protection contre les double-clics qui créent des doublons\n// (Phase 3.1.3 - Correction UX/UI critique)\nlet _widgetClickInProgress = false;\n\n// Phase 3.2.2: Track Shift key for consanguineous partner drag visual feedback\n$(document).on('keydown keyup', function(e) {\n\tlet wasPressed = shiftKeyPressed;\n\tshiftKeyPressed = e.shiftKey;\n\n\t// Update cursor when Shift state changes\n\tif(wasPressed !== shiftKeyPressed) {\n\t\tif(shiftKeyPressed && last_mouseover && !dragging) {\n\t\t\t// Shift pressed while hovering node: show crosshair cursor\n\t\t\td3.select('.pedigree_form svg').style('cursor', 'crosshair');\n\t\t\t// Make drag handle more visible\n\t\t\td3.selectAll('.line_drag_selection').attr(\"stroke\", \"darkred\").attr(\"stroke-width\", 8);\n\t\t} else if(!shiftKeyPressed && !dragging) {\n\t\t\t// Shift released: restore normal cursor\n\t\t\td3.select('.pedigree_form svg').style('cursor', 'default');\n\t\t\td3.selectAll('.line_drag_selection').attr(\"stroke\", \"black\").attr(\"stroke-width\", 6);\n\t\t}\n\t}\n});\n\n//\n// Add widgets to nodes and bind events\nexport function addWidgets(opts, node) {\n\n\t// popup gender selection box\n\tlet font_size = parseInt($(\"body\").css('font-size'));\n\tlet popup_selection = d3.select('.diagram');\n\tpopup_selection.append(\"rect\").attr(\"class\", \"popup_selection\")\n\t\t\t\t\t\t\t.attr(\"rx\", 6)\n\t\t\t\t\t\t\t.attr(\"ry\", 6)\n\t\t\t\t\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t\t\t\t\t\t.attr(\"opacity\", 0)\n\t\t\t\t\t\t\t.attr(\"width\",  font_size*7.9)\n\t\t\t\t\t\t\t.attr(\"height\", font_size*2)\n\t\t\t\t\t\t\t.attr(\"stroke\", \"darkgrey\")\n\t\t\t\t\t\t\t.attr(\"fill\", \"white\");\n\n\tlet square = popup_selection.append(\"text\")  // male\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.attr(\"opacity\", 0)\n\t\t.attr(\"font-size\", \"1.1em\")\n\t\t.attr(\"class\", \"popup_selection fa-square persontype\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"x\", font_size/3)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf096 \");\n\tlet square_title = square.append(\"svg:title\").text(\"add male\");\n\n\tlet circle = popup_selection.append(\"text\")  // female\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.attr(\"opacity\", 0)\n\t\t.attr(\"font-size\", \"1.1em\")\n\t\t.attr(\"class\", \"popup_selection fa-circle persontype\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"x\", font_size*1.71)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf10c \");\n\tlet circle_title = circle.append(\"svg:title\").text(\"add female\");\n\n\tlet unspecified = popup_selection.append(\"text\")  // unspecified\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.attr(\"opacity\", 0)\n\t\t.attr(\"font-size\", \"1.1em\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"x\", font_size*0.065)\n\t\t.attr(\"y\", -font_size*0.065)\n\t\t.attr(\"class\", \"popup_selection fa-unspecified popup_selection_rotate45 persontype\")\n\t\t.text(\"\\uf096 \");\n\tunspecified.append(\"svg:title\").text(\"add unspecified\");\n\n\tlet dztwin = popup_selection.append(\"text\")  // dizygotic twins\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.attr(\"opacity\", 0)\n\t\t.attr(\"font-size\", \"1.6em\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"class\", \"popup_selection fa-angle-up persontype dztwin\")\n\t\t.attr(\"x\", font_size*4.62)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf106 \");\n\tdztwin.append(\"svg:title\").text(\"add dizygotic/fraternal twins\");\n\n\tlet mztwin = popup_selection.append(\"text\")  // monozygotic twins\n\t.attr('font-family', 'FontAwesome')\n\t.attr(\"opacity\", 0)\n\t.attr(\"font-size\", \"1.6em\")\n\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t.attr(\"class\", \"popup_selection fa-caret-up persontype mztwin\")\n\t.attr(\"x\", font_size*6.4)\n\t.attr(\"y\", font_size*1.5)\n\t.text(\"\\uf0d8 \");\n\tmztwin.append(\"svg:title\").text(\"add monozygotic/identical twins\");\n\n\tlet add_person = {};\n\t// click the person type selection\n\td3.selectAll(\".persontype\")\n\t  .on(\"click\", function () {\n\t\t// Protection contre les double-clics (Phase 3.1.3)\n\t\tif (_widgetClickInProgress) {\n\t\t\tif(opts.DEBUG) {\n\t\t\t\tconsole.log('Widget click ignored: action already in progress');\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\t_widgetClickInProgress = true;\n\n\t\tlet newdataset = utils.copy_dataset(pedcache_current(opts));\n\t\tlet mztwin = d3.select(this).classed(\"mztwin\");\n\t\tlet dztwin = d3.select(this).classed(\"dztwin\");\n\t\tlet twin_type;\n\t\tlet sex;\n\t\t// Phase 3.2.4: Allow sex selection for dizygotic twins, force same sex for monozygotic\n\t\tif(mztwin) {\n\t\t\t// Monozygotic (identical) twins must have same sex as sibling\n\t\t\tsex = add_person.node.datum().data.sex;\n\t\t\ttwin_type = \"mztwin\";\n\t\t} else {\n\t\t\t// Dizygotic twins and regular persons: read sex from clicked button\n\t\t\tsex = d3.select(this).classed(\"fa-square\") ? 'M' : (d3.select(this).classed(\"fa-circle\") ? 'F' : 'U');\n\t\t\ttwin_type = dztwin ? \"dztwin\" : undefined;\n\t\t}\n\n\t\tif(add_person.type === 'addsibling')\n\t\t\taddsibling(newdataset, add_person.node.datum().data, sex, false, twin_type);\n\t\telse if(add_person.type === 'addchild')\n\t\t\taddchild(newdataset, add_person.node.datum().data, (twin_type ? 'U' : sex), (twin_type ? 2 : 1), twin_type);\n\t\telse {\n\t\t\t_widgetClickInProgress = false;\n\t\t\treturn;\n\t\t}\n\t\topts.dataset = newdataset;\n\t\t$(document).trigger('rebuild', [opts]);\n\t\td3.selectAll('.popup_selection').attr(\"opacity\", 0);\n\t\tadd_person = {};\n\n\t\t// Réactiver après un délai pour permettre le rebuild\n\t\tsetTimeout(() => {\n\t\t\t_widgetClickInProgress = false;\n\t\t}, 300);\n\t  })\n\t  .on(\"mouseover\", function() {\n\t\t  if(add_person.node)\n\t\t\t  add_person.node.select('rect').attr(\"opacity\", 0.2);\n\t\t  d3.selectAll('.popup_selection').attr(\"opacity\", 1);\n\t\t  // add tooltips to font awesome widgets\n\t\t  if(add_person.type === 'addsibling'){\n\t\t\t if(d3.select(this).classed(\"fa-square\"))\n\t\t\t\t  square_title.text(\"add brother\");\n\t\t\t  else\n\t\t\t\t  circle_title.text(\"add sister\");\n\t\t  } else if(add_person.type === 'addchild'){\n\t\t\t  if(d3.select(this).classed(\"fa-square\"))\n\t\t\t\t  square_title.text(\"add son\");\n\t\t\t  else\n\t\t\t\t  circle_title.text(\"add daughter\");\n\t\t  }\n\t  });\n\n\t// handle mouse out of popup selection\n\td3.selectAll(\".popup_selection\").on(\"mouseout\", function () {\n\t\t// hide rect and popup selection\n\t\tif(add_person.node !== undefined && highlight.indexOf(add_person.node.datum()) === -1)\n\t\t\tadd_person.node.select('rect').attr(\"opacity\", 0);\n\t\td3.selectAll('.popup_selection').attr(\"opacity\", 0);\n\t});\n\n\n\t// drag line between nodes to create partners\n\tdrag_handle(opts);\n\n\t// rectangle used to highlight on mouse over\n\tnode.filter(function (d) {\n\t\t    return d.data.hidden && !opts.DEBUG ? false : true;\n\t\t})\n\t\t.append(\"rect\")\n\t\t.attr(\"class\", 'indi_rect')\n\t\t.attr(\"rx\", 6)\n\t\t.attr(\"ry\", 6)\n\t\t.attr(\"x\", function(_d) { return - 0.75*opts.symbol_size; })\n\t\t.attr(\"y\", function(_d) { return - opts.symbol_size; })\n\t\t.attr(\"width\",  (1.5 * opts.symbol_size)+'px')\n\t\t.attr(\"height\", (2 * opts.symbol_size)+'px')\n\t\t.attr(\"stroke\", \"black\")\n\t\t.attr(\"stroke-width\", 0.7)\n\t\t.attr(\"opacity\", 0)\n\t\t.attr(\"fill\", \"lightgrey\");\n\n\t// widgets\n\tlet fx = function(_d) {return off - (0.75*opts.symbol_size);};\n\tlet fy = opts.symbol_size -2;\n\tlet off = 0;\n\tlet widgets = {\n\t\t'addchild':   {'text': '\\uf063', 'title': 'add child',   'fx': fx, 'fy': fy},\n\t\t'addsibling': {'text': '\\uf234', 'title': 'add sibling', 'fx': fx, 'fy': fy},\n\t\t'addpartner': {'text': '\\uf0c1', 'title': 'add partner', 'fx': fx, 'fy': fy},\n\t\t'addparents': {\n\t\t\t'text': '\\uf062', 'title': 'add parents',\n\t\t\t'fx': - 0.75*opts.symbol_size,\n\t\t\t'fy': - opts.symbol_size + 11\n\t\t},\n\t\t'delete': {\n\t\t\t'text': 'X', 'title': 'delete',\n\t\t\t'fx': (opts.symbol_size/2) - 1,\n\t\t\t'fy': - opts.symbol_size + 12,\n\t\t\t'styles': {\"font-weight\": \"bold\", \"fill\": \"darkred\", \"font-family\": \"monospace\"}\n\t\t}\n\t};\n\n\tif(opts.edit) {\n\t\twidgets.settings = {'text': '\\uf013', 'title': 'settings', 'fx': (-font_size/2)+2, 'fy': -opts.symbol_size + 11};\n\t}\n\n\tfor(let key in widgets) {\n\t\tlet widget = node.filter(function (d) {\n\t\t\t\t// Phase 3.1.4 - Supprimé la condition bloquante sur addpartner\n\t\t\t\t// Permet maintenant d'ajouter plusieurs partenaires (remariage, polygamie)\n\t\t\t\treturn  (d.data.hidden && !opts.DEBUG ? false : true) &&\n\t\t\t\t\t\t!((d.data.mother === undefined || d.data.noparents) && key === 'addsibling') &&\n\t\t\t\t\t\t!(d.data.parent_node === undefined && key === 'addchild') &&\n\t\t\t\t\t\t!((d.data.noparents === undefined && d.data.top_level === undefined) && key === 'addparents');\n\t\t\t})\n\t\t\t.append(\"text\")\n\t\t\t.attr(\"class\", key)\n\t\t\t.attr(\"opacity\", 0)\n\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t.attr(\"xx\", function(d){return d.x;})\n\t\t\t.attr(\"yy\", function(d){return d.y;})\n\t\t\t.attr(\"x\", widgets[key].fx)\n\t\t\t.attr(\"y\", widgets[key].fy)\n\t\t\t.attr('font-size', '0.85em' )\n\t\t\t.text(widgets[key].text);\n\n\t\tif('styles' in widgets[key])\n\t\t\tfor(let style in widgets[key].styles){\n\t\t\t\twidget.attr(style, widgets[key].styles[style]);\n\t\t\t}\n\n\t\twidget.append(\"svg:title\").text(widgets[key].title);\n\t\toff += 17;\n\t}\n\n\t// add sibling or child\n\t// FIX: Use node.selectAll to scope selection to widgets created in this pedigree instance\n\tnode.selectAll(\".addsibling, .addchild\")\n\t  .on(\"mouseover\", function () {\n\t\t  let type = d3.select(this).attr('class');\n\t\t  d3.selectAll('.popup_selection').attr(\"opacity\", 1);\n\t\t  add_person = {'node': d3.select(this.parentNode), 'type': type};\n\n\t\t  //let translate = getTranslation(d3.select('.diagram').attr(\"transform\"));\n\t\t  let x = parseInt(d3.select(this).attr(\"xx\")) + parseInt(d3.select(this).attr(\"x\"));\n\t\t  let y = parseInt(d3.select(this).attr(\"yy\")) + parseInt(d3.select(this).attr(\"y\"));\n\t\t  d3.selectAll('.popup_selection').attr(\"transform\", \"translate(\"+x+\",\"+(y+2)+\")\");\n\t\t  d3.selectAll('.popup_selection_rotate45')\n\t\t\t.attr(\"transform\", \"translate(\"+(x+(3*font_size))+\",\"+(y+(font_size*1.2))+\") rotate(45)\");\n\t  });\n\n\t// handle widget clicks\n\t// FIX: Use node.selectAll to scope selection to widgets created in this pedigree instance\n\tnode.selectAll(\".addchild, .addpartner, .addparents, .delete, .settings\")\n\t  .on(\"click\", function (e) {\n\t\t  e.stopPropagation();\n\n\t\t// Protection contre les double-clics (Phase 3.1.3)\n\t\tif (_widgetClickInProgress) {\n\t\t\tif(opts.DEBUG) {\n\t\t\t\tconsole.log('Widget action ignored: action already in progress');\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tlet opt = d3.select(this).attr('class');\n\t\tlet d = d3.select(this.parentNode).datum();\n\t\tif(opts.DEBUG) {\n\t\t\tconsole.log('Widget clicked:', opt);\n\t\t}\n\n\t\t// Bloquer les clics pendant l'action (sauf settings qui est instantané)\n\t\tif(opt !== 'settings') {\n\t\t\t_widgetClickInProgress = true;\n\t\t}\n\n\t\ttry {\n\t\t\tlet newdataset;\n\t\t\tif(opt === 'settings') {\n\t\t\t\tif(typeof opts.edit === 'function') {\n\t\t\t\t\topts.edit(opts, d);\n\t\t\t\t} else {\n\t\t\t\t\topenEditDialog(opts, d);\n\t\t\t\t}\n\t\t\t} else if(opt === 'delete') {\n\t\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\n\t\t\t\tdelete_node_dataset(newdataset, d.data, opts, onDone);\n\t\t\t} else if(opt === 'addparents') {\n\t\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\n\t\t\t\topts.dataset = newdataset;\n\t\t\t\taddparents(opts, newdataset, d.data.name);\n\t\t\t\t$(document).trigger('rebuild', [opts]);\n\t\t\t} else if(opt === 'addpartner') {\n\t\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\n\t\t\t\topts.dataset = newdataset;\n\t\t\t\tif(opts.DEBUG) {\n\t\t\t\t\tconsole.log('Calling addpartner for:', d.data.name);\n\t\t\t\t}\n\t\t\t\taddpartner(opts, newdataset, d.data.name);\n\t\t\t\tif(opts.DEBUG) {\n\t\t\t\t\tconsole.log('addpartner completed, triggering rebuild');\n\t\t\t\t}\n\t\t\t\t$(document).trigger('rebuild', [opts]);\n\t\t\t}\n\t\t\t// trigger fhChange event\n\t\t\t$(document).trigger('fhChange', [opts]);\n\t\t} catch(error) {\n\t\t\tconsole.error('Error in widget click handler:', error);\n\t\t\tconsole.error('Stack:', error.stack);\n\t\t\t// Réinitialiser le flag immédiatement en cas d'erreur\n\t\t\t_widgetClickInProgress = false;\n\t\t\tthrow error;  // Re-throw pour que l'erreur soit visible\n\t\t}\n\n\t\t// Réactiver après un délai (sauf settings)\n\t\tif(opt !== 'settings') {\n\t\t\tsetTimeout(() => {\n\t\t\t\t_widgetClickInProgress = false;\n\t\t\t}, 300);\n\t\t}\n\t});\n\n\t// other mouse events\n\tlet highlight = [];\n\n\tnode.filter(function (d) { return !d.data.hidden; })\n\t.on(\"click\", function (e, d) {\n\t\tif (e.ctrlKey) {\n\t\t\tif(highlight.indexOf(d) === -1)\n\t\t\t\thighlight.push(d);\n\t\t\telse\n\t\t\t\thighlight.splice(highlight.indexOf(d), 1);\n\t\t} else\n\t\t\thighlight = [d];\n\n\t\tif('nodeclick' in opts) {\n\t\t\topts.nodeclick(d.data);\n\t\t\td3.selectAll(\".indi_rect\").attr(\"opacity\", 0);\n\t\t\td3.selectAll('.indi_rect').filter(function(d) {return highlight.indexOf(d) !== -1;}).attr(\"opacity\", 0.5);\n\t\t}\n\t})\n\t.on(\"mouseover\", function(e, d){\n\t\te.stopPropagation();\n\t\tlast_mouseover = d;\n\t\tif(dragging) {\n\t\t\tif(dragging.data.name !== last_mouseover.data.name &&\n\t\t\t   dragging.data.sex !== last_mouseover.data.sex) {\n\t\t\t\td3.select(this).select('rect').attr(\"opacity\", 0.2);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\td3.select(this).select('rect').attr(\"opacity\", 0.2);\n\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').attr(\"opacity\", 1);\n\t\td3.select(this).selectAll('.indi_details').attr(\"opacity\", 0);\n\n\t\tsetLineDragPosition(opts.symbol_size-10, 0, opts.symbol_size-2, 0, d.x+\",\"+(d.y+2));\n\n\t\t// Phase 3.2.2: Enhanced visual feedback when Shift pressed\n\t\tif(shiftKeyPressed) {\n\t\t\td3.select('.pedigree_form svg').style('cursor', 'crosshair');\n\t\t\td3.selectAll('.line_drag_selection').attr(\"stroke\", \"darkred\").attr(\"stroke-width\", 8);\n\t\t}\n\t})\n\t.on(\"mouseout\", function(d){\n\t\tif(dragging)\n\t\t\treturn;\n\n\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').attr(\"opacity\", 0);\n\t\tif(highlight.indexOf(d) === -1)\n\t\t\td3.select(this).select('rect').attr(\"opacity\", 0);\n\t\td3.select(this).selectAll('.indi_details').attr(\"opacity\", 1);\n\n\t\t// Phase 3.2.2: Restore normal cursor when leaving node\n\t\tif(shiftKeyPressed) {\n\t\t\td3.select('.pedigree_form svg').style('cursor', 'default');\n\t\t\td3.selectAll('.line_drag_selection').attr(\"stroke\", \"black\").attr(\"stroke-width\", 6);\n\t\t}\n\t\tlast_mouseover = undefined;\n\n\t\t// hide popup if it looks like the mouse is moving north\n\t\tlet xcoord = d3.pointer(d)[0];\n\t\tlet ycoord = d3.pointer(d)[1];\n\t\tif(ycoord < 0.8*opts.symbol_size)\n\t\t\td3.selectAll('.popup_selection').attr(\"opacity\", 0);\n\t\tif(!dragging) {\n\t\t\t// hide popup if it looks like the mouse is moving north, south or west\n\t\t\tif( Math.abs(ycoord) > 0.25*opts.symbol_size ||\n\t\t\t\tMath.abs(ycoord) < -0.25*opts.symbol_size ||\n\t\t\t\txcoord < 0.2*opts.symbol_size){\n\t\t\t\t\tsetLineDragPosition(0, 0, 0, 0);\n\t\t\t}\n        }\n\t});\n}\n\nfunction onDone(opts, dataset) {\n\t// assign new dataset and rebuild pedigree\n\topts.dataset = dataset;\n\t$(document).trigger('rebuild', [opts]);\n}\n\n// drag line between nodes to create partners\nfunction drag_handle(opts) {\n\tlet line_drag_selection = d3.select('.diagram');\n\tlet dline = line_drag_selection.append(\"line\").attr(\"class\", 'line_drag_selection')\n        .attr(\"stroke-width\", 6)\n        .attr(\"stroke-dasharray\", (\"2, 1\"))\n        .attr(\"stroke\",\"black\")\n        .call(d3.drag()\n                .on(\"start\", dragstart)\n                .on(\"drag\", drag)\n                .on(\"end\", dragstop));\n\t// Phase 3.2.2: Enhanced tooltip with Shift key hint\n\tdline.append(\"svg:title\").text(\"Hold Shift and drag to create consanguineous partners (blood-related)\");\n\n\tsetLineDragPosition(0, 0, 0, 0);\n\n\tfunction dragstart() {\n\t\tdragging = last_mouseover;\n\t\td3.selectAll('.line_drag_selection')\n\t\t\t.attr(\"stroke\",\"darkred\");\n\t}\n\n\tfunction dragstop(_d) {\n\t\tif(last_mouseover &&\n\t\t   dragging.data.name !== last_mouseover.data.name &&\n\t\t   dragging.data.sex  !== last_mouseover.data.sex) {\n\t\t\t// make partners\n\t\t\tlet child = {\"name\": utils.makeid(4), \"sex\": 'U',\n\t\t\t\t     \"mother\": (dragging.data.sex === 'F' ? dragging.data.name : last_mouseover.data.name),\n\t\t\t         \"father\": (dragging.data.sex === 'F' ? last_mouseover.data.name : dragging.data.name)};\n\t\t\tlet newdataset = utils.copy_dataset(opts.dataset);\n\t\t\topts.dataset = newdataset;\n\n\t\t\tlet idx = utils.getIdxByName(opts.dataset, dragging.data.name)+1;\n\t\t\topts.dataset.splice(idx, 0, child);\n\t\t\t$(document).trigger('rebuild', [opts]);\n\t\t}\n\t\tsetLineDragPosition(0, 0, 0, 0);\n\t\td3.selectAll('.line_drag_selection')\n\t\t\t.attr(\"stroke\",\"black\");\n\t\tdragging = undefined;\n\t\treturn;\n\t}\n\n\tfunction drag(e) {\n\t\te.sourceEvent.stopPropagation();\n\t\tlet dx = e.dx;\n\t\tlet dy = e.dy;\n\t\tlet xnew = parseFloat(d3.select(this).attr('x2'))+ dx;\n        let ynew = parseFloat(d3.select(this).attr('y2'))+ dy;\n        setLineDragPosition(opts.symbol_size-10, 0, xnew, ynew);\n\t}\n}\n\n/**\n * Set the position and start and end of consanguineous widget.\n */\nfunction setLineDragPosition(x1, y1, x2, y2, translate) {\n\tif(translate) {\n\t\td3.selectAll('.line_drag_selection').attr(\"transform\", \"translate(\"+translate+\")\");\n\t}\n\td3.selectAll('.line_drag_selection')\n\t\t.attr(\"x1\", x1)\n\t\t.attr(\"y1\", y1)\n\t\t.attr(\"x2\", x2)\n\t\t.attr(\"y2\", y2);\n}\n\nfunction capitaliseFirstLetter(string) {\n    return string.charAt(0).toUpperCase() + string.slice(1);\n}\n\n// if opt.edit is set true (rather than given a function) this is called to edit node attributes\nfunction openEditDialog(opts, d) {\n\t$('#node_properties').dialog({\n\t    autoOpen: false,\n\t    title: d.data.display_name,\n\t    width: ($(window).width() > 400 ? 450 : $(window).width()- 30)\n\t});\n\n\tlet table = \"<table id='person_details' class='table'>\";\n\n\ttable += \"<tr><td style='text-align:right'>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value=\"+\n\t(d.data.name ? d.data.name : \"\")+\"></td></tr>\";\n\ttable += \"<tr><td style='text-align:right'>Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value=\"+\n\t\t\t(d.data.display_name ? d.data.display_name : \"\")+\"></td></tr>\";\n\n\ttable += \"<tr><td style='text-align:right'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:7em' value=\"+\n\t\t\t(d.data.age ? d.data.age : \"\")+\"></td></tr>\";\n\n\ttable += \"<tr><td style='text-align:right'>Year Of Birth</td><td><input class='form-control' type='number' id='id_yob' min='1900' max='2050' name='yob' style='width:7em' value=\"+\n\t\t(d.data.yob ? d.data.yob : \"\")+\"></td></tr>\";\n\n\t// check if sex can be changed (Phase 3.1.5)\n\tlet dataset = pedcache_current(opts);\n\tconst sexCanChange = canChangeSex(d.data, dataset);\n\tconst disableInp = (sexCanChange ? \"\" : \"disabled\")\n\tconst label = '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" ';\n\ttable += '<tr><td colspan=\"2\" id=\"id_sex\">' +\n\t\t\t label+'value=\"M\" '+(d.data.sex === 'M' ? \"checked \" : \" \")+disableInp+'>Male</label>' +\n\t\t\t label+'value=\"F\" '+(d.data.sex === 'F' ? \"checked \" : \" \")+disableInp+'>Female</label>' +\n\t\t\t label+'value=\"U\" '+disableInp+'>Unknown</label>' +\n\t\t\t '</td></tr>';\n\n\t// alive status = 0; dead status = 1\n\ttable += '<tr><td colspan=\"2\" id=\"id_status\">' +\n\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"0\" '+(parseInt(d.data.status) === 0 ? \"checked\" : \"\")+'>&thinsp;Alive</label>' +\n\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"1\" '+(parseInt(d.data.status) === 1 ? \"checked\" : \"\")+'>&thinsp;Deceased</label>' +\n\t\t\t '</td></tr>';\n\t$(\"#id_status input[value='\"+d.data.status+\"']\").prop('checked', true);\n\n\t// switches\n\tlet switches = [\"adopted_in\", \"adopted_out\", \"miscarriage\", \"stillbirth\", \"termination\"];\n\ttable += '<tr><td colspan=\"2\"><strong>Reproduction:</strong></td></tr>';\n\ttable += '<tr><td colspan=\"2\">';\n\tfor(let iswitch=0; iswitch<switches.length; iswitch++){\n\t\tlet attr = switches[iswitch];\n\t\tif(iswitch === 2)\n\t\t\ttable += '</td></tr><tr><td colspan=\"2\">';\n\t\ttable +=\n\t\t '<label class=\"checkbox-inline\"><input type=\"checkbox\" id=\"id_'+attr +\n\t\t    '\" name=\"'+attr+'\" value=\"0\" '+(d.data[attr] ? \"checked\" : \"\")+'>&thinsp;' +\n\t\t    capitaliseFirstLetter(attr.replace('_', ' '))+'</label>'\n\t}\n\ttable += '</td></tr>';\n\n\t//\n\tlet exclude = [\"children\", \"name\", \"parent_node\", \"top_level\", \"id\", \"noparents\",\n\t\t           \"level\", \"age\", \"sex\", \"status\", \"display_name\", \"mother\", \"father\",\n\t\t           \"yob\", \"mztwin\", \"dztwin\"];\n\t$.merge(exclude, switches);\n\ttable += '<tr><td colspan=\"2\"><strong>Age of Diagnosis:</strong></td></tr>';\n\t$.each(opts.diseases, function(k, v) {\n\t\texclude.push(v.type+\"_diagnosis_age\");\n\n\t\tlet disease_colour = '&thinsp;<span style=\"padding-left:5px;background:'+opts.diseases[k].colour+'\"></span>';\n\t\tlet diagnosis_age = d.data[v.type + \"_diagnosis_age\"];\n\n\t\ttable += \"<tr><td style='text-align:right'>\"+capitaliseFirstLetter(v.type.replace(\"_\", \" \"))+\n\t\t\t\t\tdisease_colour+\"&nbsp;</td><td>\" +\n\t\t\t\t\t\"<input class='form-control' id='id_\" +\n\t\t\t\t\tv.type + \"_diagnosis_age_0' max='110' min='0' name='\" +\n\t\t\t\t\tv.type + \"_diagnosis_age_0' style='width:5em' type='number' value='\" +\n\t\t\t\t\t(diagnosis_age !== undefined ? diagnosis_age : \"\") +\"'></td></tr>\";\n\t});\n\n\ttable += '<tr><td colspan=\"2\" style=\"line-height:1px;\"></td></tr>';\n\t$.each(d.data, function(k, v) {\n\t\tif($.inArray(k, exclude) === -1) {\n\t\t\tlet kk = capitaliseFirstLetter(k);\n\t\t\tif(v === true || v === false) {\n\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='checkbox' id='id_\" + k + \"' name='\" +\n\t\t\t\t\t\tk+\"' value=\"+v+\" \"+(v ? \"checked\" : \"\")+\"></td></tr>\";\n\t\t\t} else if(k.length > 0){\n\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='text' id='id_\" +\n\t\t\t\t\t\tk+\"' name='\"+k+\"' value=\"+v+\"></td></tr>\";\n\t\t\t}\n\t\t}\n    });\n\ttable += \"</table>\";\n\n\t$('#node_properties').html(table);\n\t$('#node_properties').dialog('open');\n\n\t$('#node_properties input[type=radio], #node_properties input[type=checkbox], #node_properties input[type=text], #node_properties input[type=number]').on('change', function() {\n\t\tsave(opts);\n    });\n\treturn;\n}\n\n\n\n","/**\n * Rendering Constants for PedigreeJS SVG Generation\n *\n * This module centralizes all \"magic numbers\" used in SVG rendering to improve\n * code maintainability and allow easier customization.\n *\n * @module rendering-constants\n * @version 4.0.0-rc1\n * @date 2025-11-19\n */\n\n/**\n * SVG rendering constants\n * All factors and offsets used in pedigree.js for calculating positions, sizes, and styling\n */\nexport const RENDERING_CONSTANTS = {\n\t// ========================================\n\t// NODE SEPARATION (tree layout)\n\t// ========================================\n\n\t/**\n\t * Separation factor for siblings with same parents\n\t * Used in D3 tree layout to space nodes horizontally\n\t */\n\tSEPARATION_SAME_PARENT: 1.2,\n\n\t/**\n\t * Separation factor for siblings with different parents\n\t * Larger spacing for half-siblings or nodes from different families\n\t */\n\tSEPARATION_DIFFERENT: 2.2,\n\n\t// ========================================\n\t// SYMBOL SIZING\n\t// ========================================\n\n\t/**\n\t * Extra size added to symbol border path\n\t * Ensures border is slightly larger than symbol for visual clarity\n\t */\n\tSYMBOL_BORDER_EXTRA: 2,\n\n\t/**\n\t * Size reduction factor for hidden nodes (1/5th of normal size)\n\t * Hidden nodes are structural only, shown in DEBUG mode\n\t */\n\tHIDDEN_NODE_SIZE_FACTOR: 0.2,\n\n\t// ========================================\n\t// ADOPTED BRACKETS (adopted_in/adopted_out)\n\t// ========================================\n\n\t/**\n\t * Horizontal offset for bracket start position\n\t * Bracket X position = -(symbol_size * this factor)\n\t * Value 0.66 positions bracket 2/3 of symbol width from center\n\t */\n\tBRACKET_X_OFFSET_FACTOR: 0.66,\n\n\t/**\n\t * Vertical offset for bracket start position\n\t * Bracket Y position = -(symbol_size * this factor)\n\t * Value 0.64 positions bracket slightly above center\n\t */\n\tBRACKET_Y_OFFSET_FACTOR: 0.64,\n\n\t/**\n\t * Bracket indent (horizontal depth)\n\t * Indent = symbol_size / this value\n\t * Value 4 = bracket indent is 1/4 of symbol width\n\t */\n\tBRACKET_INDENT_DIVISOR: 4,\n\n\t/**\n\t * Bracket height scaling factor\n\t * Height = symbol_size * this factor\n\t * Value 1.3 gives good visual proportion across all symbol sizes\n\t * (Previously was hardcoded 1.28, now explicit for clarity)\n\t */\n\tBRACKET_HEIGHT_FACTOR: 1.3,\n\n\t// ========================================\n\t// DECEASED STATUS LINE (diagonal stroke)\n\t// ========================================\n\n\t/**\n\t * Dead status line size factor\n\t * Line length = symbol_size * this factor\n\t * Value 0.6 = line is 60% of symbol width\n\t */\n\tDEAD_LINE_SIZE_FACTOR: 0.6,\n\n\t// ========================================\n\t// PARTNER LINKS (relationship lines)\n\t// ========================================\n\n\t/**\n\t * Vertical offset for consanguinity double line\n\t * Offset in pixels between the two parallel lines\n\t */\n\tCONSANGUINITY_LINE_OFFSET: 3,\n\n\t/**\n\t * Length factor for twin horizontal bar (MZ twins)\n\t * Bar length = opts.symbol_size / (this value / 3)\n\t * Cryptic calculation: for symbol_size=35, bar_length = 35/(6/3) = 17.5\n\t */\n\tTWIN_BAR_LENGTH_DIVISOR: 6,\n\n\t// ========================================\n\t// PROBAND ARROW (indicator arrow)\n\t// ========================================\n\n\t/**\n\t * Proband arrow horizontal position factor\n\t * Arrow X offset = symbol_size / this factor\n\t * Value 0.7 positions arrow ~1.4x symbol width from center\n\t */\n\tARROW_X_DIVISOR: 0.7,\n\n\t/**\n\t * Proband arrow vertical position factor\n\t * Arrow Y offset = symbol_size / this factor\n\t * Value 1.4 positions arrow ~0.7x symbol height from center\n\t */\n\tARROW_Y_DIVISOR: 1.4,\n\n\t/**\n\t * Proband arrow head size factor\n\t * Arrow head size = symbol_size / this value\n\t * Value 6 = arrow head is 1/6th of symbol size\n\t */\n\tARROW_HEAD_SIZE_DIVISOR: 6,\n\n\t/**\n\t * Proband arrow shaft width factor\n\t * Shaft width = symbol_size / this value\n\t * Value 40 = very thin arrow shaft\n\t */\n\tARROW_SHAFT_WIDTH_DIVISOR: 40,\n\n\t// ========================================\n\t// DIVORCE SYMBOLS (double slash on partner line)\n\t// ========================================\n\n\t/**\n\t * Divorce symbol position along partner line\n\t * Position = line length * this factor\n\t * Value 0.66 = symbol at 2/3 point along the line\n\t */\n\tDIVORCE_X_POSITION: 0.66,\n\n\t/**\n\t * Divorce slash offset from line center\n\t * Offset in pixels for the two parallel slashes\n\t */\n\tDIVORCE_OFFSET: 6,\n\n\t/**\n\t * Divorce slash length factor\n\t * Slash length = symbol_size / this value\n\t * Value 3 = slash length is 1/3 of symbol size\n\t */\n\tDIVORCE_SLASH_LENGTH_DIVISOR: 3,\n\n\t// ========================================\n\t// TEXT LABELS (age, yob, monozygotic indicator)\n\t// ========================================\n\n\t/**\n\t * Vertical offset for age/yob label below symbol\n\t * Offset = symbol_size * this factor\n\t * Value 1.6 positions label below the symbol with spacing\n\t */\n\tLABEL_Y_OFFSET_FACTOR: 1.6,\n\n\t/**\n\t * Font size for age/yob labels\n\t * Font size as CSS em value (relative to base font)\n\t */\n\tLABEL_FONT_SIZE: '0.9em',\n\n\t/**\n\t * Font size for monozygotic twin indicator (\"MZ\")\n\t * Font size as CSS em value\n\t */\n\tMZ_LABEL_FONT_SIZE: '0.8em',\n\n\t// ========================================\n\t// CLASH DETECTION (crossing partner lines)\n\t// ========================================\n\n\t/**\n\t * Distance threshold for clash detection\n\t * If two partner lines are closer than this (in pixels), it's a clash\n\t */\n\tCLASH_THRESHOLD: 10,\n\n\t// ========================================\n\t// CHILD LINK GEOMETRY\n\t// ========================================\n\n\t/**\n\t * Vertical offset for child link fork point\n\t * Adjusts where child links split from parent couple\n\t */\n\tCHILD_LINK_FORK_OFFSET: 0,\n\n\t// ========================================\n\t// PIE CHARTS (disease status)\n\t// ========================================\n\n\t/**\n\t * Inner radius for pie chart arcs\n\t * Value 0 = filled pie, no donut hole\n\t */\n\tPIE_INNER_RADIUS: 0,\n\n\t/**\n\t * Outer radius multiplier for pie chart\n\t * Radius = symbol_size * this factor\n\t */\n\tPIE_OUTER_RADIUS_FACTOR: 0.5,\n};\n\n/**\n * Color constants\n * Default colors used in rendering (can be overridden via opts)\n *\n * Note: These are being kept as constants for reference, but actual colors\n * should be made configurable via opts in Phase 3 of the refactoring plan.\n */\nexport const DEFAULT_COLORS = {\n\t// Node styling\n\tNODE_BORDER: 'darkgrey',\n\tNODE_BORDER_WITH_DATA: '#303030',\n\tNODE_BORDER_NO_DATA: 'grey',\n\n\t// Links\n\tLINK_DEFAULT: '#000',\n\tLINK_DEBUG: 'pink',\n\n\t// Status indicators\n\tAFFECTED_FILL: 'darkgrey',\n\tCLASH_INDICATOR: '#D5494A',\n};\n\n/**\n * Export all constants as a single object for convenience\n */\nexport default {\n\t...RENDERING_CONSTANTS,\n\tCOLORS: DEFAULT_COLORS\n};\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport {prefixInObj} from './utils.js';\nimport {validate_age_yob} from './validation.js';\nimport {RENDERING_CONSTANTS as RC} from './rendering-constants.js';\n\nexport function addLabels(opts, node) {\n\t// names of individuals\n\taddLabel(opts, node, -(0.4 * opts.symbol_size), -(0.1 * opts.symbol_size),\n\t\t\tfunction(d) {\n\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\treturn ('display_name' in d.data ? d.data.display_name : d.data.name) + '  ' + d.data.id;\n\t\t\t\treturn 'display_name' in d.data ? d.data.display_name : '';}, undefined, ['display_name']);\n\n\tlet baseFontPx = parseFloat(getPx(opts)) || 0;\n\tlet labelFontSize = RC.LABEL_FONT_SIZE || opts.font_size;\n\tlet labelFontPx = fontStringToPx(labelFontSize, baseFontPx);\n\tlet lineSpacing = labelFontPx || baseFontPx || 12;\n\tlet initialOffset = opts.symbol_size * (RC.LABEL_Y_OFFSET_FACTOR || 1.6);\n\n\t// Phase 3.3.4: Fonction de validation age/yob (sortie de la boucle pour éviter no-loop-func)\n\tlet validate_age_yob_data = function(d) {\n\t\t// Valider age/yob si les deux sont présents\n\t\tif(d.data.age && d.data.yob && d.data.status) {\n\t\t\treturn validate_age_yob(d.data.age, d.data.yob, d.data.status);\n\t\t}\n\t\treturn true; // Valide si données manquantes\n\t};\n\n\t// display age/yob label first\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\n\t\tlet label = opts.labels[ilab];\n\t\tlet arr = (Array.isArray(label) ? label : [label]);\n\t\tif(arr.indexOf('age') > -1 || arr.indexOf('yob') > -1) {\n\t\t\t// Phase 3.3.4: Ajouter indicateur visuel pour données age/yob invalides\n\t\t\taddLabel(opts, node, -opts.symbol_size,\n\t\t\t\tfunction(d) { return ypos(d, arr, lineSpacing, initialOffset); },\n\t\t\t\tfunction(d) { return get_text(d, arr); }, 'indi_details', arr,\n\t\t\t\tvalidate_age_yob_data);\n\t\t}\n\t}\n\n\t// individuals disease details\n\tfor(let i=0;i<opts.diseases.length; i++) {\n\t\tlet disease = opts.diseases[i].type;\n\t\taddLabel(opts, node, -opts.symbol_size,\n\t\t\t\tfunction(d) { return ypos(d, [disease], lineSpacing, initialOffset); },\n\t\t\t\tfunction(d) {\n\t\t\t\t\tlet dis = disease.replace('_', ' ').replace('cancer', 'ca.');\n\t\t\t\t\treturn disease+'_diagnosis_age' in d.data ? dis +\": \"+ d.data[disease+'_diagnosis_age'] : '';\n\t\t\t\t}, 'indi_details', [disease]);\n\t}\n\n\t// display other labels defined in opts.labels e.g. alleles/genotype data\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\n\t\tlet label = opts.labels[ilab];\n\t\tlet arr = (Array.isArray(label) ? label : [label]);\n\t\tif(arr.indexOf('age') === -1 && arr.indexOf('yob') === -1) {\n\t\t\taddLabel(opts, node, -opts.symbol_size,\n\t\t\t\tfunction(d) { return ypos(d, arr, lineSpacing, initialOffset); },\n\t\t\t\tfunction(d) { return get_text(d, arr); }, 'indi_details', arr);\n\t\t}\n\t}\n\n\t// Monozygote indicator label\n\tnode.filter(function (d) {\n\t\t\treturn !d.data.hidden && d.data.mztwin;\n\t\t})\n\t\t.append(\"text\")\n\t\t.attr(\"class\", \"ped_label mz-indicator\")\n\t\t.attr(\"x\", opts.symbol_size * 0.7)\n\t\t.attr(\"y\", -(opts.symbol_size * 0.6))\n\t\t.attr(\"font-family\", opts.font_family)\n\t\t.attr(\"font-size\", RC.MZ_LABEL_FONT_SIZE || '0.8em')\n\t\t.attr(\"font-weight\", opts.font_weight)\n\t\t.text(\"MZ\");\n}\n\nfunction get_text(d, arr) {\n\tlet txt = \"\";\n\tfor(let l=0; l<arr.length; l++) {\n\t\tlet this_label = arr[l];\n\t\tif(d.data[this_label]) {\n\t\t\tif(this_label === 'alleles') {\n\t\t\t\tlet vars = d.data.alleles.split(';');\n\t\t\t\tfor(let ivar = 0;ivar < vars.length;ivar++) {\n\t\t\t\t\tif(vars[ivar] !== \"\") txt += vars[ivar] + ';';\n\t\t\t\t}\n\t\t\t} else if(this_label === 'age') {\n\t\t\t\ttxt += d.data[this_label] +'y ';\n\t\t\t} else if(this_label === 'stillbirth') {\n\t\t\t\ttxt += \"SB\";\n\t\t\t} else if(this_label.match(\"_gene_test$\") && 'result' in d.data[this_label]) {\n\t\t\t\tlet r = d.data[this_label]['result'].toUpperCase();\n\t\t\t\t//let t = d.data[this_label]['type'];\n\t\t\t\tif(r !== \"-\") {\n\t\t\t\t\ttxt += this_label.replace('_gene_test', '').toUpperCase()\n\t\t\t\t\ttxt += (r === 'P' ? '+ ' : (r === 'N' ? '- ' : ' '));\n\t\t\t\t}\n\t\t\t} else if(this_label.match(\"_bc_pathology$\")) {\n\t\t\t\tlet r = d.data[this_label].toUpperCase();\n\t\t\t\ttxt += this_label.replace('_bc_pathology', '').toUpperCase()\n\t\t\t\ttxt += (r === 'P' ? '+ ' : (r === 'N' ? '- ' : ' '));\n\t\t\t} else {\n\t\t\t  txt += d.data[this_label];\n\t\t\t}\n\t\t}\n\t}\n\tif(txt !== \"\") return txt;\n}\n\nfunction ypos(d, arr, spacing, initialOffset) {\n\tif(!node_has_label(d, arr)) return;\n\td.y_offset = (!d.y_offset ? initialOffset : d.y_offset+spacing);\n\treturn d.y_offset;\n}\n\nfunction node_has_label(d, labels) {\n\tfor(let l=0; l<labels.length; l++) {\n\t\tif(prefixInObj(labels[l], d.data)) return true;\n\t}\n\treturn false;\n}\n\n// add label to node\nfunction addLabel(opts, node, fx, fy, ftext, class_label, labels, validate_fn) {\n\tlet labels_sel = node.filter(function (d) {\n\t\treturn !d.data.hidden && (!labels || node_has_label(d, labels));\n\t}).append(\"text\")\n\t.attr(\"class\", (class_label ? class_label + ' ped_label' : 'ped_label'))\n\t.attr(\"x\", fx)\n\t.attr(\"y\", fy)\n\t.attr(\"font-family\", opts.font_family)\n\t.attr(\"font-size\", RC.LABEL_FONT_SIZE || opts.font_size)\n\t.attr(\"font-weight\", opts.font_weight)\n\t// Phase 3.3.4: Appliquer style visuel si données invalides\n\t.attr(\"fill\", function(d) {\n\t\tif(validate_fn && !validate_fn(d)) {\n\t\t\treturn \"#d32f2f\"; // Rouge pour données invalides\n\t\t}\n\t\treturn null; // Style par défaut\n\t})\n\t.text(ftext);\n\n\t// Ajouter tooltip pour les données invalides\n\tlabels_sel.append(\"title\")\n\t.text(function(d) {\n\t\tif(validate_fn && !validate_fn(d)) {\n\t\t\treturn \"Warning: Age and year of birth are inconsistent\";\n\t\t}\n\t\treturn \"\";\n\t});\n}\n\n// get height in pixels\nfunction getPx(opts){\n\tlet emVal = opts.font_size;\n\tif (emVal === parseInt(emVal, 10)) // test if integer\n\t\treturn emVal;\n\n\tif(emVal.indexOf(\"px\") > -1)\n\t\treturn emVal.replace('px', '');\n\telse if(emVal.indexOf(\"em\") === -1)\n\t\treturn emVal;\n\temVal = parseFloat(emVal.replace('em', ''));\n\treturn (parseFloat(getComputedStyle($('#'+opts.targetDiv).get(0)).fontSize)*emVal)-1.0;\n}\n\nfunction fontStringToPx(fontSize, basePx) {\n\tif(!fontSize) return basePx;\n\tif(typeof fontSize === 'number')\n\t\treturn fontSize;\n\tlet size = String(fontSize).trim();\n\tif(size.endsWith('px'))\n\t\treturn parseFloat(size);\n\tif(size.endsWith('em'))\n\t\treturn parseFloat(size) * basePx;\n\tif(!isNaN(parseFloat(size)))\n\t\treturn parseFloat(size);\n\treturn basePx;\n}\n","import  * as utils from './utils.js';\nimport {current as pedcache_current} from './pedcache.js';\n\n/**\n * Initialize drag-and-drop repositioning for pedigree nodes\n * Enables SHIFT + DRAG to reorder siblings horizontally within their generation\n * Updates dataset ordering and triggers rebuild to reflect new positions\n * @param {Object} opts - Pedigree options object\n * @param {Array} opts.dataset - Array of person objects\n * @param {string} opts.targetDiv - ID of the container div\n * @param {Object} node - D3 selection of nodes to make draggable\n * @example\n * // Hold SHIFT key and drag a person node left or right to reorder siblings\n */\nexport function init_dragging(opts, node) {\n\t// add drag\n\tnode.filter(function (d) {return !d.data.hidden;})\n\t    .call(d3.drag()\n\t\t\t\t.filter(function filter(event) {\n\t\t\t\t\treturn !event.ctrlKey && !event.button && event.shiftKey; \t// shift and drag\n\t\t\t\t})\n                .on(\"start\", dragstart)\n                .on(\"drag\", drag)\n                .on(\"end\", dragstop));\n\n\tlet xstart;\n\tlet xnew;\n\n    function dragstart() {\n\t\txstart = d3.select(this).select('.indi_rect').attr('x');\n\t}\n\t\n\tfunction drag(e) {\n\t\te.sourceEvent.stopPropagation();\n\t\tlet dx = e.dx;\n\t\tlet indir = d3.select(this).select('.indi_rect');\n\t\txnew = parseFloat(indir.attr('x'))+ dx;\n        indir.attr(\"x\", xnew);\n\t}\n\t\n\tfunction dragstop(_d) {\n\t\tlet me = d3.select(this).datum().data;\n\t\tlet pnrs = utils.get_partners(opts.dataset, me);\n\t\tlet pnrName = (pnrs.length === 1 ? utils.get_partners(opts.dataset, me)[0] : -1);\n\n\t\t// reset individuals rectangle\n\t\tlet indir = d3.select(this).select('.indi_rect');\n\t\tindir.attr(\"x\", xstart);\n\n\t\tconst isMovingRight = (xnew>xstart);\n\t\t\n\t\t// get depth of node being dragged\n\t\tlet root = utils.roots[opts.targetDiv];\n\t\tlet flat_tree = utils.flatten(root);\n\t\tlet meNode = utils.getNodeByName(flat_tree, me.name);\n\t\t\n\t\t// nodes at same depth\n\t\tlet dnodes = utils.getNodesAtDepth(utils.flatten(root), meNode.depth);\n\n\t\t// locate adjacent nodes\n\t\tlet lft_node, rgt_node, adj_node;\n\t\txnew += meNode.x;\n\t\tlet xlft = -Number.MAX_VALUE;\n\t\tlet xrgt =  Number.MAX_VALUE;\n\t\tfor(let i=0; i<dnodes.length; i++) {\n\t\t\tif(dnodes[i].x < xnew && dnodes[i].x > xlft) {\n\t\t\t\tlft_node = dnodes[i];\n\t\t\t\txlft = dnodes[i].x;\n\t\t\t} else if(dnodes[i].x > xnew && dnodes[i].x < xrgt) {\n\t\t\t\trgt_node = dnodes[i];\n\t\t\t\txrgt = dnodes[i].x;\n\t\t\t}\n\t\t}\n\t\tif(lft_node === undefined && rgt_node === undefined) return;\n\t\tlet adjIdx;\n\t\tif(isMovingRight) {\n\t\t\tadjIdx = utils.getIdxByName(opts.dataset, lft_node.data.name);\n\t\t\tadj_node = lft_node;\n\t\t} else {\n\t\t\tadjIdx = utils.getIdxByName(opts.dataset, rgt_node.data.name);\n\t\t\tadj_node = rgt_node;\n\t\t}\n\n\t\t// move node to new location in dataset\n        let newdataset = utils.copy_dataset(pedcache_current(opts));\n        let idx = utils.getIdxByName(opts.dataset, me.name);\n        el_move(newdataset, idx, adjIdx);\n        if(pnrName !== -1 && pnrName !== adj_node.data.name) {\n\t\t\tidx = utils.getIdxByName(newdataset, pnrName);\n\t\t\tel_move(newdataset, idx, adjIdx);\n        }\n        opts.dataset = newdataset;\n        $(document).trigger('rebuild', [opts]);\n\t}\n}\n\n// move element in array\nfunction el_move(arr, old_index, new_index) {\n    if (new_index >= arr.length) {\n        var k = new_index - arr.length + 1;\n        while (k--) {\n            arr.push(undefined);\n        }\n    }\n    arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);\n    return arr;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// Pedigree Tree Builder\nimport  * as utils from './utils.js';\nimport * as pbuttons from './pbuttons.js';\nimport * as pedcache from './pedcache.js';\nimport * as io from './io.js';\nimport {addWidgets} from './widgets.js';\nimport {init_zoom} from './zoom.js';\nimport {addLabels} from './labels.js';\nimport {init_dragging} from './dragging.js';\nimport {RENDERING_CONSTANTS as RC} from './rendering-constants.js';\n\n// Protection contre les race conditions lors de rebuilds concurrents\n// (Phase 3.1.1 - Correction UX/UI critique)\nlet _isBuilding = false;\n\n/**\n * Build and render a pedigree diagram\n * @param {Object} options - Configuration options for the pedigree\n * @param {string} options.targetDiv - ID of the HTML element to render the pedigree into\n * @param {Array} options.dataset - Array of person objects representing the pedigree\n * @param {number} [options.width=600] - Width of the SVG diagram in pixels\n * @param {number} [options.height=400] - Height of the SVG diagram in pixels\n * @param {number} [options.symbol_size=35] - Size of person symbols in pixels\n * @param {Array} [options.zoomSrc=['wheel', 'button']] - Zoom sources ('wheel', 'button')\n * @param {number} [options.zoomIn=1.0] - Maximum zoom in level\n * @param {number} [options.zoomOut=1.0] - Maximum zoom out level\n * @param {boolean} [options.dragNode=true] - Enable dragging nodes (SHIFT + drag)\n * @param {boolean} [options.showWidgets=true] - Show interactive widgets\n * @param {Array} [options.diseases] - Disease types to display with colors\n * @param {boolean} [options.validate=true] - Enable pedigree validation\n * @param {boolean} [options.DEBUG=false] - Enable debug mode (shows hidden nodes and logs)\n * @returns {void}\n * @example\n * pedigreejs.build({\n *   targetDiv: 'my_pedigree',\n *   dataset: [\n *     {name: \"father\", sex: \"M\", top_level: true},\n *     {name: \"mother\", sex: \"F\", top_level: true},\n *     {name: \"child\", sex: \"F\", mother: \"mother\", father: \"father\", proband: true}\n *   ]\n * });\n */\nexport function build(options) {\n\tlet opts = $.extend({ // defaults\n\t\ttargetDiv: 'pedigree_edit',\n\t\tdataset: [ {\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n\t\t\t\t   {\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n\t\t\t\t   {\"name\": \"ch1\", \"display_name\": \"me\", \"sex\": \"F\", \"mother\": \"f21\", \"father\": \"m21\", \"proband\": true}],\n\t\twidth: 600,\n\t\theight: 400,\n\t\tsymbol_size: 35,\n\t\tzoomSrc: ['wheel', 'button'],\n\t\tzoomIn: 1.0,\n\t\tzoomOut: 1.0,\n\t\tdragNode: true,\n\t\tshowWidgets: true,\n\t\tdiseases: [\t{'type': 'breast_cancer', 'colour': '#F68F35'},\n\t\t\t\t\t{'type': 'breast_cancer2', 'colour': 'pink'},\n\t\t\t\t\t{'type': 'ovarian_cancer', 'colour': '#306430'},\n\t\t\t\t\t{'type': 'pancreatic_cancer', 'colour': '#4289BA'},\n\t\t\t\t\t{'type': 'prostate_cancer', 'colour': '#D5494A'}],\n\t\tlabels: ['stillbirth', ['age', 'yob'], 'alleles',\n\t\t\t\t\t\t\t   ['brca1_gene_test', 'brca2_gene_test', 'palb2_gene_test', 'chek2_gene_test', 'atm_gene_test'],\n\t\t\t\t\t\t\t   ['rad51d_gene_test', 'rad51c_gene_test', 'brip1_gene_test', 'hoxb13_gene_test'],\n\t\t\t\t\t\t\t   ['er_bc_pathology', 'pr_bc_pathology', 'her2_bc_pathology', 'ck14_bc_pathology', 'ck56_bc_pathology']],\n\t\tkeep_proband_on_reset: false,\n\t\tfont_size: '.75em',\n\t\tfont_family: 'Helvetica',\n\t\tfont_weight: 700,\n\t\tbackground: \"#FAFAFA\",\n\t\tnode_background: '#fdfdfd',\n\t\t// Color options (Phase 3: Couleurs Configurables)\n\t\tnode_border_color: 'darkgrey',\n\t\tnode_border_color_with_data: '#303030',\n\t\tnode_border_color_no_data: 'grey',\n\t\tlink_color: '#000',\n\t\tlink_debug_color: 'pink',\n\t\taffected_fill_color: 'darkgrey',\n\t\tclash_indicator_color: '#D5494A',\n\t\tdead_line_color: 'black',\n\t\t// FIX: Interactive feedback colors\n\t\thover_color: '#FF5722',\n\t\t// FIX: Exclude fill color configurable (Phase 4 Critical Fix #5)\n\t\texclude_fill_color: 'lightgrey',\n\t\tvalidate: true,\n\t\tDEBUG: false,\n\t\tVERBOSE: false}, options );\n\n\tif ( $( \"#fullscreen\" ).length === 0 ) {\n\t\t// add undo, redo, fullscreen buttons and event listeners once\n\t\tpbuttons.addButtons(opts, rebuild, build);\n\t\tio.addIO(opts);\n\t}\n\n\tif(pedcache.nstore(opts) === -1)\n\t\tpedcache.init_cache(opts);\n\n\tpbuttons.updateButtons(opts);\n\n\t// validate pedigree data\n\tutils.validate_pedigree(opts);\n\t// group top level nodes by partners\n\topts.dataset = group_top_level(opts.dataset);\n\n\tif(opts.VERBOSE)\n\t\tutils.print_opts(opts);\n\tlet svg_dimensions = utils.get_svg_dimensions(opts);\n\tlet svg = d3.select(\"#\"+opts.targetDiv)\n\t\t\t\t .append(\"svg:svg\")\n\t\t\t\t .attr(\"width\", svg_dimensions.width)\n\t\t\t\t .attr(\"height\", svg_dimensions.height)\n\t\t\t\t // FIX: Accessibilité ARIA (WCAG 2.1 conformité)\n\t\t\t\t .attr(\"role\", \"img\")\n\t\t\t\t .attr(\"aria-label\", \"Diagramme de pedigree familial avec \" + opts.dataset.length + \" personne\" + (opts.dataset.length > 1 ? \"s\" : \"\"))\n\t\t\t\t .attr(\"aria-describedby\", opts.targetDiv + \"_desc\");\n\n\tsvg.append(\"rect\")\n\t\t.attr(\"width\", \"100%\")\n\t\t.attr(\"height\", \"100%\")\n\t\t.attr(\"rx\", 6)\n\t\t.attr(\"ry\", 6)\n\t\t.attr(\"stroke\", opts.node_border_color)\n\t\t.attr(\"fill\", opts.background) // or none\n\t\t.attr(\"stroke-width\", 1);\n\n\t// FIX: Description pour lecteurs d'écran\n\tsvg.append(\"desc\")\n\t\t.attr(\"id\", opts.targetDiv + \"_desc\")\n\t\t.text(\"Arbre généalogique interactif montrant les relations familiales, les statuts de santé et les informations génétiques. \" +\n\t\t\t  \"Utilisez la souris ou les touches Tab/Entrée pour naviguer entre les personnes.\");\n\n\tlet ped = svg.append(\"g\")\n\t\t\t .attr(\"class\", \"diagram\");\n\n\t// Phase 3.3.2: Indicateur visuel mode DEBUG\n\tif(opts.DEBUG) {\n\t\tsvg.append(\"rect\")\n\t\t\t.attr(\"x\", svg_dimensions.width - 120)\n\t\t\t.attr(\"y\", 5)\n\t\t\t.attr(\"width\", 110)\n\t\t\t.attr(\"height\", 25)\n\t\t\t.attr(\"fill\", \"#ff9800\")\n\t\t\t.attr(\"stroke\", \"#f57c00\")\n\t\t\t.attr(\"stroke-width\", 2)\n\t\t\t.attr(\"rx\", 3);\n\t\tsvg.append(\"text\")\n\t\t\t.attr(\"x\", svg_dimensions.width - 65)\n\t\t\t.attr(\"y\", 22)\n\t\t\t.attr(\"text-anchor\", \"middle\")\n\t\t\t.attr(\"fill\", \"white\")\n\t\t\t.attr(\"font-weight\", \"bold\")\n\t\t\t.attr(\"font-size\", \"12px\")\n\t\t\t.text(\"DEBUG MODE\");\n\t}\n\n\tlet top_level = $.map(opts.dataset, function(val, _i){return 'top_level' in val && val.top_level ? val : null;});\n\tlet hidden_root = {\n\t\tname : 'hidden_root',\n\t\tid : 0,\n\t\thidden : true,\n\t\tchildren : top_level\n\t};\n\n\tlet partners = utils.buildTree(opts, hidden_root, hidden_root)[0];\n\tlet root = d3.hierarchy(hidden_root);\n\troot._dataset = opts.dataset;\n\tutils.roots[opts.targetDiv] = root;\n\n\t// get score at each depth used to adjust node separation\n\tlet tree_dimensions = utils.get_tree_dimensions(opts);\n\tif(opts.DEBUG)\n\t\tconsole.log('opts.width='+svg_dimensions.width+' width='+tree_dimensions.width+\n\t\t\t\t\t' opts.height='+svg_dimensions.height+' height='+tree_dimensions.height);\n\n\tlet treemap = d3.tree().separation(function(a, b) {\n\t\treturn a.parent === b.parent || a.data.hidden || b.data.hidden ? RC.SEPARATION_SAME_PARENT : RC.SEPARATION_DIFFERENT;\n\t}).size([tree_dimensions.width, tree_dimensions.height]);\n\n\tlet nodes = treemap(root.sort(function(a, b) { return a.data.id - b.data.id; }));\n\tlet flattenNodes = nodes.descendants();\n\n\t// check the number of visible nodes equals the size of the pedigree dataset\n\tlet hidden_nodes = $.map(opts.dataset, function(p, _i){return is_hidden_data(p) ? p : null;});\n\tlet invalid_hidden = hidden_nodes.filter(function(p){return !p.partner_placeholder;});\n\tif(invalid_hidden.length > 0) {\n\t\tthrow utils.create_err('NUMBER OF VISIBLE NODES DIFFERENT TO NUMBER IN THE DATASET');\n\t}\n\n\tutils.adjust_coords(opts, nodes, flattenNodes);\n\n\tlet ptrLinkNodes = utils.linkNodes(flattenNodes, partners);\n\tlet clashes = check_ptr_links(opts, ptrLinkNodes);   // check for crossing of partner lines (Phase 3.1.2)\n\n\tlet node = ped.selectAll(\".node\")\n\t\t\t\t  .data(nodes.descendants())\n\t\t\t\t  .enter()\n\t\t\t\t  .append(\"g\")\n\t\t\t\t\t.attr(\"class\", function(d) {\n\t\t\t\t\t\tlet classes = [\"node\", \"person\"];\n\t\t\t\t\t\tif(d.data.sex === 'M') classes.push(\"male\");\n\t\t\t\t\t\telse if(d.data.sex === 'F') classes.push(\"female\");\n\t\t\t\t\t\telse classes.push(\"unknown-sex\");\n\n\t\t\t\t\t\tif(d.data.proband) classes.push(\"proband\");\n\t\t\t\t\t\tif(is_hidden_data(d.data)) classes.push(\"hidden\");\n\t\t\t\t\t\tif(d.data.affected) classes.push(\"affected\");\n\t\t\t\t\t\tif(d.data.adopted_in || d.data.adopted_out) classes.push(\"adopted\");\n\t\t\t\t\t\tif(d.data.status === \"1\" || d.data.status === 1) classes.push(\"deceased\");\n\n\t\t\t\t\t\treturn classes.join(\" \");\n\t\t\t\t\t})\n\t\t\t\t\t.attr(\"transform\", function(d, _i) {\n\t\t\t\t\t\treturn \"translate(\" + d.x + \",\" + d.y + \")\";\n\t\t\t\t\t})\n\t\t\t\t// FIX: Accessibilité - ARIA attributes pour navigation clavier\n\t\t\t\t.attr(\"role\", function(d) {\n\t\t\t\t\treturn is_hidden_data(d.data) ? null : \"button\";\n\t\t\t\t})\n\t\t\t\t.attr(\"tabindex\", function(d) {\n\t\t\t\t\treturn is_hidden_data(d.data) ? null : \"0\";\n\t\t\t\t})\n\t\t\t\t\t.attr(\"aria-label\", function(d) {\n\t\t\t\t\t\tif(is_hidden_data(d.data)) return null;\n\t\t\t\t\t\tlet label = d.data.display_name || d.data.name;\n\t\t\t\t\t\tlabel += \", \" + (d.data.sex === 'M' ? 'Homme' : d.data.sex === 'F' ? 'Femme' : 'Sexe inconnu');\n\t\t\t\t\t\tif(d.data.age) label += \", Âge \" + d.data.age + \" ans\";\n\t\t\t\t\t\tif(d.data.yob) label += \", Né en \" + d.data.yob;\n\t\t\t\t\t\tif(d.data.status === \"1\" || d.data.status === 1) label += \", Décédé\";\n\t\t\t\t\t\tif(d.data.affected) label += \", Affecté\";\n\t\t\t\t\t\tif(d.data.proband) label += \", Proband\";\n\t\t\t\t\t\treturn label;\n\t\t\t\t\t})\n\t\t\t\t\t.each(function(d) {\n\t\t\t\t\t\tlet sel = d3.select(this);\n\t\t\t\t\t\tsel.attr(\"data-affected\", d.data.affected ? \"true\" : null);\n\t\t\t\t\t\tif(Array.isArray(opts.diseases)) {\n\t\t\t\t\t\t\topts.diseases.forEach(function(dis) {\n\t\t\t\t\t\t\t\tif(!dis || !dis.type) return;\n\t\t\t\t\t\t\t\tlet attrName = \"data-\" + dis.type.replace(/_/g, \"-\");\n\t\t\t\t\t\t\t\tlet hasDisease = utils.prefixInObj(dis.type, d.data);\n\t\t\t\t\t\t\t\tsel.attr(attrName, hasDisease ? \"true\" : null);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t// FIX: Tooltips title pour accessibilité et UX\n\tnode.filter(function(d) {return !is_hidden_data(d.data);})\n\t\t.append(\"title\")\n\t\t.text(function(d) {\n\t\t\tlet text = d.data.display_name || d.data.name;\n\t\t\tif(d.data.sex) text += \"\\nSexe: \" + (d.data.sex === 'M' ? 'Homme' : d.data.sex === 'F' ? 'Femme' : 'Inconnu');\n\t\t\tif(d.data.age) text += \"\\nÂge: \" + d.data.age + \" ans\";\n\t\t\tif(d.data.yob) text += \"\\nNé(e) en: \" + d.data.yob;\n\t\t\tif(d.data.status === \"1\" || d.data.status === 1) text += \"\\nStatut: Décédé\";\n\t\t\tif(d.data.affected) text += \"\\nAffecté: Oui\";\n\t\t\tif(d.data.proband) text += \"\\n★ Proband\";\n\t\t\treturn text;\n\t\t});\n\n\t// FIX: Interactive feedback - hover states et cursor\n\tnode.filter(function(d) {return !is_hidden_data(d.data);})\n\t\t.style(\"cursor\", \"pointer\")\n\t\t.on(\"mouseover\", function(_event, _d) {\n\t\t\td3.select(this).select(\"path\").filter(function() {\n\t\t\t\t// Sélectionner seulement le path border, pas les brackets ou pie\n\t\t\t\treturn !d3.select(this).attr(\"clip-path\") &&\n\t\t\t\t\t   d3.select(this).attr(\"shape-rendering\");\n\t\t\t})\n\t\t\t.attr(\"stroke\", opts.hover_color)\n\t\t\t.attr(\"stroke-width\", function() {\n\t\t\t\t// FIX: Hover width = 2x thicker than with-data border (consistent scaling)\n\t\t\t\tlet baseWidth = opts.symbol_size * 0.05;\n\t\t\t\tlet withDataWidth = baseWidth * 1.5;\n\t\t\t\treturn withDataWidth * 2; // 2x for emphasis (= symbol_size * 0.15)\n\t\t\t});\n\t\t})\n\t\t.on(\"mouseout\", function(event, d) {\n\t\t\td3.select(this).select(\"path\").filter(function() {\n\t\t\t\treturn !d3.select(this).attr(\"clip-path\") &&\n\t\t\t\t\t   d3.select(this).attr(\"shape-rendering\");\n\t\t\t})\n\t\t\t.attr(\"stroke\", function() {\n\t\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ?\n\t\t\t\t\topts.node_border_color_with_data : opts.node_border_color_no_data;\n\t\t\t})\n\t\t\t.attr(\"stroke-width\", function() {\n\t\t\t\t// FIX: Use symbol_size-based scaling (same as initial border)\n\t\t\t\tlet baseWidth = opts.symbol_size * 0.05;\n\t\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? baseWidth * 1.5 : baseWidth;\n\t\t\t});\n\t\t});\n\n\t// provide a border to the node\n\tnode.filter(function (d) {return !is_hidden_data(d.data);})\n\t\t.append(\"path\")\n\t\t.attr(\"class\", \"person-shape\")\n\t\t.attr(\"shape-rendering\", \"geometricPrecision\")\n\t\t.attr(\"transform\", function(d) {return !has_gender(d.data.sex) && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\n\t\t.attr(\"d\", d3.symbol().size(function(_d) { return (opts.symbol_size * opts.symbol_size) + RC.SYMBOL_BORDER_EXTRA;})\n\t\t\t\t.type(function(d) {\n\t\t\t\t\tif(d.data.miscarriage || d.data.termination)\n\t\t\t\t\t\treturn d3.symbolTriangle;\n\t\t\t\t\treturn d.data.sex === \"F\" ? d3.symbolCircle : d3.symbolSquare;}))\n\t\t.attr(\"stroke\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? opts.node_border_color_with_data : opts.node_border_color_no_data;\n\t\t})\n\t\t.attr(\"stroke-width\", function (d) {\n\t\t\t// FIX: Use symbol_size-based scaling instead of em units (Phase 4 Critical Fix #3)\n\t\t\tlet baseWidth = opts.symbol_size * 0.05; // 5% of symbol_size\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? baseWidth * 1.5 : baseWidth;\n\t\t})\n\t\t.attr(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t.attr(\"fill\", \"none\");\n\n\t// set a clippath\n\t// FIX: Prefix clipPath IDs with targetDiv to avoid collisions when multiple pedigrees on same page\n\tnode.filter(function (d) {return !(is_hidden_data(d.data) && !opts.DEBUG);})\n\t\t.append(\"clipPath\")\n\t\t.attr(\"id\", function (d) {return getClipPathId(opts, d.data);}).append(\"path\")\n\t\t.attr(\"class\", \"clippath-shape\")\n\t\t.attr(\"transform\", function(d) {return !has_gender(d.data.sex) && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\n\t\t\t.attr(\"d\", d3.symbol().size(function(d) {\n\t\t\t\t// Hidden nodes get smaller clipPath (scaled) for compact DEBUG rendering\n\t\t\t\tlet hiddenScale = RC.HIDDEN_NODE_SIZE_FACTOR || 0.2;\n\t\t\t\t// Note: Hidden nodes should not have diseases/pie charts, so this is primarily for structure\n\t\t\t\tif (is_hidden_data(d.data))\n\t\t\t\t\treturn opts.symbol_size * opts.symbol_size * hiddenScale;\n\t\t\t\treturn opts.symbol_size * opts.symbol_size;\n\t\t\t})\n\t\t\t.type(function(d) {\n\t\t\t\tif(d.data.miscarriage || d.data.termination)\n\t\t\t\t\treturn d3.symbolTriangle;\n\t\t\t\treturn d.data.sex === \"F\" ? d3.symbolCircle :d3.symbolSquare;}));\n\n\t// pie plots for disease colours\n\tlet pienode = node.filter(function (d) {return !(is_hidden_data(d.data) && !opts.DEBUG);}).selectAll(\"pienode\")\n\t   .data(function(d) {\t \t\t// set the disease data for the pie plot\n\t\t   let ncancers = 0;\n\t\t   let cancers = $.map(opts.diseases, function(_val, i){\n\t\t\t   if(utils.prefixInObj(opts.diseases[i].type, d.data)) {ncancers++; return 1;} else return 0;\n\t\t   });\n\t\t   if(ncancers === 0) cancers = [1];\n\t\t   let clipId = getClipPathId(opts, d.data);\n\t\t   return [$.map(cancers, function(val, _i){\n\t\t\t   return {'cancer': val, 'ncancers': ncancers, 'id': d.data.name,\n\t\t\t\t\t\t'sex': d.data.sex, 'proband': d.data.proband, 'hidden': d.data.hidden,\n\t\t\t\t\t\t'affected': d.data.affected,\n\t\t\t\t\t\t'exclude': d.data.exclude,\n\t\t\t\t\t\t'clipId': clipId};})];\n\t   })\n\t   .enter()\n\t\t.append(\"g\");\n\n\tconst pieInnerRadius = (typeof RC.PIE_INNER_RADIUS === 'number' ? RC.PIE_INNER_RADIUS : 0);\n\tconst pieOuterRadius = opts.symbol_size * (typeof RC.PIE_OUTER_RADIUS_FACTOR === 'number' ? RC.PIE_OUTER_RADIUS_FACTOR : 0.5);\n\n\tpienode.selectAll(\"path\")\n\t\t.data(d3.pie().value(function(d) {return d.cancer;}))\n\t\t.enter().append(\"path\")\n\t\t\t.attr(\"clip-path\", function(d) {return \"url(#\"+d.data.clipId+\")\";}) // clip the rectangle (with prefix)\n\t\t\t.attr(\"class\", \"pienode\")\n\t\t\t.attr(\"d\", d3.arc().innerRadius(pieInnerRadius).outerRadius(pieOuterRadius))\n\t\t\t.attr(\"fill\", function(d, i) {\n\t\t\t\tif(d.data.exclude)\n\t\t\t\t\treturn opts.exclude_fill_color; // FIX: Configurable exclude color\n\t\t\t\tif(d.data.ncancers === 0) {\n\t\t\t\t\tif(d.data.affected)\n\t\t\t\t\t\treturn opts.affected_fill_color;\n\t\t\t\t\treturn opts.node_background;\n\t\t\t\t}\n\t\t\t\treturn opts.diseases[i].colour;\n\t\t\t});\n\n\t// adopted in/out brackets\n\tnode.filter(function (d) {return !is_hidden_data(d.data) && (d.data.adopted_in || d.data.adopted_out);})\n\t\t.append(\"path\")\n\t\t.attr(\"d\", function(_d) {\n\t\t\tlet dx = -(opts.symbol_size * RC.BRACKET_X_OFFSET_FACTOR);\n\t\t\tlet dy = -(opts.symbol_size * RC.BRACKET_Y_OFFSET_FACTOR);\n\t\t\tlet indent = opts.symbol_size / RC.BRACKET_INDENT_DIVISOR;\n\t\t\treturn get_bracket(dx, dy, indent, opts)+get_bracket(-dx, dy, -indent, opts);\n\t\t\t})\n\t\t.attr(\"stroke\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? opts.node_border_color_with_data : opts.node_border_color_no_data;\n\t\t})\n\t\t.attr(\"stroke-width\", function (_d) {\n\t\t\t// FIX: Use symbol_size-based scaling for brackets (same base as thin border)\n\t\t\treturn opts.symbol_size * 0.05;\n\t\t})\n\t\t.attr(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t.attr(\"fill\", \"none\");\n\n\n\t// alive status = 0; dead status = 1\n\tnode.filter(function (d) {return d.data.status === \"1\" || d.data.status === 1;})\n\t\t.append('line')\n\t\t\t.attr(\"stroke\", opts.dead_line_color)\n\t\t\t.attr(\"x1\", function(_d, _i) {return -RC.DEAD_LINE_SIZE_FACTOR*opts.symbol_size;})\n\t\t\t.attr(\"y1\", function(_d, _i) {return RC.DEAD_LINE_SIZE_FACTOR*opts.symbol_size;})\n\t\t\t.attr(\"x2\", function(_d, _i) {return RC.DEAD_LINE_SIZE_FACTOR*opts.symbol_size;})\n\t\t\t.attr(\"y2\", function(_d, _i) {return -RC.DEAD_LINE_SIZE_FACTOR*opts.symbol_size;});\n\n/*\n * let warn = node.filter(function (d) { return (!d.data.age || !d.data.yob) && !d.data.hidden; }).append(\"text\") .attr('font-family', 'FontAwesome')\n * .attr(\"x\", \".25em\") .attr(\"y\", -(0.4 * opts.symbol_size), -(0.2 * opts.symbol_size)) .html(\"\\uf071\"); warn.append(\"svg:title\").text(\"incomplete\");\n */\n\t// add display names and labels defined by opts.labels\n\taddLabels(opts, node);\n\n\t//\n\tif(opts.showWidgets) addWidgets(opts, node);\n\n\t// links between partners\n\tlet clash_depth = {};\n\n\t// get path looping over node(s)\n\tlet draw_path = function(clash, dx, dy1, dy2, parent_node, cshift) {\n\t\t// Extend consecutive clash indices to merge nearby clashes\n\t\t// Note: Distance check disabled - merges all consecutive clashes regardless of proximity\n\t\tlet extend = function(i, l) {\n\t\t\tif(i+1 < l)\n\t\t\t\treturn extend(++i);\n\t\t\treturn i;\n\t\t};\n\t\tlet path = \"\";\n\t\tfor(let j=0; j<clash.length; j++) {\n\t\t\tlet k = extend(j, clash.length);\n\t\t\tlet dx1 = clash[j] - dx - cshift;\n\t\t\tlet dx2 = clash[k] + dx + cshift;\n\t\t\tif(parent_node.x > dx1 && parent_node.x < dx2)\n\t\t\t\tparent_node.y = dy2;\n\n\t\t\tpath += \"L\" + dx1 + \",\" +  (dy1 - cshift) +\n\t\t\t\t\t\"L\" + dx1 + \",\" +  (dy2 - cshift) +\n\t\t\t\t\t\"L\" + dx2 + \",\" +  (dy2 - cshift) +\n\t\t\t\t\t\"L\" + dx2 + \",\" +  (dy1 - cshift);\n\t\t\tj = k;\n\t\t}\n\t\treturn path;\n\t}\n\n\n\tpartners = ped.selectAll(\".partner\")\n\t\t.data(ptrLinkNodes)\n\t\t.enter()\n\t\t\t.insert(\"path\", \"g\")\n\t\t\t.attr(\"class\", function(d) {\n\t\t\t\tlet classes = [\"partner\", \"partner-link\"];\n\t\t\t\tlet node1 = utils.getNodeByName(flattenNodes, d.mother.data.name);\n\t\t\t\tlet node2 = utils.getNodeByName(flattenNodes, d.father.data.name);\n\t\t\t\tlet consanguity = utils.consanguity(node1, node2, opts);\n\t\t\t\tlet divorced = (d.mother.data.divorced && d.mother.data.divorced === d.father.data.name);\n\n\t\t\t\tif(consanguity) classes.push(\"consanguineous\");\n\t\t\t\tif(divorced) classes.push(\"divorced\");\n\t\t\t\tif(d.mother.data.sex === d.father.data.sex && d.mother.data.sex !== 'U')\n\t\t\t\t\tclasses.push(\"same-sex\");\n\n\t\t\t\treturn classes.join(\" \");\n\t\t\t})\n\t\t\t.attr(\"fill\", \"none\")\n\t\t\t.attr(\"stroke\", opts.link_color)\n\t\t\t.attr(\"shape-rendering\", \"auto\")\n\t\t\t.attr('d', function(d, _i) {\n\t\t\t\tlet node1 = utils.getNodeByName(flattenNodes, d.mother.data.name);\n\t\t\t\tlet node2 = utils.getNodeByName(flattenNodes, d.father.data.name);\n\t\t\t\tlet consanguity = utils.consanguity(node1, node2, opts);\n\t\t\t\tlet divorced = (d.mother.data.divorced &&  d.mother.data.divorced === d.father.data.name);\n\n\t\t\t\tlet x1 = (d.mother.x < d.father.x ? d.mother.x : d.father.x);\n\t\t\t\tlet x2 = (d.mother.x < d.father.x ? d.father.x : d.mother.x);\n\t\t\t\tlet dy1 = d.mother.y;\n\t\t\t\tlet dy2, dx, parent_node;\n\n\t\t\t\t// identify clashes with other nodes at the same depth\n\t\t\t\tlet clash = check_ptr_link_clashes(opts, d);\n\t\t\t\tlet path = \"\";\n\t\t\t\tif(clash) {\n\t\t\t\t\tif(d.mother.depth in clash_depth)\n\t\t\t\t\t\tclash_depth[d.mother.depth] += 4;\n\t\t\t\t\telse\n\t\t\t\t\t\tclash_depth[d.mother.depth] = 4;\n\n\t\t\t\t\tdy1 -= clash_depth[d.mother.depth];\n\t\t\t\t\tdx = clash_depth[d.mother.depth] + (opts.symbol_size/2) + 2;\n\n\t\t\t\t\tlet parent_nodes = d.mother.data.parent_node;\n\t\t\t\t\tlet parent_node_name = parent_nodes[0];\n\t\t\t\t\tfor(let ii=0; ii<parent_nodes.length; ii++) {\n\t\t\t\t\t\tif(parent_nodes[ii].father.name === d.father.data.name &&\n\t\t\t\t\t\t   parent_nodes[ii].mother.name === d.mother.data.name)\n\t\t\t\t\t\t\tparent_node_name = parent_nodes[ii].name;\n\t\t\t\t\t}\n\t\t\t\t\tparent_node = utils.getNodeByName(flattenNodes, parent_node_name);\n\t\t\t\t\tparent_node.y = dy1; // adjust hgt of parent node\n\t\t\t\t\tclash.sort(function (a,b) {return a - b;});\n\n\t\t\t\t\tdy2 = (dy1-(opts.symbol_size/2)-3);\n\t\t\t\t\tpath = draw_path(clash, dx, dy1, dy2, parent_node, 0);\n\t\t\t\t}\n\n\t\t\t\tlet divorce_path = \"\";\n\t\t\t\tif(divorced) {\n\t\t\t\t\t// FIX: Draw divorce symbol even with clash (Phase 4.1)\n\t\t\t\t\t// Adjust Y position when clash to avoid overlap\n\t\t\t\t\tlet divorce_y_offset = clash ? 8 : 0;\n\t\t\t\t\tdivorce_path = \"M\" + (x1+((x2-x1)*.66)+6) + \",\" + (dy1-6-divorce_y_offset) +\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-6) + \",\" + (dy1+6-divorce_y_offset) +\n\t\t\t\t\t\t\t\t   \"M\" + (x1+((x2-x1)*.66)+10) + \",\" + (dy1-6-divorce_y_offset) +\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-2)  + \",\" + (dy1+6-divorce_y_offset);\n\t\t\t\t}\n\t\t\t\tif(consanguity) {  // consanguinous, draw double line between partners\n\t\t\t\t\tdy1 = (d.mother.x < d.father.x ? d.mother.y : d.father.y);\n\t\t\t\t\tdy2 = (d.mother.x < d.father.x ? d.father.y : d.mother.y);\n\n\t\t\t\t\tlet cshift = RC.CONSANGUINITY_LINE_OFFSET;\n\t\t\t\t\tif(Math.abs(dy1-dy2) > 0.1) {\t  // DIFFERENT LEVEL\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + \"L\" + x2 + \",\" + dy2 +\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + \"L\" + x2 + \",\" + (dy2 - cshift);\n\t\t\t\t\t} else {\t\t\t\t\t\t   // SAME LEVEL\n\t\t\t\t\t\tlet path2 = (clash ? draw_path(clash, dx, dy1, dy2, parent_node, cshift) : \"\");\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 +\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + path2 + \"L\" + x2 + \",\" + (dy1 - cshift) + divorce_path;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 + divorce_path;\n\t\t\t});\n\n\t// Phase 3.1.2 - Appliquer feedback visuel aux liens qui clashent\n\tif(clashes.length > 0) {\n\t\tpartners.each(function(d) {\n\t\t\t// Vérifier si ce lien a un clash\n\t\t\tlet hasClash = clashes.some(c =>\n\t\t\t\t(c.node.mother.data.name === d.mother.data.name &&\n\t\t\t\t c.node.father.data.name === d.father.data.name)\n\t\t\t);\n\n\t\t\tif(hasClash) {\n\t\t\t\td3.select(this)\n\t\t\t\t\t.attr('stroke', opts.clash_indicator_color)  // Rouge\n\t\t\t\t\t.attr('stroke-width', 2.5)\n\t\t\t\t\t.attr('stroke-dasharray', '5,5')\n\t\t\t\t\t.append('title')\n\t\t\t\t\t.text('⚠️ Avertissement : Ce lien croise d\\'autres liens de partenaires. Le tracé a été ajusté pour éviter les chevauchements.');\n\t\t\t}\n\t\t});\n\n\t\t// FIX: Framework compatibility - Use native SVG rather than foreignObject\n\t\tif(!opts.DEBUG) {\n\t\t\tsvg.selectAll('.pedigree-warning-container').remove();\n\n\t\t\tlet warningWidth = Math.min(svg_dimensions.width - 20, 420);\n\t\t\tlet warningHeight = 54;\n\t\t\tlet warningGroup = svg.append(\"g\")\n\t\t\t\t.attr(\"class\", \"pedigree-warning-container\")\n\t\t\t\t.attr(\"pointer-events\", \"none\");\n\n\t\t\twarningGroup.append(\"rect\")\n\t\t\t\t.attr(\"width\", warningWidth)\n\t\t\t\t.attr(\"height\", warningHeight)\n\t\t\t\t.attr(\"rx\", 6)\n\t\t\t\t.attr(\"ry\", 6)\n\t\t\t\t.attr(\"fill\", \"#FFF3CD\")\n\t\t\t\t.attr(\"stroke\", \"#FFC107\")\n\t\t\t\t.attr(\"stroke-width\", 1.2);\n\n\t\t\twarningGroup.append(\"text\")\n\t\t\t\t.attr(\"x\", 16)\n\t\t\t\t.attr(\"y\", 22)\n\t\t\t\t.attr(\"fill\", \"#5f3b00\")\n\t\t\t\t.attr(\"font-size\", \"13px\")\n\t\t\t\t.attr(\"font-weight\", \"600\")\n\t\t\t\t.text(\"⚠️ Avertissement : \" + clashes.length + \" lien(s) se croisent.\");\n\n\t\t\twarningGroup.append(\"text\")\n\t\t\t\t.attr(\"x\", 16)\n\t\t\t\t.attr(\"y\", 40)\n\t\t\t\t.attr(\"fill\", \"#5f3b00\")\n\t\t\t\t.attr(\"font-size\", \"12px\")\n\t\t\t\t.text(\"Les liens en rouge pointillé ont été ajustés pour éviter les chevauchements.\");\n\n\t\t\tlet updateWarningOverlay = function(transform) {\n\t\t\t\tlet targetSvg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\n\t\t\t\tlet warning = targetSvg.selectAll(\".pedigree-warning-container\");\n\t\t\t\tif(warning.empty()) return;\n\t\t\t\tlet svgWidth = targetSvg.node() ? targetSvg.node().clientWidth : svg_dimensions.width;\n\t\t\t\tlet width = Math.min(svgWidth - 20, 420);\n\t\t\t\twarning.select(\"rect\").attr(\"width\", width);\n\t\t\t\tlet tx = 10;\n\t\t\t\tlet ty = 10;\n\t\t\t\tif(transform) {\n\t\t\t\t\tlet scale = transform.k || 1;\n\t\t\t\t\tlet x = (tx - transform.x) / scale;\n\t\t\t\t\tlet y = (ty - transform.y) / scale;\n\t\t\t\t\twarning.attr(\"transform\", \"translate(\"+x+\",\"+y+\") scale(\"+ (1/scale) +\")\");\n\t\t\t\t} else {\n\t\t\t\t\twarning.attr(\"transform\", \"translate(\"+tx+\",\"+ty+\")\");\n\t\t\t\t}\n\t\t\t};\n\t\t\topts._updateWarningOverlay = updateWarningOverlay;\n\t\t\tupdateWarningOverlay();\n\t\t}\n\t} else {\n\t\t// Pas de clashes, enlever le warning s'il existe\n\t\tsvg.selectAll('.pedigree-warning-container').remove();\n\t\topts._updateWarningOverlay = null;\n\t}\n\n\t// links to children\n\tped.selectAll(\".link\")\n\t\t.data(root.links(nodes.descendants()))\n\t\t.enter()\n\t\t\t.filter(function (d) {\n\t\t\t\t// filter unless debug is set\n\t\t\t\treturn (opts.DEBUG ||\n\t\t\t\t\t\t(d.target.data.noparents === undefined && d.source.parent !== null && !d.target.data.hidden));\n\t\t\t})\n\t\t\t.insert(\"path\", \"g\")\n\t\t\t.attr(\"class\", function(d) {\n\t\t\t\tlet classes = [\"link\", \"child-link\"];\n\t\t\t\tif(d.target.data.adopted_in) classes.push(\"adopted-link\");\n\t\t\t\tif(d.target.data.mztwin) classes.push(\"mz-twin-link\");\n\t\t\t\tif(d.target.data.dztwin) classes.push(\"dz-twin-link\");\n\t\t\t\tif(d.target.data.noparents || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\tclasses.push(\"debug-link\");\n\t\t\t\treturn classes.join(\" \");\n\t\t\t})\n\t\t\t.attr(\"fill\", \"none\")\n\t\t\t.attr(\"stroke-width\", function(d, _i) {\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\treturn 1;\n\t\t\t\treturn (opts.DEBUG ? 2 : 1);\n\t\t\t})\n\t\t\t.attr(\"stroke\", function(d, _i) {\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\treturn opts.link_debug_color;\n\t\t\t\treturn opts.link_color;\n\t\t\t})\n\t\t\t.attr(\"stroke-dasharray\", function(d, _i) {\n\t\t\t\tif(!d.target.data.adopted_in) return null;\n\t\t\t\tlet dash_len = Math.abs(d.source.y-((d.source.y + d.target.y) / 2));\n\t\t\t\tlet dash_array = [dash_len, 0, Math.abs(d.source.x-d.target.x), 0];\n\t\t\t\tlet twins = utils.getTwins(opts.dataset, d.target.data);\n\t\t\t\tif(twins.length >= 1) dash_len = dash_len * 3;\n\t\t\t\tfor(let usedlen = 0; usedlen < dash_len; usedlen += 10)\n\t\t\t\t\t$.merge(dash_array, [5, 5]);\n\t\t\t\treturn dash_array;\n\t\t\t})\n\t\t\t.attr(\"shape-rendering\", function(d, _i) {\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin)\n\t\t\t\t\treturn \"geometricPrecision\";\n\t\t\t\treturn \"auto\";\n\t\t\t})\n\t\t\t.attr(\"d\", function(d, _i) {\n\t\t\t\tlet forkOffset = RC.CHILD_LINK_FORK_OFFSET || 0;\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin) {\n\t\t\t\t\t// get twin position\n\t\t\t\t\tlet twins = utils.getTwins(opts.dataset, d.target.data);\n\t\t\t\t\tif(twins.length >= 1) {\n\t\t\t\t\t\tlet twinx = 0;\n\t\t\t\t\t\tlet xmin = d.target.x;\n\t\t\t\t\t\tfor(let t=0; t<twins.length; t++) {\n\t\t\t\t\t\t\tlet thisx = utils.getNodeByName(flattenNodes, twins[t].name).x;\n\t\t\t\t\t\t\tif(xmin > thisx) xmin = thisx;\n\t\t\t\t\t\t\ttwinx += thisx;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet xmid = ((d.target.x + twinx) / (twins.length+1));\n\t\t\t\t\t\tlet ymid = ((d.source.y + d.target.y) / 2) + forkOffset;\n\n\t\t\t\t\t\tlet xhbar = \"\";\n\t\t\t\t\t\tif(xmin === d.target.x && d.target.data.mztwin) {\n\t\t\t\t\t\t\t// horizontal bar for mztwins\n\t\t\t\t\t\t\tlet yy = (ymid + (d.target.y-(opts.symbol_size/2)))/2;\n\t\t\t\t\t\t\tlet half = opts.symbol_size / (RC.TWIN_BAR_LENGTH_DIVISOR || 6);\n\t\t\t\t\t\t\tlet start = xmid - half;\n\t\t\t\t\t\t\tlet end = xmid + half;\n\t\t\t\t\t\t\txhbar = \"M\" + start + \",\" + yy + \"L\" + end + \",\" + yy;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t\t\t   \"V\" + ymid +\n\t\t\t\t\t\t\t   \"H\" + xmid +\n\t\t\t\t\t\t\t   \"L\" + (d.target.x) + \" \" + (d.target.y-(opts.symbol_size/2)) +\n\t\t\t\t\t\t\t   xhbar;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\tif(d.source.data.mother && d.source.data.father) {   // check parents depth to see if they are at the same level in the tree\n\t\t\t\tlet motherName = typeof d.source.data.mother === 'string' ? d.source.data.mother : d.source.data.mother.name;\n\t\t\t\tlet fatherName = typeof d.source.data.father === 'string' ? d.source.data.father : d.source.data.father.name;\n\t\t\t\tif(motherName && fatherName) {\n\t\t\t\t\tlet ma = utils.getNodeByName(flattenNodes, motherName);\n\t\t\t\t\tlet pa = utils.getNodeByName(flattenNodes, fatherName);\n\n\t\t\t\t\tif(ma && pa && ma.depth !== pa.depth) {\n\t\t\t\t\t\tlet forkY = ((ma.y + pa.y) / 2) + forkOffset;\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + forkY +\n\t\t\t\t\t\t   \"H\" + (d.target.x) +\n\t\t\t\t\t\t   \"V\" + (d.target.y);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t\tlet forkY = ((d.source.y + d.target.y) / 2) + forkOffset;\n\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t   \"V\" + forkY +\n\t\t\t\t\t   \"H\" + (d.target.x) +\n\t\t\t\t\t   \"V\" + (d.target.y);\n\t\t\t});\n\n\t// draw proband arrow\n\tlet probandIdx  = utils.getProbandIndex(opts.dataset);\n\tif(typeof probandIdx !== 'undefined') {\n\t\tlet probandNode = utils.getNodeByName(flattenNodes, opts.dataset[probandIdx].name);\n\t\t// Check if probandNode exists (may be undefined if tree not fully built)\n\t\tif(probandNode) {\n\t\t\tlet triid = \"triangle\"+utils.makeid(3);\n\t\t\t// FIX: Scale arrow head with symbol_size (Phase 4.4)\n\t\t\tlet arrowHeadSize = Math.max(opts.symbol_size / RC.ARROW_HEAD_SIZE_DIVISOR, 6);\n\t\t\tlet arrowRefPoint = arrowHeadSize / 2;\n\n\t\t\tped.append(\"svg:defs\").append(\"svg:marker\")\t// arrow head\n\t\t\t\t.attr(\"id\", triid)\n\t\t\t\t.attr(\"refX\", arrowRefPoint)\n\t\t\t\t.attr(\"refY\", arrowRefPoint)\n\t\t\t\t.attr(\"markerWidth\", arrowHeadSize * 2)\n\t\t\t\t.attr(\"markerHeight\", arrowHeadSize * 2)\n\t\t\t\t.attr(\"orient\", \"auto\")\n\t\t\t\t.append(\"path\")\n\t\t\t\t.attr(\"d\", \"M 0 0 \" + arrowHeadSize + \" \" + arrowRefPoint + \" 0 \" + arrowHeadSize + \" \" + (arrowHeadSize/4) + \" \" + arrowRefPoint)\n\t\t\t\t.attr(\"fill\", \"black\");\n\n\t\t\tped.append(\"line\")\n\t\t\t\t.attr(\"x1\", probandNode.x-(opts.symbol_size/RC.ARROW_X_DIVISOR))\n\t\t\t\t.attr(\"y1\", probandNode.y+(opts.symbol_size/RC.ARROW_Y_DIVISOR))\n\t\t\t\t.attr(\"x2\", probandNode.x-(opts.symbol_size/RC.ARROW_Y_DIVISOR))\n\t\t\t\t.attr(\"y2\", probandNode.y+(opts.symbol_size/4))\n\t\t\t\t.attr(\"stroke-width\", 1)\n\t\t\t\t.attr(\"stroke\", \"black\")\n\t\t\t\t.attr(\"marker-end\", \"url(#\"+triid+\")\");\n\t\t}\n\t}\n\n\t// drag and zoom\n\tinit_zoom(opts, svg);\n\t// drag nodes\n\tif(opts.dragNode) init_dragging(opts, node);\n\treturn opts;\n}\n\nfunction has_gender(sex) {\n\treturn sex === \"M\" || sex === \"F\";\n}\n\nfunction is_hidden_data(data) {\n\treturn data && (data.hidden || data.partner_placeholder);\n}\n\nfunction sanitizeIdFragment(value) {\n\tlet fragment = (value === undefined || value === null ? \"\" : String(value)).trim();\n\tif(fragment === \"\")\n\t\tfragment = \"id\";\n\tfragment = fragment.replace(/[^A-Za-z0-9_-]/g, \"-\")\n\t\t\t\t\t   .replace(/-+/g, \"-\")\n\t\t\t\t\t   .replace(/^-+/, \"\");\n\tif(fragment === \"\" || !/^[A-Za-z_]/.test(fragment))\n\t\tfragment = \"id-\" + fragment;\n\treturn fragment;\n}\n\nfunction setHiddenMetadata(obj, key, value) {\n\ttry {\n\t\tObject.defineProperty(obj, key, {\n\t\t\tvalue: value,\n\t\t\tconfigurable: true,\n\t\t\tenumerable: false,\n\t\t\twritable: true\n\t\t});\n\t} catch(_err) {\n\t\tobj[key] = value;\n\t}\n}\n\nfunction getClipPathId(opts, person) {\n\tif(!person)\n\t\treturn opts.targetDiv + \"_clip_id-\" + utils.makeid(4);\n\tif(person.__clipId && person.__clipSource === person.name)\n\t\treturn person.__clipId;\n\tlet fragment = sanitizeIdFragment(person.name);\n\tfragment += \"-\" + utils.makeid(3);\n\tlet clipId = opts.targetDiv + \"_clip_\" + fragment;\n\tsetHiddenMetadata(person, \"__clipSource\", person.name);\n\tsetHiddenMetadata(person, \"__clipId\", clipId);\n\treturn clipId;\n}\n\n//adopted in/out brackets\n// FIX: Make bracket height relative to symbol_size with better scaling\n// Instead of hardcoded 1.28, use a proportional factor that works for all sizes\nfunction get_bracket(dx, dy, indent, opts) {\n\t// Bracket height scales with symbol: small symbols = shorter brackets, large = taller\n\t// Factor defined in RENDERING_CONSTANTS gives good visual balance across sizes\n\tlet bracket_height = opts.symbol_size * RC.BRACKET_HEIGHT_FACTOR;\n\n\treturn \t\"M\" + (dx+indent) + \",\" + dy +\n\t\t\t\"L\" + dx + \" \" + dy +\n\t\t\t\"L\" + dx + \" \" + (dy + bracket_height) +\n\t\t\t\"L\" + (dx+indent) + \",\" + (dy + bracket_height);\n}\n\n// check for crossing of partner lines\n// Phase 3.1.2 - Modifié pour retourner les clashes pour feedback visuel\nfunction check_ptr_links(opts, ptrLinkNodes){\n\tlet clashes = [];\n\tfor(let a=0; a<ptrLinkNodes.length; a++) {\n\t\tlet clash = check_ptr_link_clashes(opts, ptrLinkNodes[a]);\n\t\tif(clash) {\n\t\t\tclashes.push({node: ptrLinkNodes[a], clash: clash});\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log(\"CLASH :: \"+ptrLinkNodes[a].mother.data.name+\" \"+ptrLinkNodes[a].father.data.name, clash);\n\t\t}\n\t}\n\treturn clashes;\n}\n\nexport function check_ptr_link_clashes(opts, anode) {\n\tlet root = utils.roots[opts.targetDiv];\n\tlet flattenNodes = utils.flatten(root);\n\tlet mother, father;\n\tif('name' in anode) {\n\t\tanode = utils.getNodeByName(flattenNodes, anode.name);\n\t\tif(!anode || !('mother' in anode.data))\n\t\t\treturn null;\n\t\tlet motherName = (typeof anode.data.mother === 'string' ? anode.data.mother : anode.data.mother?.name);\n\t\tlet fatherName = (typeof anode.data.father === 'string' ? anode.data.father : anode.data.father?.name);\n\t\tif(!motherName || !fatherName)\n\t\t\treturn null;\n\t\tmother = utils.getNodeByName(flattenNodes, motherName);\n\t\tfather = utils.getNodeByName(flattenNodes, fatherName);\n\t} else {\n\t\tmother = anode.mother;\n\t\tfather = anode.father;\n\t}\n\tif(!mother || !father)\n\t\treturn null;\n\tif(mother.data === undefined || father.data === undefined) {\n\t\tmother = utils.getNodeByName(flattenNodes, mother.name || mother.data?.name);\n\t\tfather = utils.getNodeByName(flattenNodes, father.name || father.data?.name);\n\t}\n\tif(!mother || !father || mother.x === undefined || father.x === undefined)\n\t\treturn null;\n\n\tlet x1 = (mother.x < father.x ? mother.x : father.x);\n\tlet x2 = (mother.x < father.x ? father.x : mother.x);\n\tlet dy = mother.y;\n\n\t// identify clashes with other nodes at the same depth\n\tlet clash = $.map(flattenNodes, function(bnode, _i){\n\t\treturn !bnode.data.hidden &&\n\t\t\t\tbnode.data.name !== mother.data.name &&  bnode.data.name !== father.data.name &&\n\t\t\t\tbnode.y === dy && bnode.x > x1 && bnode.x < x2 ? bnode.x : null;\n\t});\n\treturn clash.length > 0 ? clash : null;\n}\n\n// group top_level nodes by their partners\nfunction group_top_level(dataset) {\n\t// let top_level = $.map(dataset, function(val, i){return 'top_level' in val && val.top_level ? val : null;});\n\t// calculate top_level nodes\n\tfor(let i=0;i<dataset.length;i++) {\n\t\tif(utils.getDepth(dataset, dataset[i].name) === 2)\n\t\t\tdataset[i].top_level = true;\n\t}\n\n\tlet top_level = [];\n\tlet top_level_seen = [];\n\tfor(let i=0;i<dataset.length;i++) {\n\t\tlet node = dataset[i];\n\t\tif('top_level' in node && $.inArray(node.name, top_level_seen) === -1){\n\t\t\ttop_level_seen.push(node.name);\n\t\t\ttop_level.push(node);\n\t\t\tlet ptrs = utils.get_partners(dataset, node);\n\t\t\tfor(let j=0; j<ptrs.length; j++){\n\t\t\t\tif($.inArray(ptrs[j], top_level_seen) === -1) {\n\t\t\t\t\ttop_level_seen.push(ptrs[j]);\n\t\t\t\t\ttop_level.push(utils.getNodeByName(dataset, ptrs[j]));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tlet newdataset = $.map(dataset, function(val, _i){return 'top_level' in val && val.top_level ? null : val;});\n\tfor (let i = top_level.length; i > 0; --i)\n\t\tnewdataset.unshift(top_level[i-1]);\n\treturn newdataset;\n}\n\n/**\n * Rebuild the pedigree diagram from scratch\n * Clears the target div, reinitializes the cache, and rebuilds the entire pedigree.\n * This function is called when the dataset changes or when user interactions require a full redraw.\n * @param {Object} opts - The same options object used in build()\n * @throws {Error} If build fails\n * @see build\n * @example\n * pedigreejs.rebuild(opts);\n */\nexport function rebuild(opts) {\n\t$(\"#\"+opts.targetDiv).empty();\n\tpedcache.init_cache(opts);\n\ttry {\n\t\tbuild(opts);\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\tthrow e;\n\t}\n\n\ttry {\n\t\ttemplates.update(opts);\t\t// eslint-disable-line no-undef\n\t} catch(e) {\n\t\t// templates not declared\n\t}\n}\n\n$(document).on('rebuild', function(_e, opts){\n\t// Protection contre les race conditions (Phase 3.1.1)\n\tif (_isBuilding) {\n\t\tif(opts && opts.DEBUG) {\n\t\t\tconsole.log('Rebuild ignored: build already in progress');\n\t\t}\n\t\treturn;\n\t}\n\n\t_isBuilding = true;\n\ttry {\n\t\trebuild(opts);\n\t} finally {\n\t\t_isBuilding = false;\n\t}\n})\n\n$(document).on('build', function(_e, opts){\n\t// Protection contre les race conditions (Phase 3.1.1)\n\tif (_isBuilding) {\n\t\tif(opts && opts.DEBUG) {\n\t\t\tconsole.log('Build ignored: build already in progress');\n\t\t}\n\t\treturn;\n\t}\n\n\t_isBuilding = true;\n\ttry {\n\t\tbuild(opts);\n\t} finally {\n\t\t_isBuilding = false;\n\t}\n})\n","/**\n/* Functions used by 3rd party apps\n/*\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport {copy_dataset, getNodeByName, getProbandIndex} from './utils.js';\nimport {rebuild} from './pedigree.js';\nimport {delete_node_dataset} from './widgets.js';\nimport {addchild} from './widgets.js';\nimport {syncTwins} from './twins.js';\nimport * as pedcache from './pedcache.js';\n\n\n// Set or remove node attributes.\n// If a value is not provided the attribute is removed.\n// 'key' can be a list of keys or a single key.\nexport function node_attr(opts, name, keys, value){\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet node = getNodeByName(newdataset, name);\n\tif(!node){\n\t\tconsole.warn(\"No person defined\");\n\t\treturn;\n\t}\n\n\tif(!Array.isArray(keys)) {\n\t\tkeys = [keys];\n\t}\n\n\tif(value) {\n\t\tfor(let i=0; i<keys.length; i++) {\n\t\t\tlet k = keys[i];\n\t\t\t//console.log('VALUE PROVIDED', k, value, (k in node));\n\t\t\tif(k in node && keys.length === 1) {\n\t\t\t\tif(node[k] === value)\n\t\t\t\t\treturn;\n\t\t\t\ttry {\n\t\t\t\t   if(JSON.stringify(node[k]) === JSON.stringify(value))\n\t\t\t\t\t   return;\n\t\t\t\t} catch(e){\n\t\t\t\t\t// continue regardless of error\n\t\t\t\t}\n\t\t\t}\n\t\t\tnode[k] = value;\n\t\t}\n\t} else {\n\t\tlet found = false;\n\t\tfor(let i=0; i<keys.length; i++) {\n\t\t\tlet k = keys[i];\n\t\t\t//console.log('NO VALUE PROVIDED', k, (k in node));\n\t\t\tif(k in node) {\n\t\t\t\tdelete node[k];\n\t\t\t\tfound = true;\n\t\t\t}\n\t\t}\n\t\tif(!found)\n\t\t\treturn;\n\t}\n\tsyncTwins(newdataset, node);\n\topts.dataset = newdataset;\n\trebuild(opts);\n}\n\n// Set or remove proband attributes.\n// If a value is not provided the attribute is removed from the proband.\n// 'key' can be a list of keys or a single key.\nexport function proband_attr(opts, keys, value){\n\tlet proband = opts.dataset[ getProbandIndex(opts.dataset) ];\n\tnode_attr(opts, proband.name, keys, value);\n}\n\n// add a child to the proband; giveb sex, age, yob and breastfeeding months (optional)\nexport function proband_add_child(opts, sex, age, yob, breastfeeding){\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet proband = newdataset[ getProbandIndex(newdataset) ];\n\tif(!proband){\n\t\tconsole.warn(\"No proband defined\");\n\t\treturn;\n\t}\n\tlet newchild = addchild(newdataset, proband, sex, 1)[0];\n\tnewchild.age = age;\n\tnewchild.yob = yob;\n\tif(breastfeeding !== undefined)\n\t\tnewchild.breastfeeding = breastfeeding;\n\topts.dataset = newdataset;\n\trebuild(opts);\n\treturn newchild.name;\n}\n\n// delete node using the name\nexport function delete_node_by_name(opts, name){\n\tfunction onDone(opts, dataset) {\n\t\t// assign new dataset and rebuild pedigree\n\t\topts.dataset = dataset;\n\t\trebuild(opts);\n\t}\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet node = getNodeByName(pedcache.current(opts), name);\n\tif(!node){\n\t\tconsole.warn(\"No node defined\");\n\t\treturn;\n\t}\n\tdelete_node_dataset(newdataset, node, opts, onDone);\n}\n"],"names":["create_err","err","console","error","Error","validate_age_yob","age","yob","status","year","Date","getFullYear","sum","parseInt","Math","abs","validate_pedigree","opts","getIdxByName","arr","name","idx","$","each","i","p","validate","DEBUG","log","call","this","display_name","uniquenames","famids","dataset","length","hidden","mother","father","midx","fidx","sex","inArray","push","famid","join","uc","unconnected","warn","combineArrays","arr1","arr2","include_children","connected","get_partners","anode","ptrs","bnode","children","getAllChildren","person","map","_i","_child_idx","child","getNodeByName","nodes","data","target","proband","val","obj","attr","getProbandIndex","change","ii","nconnect","_idx","has_parent","noparents","names","canChangeSex","node","some","isIE","ua","navigator","userAgent","indexOf","isEdge","match","messages","title","msg","onConfirm","dialog","modal","width","buttons","Yes","No","text","click","errModalEl","document","getElementById","modalTitle","querySelector","modalBodyInput","removeClass","on","off","cancelBtn","hasClass","addClass","textContent","showDialog","print_opts","key","remove","append","undefined","is_fullscreen","fullscreenElement","mozFullScreenElement","webkitFullscreenElement","msFullscreenElement","get_svg_dimensions","window","innerWidth","height","innerHeight","get_tree_dimensions","getDepth","depth","top_level","svg_dimensions","maxscore","generation","score","max_depth","Object","keys","symbol_size","max_limit","dict_cache","serialize_dataset","cleanData","copy_dataset","JSON","stringify","has_browser_storage","store_type","mod","localStorage","setItem","removeItem","e","get_prefix","btn_target","get_arr","get_browser_store","item","getItem","sessionStorage","set_browser_store","clear_pedigree_data","prefix","store","items","get_count","count","set_count","init_cache","shift","nstore","current","parse","previous","nst","next","clear","clear_browser_store","forEach","err2","setposition","x","y","zoom","zoomName","getposition","pos","parseFloat","it","j","isProband","setProband","is_proband","exists","pedcache","getChildren","getTwins","sibs","getSiblings","twin_type","mztwin","getAllSiblings","getAdoptedSiblings","getNodesAtDepth","fnodes","exclude_names","sort","a","b","linkNodes","flattenNodes","partners","links","motherName","fatherName","motherNode","fatherNode","ancestors","recurse","consanguity","node1","node2","ancestors1","ancestors2","names1","ancestor","names2","_index","flatten","root","flat","_dataset","overlap","xnew","n","adjust_coords","xmid","descendants","diff","child1","child2","descendantsNames","descendant","nodesOverlap","updateParent","parent","id","parent_node","dztwins","twins","twin","setChildrenId","dztwin","makeid","len","possible","charAt","floor","random","buildTree","partnerLinks","_j","m","f","contains_parent","merge","ptr","gp","gmidx","gfidx","get_grandparents_idx","roots","globalScope","Function","globalStructuredClone","structuredClone","canStructuredClone","deepClone","value","Array","isArray","getTime","clonedObj","prototype","hasOwnProperty","cloneValue","disallowed","Set","clone","has","prefixInObj","found","k","_n","string","toUpperCase","slice","time","d","getHours","getMinutes","getSeconds","getMonth","getDate","results","RegExp","exec","location","href","zm","init_zoom","svg","xi","yi","d3","scaleExtent","zoomIn","zoomOut","filter","zoomSrc","type","button","transform","t","ped","select","targetDiv","_updateWarningOverlay","zooming","xyk","zoomIdentity","scale","translate","btn_zoom","transition","duration","scaleBy","scale_to_fit","get_bounds","wid","xmax","xmin","hgt","ymax","ymin","get_dimensions","size","w","clientWidth","h","clientHeight","get_svg_size","max","get_pedigree_center","translateTo","setTimeout","scaleTo","Number","MAX_VALUE","sym","selectAll","g_elm","dg","getBBox","text_elements","_groups","txtsize","getTextSize","firstChild","nodeValue","font_family","font_size","getNodeSize","txt","font","fontSize","o","css","position","float","visibility","appendTo","s","addButtons","options","extend","btns","fa","disabled","lis","_e","local_dataset","trigger","exitFullscreen","msExitFullscreen","mozCancelFullScreen","webkitExitFullscreen","requestFullscreen","documentElement","mozRequestFullScreen","webkitRequestFullscreen","Element","ALLOW_KEYBOARD_INPUT","msRequestFullscreen","timeoutId","setInterval","clearInterval","stopPropagation","empty","reset","addPbuttonEvents","keep_proband_on_reset","newdataset","selected","partner","daughter","son","cancers","breast_cancer","breast_cancer2","ovarian_cancer","prostate_cancer","pancreatic_cancer","genetic_test1","genetic_test2","genetic_test4","pathology_tests","RISK_FACTOR_STORE","hasInput","v","trim","isEmpty","myObj","get_prs_values","prs","alpha","zscore","percent","getGeneticTest","version","readCanRisk","boadicea_lines","lines","split","hdr","regexp","gt","ncol","ln","ops","replace","delim","indi","cancer","diagnosis_age","ashkenazi","gene_test","result","path_test","localeCompare","get_mdensity","mdensity","test","get_pedigree","meta","isanon","ethnicity","isInteger","toString","excl","exclude","probandIdx","pedigree_util","menarche","get_risk_factor","parity","first_birth","oc_use","mht_use","bmi","alcohol","menopause","tl","endo","cmsg","risk_factor_name","store_name","pathname","el","pop","get_surgical_ops","breast_cancer_prs","ovarian_cancer_prs","prostate_cancer_prs","addIO","files","reader","FileReader","onload","load_data","onerror","utils","readAsText","load","content","save_file","save","print","get_printable_svg","svg_download","img_download","copyStylesInline","destinationNode","sourceNode","containerElements","destChildNodes","childNodes","srcChildNodes","cd","tagName","style","currentStyle","getComputedStyle","styleLength","childStyle","st","mySt","setProperty","getPropertyValue","resolution","img_type","deferred","svg2img","find","when","apply","done","arguments","grep","html","img","open","write","createElement","download","body","appendChild","removeChild","get_svg_as_data_url","svgCopy","get","cloneNode","svgStr","XMLSerializer","serializeToString","btoa","unescape","encodeURIComponent","deferred_name","defaults","iscanvg","Deferred","imgsrc","canvas","context","getContext","fillStyle","fillRect","drawImage","resolve","toDataURL","clearRect","src","promise","unique_urls","svg_html","matches","str","myRegexp","c","lastIndex","index","getMatches","quote","m1","m2","newval","svg_div","a4","constructor","cssFiles","printWindow","headContent","close","focus","filename","file","Blob","msSaveOrOpenBlob","url","URL","createObjectURL","revokeObjectURL","canrisk_validation","risk_factors","readBoadiceaV4","canrisk_data","readCanRiskFile","to_process","process_ped","readLinkage","err1","message","acc_FamHist_ticked","acc_FamHist_Leave","RESULT","FLAG_FAMILY_MODAL","err3","affected","alleles","unshift","_cancer","getLevel","updated","l","prt_lvl","level","fix_n_balance_levels","max_level","pidx","getPartnerIdx","update_parents_level","parents","ma","pa","svg_node","d3obj","setMzTwin","d1","d2","getUniqueTwinID","mz","splice","syncTwins","checkTwins","twin_types","updateStatus","update_ashkn","is","pedcache_current","switches","iswitch","update_cancer_by_sex","approx_diagnosis_age","substring","round5","checked","tres","hoxb13_result","valid","update_diagnosis_age_widget","prop","hide","show","ovarian_cancer_diagnosis_age","closest","prostate_cancer_diagnosis_age","x1","x2","round","sexInput","targetDivs","sexCanChange","removePlaceholderChildren","partner_placeholder","getTreeNode","flat_tree","dataNode","addchild","nchild","ptr_name","twin_id","addsibling","newchildren","add_lhs","skip_parent_copy","newbie","addparents","tree_node","pid","ptr_node_meta","node_mother","node_father","node_sibs","rid","lid","sibNode","sid","faidx","moidx","tmpfa","orphans","nid","orphan_meta","oid","oidx","ptr_node","addpartner","config","partner_sex","create_child","child_sex","motherExists","fatherExists","roles","personA","personB","determineParentRoles","createPartnerPlaceholderChild","partner_idx","person_idx","child_idx","adjacent_nodes","excludes","lhs_node","rhs_node","dnodes","delete_node_dataset","onDone","deletes","d3node","ps","children_names","adj","idxToRemove","del","data_node","ancestorData","mIdx","fIdx","purgePlaceholderChildren","baselineDisconnected","newopts","hadDisconnectedBefore","localOpts","localDataset","dragging","last_mouseover","shiftKeyPressed","_widgetClickInProgress","addWidgets","popup_selection","square_title","circle_title","add_person","classed","datum","highlight","dragstart","dragstop","_d","setLineDragPosition","drag","sourceEvent","dx","dy","ynew","drag_handle","fx","fy","widgets","delete","styles","fill","edit","settings","widget","parentNode","opt","autoOpen","table","disableInp","label","capitaliseFirstLetter","diseases","disease_colour","colour","kk","openEditDialog","stack","ctrlKey","nodeclick","xcoord","pointer","ycoord","y1","y2","wasPressed","shiftKey","RENDERING_CONSTANTS","addLabels","addLabel","baseFontPx","emVal","getPx","lineSpacing","basePx","String","endsWith","isNaN","fontStringToPx","RC","initialOffset","validate_age_yob_data","ilab","labels","ypos","get_text","disease","dis","font_weight","this_label","vars","ivar","r","spacing","node_has_label","y_offset","ftext","class_label","validate_fn","init_dragging","xstart","event","indir","me","pnrName","isMovingRight","lft_node","rgt_node","adj_node","meNode","adjIdx","xlft","xrgt","el_move","old_index","new_index","_isBuilding","build","dragNode","showWidgets","background","node_background","node_border_color","node_border_color_with_data","node_border_color_no_data","link_color","link_debug_color","affected_fill_color","clash_indicator_color","dead_line_color","hover_color","exclude_fill_color","VERBOSE","pbuttons","io","top_level_seen","group_top_level","hidden_root","hierarchy","tree_dimensions","tree","separation","treemap","is_hidden_data","ptrLinkNodes","clashes","clash","check_ptr_link_clashes","check_ptr_links","enter","classes","adopted_in","adopted_out","sel","attrName","hasDisease","_event","baseWidth","has_gender","miscarriage","termination","symbol","symbolTriangle","symbolCircle","symbolSquare","getClipPathId","hiddenScale","pienode","ncancers","_val","clipId","pieInnerRadius","pieOuterRadius","pie","arc","innerRadius","outerRadius","indent","get_bracket","clash_depth","draw_path","dy1","dy2","cshift","path","dx1","dx2","insert","divorced","parent_nodes","parent_node_name","divorce_path","divorce_y_offset","warningWidth","min","warningHeight","warningGroup","updateWarningOverlay","targetSvg","warning","svgWidth","source","dash_len","dash_array","usedlen","twinx","thisx","ymid","xhbar","yy","half","forkY","probandNode","triid","arrowHeadSize","arrowRefPoint","setHiddenMetadata","defineProperty","configurable","enumerable","writable","_err","__clipId","__clipSource","fragment","sanitizeIdFragment","bracket_height","rebuild","templates","update","node_attr","breastfeeding","newchild"],"mappings":"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"}