{"version":3,"file":"pedigreejs.v4.0.0-rc1.min.js","sources":["../es/validation.js","../es/dom.js","../es/pedcache.js","../es/tree-utils.js","../es/utils.js","../es/zoom.js","../es/pbuttons.js","../es/canrisk_file.js","../es/io.js","../es/twins.js","../es/popup_form.js","../es/widgets-add.js","../es/widgets-delete.js","../es/widgets.js","../es/labels.js","../es/dragging.js","../es/pedigree.js","../es/extras.js"],"sourcesContent":["/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// Pedigree validation functions\r\n\r\nexport function create_err(err) {\r\n\tconsole.error(err);\r\n\treturn new Error(err);\r\n}\r\n\r\n/**\r\n * Validate age and yob is consistent with current year. The sum of age and\r\n * yob should not be greater than or equal to current year. If alive the\r\n * absolute difference between the sum of age and year of birth and the\r\n * current year should be <= 1.\r\n * @param age\t- age in years.\r\n * @param yob\t- year of birth.\r\n * @param status - 0 = alive, 1 = dead.\r\n * @return true if age and yob are consistent with current year otherwise false.\r\n */\r\nexport function validate_age_yob(age, yob, status) {\r\n\tlet year = new Date().getFullYear();\r\n\tlet sum = parseInt(age) + parseInt(yob);\r\n\t// check status is an expected string\r\n\tif (status !== \"1\" && status !== \"0\")\r\n\t\treturn false\r\n\r\n\tif(status === \"1\") {   // deceased\r\n\t\treturn year >= sum;\r\n\t}\r\n\t// Phase 3.3.1: Assouplir validation pour éviter faux positifs (anniversaire non encore passé)\r\n\treturn Math.abs(year - sum) <= 2 && year >= sum;\r\n}\r\n\r\n/**\r\n * Validate pedigree dataset for consistency and completeness\r\n * Checks for:\r\n * - Consistent parent sex (mothers=F, fathers=M)\r\n * - Unique IndivIDs (names)\r\n * - Required fields (name, sex)\r\n * - Single family (no multiple famids)\r\n * - Warns about unconnected individuals\r\n * @param {Object} opts - Options object containing dataset and validation settings\r\n * @param {Array} opts.dataset - Array of person objects to validate\r\n * @param {boolean|function} opts.validate - Validation mode: true (default validation), false (skip), or custom function\r\n * @param {boolean} [opts.DEBUG=false] - Enable debug logging\r\n * @throws {Error} If validation fails with specific error message\r\n * @example\r\n * validate_pedigree({\r\n *   dataset: [...],\r\n *   validate: true\r\n * });\r\n */\r\nexport function validate_pedigree(opts){\r\n\t// Import needed functions dynamically to avoid circular dependencies\r\n\tconst getIdxByName = (arr, name) => {\r\n\t\tlet idx = -1;\r\n\t\t$.each(arr, function(i, p) {\r\n\t\t\tif (name === p.name) {\r\n\t\t\t\tidx = i;\r\n\t\t\t\treturn idx;\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn idx;\r\n\t};\r\n\r\n\tif(opts.validate) {\r\n\t\tif (typeof opts.validate == 'function') {\r\n\t\t\tif(opts.DEBUG)\r\n\t\t\t\tconsole.log('CALLING CONFIGURED VALIDATION FUNCTION');\r\n\t\t\treturn opts.validate.call(this, opts);\r\n\t\t}\r\n\r\n\t\t// check consistency of parents sex\r\n\t\tlet uniquenames = [];\r\n\t\tlet famids = [];\r\n\t\tlet display_name;\r\n\t\tfor(let p=0; p<opts.dataset.length; p++) {\r\n\t\t\tif(!p.hidden) {\r\n\t\t\t\tif(opts.dataset[p].mother || opts.dataset[p].father) {\r\n\t\t\t\t\tdisplay_name = opts.dataset[p].display_name;\r\n\t\t\t\t\tif(!display_name)\r\n\t\t\t\t\t\tdisplay_name = 'unnamed';\r\n\t\t\t\t\tdisplay_name += ' (IndivID: '+opts.dataset[p].name+')';\r\n\t\t\t\t\tlet mother = opts.dataset[p].mother;\r\n\t\t\t\t\tlet father = opts.dataset[p].father;\r\n\t\t\t\t\tif(!mother || !father) {\r\n\t\t\t\t\t\tthrow create_err('Missing parent for '+display_name);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tlet midx = getIdxByName(opts.dataset, mother);\r\n\t\t\t\t\tlet fidx = getIdxByName(opts.dataset, father);\r\n\t\t\t\t\tif(midx === -1)\r\n\t\t\t\t\t\tthrow create_err('The mother (IndivID: '+mother+') of family member '+\r\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\r\n\t\t\t\t\tif(fidx === -1)\r\n\t\t\t\t\t\tthrow create_err('The father (IndivID: '+father+') of family member '+\r\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\r\n\t\t\t\t\tif(opts.dataset[midx].sex !== \"F\")\r\n\t\t\t\t\t\tthrow create_err(\"The mother of family member \"+display_name+\r\n\t\t\t\t\t\t\t\t\" is not specified as female. All mothers in the pedigree must have sex specified as 'F'.\");\r\n\t\t\t\t\tif(opts.dataset[fidx].sex !== \"M\")\r\n\t\t\t\t\t\tthrow create_err(\"The father of family member \"+display_name+\r\n\t\t\t\t\t\t\t\t\" is not specified as male. All fathers in the pedigree must have sex specified as 'M'.\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\r\n\t\t\tif(!opts.dataset[p].name)\r\n\t\t\t\tthrow create_err(display_name+' has no IndivID.');\r\n\t\t\tif($.inArray(opts.dataset[p].name, uniquenames) > -1)\r\n\t\t\t\tthrow create_err('IndivID for family member '+display_name+' is not unique.');\r\n\t\t\tuniquenames.push(opts.dataset[p].name);\r\n\r\n\t\t\tif($.inArray(opts.dataset[p].famid, famids) === -1 && opts.dataset[p].famid) {\r\n\t\t\t\tfamids.push(opts.dataset[p].famid);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif(famids.length > 1) {\r\n\t\t\tthrow create_err('More than one family found: '+famids.join(\", \")+'.');\r\n\t\t}\r\n\t\t// warn if there is a break in the pedigree\r\n\t\tlet uc = unconnected(opts.dataset);\r\n\t\tif(uc.length > 0)\r\n\t\t\tconsole.warn(\"individuals unconnected to pedigree \", uc);\r\n\t}\r\n}\r\n\r\n//combine arrays ignoring duplicates\r\nfunction combineArrays(arr1, arr2) {\r\n\tfor(let i=0; i<arr2.length; i++)\r\n\t\tif($.inArray( arr2[i], arr1 ) === -1) arr1.push(arr2[i]);\r\n}\r\n\r\nfunction include_children(connected, p, dataset) {\r\n\t// Import needed functions\r\n\tconst get_partners = (dataset, anode) => {\r\n\t\tlet ptrs = [];\r\n\t\tfor(let i=0; i<dataset.length; i++) {\r\n\t\t\tlet bnode = dataset[i];\r\n\t\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) === -1)\r\n\t\t\t\tptrs.push(bnode.father);\r\n\t\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) === -1)\r\n\t\t\t\tptrs.push(bnode.mother);\r\n\t\t}\r\n\t\treturn ptrs;\r\n\t};\r\n\r\n\tconst getAllChildren = (dataset, person, sex) => {\r\n\t\treturn $.map(dataset, function(p, _i){\r\n\t\t\treturn !('noparents' in p) &&\r\n\t\t\t\t   (p.mother === person.name || p.father === person.name) &&\r\n\t\t\t\t   (!sex || p.sex === sex) ? p : null;\r\n\t\t});\r\n\t};\r\n\r\n\tif($.inArray( p.name, connected ) === -1)\r\n\t\treturn;\r\n\tcombineArrays(connected, get_partners(dataset, p));\r\n\tlet children = getAllChildren(dataset, p);\r\n\t$.each(children, function( _child_idx, child ) {\r\n\t\tif($.inArray( child.name, connected ) === -1) {\r\n\t\t\tconnected.push(child.name);\r\n\t\t\tcombineArrays(connected, get_partners(dataset, child));\r\n\t\t}\r\n\t});\r\n}\r\n\r\n//return a list of individuals that aren't connected to the target\r\nexport function unconnected(dataset){\r\n\t// Import needed functions\r\n\tconst getProbandIndex = (dataset) => {\r\n\t\tconst isProband = (obj) => {\r\n\t\t\treturn typeof $(obj).attr('proband') !== typeof undefined && $(obj).attr('proband') !== false;\r\n\t\t};\r\n\t\tlet proband;\r\n\t\t$.each(dataset, function(i, val) {\r\n\t\t\tif (isProband(val)) {\r\n\t\t\t\tproband = i;\r\n\t\t\t\treturn proband;\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn proband;\r\n\t};\r\n\r\n\tconst getNodeByName = (nodes, name) => {\r\n\t\tfor (let i = 0; i < nodes.length; i++) {\r\n\t\t\tif(nodes[i].data && name === nodes[i].data.name)\r\n\t\t\t\treturn nodes[i];\r\n\t\t\telse if (name === nodes[i].name)\r\n\t\t\t\treturn nodes[i];\r\n\t\t}\r\n\t};\r\n\r\n\tconst get_partners = (dataset, anode) => {\r\n\t\tlet ptrs = [];\r\n\t\tfor(let i=0; i<dataset.length; i++) {\r\n\t\t\tlet bnode = dataset[i];\r\n\t\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) === -1)\r\n\t\t\t\tptrs.push(bnode.father);\r\n\t\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) === -1)\r\n\t\t\t\tptrs.push(bnode.mother);\r\n\t\t}\r\n\t\treturn ptrs;\r\n\t};\r\n\r\n\tlet target = dataset[ getProbandIndex(dataset) ];\r\n\tif(!target){\r\n\t\tconsole.warn(\"No target defined\");\r\n\t\tif(dataset.length === 0) {\r\n\t\t\tthrow new Error(\"empty pedigree data set\");\r\n\t\t}\r\n\t\ttarget = dataset[0];\r\n\t}\r\n\tlet connected = [target.name];\r\n\tlet change = true;\r\n\tlet ii = 0;\r\n\twhile(change && ii < 200) {\r\n\t\tii++;\r\n\t\tlet nconnect = connected.length;\r\n\t\t$.each(dataset, function( _idx, p ) {\r\n\t\t\tif($.inArray( p.name, connected ) !== -1) {\r\n\t\t\t\t// check if this person or a partner has a parent\r\n\t\t\t\tlet ptrs = get_partners(dataset, p);\r\n\t\t\t\tlet has_parent = (p.name === target.name || !p.noparents);\r\n\t\t\t\tfor(let i=0; i<ptrs.length; i++){\r\n\t\t\t\t\tif(!getNodeByName(dataset, ptrs[i]).noparents)\r\n\t\t\t\t\t\thas_parent = true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(has_parent){\r\n\t\t\t\t\tif(p.mother && $.inArray( p.mother, connected ) === -1)\r\n\t\t\t\t\t\tconnected.push(p.mother);\r\n\t\t\t\t\tif(p.father && $.inArray( p.father, connected ) === -1)\r\n\t\t\t\t\t\tconnected.push(p.father);\r\n\t\t\t\t}\r\n\t\t\t} else if( !p.noparents &&\r\n\t\t\t\t\t  ((p.mother && $.inArray( p.mother, connected ) !== -1) ||\r\n\t\t\t\t\t   (p.father && $.inArray( p.father, connected ) !== -1))){\r\n\t\t\t\tconnected.push(p.name);\r\n\t\t\t}\r\n\t\t\t// include any children\r\n\t\t\tinclude_children(connected, p, dataset);\r\n\t\t});\r\n\t\tchange = (nconnect !== connected.length);\r\n\t}\r\n\tlet names = $.map(dataset, function(val, _i){return val.name;});\r\n\treturn $.map(names, function(name, _i){return $.inArray(name, connected) === -1 ? name : null;});\r\n}\r\n\r\n/**\r\n * Determine if the sex of a person can be changed.\r\n * Sex cannot be changed if the person is already a parent (referenced as mother/father)\r\n * by other people in the dataset, unless the current sex is 'U' (unknown).\r\n *\r\n * Phase 3.1.5 - Unified sex change rules\r\n *\r\n * @param node - The person node to check\r\n * @param dataset - The full pedigree dataset\r\n * @return true if sex can be changed, false otherwise\r\n */\r\nexport function canChangeSex(node, dataset) {\r\n\t// Validation des paramètres\r\n\tif(!node || !dataset) {\r\n\t\treturn true; // Par défaut, autoriser le changement si données manquantes\r\n\t}\r\n\r\n\t// On peut toujours changer de 'U' (unknown) vers un sexe défini\r\n\t// Car 'U' n'a pas de contraintes de cohérence mère/père\r\n\tif(node.sex === 'U') {\r\n\t\treturn true;\r\n\t}\r\n\r\n\t// Vérifier si ce nœud est référencé comme parent (mother ou father)\r\n\t// par d'autres personnes dans le dataset\r\n\tconst isReferencedAsParent = dataset.some(person => {\r\n\t\t// Un nœud est parent s'il est référencé comme mother ou father\r\n\t\treturn person.mother === node.name || person.father === node.name;\r\n\t});\r\n\r\n\t// Si le nœud est déjà parent et a un sexe défini (M ou F),\r\n\t// on ne peut pas changer le sexe car cela casserait la cohérence\r\n\t// (ex: une mother doit être 'F', un father doit être 'M')\r\n\tif(isReferencedAsParent && node.sex !== 'U') {\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// Dans tous les autres cas, autoriser le changement\r\n\treturn true;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// DOM manipulation and UI functions\r\n\r\nexport function isIE() {\r\n\t let ua = navigator.userAgent;\r\n\t /* MSIE used to detect old browsers and Trident used to newer ones*/\r\n\t return ua.indexOf(\"MSIE \") > -1 || ua.indexOf(\"Trident/\") > -1;\r\n}\r\n\r\nexport function isEdge() {\r\n\t return navigator.userAgent.match(/Edge/g);\r\n}\r\n\r\nfunction showDialog(title, msg, onConfirm, opts, dataset) {\r\n\tconst errModalEl = document.getElementById('errModal');\r\n\tconst modalTitle = errModalEl.querySelector('.modal-title');\r\n\tconst modalBodyInput = errModalEl.querySelector('.modal-body');\r\n\tif(onConfirm) {\r\n\t\t$('#errModal button.hidden').removeClass(\"hidden\");\r\n\t\t$('#errModal button:contains(\"OK\")').on( \"click\", function() {\r\n\t\t\tonConfirm(opts, dataset);\r\n\t\t\t$('#errModal button:contains(\"OK\")').off('click');\r\n\t\t});\r\n\t} else {\r\n\t\tconst cancelBtn = $('#errModal button:contains(\"CANCEL\")');\r\n\t\tif(!cancelBtn.hasClass(\"hidden\")) cancelBtn.addClass(\"hidden\");\r\n\t\t$('#errModal button:contains(\"OK\")').off('click');\r\n\t}\r\n\r\n\tmodalTitle.textContent = title;\r\n\tmodalBodyInput.textContent = msg;\r\n\t$(\"#errModal\").modal(\"show\");\r\n}\r\n\r\n/**\r\n * Show message or confirmation dialog.\r\n * @param title\t - dialog window title\r\n * @param msg\t   - message to diasplay\r\n * @param onConfirm - function to call in a confirmation dialog\r\n * @param opts\t  - pedigreejs options\r\n * @param dataset\t- pedigree dataset\r\n */\r\nexport function messages(title, msg, onConfirm, opts, dataset) {\r\n\ttry {\r\n\t\tif(onConfirm) {\r\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\r\n\t\t\t\t\tmodal: true,\r\n\t\t\t\t\ttitle: title,\r\n\t\t\t\t\twidth: 350,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\"Yes\": function () {\r\n\t\t\t\t\t\t\t$(this).dialog('close');\r\n\t\t\t\t\t\t\tonConfirm(opts, dataset);\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\"No\": function () {\r\n\t\t\t\t\t\t\t$(this).dialog('close');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t} else {\r\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\r\n\t\t\t\ttitle: title,\r\n\t\t\t\twidth: 350,\r\n\t\t\t\tbuttons: [{\r\n\t\t\t\t\ttext: \"OK\",\r\n\t\t\t\t\tclick: function() { $( this ).dialog( \"close\" );}\r\n\t\t\t\t}]\r\n\t\t\t});\r\n\t\t}\r\n\t} catch(err) {\r\n\t\tshowDialog(title, msg, onConfirm, opts, dataset);\r\n\t}\r\n}\r\n\r\n// print options and dataset\r\nexport function print_opts(opts){\r\n\t$(\"#pedigree_data\").remove();\r\n\t$(\"body\").append(\"<div id='pedigree_data'></div>\" );\r\n\tlet key;\r\n\tfor(let i=0; i<opts.dataset.length; i++) {\r\n\t\tlet person = \"<div class='row'><strong class='col-md-1 text-right'>\"+opts.dataset[i].name+\"</strong><div class='col-md-11'>\";\r\n\t\tfor(key in opts.dataset[i]) {\r\n\t\t\tif(key === 'name') continue;\r\n\t\t\tif(key === 'parent')\r\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key].name+\"; </span>\";\r\n\t\t\telse if (key === 'children') {\r\n\t\t\t\tif (opts.dataset[i][key][0] !== undefined)\r\n\t\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key][0].name+\"; </span>\";\r\n\t\t\t} else\r\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key]+\"; </span>\";\r\n\t\t}\r\n\t\t$(\"#pedigree_data\").append(person + \"</div></div>\");\r\n\r\n\t}\r\n\t$(\"#pedigree_data\").append(\"<br /><br />\");\r\n\tfor(key in opts) {\r\n\t\tif(key === 'dataset') continue;\r\n\t\t$(\"#pedigree_data\").append(\"<span>\"+key + \":\" + opts[key]+\"; </span>\");\r\n\t}\r\n}\r\n\r\nexport function is_fullscreen(){\r\n\treturn !!(document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement);\r\n}\r\n\r\nexport function get_svg_dimensions(opts) {\r\n\treturn {'width' : (is_fullscreen()? window.innerWidth  : opts.width),\r\n\t\t\t'height': (is_fullscreen()? window.innerHeight : opts.height)};\r\n}\r\n\r\nexport function get_tree_dimensions(opts) {\r\n\t// Import needed function\r\n\tconst getDepth = (dataset, name) => {\r\n\t\tconst getIdxByName = (arr, name) => {\r\n\t\t\tlet idx = -1;\r\n\t\t\t$.each(arr, function(i, p) {\r\n\t\t\t\tif (name === p.name) {\r\n\t\t\t\t\tidx = i;\r\n\t\t\t\t\treturn idx;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn idx;\r\n\t\t};\r\n\r\n\t\tlet idx = getIdxByName(dataset, name);\r\n\t\tlet depth = 1;\r\n\r\n\t\twhile(idx >= 0 && ('mother' in dataset[idx] || dataset[idx].top_level)){\r\n\t\t\tidx = getIdxByName(dataset, dataset[idx].mother);\r\n\t\t\tdepth++;\r\n\t\t}\r\n\t\treturn depth;\r\n\t};\r\n\r\n\tconst getAllChildren = (dataset, person, sex) => {\r\n\t\treturn $.map(dataset, function(p, _i){\r\n\t\t\treturn !('noparents' in p) &&\r\n\t\t\t\t   (p.mother === person.name || p.father === person.name) &&\r\n\t\t\t\t   (!sex || p.sex === sex) ? p : null;\r\n\t\t});\r\n\t};\r\n\r\n\t// / get score at each depth used to adjust node separation\r\n\tlet svg_dimensions = get_svg_dimensions(opts);\r\n\tlet maxscore = 0;\r\n\tlet generation = {};\r\n\tfor(let i=0; i<opts.dataset.length; i++) {\r\n\t\tlet depth = getDepth(opts.dataset, opts.dataset[i].name);\r\n\t\tlet children = getAllChildren(opts.dataset, opts.dataset[i]);\r\n\r\n\t\t// score based on no. of children and if parent defined\r\n\t\tlet score = 1 + (children.length > 0 ? 0.55+(children.length*0.25) : 0) + (opts.dataset[i].father ? 0.25 : 0);\r\n\t\tif(depth in generation)\r\n\t\t\tgeneration[depth] += score;\r\n\t\telse\r\n\t\t\tgeneration[depth] = score;\r\n\r\n\t\tif(generation[depth] > maxscore)\r\n\t\t\tmaxscore = generation[depth];\r\n\t}\r\n\r\n\tlet max_depth = Object.keys(generation).length*opts.symbol_size*3.5;\r\n\tlet tree_width =  (svg_dimensions.width - opts.symbol_size > maxscore*opts.symbol_size*1.65 ?\r\n\t\t\t\t\t   svg_dimensions.width - opts.symbol_size : maxscore*opts.symbol_size*1.65);\r\n\tlet tree_height = (svg_dimensions.height - opts.symbol_size > max_depth ?\r\n\t\t\t\t\t   svg_dimensions.height - opts.symbol_size : max_depth);\r\n\treturn {'width': tree_width, 'height': tree_height};\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n//store a history of pedigree\r\n\r\nlet max_limit = 25;\r\nlet dict_cache = {};\r\n\r\n// Helper function to serialize dataset avoiding circular references\r\n// D3 adds circular references (parent/children) that can't be stringified directly\r\nfunction serialize_dataset(dataset) {\r\n\ttry {\r\n\t\t// Try direct stringification first (for performance)\r\n\t\treturn JSON.stringify(dataset);\r\n\t} catch (e) {\r\n\t\t// If circular reference error, create a clean copy\r\n\t\t// Copy only the original data properties, excluding D3-added references\r\n\t\tlet cleanData = dataset.map(function(person) {\r\n\t\t\tlet clean = {};\r\n\t\t\tfor (let key in person) {\r\n\t\t\t\t// Skip D3-added properties and circular references\r\n\t\t\t\tif (key !== 'parent' && key !== 'children' && key !== 'data' &&\r\n\t\t\t\t\ttypeof person[key] !== 'function' && typeof person[key] !== 'object') {\r\n\t\t\t\t\tclean[key] = person[key];\r\n\t\t\t\t} else if (key === 'children' && Array.isArray(person[key])) {\r\n\t\t\t\t\t// For children array, only store names not full objects\r\n\t\t\t\t\tclean[key] = person[key].map(c => c.name || c);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn clean;\r\n\t\t});\r\n\t\treturn JSON.stringify(cleanData);\r\n\t}\r\n}\r\n\r\n// test if browser storage is supported\r\nfunction has_browser_storage(opts) {\r\n\ttry {\r\n\t\tif(opts.store_type === 'array')\r\n\t\t\treturn false;\r\n\r\n\t\tif(opts.store_type !== 'local' && opts.store_type !== 'session' && opts.store_type !== undefined)\r\n\t\t\treturn false;\r\n\r\n\t\tlet mod = 'test';\r\n\t\tlocalStorage.setItem(mod, mod);\r\n\t\tlocalStorage.removeItem(mod);\r\n\t\treturn true;\r\n\t} catch(e) {\r\n\t\treturn false;\r\n\t}\r\n}\r\n\r\nfunction get_prefix(opts) {\r\n\treturn \"PEDIGREE_\"+opts.btn_target+\"_\";\r\n}\r\n\r\n// use dict_cache to store cache as an array\r\nfunction get_arr(opts) {\r\n\treturn dict_cache[get_prefix(opts)];\r\n}\r\n\r\nfunction get_browser_store(opts, item) {\r\n\tif(opts.store_type === 'local')\r\n\t\treturn localStorage.getItem(item);\r\n\telse\r\n\t\treturn sessionStorage.getItem(item);\r\n}\r\n\r\nfunction set_browser_store(opts, name, item) {\r\n\tif(opts.store_type === 'local')\r\n\t\treturn localStorage.setItem(name, item);\r\n\telse\r\n\t\treturn sessionStorage.setItem(name, item);\r\n}\r\n\r\n// clear all storage items\r\nfunction clear_browser_store(opts) {\r\n\tif(opts.store_type === 'local')\r\n\t\treturn localStorage.clear();\r\n\telse\r\n\t\treturn sessionStorage.clear();\r\n}\r\n\r\n// remove all storage items with keys that have the pedigree history prefix\r\nexport function clear_pedigree_data(opts) {\r\n\tlet prefix = get_prefix(opts);\r\n\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\r\n\tlet items = [];\r\n\tfor(let i = 0; i < store.length; i++){\r\n\t\tif(store.key(i).indexOf(prefix) === 0)\r\n\t\t\titems.push(store.key(i));\r\n\t}\r\n\tfor(let i = 0; i < items.length; i++)\r\n\t\tstore.removeItem(items[i]);\r\n}\r\n\r\nexport function get_count(opts) {\r\n\tlet count;\r\n\tif (has_browser_storage(opts))\r\n\t\tcount = get_browser_store(opts, get_prefix(opts)+'COUNT');\r\n\telse\r\n\t\tcount = dict_cache[get_prefix(opts)+'COUNT'];\r\n\tif(count !== null && count !== undefined)\r\n\t\treturn count;\r\n\treturn 0;\r\n}\r\n\r\nfunction set_count(opts, count) {\r\n\tif (has_browser_storage(opts))\r\n\t\tset_browser_store(opts, get_prefix(opts)+'COUNT', count);\r\n\telse\r\n\t\tdict_cache[get_prefix(opts)+'COUNT'] = count;\r\n}\r\n\r\nexport function init_cache(opts) {\r\n\tif(!opts.dataset)\r\n\t\treturn;\r\n\tlet count = get_count(opts);\r\n\tif (has_browser_storage(opts)) {   // local storage\r\n\t\tset_browser_store(opts, get_prefix(opts)+count, serialize_dataset(opts.dataset));\r\n\t} else {   // array cache with LRU eviction\r\n\t\tconsole.warn('Local storage not found/supported for this browser!', opts.store_type);\r\n\t\tmax_limit = 500;\r\n\t\tif(get_arr(opts) === undefined)\r\n\t\t\tdict_cache[get_prefix(opts)] = [];\r\n\r\n\t\tlet arr = get_arr(opts);\r\n\t\t// LRU eviction: if array is at max capacity, remove oldest (first) element\r\n\t\tif(arr.length >= max_limit) {\r\n\t\t\tarr.shift(); // Remove oldest entry (FIFO = simple LRU)\r\n\t\t\t// Adjust count since we removed an element\r\n\t\t\tif(count > 0)\r\n\t\t\t\tcount--;\r\n\t\t}\r\n\t\tarr.push(serialize_dataset(opts.dataset));\r\n\t}\r\n\tif(count < max_limit)\r\n\t\tcount++;\r\n\telse\r\n\t\tcount = 0;\r\n\tset_count(opts, count);\r\n}\r\n\r\nexport function nstore(opts) {\r\n\tif(has_browser_storage(opts)) {\r\n\t\tfor(let i=max_limit; i>0; i--) {\r\n\t\t\tif(get_browser_store(opts, get_prefix(opts)+(i-1)) !== null)\r\n\t\t\t\treturn i;\r\n\t\t}\r\n\t} else {\r\n\t\treturn (get_arr(opts) && get_arr(opts).length > 0 ? get_arr(opts).length : -1);\r\n\t}\r\n\treturn -1;\r\n}\r\n\r\nexport function current(opts) {\r\n\tlet current = get_count(opts)-1;\r\n\tif(current === -1)\r\n\t\tcurrent = max_limit;\r\n\tif(has_browser_storage(opts))\r\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+current));\r\n\telse if(get_arr(opts))\r\n\t\treturn JSON.parse(get_arr(opts)[current]);\r\n}\r\n\r\nexport function last(opts) {\r\n\tif(has_browser_storage(opts)) {\r\n\t\tfor(let i=max_limit; i>0; i--) {\r\n\t\t\tlet it = get_browser_store(opts, get_prefix(opts)+(i-1));\r\n\t\t\tif(it !== null) {\r\n\t\t\t\tset_count(opts, i);\r\n\t\t\t\treturn JSON.parse(it);\r\n\t\t\t}\r\n\t\t}\r\n\t} else {\n\t\tlet arr = get_arr(opts);\n\t\tif(arr)\n\t\t\treturn JSON.parse(arr[arr.length-1]);\n\t}\n\treturn undefined;\r\n}\r\n\r\nexport function previous(opts, previous) {\r\n\tif(previous === undefined)\r\n\t\tprevious = get_count(opts) - 2;\r\n\r\n\tif(previous < 0) {\r\n\t\tlet nst = nstore(opts);\r\n\t\tif(nst < max_limit)\r\n\t\t\tprevious = nst - 1;\r\n\t\telse\r\n\t\t\tprevious = max_limit - 1;\r\n\t}\r\n\tset_count(opts, previous + 1);\r\n\tif(has_browser_storage(opts))\r\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+previous));\r\n\telse\r\n\t\treturn JSON.parse(get_arr(opts)[previous]);\r\n}\r\n\r\nexport function next(opts, next) {\r\n\tif(next === undefined)\r\n\t\tnext = get_count(opts);\r\n\tif(next >= max_limit)\r\n\t\tnext = 0;\r\n\r\n\tset_count(opts, parseInt(next) + 1);\r\n\tif(has_browser_storage(opts))\r\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+next));\r\n\telse\r\n\t\treturn JSON.parse(get_arr(opts)[next]);\r\n}\r\n\r\nexport function clear(opts) {\r\n\tif(has_browser_storage(opts))\r\n\t\tclear_browser_store(opts);\r\n\tdict_cache = {};\r\n}\r\n\r\n// zoom - store translation coords\r\nexport function setposition(opts, x, y, zoom) {\r\n\tif(has_browser_storage(opts)) {\r\n\t\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\r\n\t\tif(x) {\r\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_X', x);\r\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_Y', y);\r\n\t\t} else {\r\n\t\t\tstore.removeItem(get_prefix(opts)+'_X');\r\n\t\t\tstore.removeItem(get_prefix(opts)+'_Y');\r\n\t\t}\r\n\r\n\t\tlet zoomName = get_prefix(opts)+'_ZOOM';\r\n\t\tif(zoom)\r\n\t\t\tset_browser_store(opts, zoomName, zoom);\r\n\t\telse\r\n\t\t\tstore.removeItem(zoomName);\r\n\t} else {\r\n\t\t// Array cache fallback for position storage\r\n\t\tif(x) {\r\n\t\t\tdict_cache[get_prefix(opts)+'_X'] = x;\r\n\t\t\tdict_cache[get_prefix(opts)+'_Y'] = y;\r\n\t\t} else {\r\n\t\t\tdelete dict_cache[get_prefix(opts)+'_X'];\r\n\t\t\tdelete dict_cache[get_prefix(opts)+'_Y'];\r\n\t\t}\r\n\r\n\t\tlet zoomName = get_prefix(opts)+'_ZOOM';\r\n\t\tif(zoom)\r\n\t\t\tdict_cache[zoomName] = zoom;\r\n\t\telse\r\n\t\t\tdelete dict_cache[zoomName];\r\n\t}\r\n}\r\n\r\nexport function getposition(opts) {\r\n\tif(has_browser_storage(opts)) {\r\n\t\tif(localStorage.getItem(get_prefix(opts)+'_X') === null &&\r\n\t\t   sessionStorage.getItem(get_prefix(opts)+'_X') === null)\r\n\t\t\treturn [null, null];\r\n\t\tlet pos = [ parseInt(get_browser_store(opts, get_prefix(opts)+'_X')),\r\n\t\t\t\t\tparseInt(get_browser_store(opts, get_prefix(opts)+'_Y')) ];\r\n\t\tif(get_browser_store(opts, get_prefix(opts)+'_ZOOM') !== null)\r\n\t\t\tpos.push(parseFloat(get_browser_store(opts, get_prefix(opts)+'_ZOOM')));\r\n\t\treturn pos;\r\n\t} else {\r\n\t\t// Array cache fallback for position retrieval\r\n\t\tif(dict_cache[get_prefix(opts)+'_X'] === null ||\r\n\t\t   dict_cache[get_prefix(opts)+'_X'] === undefined)\r\n\t\t\treturn [null, null];\r\n\t\tlet pos = [ parseInt(dict_cache[get_prefix(opts)+'_X']),\r\n\t\t\t\t\tparseInt(dict_cache[get_prefix(opts)+'_Y']) ];\r\n\t\tif(dict_cache[get_prefix(opts)+'_ZOOM'] !== null &&\r\n\t\t   dict_cache[get_prefix(opts)+'_ZOOM'] !== undefined)\r\n\t\t\tpos.push(parseFloat(dict_cache[get_prefix(opts)+'_ZOOM']));\r\n\t\treturn pos;\r\n\t}\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// Tree navigation, construction, and geometry functions\r\nimport * as pedcache from './pedcache.js';\r\n\r\n/**\r\n * Find the array index of a person by their name\r\n * @param {Array} arr - Array of person objects\r\n * @param {string} name - The name (IndivID) to search for\r\n * @returns {number} Index of the person in the array, or -1 if not found\r\n * @example\r\n * let idx = getIdxByName(dataset, 'person1');\r\n */\r\nexport function getIdxByName(arr, name) {\r\n\tlet idx = -1;\r\n\t$.each(arr, function(i, p) {\r\n\t\tif (name === p.name) {\r\n\t\t\tidx = i;\r\n\t\t\treturn idx;\r\n\t\t}\r\n\t});\r\n\treturn idx;\r\n}\r\n\r\n/**\r\n * Find a D3 tree node by person name\r\n * @param {Array|Object} nodes - Array of D3 nodes or nodes object with dataset property\r\n * @param {string} name - The name (IndivID) to search for\r\n * @returns {Object|undefined} The D3 node object with data property, or undefined if not found\r\n * @example\r\n * let node = getNodeByName(flattened_tree, 'person1');\r\n */\r\nexport function getNodeByName(nodes, name) {\r\n\tfor (let i = 0; i < nodes.length; i++) {\r\n\t\tif(nodes[i].data && name === nodes[i].data.name)\r\n\t\t\treturn nodes[i];\r\n\t\telse if (name === nodes[i].name)\r\n\t\t\treturn nodes[i];\r\n\t}\r\n\tif(nodes && nodes.dataset) {\r\n\t\tfor(let j=0; j<nodes.dataset.length; j++) {\r\n\t\t\tif(name === nodes.dataset[j].name)\r\n\t\t\t\treturn {data: nodes.dataset[j]};\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * Check if an object has the proband attribute set\r\n * @param {Object} obj - Person object or jQuery element\r\n * @returns {boolean} True if proband attribute is set and not false\r\n */\r\nexport function isProband(obj) {\r\n\treturn typeof $(obj).attr('proband') !== typeof undefined && $(obj).attr('proband') !== false;\r\n}\r\n\r\n/**\r\n * Set or unset a person as the proband (index case)\r\n * Only one person can be proband at a time - this removes proband status from all others\r\n * @param {Array} dataset - Array of person objects\r\n * @param {string} name - Name (IndivID) of person to set as proband\r\n * @param {boolean} is_proband - True to set as proband, false to unset\r\n * @example\r\n * setProband(dataset, 'person1', true);\r\n */\r\nexport function setProband(dataset, name, is_proband) {\r\n\t$.each(dataset, function(_i, p) {\r\n\t\tif (name === p.name)\r\n\t\t\tp.proband = is_proband;\r\n\t\telse\r\n\t\t\tdelete p.proband;\r\n\t});\r\n}\r\n\r\n/**\r\n * Find the index of the proband in the dataset\r\n * @param {Array} dataset - Array of person objects\r\n * @returns {number|undefined} Index of the proband, or undefined if no proband is set\r\n */\r\nexport function getProbandIndex(dataset) {\r\n\tlet proband;\r\n\t$.each(dataset, function(i, val) {\r\n\t\tif (isProband(val)) {\r\n\t\t\tproband = i;\r\n\t\t\treturn proband;\r\n\t\t}\r\n\t});\r\n\treturn proband;\r\n}\r\n\r\n/**\r\n * Check if an individual exists in the cached dataset\r\n * @param {Object} opts - Options object\r\n * @param {string} name - Name (IndivID) to check\r\n * @returns {boolean} True if individual exists in cache\r\n */\r\nexport function exists(opts, name){\r\n\treturn getNodeByName(pedcache.current(opts), name) !== undefined;\r\n}\r\n\r\n/**\r\n * Get all partners (spouses) of a given person\r\n * A partner is someone who shares children with the person\r\n * @param {Array} dataset - Array of person objects\r\n * @param {Object} anode - Person object to find partners for\r\n * @returns {Array} Array of partner names (IndivIDs)\r\n * @example\r\n * let partners = get_partners(dataset, person);\r\n * // Returns ['spouse1', 'spouse2']\r\n */\r\nexport function get_partners(dataset, anode) {\r\n\tlet ptrs = [];\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tlet bnode = dataset[i];\r\n\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) === -1)\r\n\t\t\tptrs.push(bnode.father);\r\n\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) === -1)\r\n\t\t\tptrs.push(bnode.mother);\r\n\t}\r\n\treturn ptrs;\r\n}\r\n\r\n/**\r\n * Get children of a mother and optional father\r\n * Excludes children with noparents flag (visually disconnected)\r\n * @param {Array} dataset - Array of person objects\r\n * @param {Object} mother - Mother person object (must have sex='F')\r\n * @param {Object} [father] - Optional father person object to filter by\r\n * @returns {Array} Array of child person objects\r\n * @example\r\n * let children = getChildren(dataset, mother, father);\r\n */\r\nexport function getChildren(dataset, mother, father) {\r\n\tlet children = [];\r\n\tlet names = [];\r\n\tif(mother.sex === 'F')\r\n\t\t$.each(dataset, function(_i, p) {\r\n\t\t\tif(mother.name === p.mother)\r\n\t\t\t\tif(!father || father.name === p.father) {\r\n\t\t\t\t\tif($.inArray(p.name, names) === -1 && !p.noparents){\r\n\t\t\t\t\t\tchildren.push(p);\r\n\t\t\t\t\t\tnames.push(p.name);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t});\r\n\treturn children;\r\n}\r\n\r\n/**\r\n * Get all children of a person, including those with noparents flag\r\n * @param {Array} dataset - Array of person objects\r\n * @param {Object} person - Person object to find children for\r\n * @param {string} [sex] - Optional sex filter ('M' or 'F')\r\n * @returns {Array} Array of child person objects\r\n */\r\nexport function getAllChildren(dataset, person, sex) {\r\n\treturn $.map(dataset, function(p, _i){\r\n\t\treturn !('noparents' in p) &&\r\n\t\t\t   (p.mother === person.name || p.father === person.name) &&\r\n\t\t\t   (!sex || p.sex === sex) ? p : null;\r\n\t});\r\n}\r\n\r\n/**\r\n * Get monozygotic or dizygotic twin(s) of a person\r\n * @param {Array} dataset - Array of person objects\r\n * @param {Object} person - Person object to find twins for\r\n * @returns {Array} Array of twin person objects (excludes the person themselves)\r\n */\r\nexport function getTwins(dataset, person) {\r\n\tlet sibs = getSiblings(dataset, person);\r\n\tlet twin_type = (person.mztwin ? \"mztwin\" : \"dztwin\");\r\n\treturn $.map(sibs, function(p, _i){\r\n\t\treturn p.name !== person.name && p[twin_type] === person[twin_type] ? p : null;\r\n\t});\r\n}\r\n\r\n/**\r\n * Get siblings of a person with optional sex filter\r\n * Excludes the person themselves and those with noparents flag\r\n * @param {Array} dataset - Array of person objects\r\n * @param {Object} person - Person object to find siblings for\r\n * @param {string} [sex] - Optional sex filter ('M' for brothers, 'F' for sisters)\r\n * @returns {Array} Array of sibling person objects\r\n * @example\r\n * let brothers = getSiblings(dataset, person, 'M');\r\n */\r\nexport function getSiblings(dataset, person, sex) {\r\n\tif(person === undefined || !person.mother || person.noparents)\r\n\t\treturn [];\r\n\r\n\treturn $.map(dataset, function(p, _i){\r\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\r\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\r\n\t\t\t   (!sex || p.sex === sex) ? p : null;\r\n\t});\r\n}\r\n\r\n// get the siblings + adopted siblings - sex is an optional parameter\r\n// for only returning brothers or sisters\r\nexport function getAllSiblings(dataset, person, sex) {\r\n\treturn $.map(dataset, function(p, _i){\r\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\r\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\r\n\t\t\t   (!sex || p.sex === sex) ? p : null;\r\n\t});\r\n}\r\n\r\n// get the adopted siblings of a given individual\r\nexport function getAdoptedSiblings(dataset, person) {\r\n\treturn $.map(dataset, function(p, _i){\r\n\t\treturn  p.name !== person.name && 'noparents' in p &&\r\n\t\t\t   (p.mother === person.mother && p.father === person.father) ? p : null;\r\n\t});\r\n}\r\n\r\n// get the depth of the given person from the root\r\nexport function getDepth(dataset, name) {\r\n\tlet idx = getIdxByName(dataset, name);\r\n\tlet depth = 1;\r\n\r\n\twhile(idx >= 0 && ('mother' in dataset[idx] || dataset[idx].top_level)){\r\n\t\tidx = getIdxByName(dataset, dataset[idx].mother);\r\n\t\tdepth++;\r\n\t}\r\n\treturn depth;\r\n}\r\n\r\n// get the nodes at a given depth sorted by their x position\r\nexport function getNodesAtDepth(fnodes, depth, exclude_names) {\r\n\treturn $.map(fnodes, function(p, _i){\r\n\t\treturn p.depth === depth && !p.data.hidden && $.inArray(p.data.name, exclude_names) === -1 ? p : null;\r\n\t}).sort(function (a,b) {return a.x - b.x;});\r\n}\r\n\r\n// convert the partner names into corresponding tree nodes\r\nexport function linkNodes(flattenNodes, partners) {\r\n\tlet links = [];\r\n\tfor(let i=0; i< partners.length; i++) {\r\n\t\tlet motherName = partners[i].mother?.data?.name || partners[i].mother?.name;\r\n\t\tlet fatherName = partners[i].father?.data?.name || partners[i].father?.name;\r\n\t\tif(!motherName || !fatherName)\r\n\t\t\tcontinue;\r\n\t\tlet motherNode = getNodeByName(flattenNodes, motherName);\r\n\t\tlet fatherNode = getNodeByName(flattenNodes, fatherName);\r\n\t\tif(motherNode && fatherNode)\r\n\t\t\tlinks.push({'mother': motherNode, 'father': fatherNode});\r\n\t}\r\n\treturn links;\r\n}\r\n\r\n// get ancestors of a node\r\nexport function ancestors(dataset, node) {\r\n\tlet ancestors = [];\r\n\tfunction recurse(node) {\r\n\t\tif(node.data) node = node.data;\r\n\t\tif('mother' in node && 'father' in node && !('noparents' in node)){\r\n\t\t\trecurse(getNodeByName(dataset, node.mother));\r\n\t\t\trecurse(getNodeByName(dataset, node.father));\r\n\t\t}\r\n\t\tancestors.push(node);\r\n\t}\r\n\trecurse(node);\r\n\treturn ancestors;\r\n}\r\n\r\n// test if two nodes are consanguinous partners\r\nexport function consanguity(node1, node2, opts) {\r\n\tif(node1.depth !== node2.depth) // parents at different depths\r\n\t\treturn true;\r\n\tlet ancestors1 = ancestors(opts.dataset, node1);\r\n\tlet ancestors2 = ancestors(opts.dataset, node2);\r\n\tlet names1 = $.map(ancestors1, function(ancestor, _i){return ancestor.name;});\r\n\tlet names2 = $.map(ancestors2, function(ancestor, _i){return ancestor.name;});\r\n\tlet consanguity = false;\r\n\t$.each(names1, function( _index, name ) {\r\n\t\tif($.inArray(name, names2) !== -1){\r\n\t\t\tconsanguity = true;\r\n\t\t\treturn false;\r\n\t\t}\r\n\t});\r\n\treturn consanguity;\r\n}\r\n\r\n// return a flattened representation of the tree\r\nexport function flatten(root) {\r\n\tlet flat = [];\r\n\tfunction recurse(node) {\r\n\t\tif(node.children)\r\n\t\t\tnode.children.forEach(recurse);\r\n\t\tflat.push(node);\r\n\t}\r\n\trecurse(root);\r\n\tif(root && root._dataset)\r\n\t\tflat.dataset = root._dataset;\r\n\treturn flat;\r\n}\r\n\r\n// test if x position overlaps a node at the same depth\r\nexport function overlap(opts, nodes, xnew, depth, exclude_names) {\r\n\tfor(let n=0; n<nodes.length; n++) {\r\n\t\tif(depth === nodes[n].depth && $.inArray(nodes[n].data.name, exclude_names) === -1){\r\n\t\t\tif(Math.abs(xnew - nodes[n].x) < (opts.symbol_size*1.15))\r\n\t\t\t\treturn true;\r\n\t\t}\r\n\t}\r\n\treturn false;\r\n}\r\n\r\n// test if moving siblings by diff overlaps with other nodes\r\nfunction nodesOverlap(opts, node, diff, root) {\r\n\tlet descendants = node.descendants();\r\n\tlet descendantsNames = $.map(descendants, function(descendant, _i){return descendant.data.name;});\r\n\tlet nodes = root.descendants();\r\n\tfor(let i=0; i<descendants.length; i++){\r\n\t\tlet descendant = descendants[i];\r\n\t\tif(node.data.name !== descendant.data.name){\r\n\t\t\tlet xnew = descendant.x - diff;\r\n\t\t\tif(overlap(opts, nodes, xnew, descendant.depth, descendantsNames))\r\n\t\t\t\treturn true;\r\n\t\t}\r\n\t}\r\n\treturn false;\r\n}\r\n\r\n// Adjust D3 layout positioning.\r\n// Position hidden parent node centring them between father and mother nodes. Remove kinks\r\n// from links - e.g. where there is a single child plus a hidden child\r\nexport function adjust_coords(opts, root, flattenNodes) {\r\n\tfunction recurse(node) {\r\n\t\tif (node.children) {\r\n\t\t\tnode.children.forEach(recurse);\r\n\r\n\t\t\tif(node.data.father !== undefined && node.data.mother !== undefined) { \t// hidden nodes\r\n\t\t\t\tlet fatherName = (typeof node.data.father === 'string' ? node.data.father : node.data.father.name);\r\n\t\t\t\tlet motherName = (typeof node.data.mother === 'string' ? node.data.mother : node.data.mother.name);\r\n\t\t\t\tif(!fatherName || !motherName)\r\n\t\t\t\t\treturn;\r\n\t\t\t\tlet father = getNodeByName(flattenNodes, fatherName);\r\n\t\t\t\tlet mother = getNodeByName(flattenNodes, motherName);\r\n\t\t\t\tif(!father || !mother)\r\n\t\t\t\t\treturn;\r\n\t\t\t\tlet xmid = (father.x + mother.x) /2;\r\n\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.depth, [node.data.name])) {\r\n\t\t\t\t\tnode.x = xmid;   // centralise parent nodes\r\n\t\t\t\t\tlet diff = node.x - xmid;\r\n\t\t\t\t\tif(node.children.length === 2 && (node.children[0].data.hidden || node.children[1].data.hidden)) {\r\n\t\t\t\t\t\tif(!(node.children[0].data.hidden && node.children[1].data.hidden)) {\r\n\t\t\t\t\t\t\tlet child1 = (node.children[0].data.hidden ? node.children[1] : node.children[0]);\r\n\t\t\t\t\t\t\tlet child2 = (node.children[0].data.hidden ? node.children[0] : node.children[1]);\r\n\t\t\t\t\t\t\tif( ((child1.x < child2.x && xmid < child2.x) || (child1.x > child2.x && xmid > child2.x)) &&\r\n\t\t\t\t\t\t\t\t!overlap(opts, root.descendants(), xmid, child1.depth, [child1.data.name])){\r\n\t\t\t\t\t\t\t\tchild1.x = xmid;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if(node.children.length === 1 && !node.children[0].data.hidden) {\r\n\t\t\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.children[0].depth, [node.children[0].data.name]))\r\n\t\t\t\t\t\t\tnode.children[0].x = xmid;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif(diff !== 0 && !nodesOverlap(opts, node, diff, root)){\r\n\t\t\t\t\t\t\tif(node.children.length === 1) {\r\n\t\t\t\t\t\t\t\tnode.children[0].x = xmid;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tlet descendants = node.descendants();\r\n\t\t\t\t\t\t\t\tif(opts.DEBUG)\r\n\t\t\t\t\t\t\t\t\tconsole.log('ADJUSTING '+node.data.name+' NO. DESCENDANTS '+descendants.length+' diff='+diff);\r\n\t\t\t\t\t\t\t\tfor(let i=0; i<descendants.length; i++) {\r\n\t\t\t\t\t\t\t\t\tif(node.data.name !== descendants[i].data.name)\r\n\t\t\t\t\t\t\t\t\t\tdescendants[i].x -= diff;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if((node.x < father.x && node.x < mother.x) || (node.x > father.x && node.x > mother.x)){\r\n\t\t\t\t\t\tnode.x = xmid;   // centralise parent nodes if it doesn't lie between mother and father\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\trecurse(root);\r\n\trecurse(root);\r\n}\r\n\r\nfunction contains_parent(arr, m, f) {\r\n\tfor(let i=0; i<arr.length; i++)\r\n\t\tif(arr[i].mother === m && arr[i].father === f)\r\n\t\t\treturn true;\r\n\treturn false;\r\n}\r\n\r\n// get grandparents index\r\nfunction get_grandparents_idx(dataset, midx, fidx) {\r\n\tlet gmidx = midx;\r\n\tlet gfidx = fidx;\r\n\twhile(  'mother' in dataset[gmidx] && 'mother' in dataset[gfidx] &&\r\n\t\t  !('noparents' in dataset[gmidx]) && !('noparents' in dataset[gfidx])){\r\n\t\tgmidx = getIdxByName(dataset, dataset[gmidx].mother);\r\n\t\tgfidx = getIdxByName(dataset, dataset[gfidx].mother);\r\n\t}\r\n\treturn {'midx': gmidx, 'fidx': gfidx};\r\n}\r\n\r\n// update parent node and sort twins\r\nfunction updateParent(p, parent, id, nodes, opts) {\r\n\t// add to parent node\r\n\tif('parent_node' in p)\r\n\t\tp.parent_node.push(parent);\r\n\telse\r\n\t\tp.parent_node = [parent];\r\n\r\n\t// check twins lie next to each other\r\n\tif(p.mztwin || p.dztwins) {\r\n\t\tlet twins = getTwins(opts.dataset, p);\r\n\t\tfor(let i=0; i<twins.length; i++) {\r\n\t\t\tlet twin = getNodeByName(nodes, twins[i].name);\r\n\t\t\tif(twin)\r\n\t\t\t\ttwin.id = id++;\r\n\t\t}\r\n\t}\r\n\treturn id;\r\n}\r\n\r\nfunction setChildrenId(children, id) {\r\n\t// sort twins to lie next to each other\r\n\tchildren.sort(function(a, b) {\r\n\t\tif(a.mztwin && b.mztwin && a.mztwin === b.mztwin)\r\n\t\t\treturn 0;\r\n\t\telse if(a.dztwin && b.dztwin && a.dztwin === b.dztwin)\r\n\t\t\treturn 0;\r\n\t\telse if(a.mztwin || b.mztwin || a.dztwin || b.dztwin)\r\n\t\t\treturn 1;\r\n\t\treturn 0;\r\n\t});\r\n\r\n\t$.each(children, function(_i, p) {\r\n\t\tif(p.id === undefined) p.id = id++;\r\n\t});\r\n\treturn id;\r\n}\r\n\r\nexport function makeid(len) {\r\n\tlet text = \"\";\r\n\tlet possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\r\n\tfor( let i=0; i < len; i++ )\r\n\t\ttext += possible.charAt(Math.floor(Math.random() * possible.length));\r\n\treturn text;\r\n}\r\n\r\nexport function buildTree(opts, person, root, partnerLinks, id) {\r\n\tif (typeof person.children === typeof undefined)\r\n\t\tperson.children = getChildren(opts.dataset, person);\r\n\r\n\tif (typeof partnerLinks === typeof undefined) {\r\n\t\tpartnerLinks = [];\r\n\t\tid = 1;\r\n\t}\r\n\r\n\tlet nodes = flatten(root);\r\n\t//console.log('NAME='+person.name+' NO. CHILDREN='+person.children.length);\r\n\tlet partners = [];\r\n\t$.each(person.children, function(_i, child) {\r\n\t\t$.each(opts.dataset, function(_j, p) {\r\n\t\t\tif (((child.name === p.mother) || (child.name === p.father)) && child.id === undefined) {\r\n\t\t\t\tlet m = getNodeByName(nodes, p.mother);\r\n\t\t\t\tlet f = getNodeByName(nodes, p.father);\r\n\t\t\t\tm = (m !== undefined? m : getNodeByName(opts.dataset, p.mother));\r\n\t\t\t\tf = (f !== undefined? f : getNodeByName(opts.dataset, p.father));\r\n\t\t\t\tif(!contains_parent(partners, m, f))\r\n\t\t\t\t\tpartners.push({'mother': m, 'father': f});\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n\t$.merge(partnerLinks, partners);\r\n\r\n\t$.each(partners, function(_i, ptr) {\r\n\t\tlet mother = ptr.mother;\r\n\t\tlet father = ptr.father;\r\n\t\tmother.children = [];\r\n\t\tlet parent = {\r\n\t\t\t\tname : makeid(4),\r\n\t\t\t\thidden : true,\r\n\t\t\t\tparent : null,\r\n\t\t\t\tfather : father,\r\n\t\t\t\tmother : mother,\r\n\t\t\t\tchildren : getChildren(opts.dataset, mother, father)\r\n\t\t};\r\n\r\n\t\tlet midx = getIdxByName(opts.dataset, mother.name);\r\n\t\tlet fidx = getIdxByName(opts.dataset, father.name);\r\n\t\tif(!('id' in father) && !('id' in mother))\r\n\t\t\tid = setChildrenId(person.children, id);\r\n\r\n\t\t// look at grandparents index\r\n\t\tlet gp = get_grandparents_idx(opts.dataset, midx, fidx);\r\n\t\tif(gp.fidx < gp.midx) {\r\n\t\t\tfather.id = id++;\r\n\t\t\tparent.id = id++;\r\n\t\t\tmother.id = id++;\r\n\t\t} else {\r\n\t\t\tmother.id = id++;\r\n\t\t\tparent.id = id++;\r\n\t\t\tfather.id = id++;\r\n\t\t}\r\n\t\tid = updateParent(mother, parent, id, nodes, opts);\r\n\t\tid = updateParent(father, parent, id, nodes, opts);\r\n\t\tperson.children.push(parent);\r\n\t});\r\n\tid = setChildrenId(person.children, id);\r\n\r\n\t$.each(person.children, function(_i, p) {\r\n\t\tid = buildTree(opts, p, root, partnerLinks, id)[1];\r\n\t});\r\n\treturn [partnerLinks, id];\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// General utility functions\r\n\r\n// Re-export functions from new modules for backward compatibility\r\nexport {validate_pedigree, validate_age_yob, create_err, unconnected} from './validation.js';\r\nexport {messages, print_opts, is_fullscreen, get_svg_dimensions, get_tree_dimensions, isIE, isEdge} from './dom.js';\r\nexport {\r\n\tgetIdxByName, getNodeByName, isProband, setProband, getProbandIndex, exists,\r\n\tget_partners, getChildren, getAllChildren, getTwins, getSiblings, getAllSiblings,\r\n\tgetAdoptedSiblings, getDepth, getNodesAtDepth, linkNodes, ancestors, consanguity,\r\n\tflatten, overlap, adjust_coords, buildTree, makeid\r\n} from './tree-utils.js';\r\n\r\n// Global state (to be refactored later)\r\nexport let roots = {};\r\n\r\nexport function copy_dataset(dataset) {\r\n\tif(dataset[0].id) { // sort by id\r\n\t\tdataset.sort(function(a,b){return (!a.id || !b.id ? 0: (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0));});\r\n\t}\r\n\r\n\tlet disallowed = [\"id\", \"parent_node\"];\r\n\tlet newdataset = [];\r\n\tfor(let i=0; i<dataset.length; i++){\r\n\t\tlet obj = {};\r\n\t\tfor(let key in dataset[i]) {\r\n\t\t\tif(disallowed.indexOf(key) === -1)\r\n\t\t\t\tobj[key] = dataset[i][key];\r\n\t\t}\r\n\t\tnewdataset.push(obj);\r\n\t}\r\n\treturn newdataset;\r\n}\r\n\r\n// check if the object contains a key with a given prefix\r\nexport function prefixInObj(prefix, obj) {\r\n\tlet found = false;\r\n\tif(obj)\r\n\t\t$.each(obj, function(k, _n){\r\n\t\t\tif(k.indexOf(prefix+\"_\") === 0 || k === prefix) {\r\n\t\t\t\tfound = true;\r\n\t\t\t\treturn found;\r\n\t\t\t}\r\n\t\t});\r\n\treturn found;\r\n}\r\n\r\n/**\r\n *  Get formatted time or data & time\r\n */\r\nexport function getFormattedDate(time){\r\n\tlet d = new Date();\r\n\tif(time)\r\n\t\treturn ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\r\n\telse\r\n\t\treturn d.getFullYear() + \"-\" + ('0' + (d.getMonth() + 1)).slice(-2) + \"-\" + ('0' + d.getDate()).slice(-2) + \" \" + ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\r\n }\r\n\r\nexport function capitaliseFirstLetter(string) {\r\n\treturn string.charAt(0).toUpperCase() + string.slice(1);\r\n}\r\n\r\n// given the name of a url param get the value\r\nexport function urlParam(name){\r\n\tlet results = new RegExp('[?&]' + name + '=([^&#]*)').exec(window.location.href);\r\n\tif (results===null)\r\n\t   return null;\r\n\telse\r\n\t   return results[1] || 0;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\nimport {getposition, setposition} from './pedcache.js';\r\n\r\nlet zm;\r\n\r\n/**\r\n * Initialize zoom and pan behavior on SVG element\r\n * Sets up D3 zoom with configurable scale extent and source filters\r\n * Restores cached position from previous session if available\r\n * @param {Object} opts - Pedigree options object\r\n * @param {number} opts.zoomIn - Minimum zoom scale (e.g., 0.1)\r\n * @param {number} opts.zoomOut - Maximum zoom scale (e.g., 10)\r\n * @param {Array} [opts.zoomSrc] - Array of zoom sources to enable ('wheel', 'button')\r\n * @param {number} opts.symbol_size - Size of person symbols for positioning\r\n * @param {Object} svg - D3 selection of SVG element\r\n */\r\nexport function init_zoom(opts, svg) {\r\n\t// offsets\r\n\tlet xi = opts.symbol_size/2;\r\n\tlet yi = -opts.symbol_size*2.5;\r\n\r\n\tzm = d3.zoom()\r\n\t  .scaleExtent([opts.zoomIn, opts.zoomOut])\r\n\t  .filter(function(e) {\r\n\t\t\tif(!opts.zoomSrc || opts.zoomSrc.indexOf('wheel') === -1) {\r\n\t\t\t\tif(e.type && e.type === 'wheel') return false\r\n\t\t\t}\r\n\t\t\t// ignore dblclick & secondary mouse buttons\r\n\t\t\treturn (e.type !== 'dblclick') && !e.button})\r\n\t  .on('zoom', function(e) { zooming(e, opts); });\r\n\tsvg.call(zm);\r\n\r\n\t// set initial position & scale\r\n\tlet xyk = getposition(opts);\t\t// cached position\r\n\tlet k = (xyk.length === 3 ? xyk[2] : 1);\r\n\tlet x = (xyk[0] !== null ? xyk[0]/k: (xi*k));\r\n\tlet y = (xyk[1] !== null ? xyk[1]/k: (yi*k));\r\n\r\n\tvar transform = d3.zoomIdentity\r\n      .scale(k)\r\n      .translate(x, y);\r\n    svg.call(zm.transform, transform);\r\n}\r\n\r\n/**\r\n * Zoom in or out by a scale factor using button controls\r\n * @param {Object} opts - Pedigree options object\r\n * @param {string} opts.targetDiv - ID of the container div\r\n * @param {number} scale - Scale factor (>1 zooms in, <1 zooms out, e.g., 1.2 or 0.8)\r\n * @example\r\n * btn_zoom(opts, 1.5); // Zoom in by 50%\r\n * btn_zoom(opts, 0.8); // Zoom out by 20%\r\n */\r\nexport function btn_zoom(opts, scale) {\r\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\r\n\tsvg.transition().duration(50).call(zm.scaleBy, scale);\r\n}\r\n\r\n/**\r\n * Scale and center the pedigree to fit within the viewport\r\n * Calculates optimal scale and position to show entire pedigree\r\n * Uses animated transition for smooth scaling\r\n * @param {Object} opts - Pedigree options object\r\n * @param {string} opts.targetDiv - ID of the container div\r\n * @param {number} opts.zoomIn - Minimum zoom scale\r\n * @param {number} opts.zoomOut - Maximum zoom scale\r\n * @param {number} opts.symbol_size - Size of person symbols\r\n */\r\nexport function scale_to_fit(opts) {\r\n\tlet d = get_dimensions(opts);\r\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\r\n\tlet size = get_svg_size(svg);\r\n\tlet f = 1;\r\n\tlet k = (f / Math.max(d.wid/size.w, d.hgt/size.h));\r\n\r\n\tif(k < opts.zoomIn) zm.scaleExtent([k, opts.zoomOut]);\r\n\r\n\tlet ped = get_pedigree_center(opts);\r\n\tsvg.call(zm.translateTo, ped.x-(opts.symbol_size), ped.y-(opts.symbol_size));\r\n\tsetTimeout(function(){svg.transition().duration(700).call(zm.scaleTo, k)}, 400);\r\n}\r\n\r\nfunction zooming(e, opts) {\r\n\t(opts.DEBUG && console.log(\"zoom\", e.transform));\r\n\tlet t = e.transform;\r\n\tlet k = (t.k && t.k !== 1 ? t.k : undefined);\r\n\tsetposition(opts, t.x, t.y, k);\r\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\r\n\tped.attr('transform', 'translate(' + t.x + ',' + t.y + ')' + (k ? ' scale(' + k + ')' : ''));\r\n}\r\n\r\nfunction get_pedigree_center(opts) {\r\n\tlet b = get_bounds(opts);\r\n\treturn {x: b.xmin+((b.xmax-b.xmin)/2), y: b.ymin+((b.ymax-b.ymin)/2)};\r\n}\r\n\r\n// find width/height of pedigree graphic\r\nfunction get_dimensions(opts) {\r\n\tlet b = get_bounds(opts);\r\n\treturn {wid: Math.abs(b.xmax-b.xmin), hgt: Math.abs(b.ymax-b.ymin)};\r\n}\r\n\r\n/**\r\n * Get the bounding box coordinates of the visible pedigree\r\n * Calculates min/max x and y coordinates of all visible nodes\r\n * Excludes hidden nodes and hidden_root from calculations\r\n * @param {Object} opts - Pedigree options object\r\n * @param {string} opts.targetDiv - ID of the container div\r\n * @param {number} opts.symbol_size - Size of person symbols for padding\r\n * @returns {Object} Bounding box with {xmin, xmax, ymin, ymax} properties\r\n * @example\r\n * let bounds = get_bounds(opts);\r\n * console.log(bounds.xmin, bounds.xmax, bounds.ymin, bounds.ymax);\r\n */\r\nexport function get_bounds(opts) {\r\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\r\n\tlet xmin = Number.MAX_VALUE;\r\n\tlet xmax = -1000000;\r\n\tlet ymin = Number.MAX_VALUE;\r\n\tlet ymax = -1000000;\r\n\tlet sym = opts.symbol_size;\r\n\tped.selectAll('g').each(function(d, _i) {\r\n\t\tif(d.x && d.data.name !== 'hidden_root' && !d.data.hidden) {\r\n\t\t\tlet n = getNodeSize(opts, this, sym);\r\n\t\t\tif(d.x-sym < xmin) xmin = d.x-sym;\r\n\t\t\tif(d.x+n.w+sym > xmax) xmax = d.x+n.w+sym;\r\n\t\t\tif(d.y < ymin) ymin = d.y;\r\n\t\t\tif(d.y+n.h+sym > ymax) ymax = d.y+n.h+sym;\r\n\t\t}\r\n\t});\r\n\treturn {xmin:xmin, xmax:xmax, ymin:ymin, ymax:ymax};\r\n}\r\n\r\n/**\r\n * Get the size of an individual's graphical representation\r\n */\r\nfunction getNodeSize(opts, g_elm, sym) {\r\n\tlet node = d3.select(g_elm).node();\r\n\tlet dg = node.getBBox();\r\n\tlet w = dg.width;\r\n\tlet h = dg.height;\r\n\tif(w === 0 && h === 0) {\t// pedigree not shown yet (family history section not opened)\r\n\t\ttry {\r\n\t\t\tw = sym*2;\r\n\t\t\th = sym*2;\r\n\t\t\tlet text_elements = d3.select(g_elm).selectAll(\".indi_details\"); // get individuals details\r\n\t\t\tfor(let i=0; i<text_elements._groups[0].length; i++) {\r\n\t\t\t\tlet txt = text_elements._groups[0][i].firstChild.nodeValue;\r\n\t\t\t\tlet txtsize = getTextSize(txt, opts.font_family, opts.font_size);\r\n\t\r\n\t\t\t\tw = Math.max(txtsize.w+(sym/2), w);\r\n\t\t\t\th = Math.max((sym*2)+(i*txtsize.h), h);\r\n\t\t\t}\r\n\t\t} catch(err) {\r\n\t\t\tconsole.error(err);\r\n\t\t\tw = sym*2;\r\n\t\t\th = sym*2;\r\n\t\t}\r\n\t}\r\n\treturn {w:w, h:h};\r\n}\r\n\r\n/**\r\n * Calculate width and height of text\r\n */\r\nfunction getTextSize(txt, font, fontSize) {\r\n\t  let o = $('<div></div>')\r\n\t            .text(txt)\r\n\t            .css(\r\n\t\t\t\t\t{'position': 'absolute',\r\n\t\t\t\t\t 'float': 'left', 'white-space': 'nowrap', 'visibility': 'hidden',\r\n\t\t\t\t\t 'font': font || 'Helvetica',\r\n\t\t\t\t\t 'fontSize': fontSize || '1em'})\r\n\t            .appendTo($('body'));\r\n\t  let s = {w: o.width(), h:o.height()};\r\n\t  o.remove();\r\n\t  return s;\r\n}\r\n\r\nfunction get_svg_size(svg) {\r\n\treturn {w: svg.node().clientWidth, h:svg.node().clientHeight};\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// undo, redo, reset buttons\r\nimport * as pedcache from './pedcache.js';\r\nimport {btn_zoom, scale_to_fit} from './zoom.js';\r\nimport {copy_dataset, getProbandIndex, is_fullscreen, messages} from './utils.js';\r\n\r\nexport function addButtons(options) {\r\n\tlet opts = $.extend({\r\n        // defaults\r\n\t\tbtn_target: 'pedigree_history'\r\n    }, options );\r\n\r\n\tlet btns = [{\"fa\": \"fa-file-image\", \"title\": \"download PNG image\"},\r\n\t\t\t\t{\"fa\": \"fa-undo\", \"title\": \"undo\"},\r\n\t\t\t\t{\"fa\": \"fa-redo\", \"title\": \"redo\"},\r\n\t\t\t\t{\"fa\": \"fa-refresh\", \"title\": \"reset\"}];\r\n\r\n\tbtns.push({\"fa\": \"fa-crosshairs\", \"title\": \"scale-to-fit\"});\r\n\t// Phase 3.3.3: Toujours afficher les boutons zoom, mais les griser si désactivés\r\n\tif(opts.zoomSrc && (opts.zoomSrc.indexOf('button') > -1)) {\r\n\t\tbtns.push({\"fa\": \"fa-minus-circle\", \"title\": opts.zoomOut === 1 ? \"zoom-out (disabled: already at minimum)\" : \"zoom-out\", \"disabled\": opts.zoomOut === 1});\r\n\t\tbtns.push({\"fa\": \"fa-plus-circle\", \"title\": opts.zoomIn === 1 ? \"zoom-in (disabled: already at maximum)\" : \"zoom-in\", \"disabled\": opts.zoomIn === 1});\r\n\t}\r\n\tbtns.push({\"fa\": \"fa-arrows-alt\", \"title\": \"fullscreen\"});\r\n\r\n\tlet lis = \"\";\r\n\tfor(let i=0; i<btns.length; i++) {\r\n\t\tlis += '<span>';\r\n\t\tlis += '<i class=\"fa fa-lg ' + btns[i].fa + ' pe-2' + (btns[i].disabled ? ' disabled-btn' : '') + '\" ' +\r\n\t\t'aria-hidden=\"true\" title=\"'+ btns[i].title + '\" ' +\r\n\t\t(btns[i].fa === \"fa-arrows-alt\" ? 'id=\"fullscreen\" ' : '') +\r\n\t\t(btns[i].disabled ? 'style=\"opacity: 0.3; cursor: not-allowed;\" ' : '') +\r\n\t\t'></i>';\r\n\r\n\t\tlis += '</span>';\r\n\t}\r\n\t$( \"#\"+opts.btn_target ).append(lis);\r\n\taddPbuttonEvents(opts);\r\n}\r\n\r\nfunction addPbuttonEvents(opts) {\r\n\t// fullscreen\r\n    $(document).on('webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange', function(_e)  {\r\n\t\tlet local_dataset = pedcache.current(opts);\r\n\t\tif (local_dataset !== undefined && local_dataset !== null) {\r\n\t\t\topts.dataset = local_dataset;\r\n\t\t}\r\n\t\t$(document).trigger('rebuild', [opts]);\r\n\t\t// Phase 3.2.3: Preserve zoom/pan position in fullscreen\r\n\t\t// scale_to_fit(opts) was called here, but it resets the zoom\r\n\t\t// The rebuild automatically restores the cached position via init_zoom()\r\n    });\r\n\r\n\t$('#fullscreen').on('click', function(_e) {\r\n\t\t// toggle fullscreen\r\n\t\tif (!is_fullscreen()) {\r\n\t\t\tlet target = $(\"#\"+opts.targetDiv)[0];\r\n\t\t\tif (target.requestFullscreen) {\r\n                target.requestFullscreen();\r\n            } else if (document.documentElement.mozRequestFullScreen) {\r\n\t\t\t\ttarget.mozRequestFullScreen(); // Firefox\r\n            } else if (document.documentElement.webkitRequestFullscreen) {\r\n                target.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT); // Chrome and Safari\r\n            } else if (document.documentElement.msRequestFullscreen) {\r\n                target.msRequestFullscreen(); // IE\r\n            }\r\n\t\t} else {\r\n            if (document.exitFullscreen) {\r\n                document.exitFullscreen();\r\n            } else if (document.msExitFullscreen) {\r\n                document.msExitFullscreen();\r\n            } else if (document.mozCancelFullScreen) {\r\n                document.mozCancelFullScreen();\r\n            } else if (document.webkitExitFullscreen) {\r\n                document.webkitExitFullscreen();\r\n            }\r\n\t\t}\r\n\t});\r\n\r\n\t// press and hold to zoom in/out\r\n\tlet timeoutId = 0;\r\n\tfunction zoomIn() {btn_zoom(opts, 1.05);}\r\n\tfunction zoomOut() {btn_zoom(opts, 0.95);}\r\n\t$('.fa-plus-circle, .fa-minus-circle').on('mousedown', function() {\r\n\t\t// Phase 3.3.3: Ignorer les clics sur les boutons désactivés\r\n\t\tif($(this).hasClass('disabled-btn')) return;\r\n\t    timeoutId = setInterval(($( this ).hasClass( \"fa-plus-circle\" ) ? zoomIn : zoomOut), 50);\r\n\t}).on('mouseup mouseleave', function() {\r\n\t    clearInterval(timeoutId);\r\n\t});\r\n\r\n\t// undo/redo/reset\r\n\t$( \"#\"+opts.btn_target ).on( \"click\", function(e) {\r\n\t\te.stopPropagation();\r\n\t\tif($(e.target).hasClass(\"fg-grey\"))\r\n\t\t\treturn false;\r\n\r\n\t\tif($(e.target).hasClass('fa-undo')) {\r\n\t\t\topts.dataset = pedcache.previous(opts);\r\n\t\t\t$(\"#\"+opts.targetDiv).empty();\r\n\t\t\t$(document).trigger('build', [opts]);\r\n\t\t} else if ($(e.target).hasClass('fa-redo')) {\r\n\t\t\topts.dataset = pedcache.next(opts);\r\n\t\t\t$(\"#\"+opts.targetDiv).empty();\r\n\t\t\t$(document).trigger('build', [opts]);\r\n\t\t} else if ($(e.target).hasClass('fa-refresh')) {\r\n\t\t\tmessages(\"Pedigree Reset\",\r\n\t\t\t         \"This may result in loss of some data. Reset now?\",\r\n\t\t\t         reset, opts);\r\n\t\t} else if ($(e.target).hasClass('fa-crosshairs')) {\r\n\t\t\tscale_to_fit(opts);\r\n\t\t} else if ($(e.target).hasClass('fa-file-image')) {\r\n\t\t\treturn;\r\n\t\t} \r\n\r\n\t\t// trigger fhChange event\r\n\t\t$(document).trigger('fhChange', [opts]);\r\n\t});\r\n}\r\n\r\n// reset pedigree and clear the history\r\nfunction reset(opts) {\r\n\tlet proband;\r\n\tif(opts.keep_proband_on_reset) {\r\n\t\tlet local_dataset = pedcache.current(opts);\r\n\t\tlet newdataset =  copy_dataset(local_dataset);\r\n\t\tproband = newdataset[getProbandIndex(newdataset)];\r\n\t\t//let children = pedigree_util.getChildren(newdataset, proband);\r\n\t\t// Phase 3.2.5: Preserve proband.name to maintain external references\r\n\t\t// proband.name = \"ch1\";  // REMOVED: This was resetting the name incorrectly\r\n\t\tproband.mother = \"f21\";\r\n\t\tproband.father = \"m21\";\r\n\t\t// clear pedigree data but keep proband data and risk factors\r\n\t\tpedcache.clear_pedigree_data(opts)\r\n\t} else {\r\n\t\tproband = {\r\n\t\t\t\"name\":\"ch1\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"proband\":true,\"status\":\"0\",\"display_name\":\"me\"\r\n\t\t};\r\n\t\tpedcache.clear(opts); // clear all storage data\r\n\t}\r\n\tdelete opts.dataset;\r\n\r\n\tlet selected = $(\"input[name='default_fam']:checked\");\r\n\tif(selected.length > 0 && selected.val().indexOf(\"extended\") > -1) {\r\n\t\tlet partner = {\"name\":\"Spj\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"};\r\n\t\tlet daughter = {\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"};\r\n\t\tlet son     = {\"name\":\"Knx\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"son\"};\r\n\t\tpartner.sex    = (proband.sex === \"F\" ?\"M\":\"F\");\r\n\t\tdaughter.mother = (proband.sex === \"F\" ? proband.name: partner.name);\r\n\t\tdaughter.father = (proband.sex === \"F\" ? partner.name: proband.name);\r\n\t\tson.mother      = (proband.sex === \"F\" ? proband.name: partner.name);\r\n\t\tson.father      = (proband.sex === \"F\" ? partner.name: proband.name);\r\n\t\topts.dataset    = [proband, partner, daughter, son];\r\n\t}\r\n\r\n\tif(selected.length > 0 && selected.val() === 'extended2') {    // secondary relatives\r\n\t\topts.dataset.push(\r\n\t\t\t{\"name\":\"wZA\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandfather\"},\r\n\t\t\t{\"name\":\"MAk\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandmother\"},\r\n\t\t\t{\"name\":\"zwB\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandfather\"},\r\n\t\t\t{\"name\":\"dOH\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandmother\"},\r\n\t\t\t{\"name\":\"MKg\",\"sex\":\"F\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal aunt\"},\r\n\t\t\t{\"name\":\"xsm\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal uncle\"},\r\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"father\"},\r\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\",\"display_name\":\"mother\"},\r\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\r\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\r\n\t\t\t{\"name\":\"uuc\",\"display_name\":\"maternal aunt\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"xIw\",\"display_name\":\"maternal uncle\",\"sex\":\"M\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"});\r\n\t} else if(selected.length > 0 && selected.val() === 'extended1') {    // primary relatives\r\n\t\topts.dataset.push(\r\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"father\",\"noparents\":true},\r\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"mother\",\"noparents\":true},\r\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\r\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"});\r\n\t} else {\r\n\t\topts.dataset = [\r\n\t\t\t{\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\r\n\t\t\t{\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\r\n\t\t\tproband];\r\n\t}\r\n\t$(document).trigger('rebuild', [opts]);\r\n}\r\n\r\nexport function updateButtons(opts) {\r\n\tlet current = pedcache.get_count(opts);\r\n\tlet nstore = pedcache.nstore(opts);\r\n\tlet id = \"#\"+opts.btn_target;\r\n\tif(nstore <= current)\r\n\t\t$(id+\" .fa-redo\").addClass('fg-grey');\r\n\telse\r\n\t\t$(id+\" .fa-redo\").removeClass('fg-grey');\r\n\r\n\tif(current > 1)\r\n\t\t$(id+\" .fa-undo\").removeClass('fg-grey');\r\n\telse\r\n\t\t$(id+\" .fa-undo\").addClass('fg-grey');\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\nimport * as pedigree_util from './utils.js';\r\n\r\n// cancers, genetic & pathology tests\r\nexport let cancers = {\r\n\t\t'breast_cancer': 'breast_cancer_diagnosis_age',\r\n\t\t'breast_cancer2': 'breast_cancer2_diagnosis_age',\r\n\t\t'ovarian_cancer': 'ovarian_cancer_diagnosis_age',\r\n\t\t'prostate_cancer': 'prostate_cancer_diagnosis_age',\r\n\t\t'pancreatic_cancer': 'pancreatic_cancer_diagnosis_age'\r\n\t};\r\nexport let genetic_test1 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'rad51d', 'rad51c', 'brip1'];\r\nexport let genetic_test2 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1'];\r\nexport let genetic_test4 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1', 'hoxb13'];\r\n\r\nexport let pathology_tests = ['er', 'pr', 'her2', 'ck14', 'ck56'];\r\n\r\n// risk factor to storage\r\nlet RISK_FACTOR_STORE = {};\r\n\r\n// get surgical ops and PRS for canrisk header\r\nexport function get_meta() {\r\n\tlet meta = get_surgical_ops();\r\n\tlet prs;\r\n\ttry {\r\n\t\tprs = get_prs_values();\r\n\t\tif(prs.breast_cancer_prs && prs.breast_cancer_prs.alpha !== 0 && prs.breast_cancer_prs.zscore !== 0) {\r\n\t\t\tmeta += \"\\n##PRS_BC=alpha=\"+prs.breast_cancer_prs.alpha+\",zscore=\"+prs.breast_cancer_prs.zscore;\r\n\t\t}\r\n\r\n\t\tif(prs.ovarian_cancer_prs && prs.ovarian_cancer_prs.alpha !== 0 && prs.ovarian_cancer_prs.zscore !== 0) {\r\n\t\t\tmeta += \"\\n##PRS_OC=alpha=\"+prs.ovarian_cancer_prs.alpha+\",zscore=\"+prs.ovarian_cancer_prs.zscore;\r\n\t\t}\r\n\r\n\t\tif(prs.prostate_cancer_prs && prs.prostate_cancer_prs.alpha !== 0 && prs.prostate_cancer_prs.zscore !== 0) {\r\n\t\t\tmeta += \"\\n##PRS_PC=alpha=\"+prs.prostate_cancer_prs.alpha+\",zscore=\"+prs.prostate_cancer_prs.zscore;\r\n\t\t}\r\n\t} catch(err) { console.warn(\"PRS\", prs); }\r\n\treturn meta;\r\n}\r\n\r\n// return a non-anonimised pedigree format\r\nexport function get_non_anon_pedigree(dataset, meta, version=2, ethnicity=undefined) {\r\n\treturn get_pedigree(dataset, undefined, meta, false, version, ethnicity);\r\n}\r\n\r\n//check if input has a value\r\nexport function hasInput(id) {\r\n\tconst v = $('#'+id).val();\r\n\treturn v && v.trim().length !== 0;\r\n}\r\n\r\n//return true if the object is empty\r\nlet isEmpty = function(myObj) {\r\n\tfor(let key in myObj) {\r\n\t\tif (Object.prototype.hasOwnProperty.call(myObj, key)) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\treturn true;\r\n}\r\n\r\n//get breast and ovarian PRS values\r\nexport function get_prs_values() {\r\n\tlet prs = {};\r\n\tif(hasInput(\"breast_prs_a\") && hasInput(\"breast_prs_z\")) {\r\n\t\tprs['breast_cancer_prs'] = {\r\n\t\t\t'alpha': parseFloat($('#breast_prs_a').val()),\r\n\t\t\t'zscore': parseFloat($('#breast_prs_z').val()),\r\n\t\t\t'percent': parseFloat($('#breast_prs_percent').val())\r\n\t\t};\r\n\t}\r\n\tif(hasInput(\"ovarian_prs_a\") && hasInput(\"ovarian_prs_z\")) {\r\n\t\tprs['ovarian_cancer_prs'] = {\r\n\t\t\t'alpha': parseFloat($('#ovarian_prs_a').val()),\r\n\t\t\t'zscore': parseFloat($('#ovarian_prs_z').val()),\r\n\t\t\t'percent': parseFloat($('#ovarian_prs_percent').val())\r\n\t\t};\r\n\t}\r\n\tif(hasInput(\"prostate_prs_a\") && hasInput(\"prostate_prs_z\")) {\r\n\t\tprs['prostate_cancer_prs'] = {\r\n\t\t\t'alpha': parseFloat($('#prostate_prs_a').val()),\r\n\t\t\t'zscore': parseFloat($('#prostate_prs_z').val()),\r\n\t\t\t'percent': parseFloat($('#prostate_prs_percent').val())\r\n\t\t};\r\n\t}\r\n\tconsole.log(prs);\r\n\treturn (isEmpty(prs) ? 0 : prs);\r\n}\r\n\r\nfunction get_surgical_ops() {\r\n\tlet meta = \"\";\r\n\tif(!$('#A6_4_3_check').parent().hasClass(\"off\")) {\r\n\t\tmeta += \";OVARY2=y\";\r\n\t}\r\n\tif(!$('#A6_4_7_check').parent().hasClass(\"off\")) {\r\n\t\tmeta += \";MAST2=y\";\r\n\t}\r\n\treturn meta;\r\n}\r\n\r\n/**\r\n * Get genetic test genes based on CanRisk version\r\n */\r\nfunction getGeneticTest(version) {\r\n\tversion = parseInt(version);\r\n\tif(version === 1)\r\n\t\treturn genetic_test1;\r\n\telse if(version === 2)\r\n\t\treturn genetic_test2;\r\n\telse if(version === 3)\r\n\t\treturn genetic_test2;\r\n\treturn genetic_test4;\r\n}\r\n\r\nexport function readCanRisk(boadicea_lines) {\r\n\tlet lines = boadicea_lines.trim().split('\\n');\r\n\tlet ped = [];\r\n\tlet hdr = [];  // collect risk factor header lines\r\n\tconst regexp = /([0-9])/;\r\n\tlet version = 3;\r\n\tlet gt = getGeneticTest(version);\r\n\tlet ncol = [26, 27, 27, 28];\t// number of columns - v1, v2, v3, v4\r\n\t// assumes two line header\r\n\tfor(let i = 0;i < lines.length;i++){\r\n\t\tlet ln = lines[i].trim();\r\n\t\tif(ln.indexOf(\"##\") === 0) {\r\n\t\t\tif(ln.indexOf(\"##CanRisk\") === 0) {\r\n\t\t\t\tconst match = ln.match(regexp);\r\n\t\t\t\tversion = parseInt(match[1]);\r\n\t\t\t\tgt = getGeneticTest(version);\r\n\t\t\t\tconsole.log(\"CanRisk File Format version \"+version);\r\n\r\n\t\t\t\tif(ln.indexOf(\";\") > -1) {   // contains surgical op data\r\n\t\t\t\t\tlet ops = ln.split(\";\");\r\n\t\t\t\t\tfor(let j=1; j<ops.length; j++) {\r\n\t\t\t\t\t\tlet opdata = ops[j].split(\"=\");\r\n\t\t\t\t\t\tif(opdata.length === 2) {\r\n\t\t\t\t\t\t\thdr.push(ops[j]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(ln.indexOf(\"CanRisk\") === -1 && ln.indexOf(\"##FamID\") !== 0) {\r\n\t\t\t\thdr.push(ln.replace(\"##\", \"\"));\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tlet delim = /\\t/;\r\n\t\tif(ln.indexOf('\\t') < 0) {\r\n\t\t\tdelim = /\\s+/;\r\n\t\t\tconsole.log(\"NOT TAB DELIM\");\r\n\t\t}\r\n\t\tlet attr = $.map(ln.split(delim), function(val, _i){return val.trim();});\r\n\r\n\t\tif(attr.length > 1) {\r\n\t\t\tif(attr.length !== ncol[version-1]) {\r\n\t\t\t\tconsole.error(ln, attr);\r\n\t\t\t\tthrow new Error('Found number of columns '+attr.length+'; expected '+ncol[version-1]+' for CanRisk version '+version);\r\n\t\t\t}\r\n\t\t\tlet indi = {\r\n\t\t\t\t'famid': attr[0],\r\n\t\t\t\t'display_name': attr[1],\r\n\t\t\t\t'name':\tattr[3],\r\n\t\t\t\t'sex': attr[6],\r\n\t\t\t\t'status': attr[8]\r\n\t\t\t};\r\n\t\t\tif(attr[2] === \"1\") indi.proband = true;\r\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\r\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\r\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\r\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\r\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\r\n\r\n\t\t\tlet idx = 11;\r\n\t\t\t$.each(cancers, function(cancer, diagnosis_age) {\r\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\r\n\t\t\t\tif(attr[idx] !== \"0\") {\r\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\r\n\t\t\t\t}\r\n\t\t\t\tidx++;\r\n\t\t\t});\r\n\r\n\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\r\n\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2, .... genetic tests\r\n\t\t\t// genetic test type, 0 = untested, S = mutation search, T = direct gene test\r\n\t\t\t// genetic test result, 0 = untested, P = positive, N = negative\r\n\t\t\tfor(let j=0; j<gt.length; j++) {\r\n\t\t\t\tlet gene_test = attr[idx].split(\":\");\r\n\t\t\t\tif(gene_test[0] !== '0') {\r\n\t\t\t\t\tif((gene_test[0] === 'S' || gene_test[0] === 'T') && (gene_test[1] === 'P' || gene_test[1] === 'N' ||\r\n\t\t\t\t\t    gene_test[1] === 'HOM' || gene_test[1] === 'HET'))\r\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + gene_test[0] + \" \" + gene_test[1]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif(gene_test[1] === 'P' || gene_test[1] === 'N')\r\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\r\n\t\t\t\t}\r\n\t\t\t\tidx++;\r\n\t\t\t}\r\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\r\n\t\t\tlet path_test = attr[idx].split(\":\");\r\n\t\t\tfor(let j=0; j<path_test.length; j++) {\r\n\t\t\t\tif(path_test[j] !== '0') {\r\n\t\t\t\t\tif(path_test[j] === 'N' || path_test[j] === 'P')\r\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = path_test[j];\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +path_test[j]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tped.push(indi);\r\n\t\t}\r\n\t}\r\n\r\n\t// group mztwins\r\n\tped.sort(function(a, b) {\r\n\t\treturn a.mztwin !== undefined ? a.mztwin.localeCompare(b.mztwin) : 0;\r\n\t});\r\n\r\n\treturn [hdr, ped];\r\n}\r\n\r\n/**\r\n * Get the mammographic density formatted CanRisk data file line\r\n */\r\nexport function get_mdensity(mdensity) {\r\n\tconst regexp = /^(birads|Volpara|Stratus)=/i;\r\n\tif(regexp.test(mdensity))\r\n\t\treturn \"\\n##\"+mdensity;\r\n\t\t\r\n\tconst birads = /^(1|2|3|4|a|b|c|d)$/i\r\n\tif(birads.test(mdensity))\r\n\t\treturn \"\\n##birads=\"+mdensity;\r\n\r\n\tconsole.error(\"Unrecognised mammographic density format :: \" + mdensity);\r\n\treturn \"\"\r\n}\r\n\r\n/**\r\n * Get CanRisk formated pedigree.\r\n */\r\nexport function get_pedigree(dataset, famid, meta, isanon, version=3, ethnicity=undefined) {\r\n\tlet v = (Number.isInteger(version) ? version+\".0\" : version.toString());\r\n\tlet msg = \"##CanRisk \" + v;\r\n\tif(!famid) {\r\n\t\tfamid = \"XXXX\";\r\n\t}\r\n\tif(meta) {\r\n\t\tmsg += meta;\r\n\t}\r\n\tif(typeof isanon === 'undefined') {\r\n\t\tisanon = true;\r\n\t}\r\n\t// array of individuals excluded from the calculation\r\n\tlet excl = $.map(dataset, function(p, _i){return 'exclude' in p && p.exclude ? p.name : null;});\r\n\r\n\t// female risk factors\r\n\tlet probandIdx  = pedigree_util.getProbandIndex(dataset);\r\n\tlet sex = 'F';\r\n\tif(probandIdx) {\r\n\t\tsex = dataset[probandIdx].sex;\r\n\t}\r\n\r\n\tif(sex !== 'M') {\r\n\t\tlet menarche    = get_risk_factor('menarche_age');\r\n\t\tlet parity      = get_risk_factor('parity');\r\n\t\tlet first_birth = get_risk_factor('age_of_first_live_birth');\r\n\t\tlet oc_use      = get_risk_factor('oral_contraception');\r\n\t\tlet mht_use     = get_risk_factor('mht');\r\n\t\tlet bmi         = get_risk_factor('bmi');\r\n\t\tlet alcohol     = get_risk_factor('alcohol_intake');\r\n\t\tlet menopause   = get_risk_factor('age_of_menopause');\r\n\t\tlet mdensity    = get_risk_factor('mammographic_density');\r\n\t\tlet hgt         = get_risk_factor('height');\r\n\t\tlet tl          = get_risk_factor('Age_Tubal_ligation');\r\n\t\tlet endo        = get_risk_factor('endometriosis');\r\n\r\n\t\tif(menarche !== undefined)\r\n\t\t\tmsg += \"\\n##menarche=\"+menarche;\r\n\t\tif(parity !== undefined)\r\n\t\t\tmsg += \"\\n##parity=\"+parity;\r\n\t\tif(first_birth !== undefined)\r\n\t\t\tmsg += \"\\n##first_live_birth=\"+first_birth;\r\n\t\tif(oc_use !== undefined)\r\n\t\t\tmsg += \"\\n##oc_use=\"+oc_use;\r\n\t\tif(mht_use !== undefined)\r\n\t\t\tmsg += \"\\n##mht_use=\"+mht_use;\r\n\t\tif(bmi !== undefined)\r\n\t\t\tmsg += \"\\n##BMI=\"+bmi;\r\n\t\tif(alcohol !== undefined)\r\n\t\t\tmsg += \"\\n##alcohol=\"+alcohol;\r\n\t\tif(menopause !== undefined)\r\n\t\t\tmsg += \"\\n##menopause=\"+menopause;\r\n\t\tif(mdensity !== undefined)\r\n\t\t\tmsg += get_mdensity(mdensity);\r\n\t\tif(hgt !== undefined)\r\n\t\t\tmsg += \"\\n##height=\"+hgt;\r\n\t\tif(tl !== undefined)\r\n\t\t\tif(tl !== \"n\" && tl !== \"N\")\r\n\t\t\t\tmsg += \"\\n##TL=Y\";\r\n\t\t\telse\r\n\t\t\t\tmsg += \"\\n##TL=N\";\r\n\r\n\t\tif(endo !== undefined)\r\n\t\t\tmsg += \"\\n##endo=\"+endo;\r\n\t}\r\n\t\r\n\tif(version > 2 && ethnicity !== undefined) {\r\n\t\tmsg += \"\\n##ethnicity=\"+ethnicity;\r\n\t}\r\n\tmsg += \"\\n##FamID\\tName\\tTarget\\tIndivID\\tFathID\\tMothID\\tSex\\tMZtwin\\tDead\\tAge\\tYob\\tBC1\\tBC2\\tOC\\tPRO\\tPAN\\tAshkn\"\r\n\r\n\tlet gt = getGeneticTest(version);\r\n\tfor(let i=0; i<gt.length; i++) {\r\n\t\tmsg += \"\\t\"+gt[i].toUpperCase();\r\n\t}\r\n\tmsg += \"\\tER:PR:HER2:CK14:CK56\";\r\n\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tlet p = dataset[i];\r\n\t\tif($.inArray(p.name, excl) !== -1) {\r\n\t\t\tconsole.log('EXCLUDE: '+p.name);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tmsg += '\\n'+famid+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t// max 13 chars\r\n\t\tif(isanon)\r\n\t\t\tmsg += i+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// display_name (ANONIMISE) max 8 chars\r\n\t\telse\r\n\t\t\tmsg += (p.display_name ? p.display_name : \"NA\")+'\\t';\r\n\t\tmsg += ('proband' in p ? '1' : 0)+'\\t';\r\n\t\tmsg += p.name+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// max 7 chars\r\n\t\tmsg += ('father' in p && !('noparents' in p) && ($.inArray(p.mother, excl) === -1)? p.father : 0)+'\\t';\t// max 7 chars\r\n\t\tmsg += ('mother' in p && !('noparents' in p) && ($.inArray(p.mother, excl) === -1)? p.mother : 0)+'\\t';\t// max 7 chars\r\n\t\tmsg += p.sex+'\\t';\r\n\t\tmsg += ('mztwin' in p ? p.mztwin : 0)+'\\t'; \t\t\t\t\t\t// MZtwin\r\n\t\tmsg += ('status' in p ? p.status : 0)+'\\t';\t\t\t\t\t\t\t// current status: 0 = alive, 1 = dead\r\n\t\tmsg += ('age' in p ? p.age : 0)+'\\t';\t\t\t\t\t\t\t\t// Age at last follow up or 0 = unspecified\r\n\t\tmsg += ('yob' in p ? p.yob : 0)+'\\t';\t\t\t\t\t\t\t\t// YOB or 0 = unspecified\r\n\r\n\t\tlet cmsg = \"\";\r\n\t\t$.each(cancers, function(cancer, diagnosis_age) {\r\n\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\r\n\t\t\tif(diagnosis_age in p)\r\n\t\t\t\tcmsg += (diagnosis_age in p ? p[diagnosis_age] : 'AU')+'\\t';\r\n\t\t\telse\r\n\t\t\t\tcmsg += '0\\t';\r\n\t\t});\r\n\t\tmsg+=cmsg;\r\n\r\n\t\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\r\n\t\tmsg += ('ashkenazi' in p ? p.ashkenazi : 0)+'\\t';\r\n\r\n\t\tfor(let j=0; j<gt.length; j++) {\r\n\t\t\tif(gt[j]+'_gene_test' in p &&\r\n\t\t\t   p[gt[j]+'_gene_test']['type'] !== '-' &&\r\n\t\t\t   p[gt[j]+'_gene_test']['result'] !== '-') {\r\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['type'] + ':';\r\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['result'] + '\\t';\r\n\t\t\t} else {\r\n\t\t\t\tmsg += '0:0\\t';\t\t// type, 0=untested, S=mutation search, T=direct gene test\r\n\t\t\t\t\t\t\t\t\t// result, 0=untested, P=positive, N=negative\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor(let j=0; j<pathology_tests.length; j++) {\r\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\r\n\t\t\tif(pathology_tests[j]+'_bc_pathology' in p) {\r\n\t\t\t\tmsg += p[pathology_tests[j]+'_bc_pathology'];\r\n\t\t\t\tconsole.log('pathology '+p[pathology_tests[j]+'_bc_pathology']+' for '+p.display_name);\r\n\t\t\t} else {\r\n\t\t\t\tmsg += '0';\r\n\t\t\t}\r\n\t\t\tif(j<(pathology_tests.length-1))\r\n\t\t\t\tmsg += \":\";\r\n\t\t}\r\n\t}\r\n\tconsole.log(msg, RISK_FACTOR_STORE);\r\n\treturn msg;\r\n}\r\n\r\nexport function show_risk_factor_store() {\r\n\tconsole.log(\"RISK_FACTOR_STORE::\");\r\n\t$.each(RISK_FACTOR_STORE, function(name, val){\r\n\t\tconsole.log(name + \" : \" + val);\r\n\t});\r\n}\r\n\r\nexport function save_risk_factor(risk_factor_name, val) {\r\n\tRISK_FACTOR_STORE[store_name(risk_factor_name)] = val;\r\n}\r\n\r\nexport function get_risk_factor(risk_factor_name) {\r\n\tlet key = store_name(risk_factor_name);\r\n\tif(key in RISK_FACTOR_STORE) {\r\n\t\treturn RISK_FACTOR_STORE[key];\r\n\t}\r\n\treturn undefined;\r\n}\r\n\r\n// remove risk factor from storage\r\nexport function remove_risk_factor(risk_factor_name) {\r\n\tdelete RISK_FACTOR_STORE[store_name(risk_factor_name)];\r\n}\r\n\r\n// prefix risk factor name with the app/page name\r\nexport function store_name(risk_factor_name) {\r\n\treturn window.location.pathname.split('/').filter(function(el){ return !!el; }).pop() +\r\n\t       '::' + risk_factor_name;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// pedigree I/O\r\nimport * as utils from './utils.js';\r\nimport * as pedcache from './pedcache.js';\r\nimport {readCanRisk, cancers, genetic_test1, pathology_tests} from './canrisk_file.js';\r\nimport {get_bounds} from './zoom.js';\r\n\r\n\r\nexport function addIO(opts) {\r\n\t$('#load').on('change', function(e) {\r\n\t\tload(e, opts);\r\n\t});\r\n\r\n\t$('#save').on('click', function() {\r\n\t\tsave(opts);\r\n\t});\r\n\r\n\t$('#print').on('click', function() {\r\n\t\tprint(get_printable_svg(opts));\r\n\t});\r\n\r\n\t$('#svg_download').on('click', function() {\r\n\t\tsvg_download(get_printable_svg(opts));\r\n\t});\r\n\r\n\t$('#png_download, .fa-file-image').on('click', function() {\r\n\t\tlet resolution = 4;\r\n\t\timg_download(opts, resolution, \"image/png\");\r\n\t});\r\n}\r\n\r\n/**\r\n * Get object from array by the name attribute.\r\n */\r\nfunction getByName(arr, name) {\r\n\treturn $.grep(arr, function(o){ return o && o.name === name; })[0];\r\n}\r\n\r\n/**\r\n * Provide font style to svg\r\n */\r\nfunction copyStylesInline(destinationNode, sourceNode) {\r\n\tlet containerElements = [\"svg\",\"g\"];\r\n\tlet destChildNodes = destinationNode.childNodes;\r\n\tlet srcChildNodes = sourceNode.childNodes;\r\n\tfor (let cd = 0; cd < destChildNodes.length; cd++) {\r\n\t\tlet child = destChildNodes[cd];\r\n\t\tif (containerElements.indexOf(child.tagName) !== -1) {\r\n\t\t\tcopyStylesInline(child, srcChildNodes[cd]);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\t\ttry {\r\n\t\t\tlet style = srcChildNodes[cd].currentStyle || window.getComputedStyle(srcChildNodes[cd]);\r\n\t\t\tif (style === \"undefined\" || style === null) continue;\r\n\r\n\t\t\tlet styleLength = style.length;\r\n\t\t\tlet childStyle = child.style;\r\n\t\t\tfor (let st = 0; st < styleLength; st++){\r\n\t\t\t\tlet mySt = style[st];\r\n\t\t\t\tif(mySt.indexOf(\"text-\") > -1 || mySt.indexOf(\"font-\") > -1) childStyle.setProperty(mySt, style.getPropertyValue(mySt));\r\n\t\t\t}\r\n\t\t} catch(err) { continue; }\r\n   }\r\n}\r\n\r\n/**\r\n * Export pedigree as image, e.g. PNG\r\n */\r\nexport function img_download(opts, resolution, img_type) {\r\n\tlet deferred = svg2img($('#'+opts.targetDiv).find('svg'), \"pedigree\", {resolution: resolution, img_type: img_type});\r\n\t$.when.apply($,[deferred]).done(function() {\r\n\t\tlet obj = getByName(arguments, \"pedigree\");\r\n\t\tif(utils.isEdge() || utils.isIE()) {\r\n\t\t\tlet html=\"<img src='\"+obj.img+\"' alt='canvas image'/>\";\r\n\t\t\tlet newTab = window.open();\t\t// pop-ups need to be enabled\r\n\t\t\tnewTab.document.write(html);\r\n\t\t} else {\r\n\t\t\tlet a\t  = document.createElement('a');\r\n\t\t\ta.href\t = obj.img;\r\n\t\t\ta.download = 'plot.png';\r\n\t\t\ta.target   = '_blank';\r\n\t\t\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/** Get SVG data URL from svg element */\r\nfunction get_svg_as_data_url(svg) {\r\n\tlet svgCopy = svg.get(0).cloneNode(true);\r\n\t// remove unused elements\r\n\td3.select(svgCopy).selectAll(\"text\").filter(function(){\r\n\t\t return d3.select(this).text().length === 0 || \r\n\t\t        d3.select(this), d3.select(this).attr('font-family') === \"FontAwesome\"\r\n\t }).remove();\r\n\tcopyStylesInline(svgCopy, svg.get(0));\r\n\tlet svgStr = (new XMLSerializer()).serializeToString(svgCopy);\r\n\treturn 'data:image/svg+xml;base64,'+ window.btoa(unescape(encodeURIComponent(svgStr))); // convert SVG string to data URL\r\n}\r\n/**\r\n * Given a SVG document element convert to image (e.g. jpeg, png - default png).\r\n */\r\nexport function svg2img(svg, deferred_name, options) {\r\n\tlet defaults = {iscanvg: false, resolution: 1, img_type: \"image/png\"};\r\n\tif(!options) options = defaults;\r\n\t$.each(defaults, function(key, value) {\r\n\t\tif(!(key in options)) {options[key] = value;}\r\n\t});\r\n\r\n\tlet deferred = $.Deferred();\r\n\tlet imgsrc = get_svg_as_data_url(svg); // convert SVG string to data URL\r\n\tlet canvas = document.createElement(\"canvas\");\r\n\tcanvas.width = svg.width()*options.resolution;\r\n\tcanvas.height = svg.height()*options.resolution;\r\n\tlet context = canvas.getContext(\"2d\");\r\n\t// provide a white background\r\n\tcontext.fillStyle = \"white\";\r\n\tcontext.fillRect(0, 0, canvas.width, canvas.height);\r\n\t\r\n\tlet img = document.createElement(\"img\");\r\n\timg.onload = function() {\r\n\t\tcontext.drawImage(img, 0, 0, canvas.width, canvas.height);\r\n\t\t// console.log(deferred_name, options.img_type);\r\n\t\tdeferred.resolve(\r\n\t\t\t{'name': deferred_name,\r\n\t\t\t'resolution': options.resolution,\r\n\t\t\t'img':canvas.toDataURL(options.img_type, 1),\r\n\t\t\t'w':canvas.width,\r\n\t\t\t'h':canvas.height});\r\n\t\tcontext.clearRect(0, 0, canvas.width, canvas.height);\r\n\t};\r\n\timg.src = imgsrc;\r\n\treturn deferred.promise();\r\n}\r\n\r\nfunction getMatches(str, myRegexp) {\r\n\tlet matches = [];\r\n\tlet c = 0;\r\n\tmyRegexp.lastIndex = 0;\r\n\tlet match = myRegexp.exec(str);\r\n\twhile (match) {\r\n\t\tc++;\r\n\t\tif(c > 400) {\r\n\t\t\tconsole.error(\"getMatches: counter exceeded 400\");\r\n\t\t\treturn -1;\r\n\t\t}\r\n\t\tmatches.push(match);\r\n\t\tif (myRegexp.lastIndex === match.index) {\r\n\t\t\tmyRegexp.lastIndex++;\r\n\t\t}\r\n\t\tmatch = myRegexp.exec(str);\r\n\t}\r\n\treturn matches;\r\n}\r\n\r\n// find all url's to make unique\r\nfunction unique_urls(svg_html) {\r\n\tlet matches = getMatches(svg_html, /url\\((&quot;|\"|'){0,1}#(.*?)(&quot;|\"|'){0,1}\\)/g);\r\n\tif(matches === -1)\r\n\t\treturn \"ERROR DISPLAYING PEDIGREE\"\r\n\r\n\t$.each(matches, function(_index, match) {\r\n\t\tlet quote = (match[1] ? match[1] : \"\");\r\n\t\tlet val = match[2];\r\n\t\tlet m1 = \"id=\\\"\" + val + \"\\\"\";\r\n\t\tlet m2 = \"url\\\\(\" + quote + \"#\" + val + quote + \"\\\\)\";\r\n\r\n\t\tlet newval = val+utils.makeid(2);\r\n\t\tsvg_html = svg_html.replace(new RegExp(m1, 'g'), \"id=\\\"\"+newval+\"\\\"\" );\r\n\t\tsvg_html = svg_html.replace(new RegExp(m2, 'g'), \"url(#\"+newval+\")\" );\r\n   });\r\n\treturn svg_html;\r\n}\r\n\r\n// return a copy pedigree svg\r\nexport function copy_svg(opts) {\r\n\tlet svg_node = get_printable_svg(opts);\r\n\tlet d3obj = d3.select(svg_node.get(0));\r\n\r\n\t// remove unused elements\r\n\td3obj.selectAll(\"text\")\r\n\t  .filter(function(){\r\n\t\treturn d3.select(this).text().length === 0 || d3.select(this), d3.select(this).attr('font-family') === \"FontAwesome\"\r\n\t}).remove();\r\n\t// remove inline styles\r\n\td3obj.selectAll('[style]').attr(\"style\", null);\r\n\treturn $(unique_urls(svg_node.html()));\r\n}\r\n\r\n// get printable svg div, adjust size to tree dimensions and scale to fit\r\nfunction get_printable_svg(opts) {\r\n\tlet local_dataset = pedcache.current(opts); // get current dataset\r\n\tif (local_dataset !== undefined && local_dataset !== null) {\r\n\t\topts.dataset = local_dataset;\r\n\t}\r\n\r\n\tlet svg_div = $('<div></div>');  \t\t\t\t// create a new div\r\n\tlet svg = $('#'+opts.targetDiv).find('svg').clone().appendTo(svg_div);\r\n\r\n\tlet a4 = {w: (595-40), h: (842-50)};\r\n\t\r\n\tlet b = get_bounds(opts);\r\n\tlet d = {w: Math.abs(b.xmax-b.xmin), h: Math.abs(b.ymax-b.ymin)};\r\n\tlet f = 1;\r\n\tlet k = (f / Math.max(d.w/a4.w, d.h/a4.h));\r\n\r\n\tlet xi = -(b.xmin-(opts.symbol_size))*k;\r\n\tlet yi = -(b.ymin-(opts.symbol_size))*k;\r\n\r\n\tsvg.attr('width', a4.w);\r\n\tsvg.attr('height', d.h*k);\t\r\n\r\n\tsvg.find(\".diagram\").attr(\"transform\", \"translate(\"+xi+\", \"+yi+\") scale(\"+k+\")\");\r\n\treturn svg_div;\r\n}\r\n\r\n// download the SVG to a file\r\nexport function svg_download(svg){\r\n\tlet a\t   = document.createElement('a');\r\n\ta.href\t   = get_svg_as_data_url(svg);\r\n\ta.download = 'plot.svg';\r\n\ta.target   = '_blank';\r\n\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\r\n}\r\n\r\n// open print window for a given element\r\nexport function print(el, id){\r\n\tif(el.constructor !== Array)\r\n\t\tel = [el];\r\n\r\n\tlet width = $(window).width()*0.9;\r\n\tlet height = $(window).height()-10;\r\n\tlet cssFiles = [\r\n\t\t'/static/css/canrisk.css',\r\n\t\t'https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css'\r\n\t];\r\n\tlet printWindow = window.open('', 'PrintMap', 'width=' + width + ',height=' + height);\r\n\tlet headContent = '';\r\n\tfor(let i=0; i<cssFiles.length; i++)\r\n\t\theadContent += '<link href=\"'+cssFiles[i]+'\" rel=\"stylesheet\" type=\"text/css\" media=\"all\">';\r\n\theadContent += \"<style>body {font-size: \" + $(\"body\").css('font-size') + \";}</style>\";\r\n\r\n\tlet html = \"\";\r\n\tfor(let i=0; i<el.length; i++) {\r\n\t\tif(i === 0 && id)\r\n\t\t\thtml += id;\r\n\t\thtml += $(el[i]).html();\r\n\t\tif(i < el.length-1)\r\n\t\t\thtml += '<div class=\"page-break\"> </div>';\r\n\t}\r\n\r\n\tprintWindow.document.write(headContent);\r\n\tprintWindow.document.write(html);\r\n\tprintWindow.document.close();\r\n\r\n\tprintWindow.focus();\r\n\tsetTimeout(function() {\r\n\t\tprintWindow.print();\r\n\t\tprintWindow.close();\r\n\t}, 300);\r\n}\r\n\r\n// save content to a file\r\nexport function save_file(opts, content, filename, type){\r\n\tif(opts.DEBUG)\r\n\t\tconsole.log(content);\r\n\tif(!filename) filename = \"ped.txt\";\r\n\tif(!type) type = \"text/plain\";\r\n\r\n   let file = new Blob([content], {type: type});\r\n   if (window.navigator.msSaveOrOpenBlob) \t// IE10+\r\n\t   window.navigator.msSaveOrOpenBlob(file, filename);\r\n   else { \t\t\t\t\t\t\t\t\t// other browsers\r\n\t   let a = document.createElement(\"a\");\r\n\t   let url = URL.createObjectURL(file);\r\n\t   a.href = url;\r\n\t   a.download = filename;\r\n\t   document.body.appendChild(a);\r\n\t   a.click();\r\n\t   setTimeout(function() {\r\n\t\t   document.body.removeChild(a);\r\n\t\t   window.URL.revokeObjectURL(url);\r\n\t\t}, 0);\r\n\t}\r\n}\r\n\r\nfunction save(opts){\r\n\tlet content = JSON.stringify(pedcache.current(opts));\r\n\tsave_file(opts, content);\r\n}\r\n\r\nfunction canrisk_validation(opts) {\r\n\t$.each(opts.dataset, function(_idx, p) {\r\n\t\tif(!p.hidden && p.sex === 'M' && !utils.isProband(p)) {\r\n\t\t\tif(p[cancers['breast_cancer2']]) {\r\n\t\t\t\tlet msg = 'Male family member ('+p.display_name+') with contralateral breast cancer found. '+\r\n\t\t\t\t\t\t  'Please note that as the risk models do not take this into account the second '+\r\n\t\t\t\t\t\t  'breast cancer is ignored.'\r\n\t\t\t\tconsole.error(msg);\r\n\t\t\t\tdelete p[cancers['breast_cancer2']];\r\n\t\t\t\tutils.messages(\"Warning\", msg);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/** Read and load pedigree data string */\r\nexport function load_data(d, opts) {\r\n\tif(opts.DEBUG) console.log(d);\r\n\tlet risk_factors;\r\n\ttry {\r\n\t\tif(d.indexOf(\"BOADICEA import pedigree file format 4.0\") === 0) {\r\n\t\t\topts.dataset = readBoadiceaV4(d, 4);\r\n\t\t\tcanrisk_validation(opts);\r\n\t\t} else if(d.indexOf(\"BOADICEA import pedigree file format 2.0\") === 0) {\r\n\t\t\topts.dataset = readBoadiceaV4(d, 2);\r\n\t\t\tcanrisk_validation(opts);\r\n\t\t} else if(d.indexOf(\"##\") === 0 && d.indexOf(\"CanRisk\") !== -1) {\r\n\t\t\tlet canrisk_data = readCanRiskFile(d);\r\n\t\t\trisk_factors = canrisk_data[0];\r\n\t\t\topts.dataset = canrisk_data[1];\r\n\t\t\tcanrisk_validation(opts);\r\n\t\t} else {\r\n\t\t\ttry {\r\n\t\t\t\tlet ped = JSON.parse(d);\r\n\t\t\t\tlet to_process = true;\r\n\t\t\t\tfor(let i=0;i<ped.length;i++) {\r\n\t\t\t\t\tif(ped[i].top_level) {\r\n\t\t\t\t\t\tto_process = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\topts.dataset = (to_process ? process_ped(ped) : ped);\r\n\t\t\t} catch(err) {\r\n\t\t\t\topts.dataset = readLinkage(d);\r\n\t\t\t}\r\n\t\t}\r\n\t\tutils.validate_pedigree(opts);\r\n\t} catch(err1) {\r\n\t\tconsole.error(err1, d);\r\n\t\tutils.messages(\"File Error\", ( err1.message ? err1.message : err1));\r\n\t\treturn;\r\n\t}\r\n\tif(opts.DEBUG) console.log(opts.dataset);\r\n\ttry{\r\n\t\tpedcache.setposition(opts);\t\t// clear position\r\n\t\t$(document).trigger('rebuild', [opts]);\r\n\t\tconsole.log(risk_factors);\r\n\t\t// load risk factors - fire riskfactorChange event\r\n\t\t$(document).trigger('riskfactorChange', [opts, risk_factors]);\r\n\t\t$(document).trigger('fhChange', [opts]); \t// trigger fhChange event\r\n\t\r\n\t\ttry {\r\n\t\t\t// update FH section\r\n\t\t\tacc_FamHist_ticked();\t\t\t\t// eslint-disable-line no-undef\r\n\t\t\tacc_FamHist_Leave();\t\t\t\t// eslint-disable-line no-undef\r\n\t\t\tRESULT.FLAG_FAMILY_MODAL = true;\t// eslint-disable-line no-undef\r\n\t\t} catch(err3) {\r\n\t\t\t// ignore error\r\n\t\t}\r\n\t} catch(err2) {\r\n\t\tutils.messages(\"File Error\", ( err2.message ? err2.message : err2));\r\n\t}\r\n}\r\n\r\nfunction load(e, opts) {\r\n\tlet f = e.target.files[0];\r\n\tif(f) {\r\n\t\tlet reader = new FileReader();\r\n\t\treader.onload = function(e) {\r\n\t\t\tload_data(e.target.result, opts);\r\n\t\t};\r\n\t\treader.onerror = function() {\r\n\t\t\tutils.messages(\"File Error\", \"File could not be read! Code \" + reader.error);\r\n\t\t};\r\n\t\treader.readAsText(f);\r\n\t} else {\r\n\t\tconsole.error(\"File could not be read!\");\r\n\t}\r\n\t$(\"#load\")[0].value = ''; // reset value\r\n}\r\n\r\n//\r\n// https://www.cog-genomics.org/plink/1.9/formats#ped\r\n// https://www.cog-genomics.org/plink/1.9/formats#fam\r\n//\t1. Family ID ('FID')\r\n//\t2. Within-family ID ('IID'; cannot be '0')\r\n//\t3. Within-family ID of father ('0' if father isn't in dataset)\r\n//\t4. Within-family ID of mother ('0' if mother isn't in dataset)\r\n//\t5. Sex code ('1' = male, '2' = female, '0' = unknown)\r\n//\t6. Phenotype value ('1' = control, '2' = case, '-9'/'0'/non-numeric = missing data if case/control)\r\n//  7. Genotypes (column 7 onwards);\r\n//\t columns 7 & 8 are allele calls for first variant ('0' = no call); colummns 9 & 10 are calls for second variant etc.\r\nexport function readLinkage(boadicea_lines) {\r\n\tlet lines = boadicea_lines.trim().split('\\n');\r\n\tlet ped = [];\r\n\tlet famid;\r\n\tfor(let i = 0;i < lines.length;i++){\r\n\t   let attr = $.map(lines[i].trim().split(/\\s+/), function(val, _i){return val.trim();});\r\n\t   if(attr.length < 5)\r\n\t\t   throw new Error('unknown format');\r\n\t   let sex = (attr[4] === '1' ? 'M' : (attr[4] === '2' ? 'F' : 'U'));\r\n\t   let indi = {\r\n\t\t\t'famid': attr[0],\r\n\t\t\t'display_name': attr[1],\r\n\t\t\t'name':\tattr[1],\r\n\t\t\t'sex': sex\r\n\t\t};\r\n\t\tif(attr[2] !== \"0\") indi.father = attr[2];\r\n\t\tif(attr[3] !== \"0\") indi.mother = attr[3];\r\n\r\n\t\tif (typeof famid != 'undefined' && famid !== indi.famid) {\r\n\t\t\tconsole.error('multiple family IDs found only using famid = '+famid);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\tif(attr[5] === \"2\") indi.affected = 2;\r\n\t\t// add genotype columns\r\n\t\tif(attr.length > 6) {\r\n\t\t\tindi.alleles = \"\";\r\n\t\t\tfor(let j=6; j<attr.length; j+=2) {\r\n\t\t\t\tindi.alleles += attr[j] + \"/\" + attr[j+1] + \";\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tped.unshift(indi);\r\n\t\tfamid = attr[0];\r\n\t}\r\n\treturn process_ped(ped);\r\n}\r\n\r\nexport function readCanRiskFile(boadicea_lines) {\r\n\tlet [hdr, ped] = readCanRisk(boadicea_lines);\r\n\ttry {\r\n\t\treturn [hdr, process_ped(ped)];\r\n\t} catch(e) {\r\n\t\tconsole.error(e);\r\n\t\treturn [hdr, ped];\r\n\t}\r\n}\r\n\r\n// read boadicea format v4 & v2\r\nexport function readBoadiceaV4(boadicea_lines, version) {\r\n\tlet lines = boadicea_lines.trim().split('\\n');\r\n\tlet ped = [];\r\n\t// assumes two line header\r\n\tfor(let i = 2;i < lines.length;i++){\r\n\t   let attr = $.map(lines[i].trim().split(/\\s+/), function(val, _i){return val.trim();});\r\n\t\tif(attr.length > 1) {\r\n\t\t\tlet indi = {\r\n\t\t\t\t'famid': attr[0],\r\n\t\t\t\t'display_name': attr[1],\r\n\t\t\t\t'name':\tattr[3],\r\n\t\t\t\t'sex': attr[6],\r\n\t\t\t\t'status': attr[8]\r\n\t\t\t};\r\n\t\t\tif(attr[2] === \"1\") indi.proband = true;\r\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\r\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\r\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\r\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\r\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\r\n\r\n\t\t\tlet idx = 11;\r\n\t\t\t$.each(cancers, function(_cancer, diagnosis_age) {\r\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\r\n\t\t\t\tif(attr[idx] !== \"0\") {\r\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\r\n\t\t\t\t}\r\n\t\t\t\tidx++;\r\n\t\t\t});\r\n\r\n\t\t\tif(version === 4) {\r\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\r\n\t\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2 genetic tests\r\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\r\n\t\t\t\t// result, 0 = untested, P = positive, N = negative\r\n\t\t\t\tfor(let j=0; j<5; j++) {\r\n\t\t\t\t\tidx+=2;\r\n\t\t\t\t\tif(attr[idx-2] !== '0') {\r\n\t\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T') && (attr[idx-1] === 'P' || attr[idx-1] === 'N'))\r\n\t\t\t\t\t\t\tindi[genetic_test1[j] + '_gene_test'] = {'type': attr[idx-2], 'result': attr[idx-1]};\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else if (version === 2) {\r\n\t\t\t\t// genetic test BRCA1, BRCA2\r\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\r\n\t\t\t\t// result, 0 = untested, N = no mutation, 1 = BRCA1 positive, 2 = BRCA2 positive, 3 = BRCA1/2 positive\r\n\t\t\t\tidx+=2; \t// gtest\r\n\t\t\t\tif(attr[idx-2] !== '0') {\r\n\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T')) {\r\n\t\t\t\t\t\tif(attr[idx-1] === 'N') {\r\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\r\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\r\n\t\t\t\t\t\t} else if(attr[idx-1] === '1') {\r\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\r\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\r\n\t\t\t\t\t\t} else if(attr[idx-1] === '2') {\r\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\r\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\r\n\t\t\t\t\t\t} else if(attr[idx-1] === '3') {\r\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\r\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\r\n\t\t\t}\r\n\r\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\r\n\t\t\tfor(let j=0; j<pathology_tests.length; j++) {\r\n\t\t\t\tif(attr[idx] !== '0') {\r\n\t\t\t\t\tif(attr[idx] === 'N' || attr[idx] === 'P')\r\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = attr[idx];\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +attr[idx]);\r\n\t\t\t\t}\r\n\t\t\t\tidx++;\r\n\t\t\t}\r\n\t\t\tped.unshift(indi);\r\n\t\t}\r\n\t}\r\n\r\n\ttry {\r\n\t\treturn process_ped(ped);\r\n\t} catch(e) {\r\n\t\tconsole.error(e);\r\n\t\treturn ped;\r\n\t}\r\n}\r\n\r\nfunction process_ped(ped) {\r\n\t// find the level of individuals in the pedigree\r\n\tfor(let j=0;j<2;j++) {\r\n\t\tfor(let i=0;i<ped.length;i++) {\r\n\t\t\tgetLevel(ped, ped[i].name);\r\n\t\t}\r\n\t}\r\n\r\n\tfix_n_balance_levels(ped);\r\n\r\n\t// find the max level (i.e. top_level)\r\n\tlet max_level = 0;\r\n\tfor(let i=0;i<ped.length;i++) {\r\n\t\tif(ped[i].level && ped[i].level > max_level)\r\n\t\t\tmax_level = ped[i].level;\r\n\t}\r\n\r\n\t// identify top_level and other nodes without parents\r\n\tfor(let i=0;i<ped.length;i++) {\r\n\t\tif(utils.getDepth(ped, ped[i].name) === 1) {\r\n\t\t\tif(ped[i].level && ped[i].level === max_level) {\r\n\t\t\t\tped[i].top_level = true;\r\n\t\t\t} else {\r\n\t\t\t\tped[i].noparents = true;\r\n\r\n\t\t\t\t// 1. look for partners parents\r\n\t\t\t\tlet pidx = getPartnerIdx(ped, ped[i]);\r\n\t\t\t\tif(pidx > -1) {\r\n\t\t\t\t\tif(ped[pidx].mother) {\r\n\t\t\t\t\t\tped[i].mother = ped[pidx].mother;\r\n\t\t\t\t\t\tped[i].father = ped[pidx].father;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 2. or adopt parents from level above\r\n\t\t\t\tif(!ped[i].mother){\r\n\t\t\t\t\tfor(let j=0; j<ped.length; j++) {\r\n\t\t\t\t\t\tif(ped[i].level === (ped[j].level-1)) {\r\n\t\t\t\t\t\t\tpidx = getPartnerIdx(ped, ped[j]);\r\n\t\t\t\t\t\t\tif(pidx > -1 && i !== pidx) {\r\n\t\t\t\t\t\t\t\tped[i].mother = (ped[j].sex === 'F' ? ped[j].name : ped[pidx].name);\r\n\t\t\t\t\t\t\t\tped[i].father = (ped[j].sex === 'M' ? ped[j].name : ped[pidx].name);\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tdelete ped[i].top_level;\r\n\t\t}\r\n\t}\r\n\treturn ped;\r\n}\r\n\r\n// get the partners for a given node\r\nfunction getPartnerIdx(dataset, anode) {\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tlet bnode = dataset[i];\r\n\t\tif(anode.name === bnode.mother)\r\n\t\t\treturn utils.getIdxByName(dataset, bnode.father);\r\n\t\telse if(anode.name === bnode.father)\r\n\t\t\treturn utils.getIdxByName(dataset, bnode.mother);\r\n\t}\r\n\treturn -1;\r\n}\r\n\r\n// for a given individual assign levels to a parents ancestors\r\nfunction getLevel(dataset, name) {\r\n\tlet idx = utils.getIdxByName(dataset, name);\r\n\tlet level = (dataset[idx].level ? dataset[idx].level : 0);\r\n\tupdate_parents_level(idx, level, dataset);\r\n}\r\n\r\n// recursively update parents levels\r\nfunction update_parents_level(idx, level, dataset) {\r\n\tlet parents = ['mother', 'father'];\r\n\tlevel++;\r\n\tfor(let i=0; i<parents.length; i++) {\r\n\t\tlet pidx = utils.getIdxByName(dataset, dataset[idx][parents[i]]);\r\n\t\tif(pidx >= 0) {\r\n\t\t\tlet ma = dataset[utils.getIdxByName(dataset, dataset[idx].mother)];\r\n\t\t\tlet pa = dataset[utils.getIdxByName(dataset, dataset[idx].father)];\r\n\t\t\tif(!dataset[pidx].level || dataset[pidx].level < level) {\r\n\t\t\t\tma.level = level;\r\n\t\t\t\tpa.level = level;\r\n\t\t\t}\r\n\r\n\t\t\tif(ma.level < pa.level) {\r\n\t\t\t\tma.level = pa.level;\r\n\t\t\t} else if(pa.level < ma.level) {\r\n\t\t\t\tpa.level = ma.level;\r\n\t\t\t}\r\n\t\t\tupdate_parents_level(pidx, level, dataset);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// for a pedigree fix the levels of children nodes to be consistent with parent\r\nfunction fix_n_balance_levels(ped) {\r\n\tlet updated = false;\r\n\tlet l = ped.length;\r\n\r\n\tfor(let i=0;i<l;i++) {\r\n\t\tlet children = utils.getChildren(ped, ped[i]);\r\n\t\tlet prt_lvl = ped[i].level;\r\n\t\tfor(let j=0;j<children.length;j++){\r\n\t\t\tif(prt_lvl - children[j].level > 1) {\r\n\t\t\t\tchildren[j].level = prt_lvl-1;\r\n\t\t\t\tlet ptrs = utils.get_partners(ped, children[j]);\r\n\r\n\t\t\t\tfor(let k=0;k<ptrs.length;k++){\r\n\t\t\t\t\tlet p = utils.getNodeByName(ped, ptrs[k])\r\n\t\t\t\t\tp.level = prt_lvl-1;\r\n\r\n\t\t\t\t\tlet m = utils.getNodeByName(ped, p.mother);\r\n\t\t\t\t\tlet f = utils.getNodeByName(ped, p.father);\r\n\t\t\t\t\tif(m) m.level = prt_lvl;\r\n\t\t\t\t\tif(f) f.level = prt_lvl;\r\n\t\t\t\t}\r\n\t\t\t\tupdated = true;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn updated;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n/**\r\n * Mark two siblings as twins (monozygotic or dizygotic)\r\n * Assigns matching twin IDs and synchronizes age/yob between twins\r\n * @param {Array} dataset - Array of person objects\r\n * @param {Object} d1 - First twin person object\r\n * @param {Object} d2 - Second twin person object\r\n * @param {string} twin_type - Type of twin relationship: 'mztwin' or 'dztwin'\r\n * @returns {boolean} True if successful, false if no twin ID available (max 10 twin pairs)\r\n * @example\r\n * setMzTwin(dataset, person1, person2, 'mztwin');\r\n */\r\nexport function setMzTwin(dataset, d1, d2, twin_type) {\r\n\tif(!d1[twin_type]) {\r\n\t\td1[twin_type] = getUniqueTwinID(dataset, twin_type);\r\n\t\tif(!d1[twin_type])\r\n\t\t\treturn false;\r\n\t}\r\n\td2[twin_type] = d1[twin_type];\r\n\tif(d1.yob)\r\n\t\td2.yob = d1.yob;\r\n\tif(d1.age && (d1.status === \"0\" || !d1.status))\r\n\t\td2.age = d1.age;\r\n\treturn true;\r\n}\r\n\r\n/**\r\n * Get the next available unique twin ID\r\n * Twin IDs are: 1-9 and 'A', supporting up to 10 twin pairs per pedigree\r\n * @param {Array} dataset - Array of person objects\r\n * @param {string} twin_type - Type of twin: 'mztwin' or 'dztwin'\r\n * @returns {number|string|undefined} Next available twin ID (1-9 or 'A'), or undefined if all used\r\n */\r\nexport function getUniqueTwinID(dataset, twin_type) {\r\n\tlet mz = [1, 2, 3, 4, 5, 6, 7, 8, 9, \"A\"];\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tif(dataset[i][twin_type]) {\r\n\t\t\tlet idx = mz.indexOf(dataset[i][twin_type]);\r\n\t\t\tif (idx > -1)\r\n\t\t\t\tmz.splice(idx, 1);\r\n\t\t}\r\n\t}\r\n\tif(mz.length > 0)\r\n\t\treturn mz[0];\r\n\treturn undefined;\r\n}\r\n\r\n/**\r\n * Synchronize attributes between twins after changes\r\n * For monozygotic twins: syncs sex, yob, and age (if alive)\r\n * For dizygotic twins: syncs yob and age (if alive) only\r\n * @param {Array} dataset - Array of person objects\r\n * @param {Object} d1 - The twin whose attributes should be copied to their twin(s)\r\n */\r\nexport function syncTwins(dataset, d1) {\r\n\tif(!d1.mztwin && !d1.dztwin)\r\n\t\treturn;\r\n\tlet twin_type = (d1.mztwin ? \"mztwin\" : \"dztwin\");\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tlet d2 = dataset[i];\r\n\t\tif(d2[twin_type] && d1[twin_type] === d2[twin_type] && d2.name !== d1.name) {\r\n\t\t\tif(twin_type === \"mztwin\")\r\n\t\t\t  d2.sex = d1.sex;\r\n\t\t\tif(d1.yob)\r\n\t\t\t\td2.yob = d1.yob;\r\n\t\t\tif(d1.age && (d1.status === 0 || !d1.status))\r\n\t\t\t\td2.age = d1.age;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * Validate twin relationships and remove orphaned twin markers\r\n * Removes twin IDs from individuals who don't have at least one twin partner\r\n * Supports multiplets (triplets, quadruplets, etc.)\r\n * @param {Array} dataset - Array of person objects to validate\r\n */\r\nexport function checkTwins(dataset) {\r\n\tlet twin_types = [\"mztwin\", \"dztwin\"];\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tfor(let j=0; j<twin_types.length; j++) {\r\n\t\t\tlet twin_type = twin_types[j];\r\n\t\t\tif(dataset[i][twin_type]) {\r\n\t\t\t\tlet count = 0;\r\n\t\t\t\tfor(let j=0; j<dataset.length; j++) {\r\n\t\t\t\t\tif(dataset[j][twin_type] === dataset[i][twin_type])\r\n\t\t\t\t\t\tcount++;\r\n\t\t\t\t}\r\n\t\t\t\tif(count < 2)\r\n\t\t\t\t\tdelete dataset[i][twin_type];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// pedigree form\r\nimport {syncTwins} from './twins.js';\r\nimport * as utils from './utils.js';\r\nimport {current as pedcache_current} from './pedcache.js';\r\nimport {canChangeSex} from './validation.js';\r\n\r\n\r\n// handle family history change events (undo/redo/delete)\r\n$(document).on('fhChange', function(e, opts){\r\n\ttry {\r\n\t\tlet id = $('#id_name').val();  // get name from hidden field\r\n\t\tlet node = utils.getNodeByName(pedcache_current(opts), id)\r\n\t\tif(node === undefined)\r\n\t\t\t$('form > fieldset').prop(\"disabled\", true);\r\n\t\telse\r\n\t\t\t$('form > fieldset').prop('disabled', false);\r\n\t} catch(err) {\r\n\t\tconsole.warn(err);\r\n\t}\r\n})\r\n\r\n// Phase 3.2.1: Auto-enable pathology fields when breast cancer diagnosis age is entered\r\n$(document).on('change input', \"[id^='id_breast_cancer_diagnosis_age']\", function() {\r\n\tlet value = $(this).val();\r\n\tlet sexInput = $(\"input[name='sex']:checked\");\r\n\r\n\t// Only enable pathology for females with a diagnosis age\r\n\tif(value && value !== '' && sexInput.val() === 'F') {\r\n\t\t$(\"select[id$='_bc_pathology']\").prop(\"disabled\", false);\r\n\t}\r\n})\r\n\r\n// update status field and age label - 0 = alive, 1 = dead\r\nexport function updateStatus(status) {\r\n\t$('#age_yob_lock').removeClass('fa-lock fa-unlock-alt');\r\n\t(status === \"1\" ? $('#age_yob_lock').addClass('fa-unlock-alt') : $('#age_yob_lock').addClass('fa-lock'));\r\n\t$('#id_age_'+status).removeClass(\"hidden\");\r\n\t$('#id_age_'+(status === \"1\" ? '0' : '1')).addClass(\"hidden\");\r\n}\r\n\r\nexport function nodeclick(node) {\r\n\t$('form > fieldset').prop('disabled', false);\r\n\t// clear values\r\n\t$('#person_details').find(\"input[type=text], input[type=number]\").val(\"\");\r\n\t$('#person_details select').val('').prop('selected', true);\r\n\r\n\t// assign values to input fields in form\r\n\tif(node.sex === 'M' || node.sex === 'F')\r\n\t\t$('input[name=sex][value=\"'+node.sex+'\"]').prop('checked', true);\r\n\telse\r\n\t\t$('input[name=sex]').prop('checked', false);\r\n\tupdate_cancer_by_sex(node);\r\n\r\n\tif(!('status' in node))\r\n\t\tnode.status = 0;\r\n\t$('input[name=status][value=\"'+node.status+'\"]').prop('checked', true);\r\n\t// show lock symbol for age and yob synchronisation\r\n\tupdateStatus(node.status);\r\n\r\n\tif('proband' in node) {\r\n\t\t$('#id_proband').prop('checked', node.proband);\r\n\t\t$('#id_proband').prop(\"disabled\", true);\r\n\t} else {\r\n\t\t$('#id_proband').prop('checked', false);\r\n\t\t$('#id_proband').prop(\"disabled\", !('yob' in node))\r\n\t}\r\n\r\n\tif('exclude' in node) {\r\n\t\t$('#id_exclude').prop('checked', node.exclude);\r\n\t} else {\r\n\t\t$('#id_exclude').prop('checked', false);\r\n\t}\r\n\r\n/*\t\tif('ashkenazi' in node) {\r\n\t\t\t$('#id_ashkenazi').prop('checked', (node.proband == 1 ? true: false));\r\n\t\t} else {\r\n\t\t\t$('#id_ashkenazi').prop('checked', false);\r\n\t\t}*/\r\n\r\n\t// year of birth\r\n\tif('yob' in node) {\r\n\t\t$('#id_yob_0').val(node.yob);\r\n\t} else {\r\n\t\t$('#id_yob_0').val('-');\r\n\t}\r\n\r\n\t// clear pathology\r\n\t$('select[name$=\"_bc_pathology\"]').val('-');\r\n\t// clear gene tests\r\n\t$('select[name*=\"_gene_test\"]').val('-');\r\n\r\n\t// disable sex radio buttons if the person is already a parent (Phase 3.1.5)\r\n\t// Note: récupère le dataset depuis les utils.roots car opts n'est pas disponible dans nodeclick\r\n\tlet dataset = null;\r\n\ttry {\r\n\t\t// Essayer de récupérer le dataset depuis le premier pedigree chargé\r\n\t\tlet targetDivs = Object.keys(utils.roots || {});\r\n\t\tif(targetDivs.length > 0) {\r\n\t\t\tdataset = utils.roots[targetDivs[0]]._dataset;\r\n\t\t}\r\n\t} catch(e) {\r\n\t\t// Si erreur, autoriser le changement par défaut\r\n\t}\r\n\tlet sexCanChange = canChangeSex(node, dataset);\r\n\t$(\"input[id^='id_sex_']\").prop(\"disabled\", !sexCanChange);\r\n\r\n\t// disable pathology for male relatives (as not used by model)\r\n\t// and if no breast cancer age of diagnosis\r\n\t$(\"select[id$='_bc_pathology']\").prop(\"disabled\",\r\n\t\t\t(node.sex === 'M' || (node.sex === 'F' && !('breast_cancer_diagnosis_age' in node)) ? true : false));\r\n\r\n\t// approximate diagnosis age\r\n\t$('#id_approx').prop('checked', (node.approx_diagnosis_age ? true: false));\r\n\tupdate_diagnosis_age_widget();\r\n\r\n\tfor(let key in node) {\r\n\t\tif(key !== 'proband' && key !== 'sex') {\r\n\t\t\tif($('#id_'+key).length) {\t// input value\r\n\t\t\t\tif(key.indexOf('_gene_test')  !== -1 && node[key] !== null && typeof node[key] === 'object') {\r\n\t\t\t\t\t$('#id_'+key).val(node[key].type);\r\n\t\t\t\t\t$('#id_'+key+'_result').val(node[key].result);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$('#id_'+key).val(node[key]);\r\n\t\t\t\t}\r\n\t\t\t} else if(key.indexOf('_diagnosis_age') !== -1) {\r\n\t\t\t\tif($(\"#id_approx\").is(':checked')) {\r\n\t\t\t\t\t$('#id_'+key+'_1').val(round5(node[key])).prop('selected', true);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$('#id_'+key+'_0').val(node[key]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttry {\r\n\t\t$('#person_details').find('form').valid();\r\n\t} catch(err) {\r\n\t\tconsole.warn('valid() not found');\r\n\t}\r\n}\r\n\r\nfunction update_ashkn(newdataset) {\r\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\r\n\tif($('#orig_ashk').is(':checked')) {\r\n\t\t$.each(newdataset, function(_i, p) {\r\n\t\t\tif(p.proband)\r\n\t\t\t\tp.ashkenazi = 1;\r\n\t\t});\r\n\t} else {\r\n\t\t$.each(newdataset, function(_i, p) {\r\n\t\t\tdelete p.ashkenazi;\r\n\t\t});\r\n\t}\r\n}\r\n\r\n// Save Ashkenazi status\r\nexport function save_ashkn(opts) {\r\n\tlet dataset = pedcache_current(opts);\r\n\tlet newdataset = utils.copy_dataset(dataset);\r\n\tupdate_ashkn(newdataset);\r\n\topts.dataset = newdataset;\r\n\t$(document).trigger('rebuild', [opts]);\r\n}\r\n\r\nexport function save(opts) {\r\n\tlet dataset = pedcache_current(opts);\r\n\tlet name = $('#id_name').val();\r\n\tlet newdataset = utils.copy_dataset(dataset);\r\n\tlet person = utils.getNodeByName(newdataset, name);\r\n\tif(!person) {\r\n\t\tconsole.warn('person not found when saving details');\r\n\t\treturn;\r\n\t}\r\n\t$(\"#\"+opts.targetDiv).empty();\r\n\r\n\t// individual's personal and clinical details\r\n\tlet yob = $('#id_yob_0').val();\r\n\tif(yob && yob !== '') {\r\n\t\tperson.yob = yob;\r\n\t} else {\r\n\t\tdelete person.yob;\r\n\t}\r\n\r\n\t// current status: 0 = alive, 1 = dead\r\n\tlet status = $('#id_status').find(\"input[type='radio']:checked\");\r\n\tif(status.length > 0){\r\n\t\tperson.status = status.val();\r\n\t}\r\n\r\n\t// booleans switches\r\n\tlet switches = [\"miscarriage\", \"adopted_in\", \"adopted_out\", \"termination\", \"stillbirth\"];\r\n\tfor(let iswitch=0; iswitch<switches.length; iswitch++){\r\n\t\tlet attr = switches[iswitch];\r\n\t\tlet s = $('#id_'+attr);\r\n\t\tif(s.length > 0){\r\n\t\t\tconsole.log(s.is(\":checked\"));\r\n\t\t\tif(s.is(\":checked\"))\r\n\t\t\t\tperson[attr] = true;\r\n\t\t\telse\r\n\t\t\t\tdelete person[attr];\r\n\t\t}\r\n\t}\r\n\r\n\t// current sex\r\n\tlet sex = $('#id_sex').find(\"input[type='radio']:checked\");\r\n\tif(sex.length > 0){\r\n\t\tperson.sex = sex.val();\r\n\t\tupdate_cancer_by_sex(person);\r\n\t}\r\n\r\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\r\n\tupdate_ashkn(newdataset);\r\n\r\n\tif($('#id_approx').is(':checked')) // approximate diagnosis age\r\n\t\tperson.approx_diagnosis_age = true;\r\n\telse\r\n\t\tdelete person.approx_diagnosis_age;\r\n\r\n\t$(\"#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible\").each(function() {\r\n\t\tlet name = (this.name.indexOf(\"_diagnosis_age\")>-1 ? this.name.substring(0, this.name.length-2): this.name);\r\n\r\n\t\tif($(this).val()) {\r\n\t\t\tlet val = $(this).val();\r\n\t\t\tif(name.indexOf(\"_diagnosis_age\") > -1 && $(\"#id_approx\").is(':checked')) {\r\n\t\t\t\tval = round5(val);\r\n\t\t\t\t// check if approximate diagnosis age val is greater than age by 5 or less\r\n\t\t\t\tlet age = parseInt($(\"#id_age\").val());\r\n\t\t\t\tif(val > age && (val - age) <= 5) val = age;\r\n\t\t\t}\r\n\t\t\tperson[name] = val;\r\n\t\t} else {\r\n\t\t\tdelete person[name];\r\n\t\t}\r\n\t});\r\n\r\n\t// cancer checkboxes\r\n\t$('#person_details input[type=\"checkbox\"][name$=\"cancer\"],input[type=\"checkbox\"][name$=\"cancer2\"]').each(function() {\r\n\t\tif(this.checked)\r\n\t\t\tperson[$(this).attr('name')] = true;\r\n\t\telse\r\n\t\t\tdelete person[$(this).attr('name')];\r\n\t});\r\n\r\n\t// pathology tests\r\n\t$('#person_details select[name$=\"_bc_pathology\"]').each(function() {\r\n\t\tif($(this).val() !== '-') {\r\n\t\t\tperson[$(this).attr('name')] = $(this).val();\r\n\t\t} else {\r\n\t\t\tdelete person[$(this).attr('name')];\r\n\t\t}\r\n\t});\r\n\r\n\t// genetic tests\r\n\t$('#person_details select[name$=\"_gene_test\"]').each(function() {\r\n\t\tif($(this).val() !== '-') {\r\n\t\t\tlet tres = $('select[name=\"'+$(this).attr('name')+'_result\"]');\r\n\t\t\tperson[$(this).attr('name')] = {'type': $(this).val(), 'result': $(tres).val()};\r\n\t\t} else {\r\n\t\t\tdelete person[$(this).attr('name')];\r\n\t\t}\r\n\t});\r\n\r\n\t// record HOXB13 genetic test\r\n\tlet hoxb13_result = $('#person_details select[name=\"hoxb13_gene_test_result\"]').val();\r\n\tif(hoxb13_result !== undefined && hoxb13_result !== '-') {\r\n\t\tperson[\"hoxb13_gene_test\"] = {'type': 'T', 'result': hoxb13_result};\t// assume direct test\r\n\t} else {\r\n\t\tdelete person[\"hoxb13_gene_test\"];\r\n\t}\r\n\r\n\ttry {\r\n\t\t$('#person_details').find('form').valid();\r\n\t} catch(err) {\r\n\t\tconsole.warn('valid() not found');\r\n\t}\r\n\r\n\tsyncTwins(newdataset, person);\r\n\topts.dataset = newdataset;\r\n\t$(document).trigger('rebuild', [opts]);\r\n}\r\n\r\nexport function update_diagnosis_age_widget() {\r\n\tif($(\"#id_approx\").is(':checked')) {\r\n\t\t$(\"[id$='_diagnosis_age_0']\").each(function( _i ) {\r\n\t\t\tif($(this).val() !== '') {\r\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\r\n\t\t\t\t$(\"#id_\"+name+\"_1\").val(round5($(this).val())).prop('selected', true);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$(\"[id$='_diagnosis_age_0']\").hide();\r\n\t\t$(\"[id$='_diagnosis_age_1']\").show();\r\n\t} else {\r\n\t\t$(\"[id$='_diagnosis_age_1']\").each(function( _i ) {\r\n\t\t\tif($(this).val() !== '') {\r\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\r\n\t\t\t\t$(\"#id_\"+name+\"_0\").val($(this).val());\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$(\"[id$='_diagnosis_age_0']\").show();\r\n\t\t$(\"[id$='_diagnosis_age_1']\").hide();\r\n\t}\r\n}\r\n\r\n// males should not have ovarian cancer and females should not have prostate cancer\r\nfunction update_cancer_by_sex(node) {\r\n\t$('#cancer .row').show();\r\n\tif(node.sex === 'M') {\r\n\t\tdelete node.ovarian_cancer_diagnosis_age;\r\n\t\t$(\"[id^='id_ovarian_cancer_diagnosis_age']\").closest('.row').hide();\r\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', true);\r\n\t} else if(node.sex === 'F') {\r\n\t\tdelete node.prostate_cancer_diagnosis_age;\r\n\t\t$(\"[id^='id_prostate_cancer_diagnosis_age']\").closest('.row').hide();\r\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', false);\r\n\t}\r\n}\r\n\r\n// round to 5, 15, 25, 35 ....\r\nfunction round5(x1) {\r\n\tlet x2 = (Math.round((x1-1) / 10) * 10);\r\n\treturn (x1 < x2 ? x2 - 5 : x2 + 5);\r\n}\r\n\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// Helpers for adding relatives (children, siblings, parents, partners)\r\nimport * as utils from './utils.js';\r\nimport {getUniqueTwinID, setMzTwin} from './twins.js';\r\n\r\nfunction getTreeNode(flat_tree, dataset, name) {\r\n\tif(!name)\r\n\t\treturn undefined;\r\n\tlet node = flat_tree && flat_tree.length ? utils.getNodeByName(flat_tree, name) : undefined;\r\n\tif(node)\r\n\t\treturn node;\r\n\tlet dataNode = utils.getNodeByName(dataset, name);\r\n\tif(!dataNode)\r\n\t\treturn undefined;\r\n\tif(dataNode.id === undefined)\r\n\t\tdataNode.id = utils.getIdxByName(dataset, name);\r\n\treturn {\r\n\t\tdata: dataNode,\r\n\t\tdepth: utils.getDepth(dataset, name)\r\n\t};\r\n}\r\n\r\nexport function addchild(dataset, node, sex, nchild, twin_type) {\r\n\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\r\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\r\n\r\n\tif (typeof nchild === typeof undefined)\r\n\t\tnchild = 1;\r\n\tlet children = utils.getAllChildren(dataset, node);\r\n\tlet ptr_name, idx;\r\n\tif (children.length === 0) {\r\n\t\tlet partner = addsibling(dataset, node, node.sex === 'F' ? 'M': 'F', node.sex === 'F');\r\n\t\tpartner.noparents = true;\r\n\t\tptr_name = partner.name;\r\n\t\tidx = utils.getIdxByName(dataset, node.name)+1;\r\n\t} else {\r\n\t\tlet c = children[0];\r\n\t\tptr_name = (c.father === node.name ? c.mother : c.father);\r\n\t\tidx = utils.getIdxByName(dataset, c.name);\r\n\t}\r\n\r\n\tlet twin_id;\r\n\tif(twin_type)\r\n\t\ttwin_id = getUniqueTwinID(dataset, twin_type);\r\n\tlet newchildren = [];\r\n\tfor (let i = 0; i < nchild; i++) {\r\n\t\tlet child = {\"name\": utils.makeid(4), \"sex\": sex,\r\n\t\t\t\t\t \"mother\": (node.sex === 'F' ? node.name : ptr_name),\r\n\t\t\t\t\t \"father\": (node.sex === 'F' ? ptr_name : node.name)};\r\n\t\tdataset.splice(idx, 0, child);\r\n\r\n\t\tif(twin_type)\r\n\t\t\tchild[twin_type] = twin_id;\r\n\t\tnewchildren.push(child);\r\n\t}\r\n\treturn newchildren;\r\n}\r\n\r\nexport function addsibling(dataset, node, sex, add_lhs, twin_type, skip_parent_copy = false) {\r\n\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\r\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\r\n\r\n\tlet newbie = {\"name\": utils.makeid(4), \"sex\": sex};\r\n\tif(node.top_level) {\r\n\t\tnewbie.top_level = true;\r\n\t} else if (!skip_parent_copy) {\r\n\t\tnewbie.mother = node.mother;\r\n\t\tnewbie.father = node.father;\r\n\t}\r\n\tlet idx = utils.getIdxByName(dataset, node.name);\r\n\r\n\tif(twin_type) {\r\n\t\tsetMzTwin(dataset, dataset[idx], newbie, twin_type);\r\n\t}\r\n\r\n\tif(add_lhs) {\r\n\t\tif(idx > 0) idx--;\r\n\t} else\r\n\t\tidx++;\r\n\tdataset.splice(idx, 0, newbie);\r\n\treturn newbie;\r\n}\r\n\r\nexport function addparents(opts, dataset, name) {\r\n\tlet mother, father;\r\n\tlet root = utils.roots[opts.targetDiv];\r\n\tlet flat_tree = root ? utils.flatten(root) : [];\r\n\tlet tree_node = getTreeNode(flat_tree, dataset, name);\r\n\tif(!tree_node)\r\n\t\tthrow utils.create_err('Person '+name+' not found when adding parents');\r\n\tlet node  = tree_node.data;\r\n\tlet depth = tree_node.depth || utils.getDepth(dataset, node.name);\r\n\r\n\tlet pid = -101;\r\n\tlet ptr_name;\r\n\tlet children = utils.getAllChildren(dataset, node);\r\n\tif(children.length > 0){\r\n\t\tptr_name = children[0].mother === node.name ? children[0].father : children[0].mother;\r\n\t\tlet ptr_node_meta = getTreeNode(flat_tree, dataset, ptr_name);\r\n\t\tpid = ptr_node_meta && ptr_node_meta.data.id !== undefined ? ptr_node_meta.data.id : utils.getIdxByName(dataset, ptr_name);\r\n\t}\r\n\r\n\tlet i;\r\n\tif(depth === 1) {\r\n\t\tmother = {\"name\": utils.makeid(4), \"sex\": \"F\", \"top_level\": true};\r\n\t\tfather = {\"name\": utils.makeid(4), \"sex\": \"M\", \"top_level\": true};\r\n\t\tdataset.splice(0, 0, mother);\r\n\t\tdataset.splice(0, 0, father);\r\n\r\n\t\tfor(i=0; i<dataset.length; i++){\r\n\t\t\tif( (dataset[i].top_level || utils.getDepth(dataset, dataset[i].name) === 2) &&\r\n\t\t\t     dataset[i].name !== mother.name && dataset[i].name !== father.name){\r\n\t\t\t\tdelete dataset[i].top_level;\r\n\t\t\t\tdataset[i].noparents = true;\r\n\t\t\t\tdataset[i].mother = mother.name;\r\n\t\t\t\tdataset[i].father = father.name;\r\n\t\t\t}\r\n\t\t}\r\n\t} else {\r\n\t\tlet motherName = typeof tree_node.data.mother === 'string' ? tree_node.data.mother : tree_node.data.mother;\r\n\t\tmotherName = motherName && motherName.name ? motherName.name : motherName;\r\n\t\tlet fatherName = typeof tree_node.data.father === 'string' ? tree_node.data.father : tree_node.data.father;\r\n\t\tfatherName = fatherName && fatherName.name ? fatherName.name : fatherName;\r\n\t\tlet node_mother = getTreeNode(flat_tree, dataset, motherName);\r\n\t\tlet node_father = getTreeNode(flat_tree, dataset, fatherName);\r\n\t\tlet node_sibs = utils.getAllSiblings(dataset, node);\r\n\r\n\t\tlet rid = 10000;\r\n\t\tlet lid = tree_node.data.id;\r\n\t\tfor(i=0; i<node_sibs.length; i++){\r\n\t\t\tlet sibNode = getTreeNode(flat_tree, dataset, node_sibs[i].name);\r\n\t\t\tlet sid = (sibNode && sibNode.data.id !== undefined) ? sibNode.data.id : utils.getIdxByName(dataset, node_sibs[i].name);\r\n\t\t\tif(sid < rid && sid > tree_node.data.id)\r\n\t\t\t\trid = sid;\r\n\t\t\tif(sid < lid)\r\n\t\t\t\tlid = sid;\r\n\t\t}\r\n\t\tlet add_lhs = (lid >= tree_node.data.id || (pid === lid && rid < 10000));\r\n\t\tif(opts.DEBUG)\r\n\t\t\tconsole.log('lid='+lid+' rid='+rid+' nid='+tree_node.data.id+' ADD_LHS='+add_lhs);\r\n\t\tlet midx;\r\n\t\tif( (!add_lhs && node_father.data.id > node_mother.data.id) ||\r\n\t\t\t(add_lhs && node_father.data.id < node_mother.data.id) )\r\n\t\t\tmidx = utils.getIdxByName(dataset, node.father);\r\n\t\telse\r\n\t\t\tmidx = utils.getIdxByName(dataset, node.mother);\r\n\r\n\t\tlet parent = dataset[midx];\r\n\t\tfather = addsibling(dataset, parent, 'M', add_lhs);\r\n\t\tmother = addsibling(dataset, parent, 'F', add_lhs);\r\n\r\n\t\tlet faidx = utils.getIdxByName(dataset, father.name);\r\n\t\tlet moidx = utils.getIdxByName(dataset, mother.name);\r\n\t\tif(faidx > moidx) {\r\n\t\t\tlet tmpfa = dataset[faidx];\r\n\t\t\tdataset[faidx] = dataset[moidx];\r\n\t\t\tdataset[moidx] = tmpfa;\r\n\t\t}\r\n\r\n\t\tlet orphans = utils.getAdoptedSiblings(dataset, node);\r\n\t\tlet nid = tree_node.data.id;\r\n\t\tfor(i=0; i<orphans.length; i++){\r\n\t\t\tlet orphan_meta = getTreeNode(flat_tree, dataset, orphans[i].name);\r\n\t\t\tlet oid = orphan_meta && orphan_meta.data.id !== undefined ? orphan_meta.data.id : utils.getIdxByName(dataset, orphans[i].name);\r\n\t\t\tif(opts.DEBUG)\r\n\t\t\t\tconsole.log('ORPHAN='+i+' '+orphans[i].name+' '+(nid < oid && oid < rid)+' nid='+nid+' oid='+oid+' rid='+rid);\r\n\t\t\tif((add_lhs || nid < oid) && oid < rid){\r\n\t\t\t\tlet oidx = utils.getIdxByName(dataset, orphans[i].name);\r\n\t\t\t\tdataset[oidx].mother = mother.name;\r\n\t\t\t\tdataset[oidx].father = father.name;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif(depth === 2) {\r\n\t\tmother.top_level = true;\r\n\t\tfather.top_level = true;\r\n\t}\r\n\tlet idx = utils.getIdxByName(dataset, node.name);\r\n\tdataset[idx].mother = mother.name;\r\n\tdataset[idx].father = father.name;\r\n\tdelete dataset[idx].noparents;\r\n\r\n\tif('parent_node' in node) {\r\n\t\tlet ptr_node = dataset[utils.getIdxByName(dataset, ptr_name)];\r\n\t\tif('noparents' in ptr_node) {\r\n\t\t\tptr_node.mother = mother.name;\r\n\t\t\tptr_node.father = father.name;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function addpartner(opts, dataset, name) {\r\n\tlet root = utils.roots[opts.targetDiv];\r\n\tlet flat_tree = root ? utils.flatten(root) : [];\r\n\tlet tree_node = getTreeNode(flat_tree, dataset, name);\r\n\tif(!tree_node)\r\n\t\tthrow utils.create_err('Person '+name+' not found when adding partner');\r\n\r\n\t// CRITICAL: Cannot add partner if sex is unspecified\r\n\t// Reason: getChildren() requires mother.sex === 'F' to function\r\n\t// Without proper sex assignment, partner detection fails → broken visual rendering\r\n\tif(tree_node.data.sex === 'U' || !tree_node.data.sex) {\r\n\t\tthrow utils.create_err(\r\n\t\t\t'Cannot add partner: person has unspecified sex. ' +\r\n\t\t\t'Please edit the person and set sex to M or F before adding a partner.'\r\n\t\t);\r\n\t}\r\n\r\n\t// Determine partner sex (guaranteed to be 'M' or 'F' now)\r\n\tlet partner_sex = tree_node.data.sex === 'F' ? 'M' : 'F';\r\n\r\n\t// Create partner with display_name for better UX\r\n\tlet partner = {\r\n\t\t\"name\": utils.makeid(4),\r\n\t\t\"sex\": partner_sex,\r\n\t\t\"display_name\": \"Partner\"\r\n\t};\r\n\r\n\tif(tree_node.data.top_level) {\r\n\t\tpartner.top_level = true;\r\n\t} else {\r\n\t\t// Validate and copy parents if they exist\r\n\t\tif(tree_node.data.mother && utils.getIdxByName(dataset, tree_node.data.mother) !== -1) {\r\n\t\t\tpartner.mother = tree_node.data.mother;\r\n\t\t}\r\n\t\tif(tree_node.data.father && utils.getIdxByName(dataset, tree_node.data.father) !== -1) {\r\n\t\t\tpartner.father = tree_node.data.father;\r\n\t\t}\r\n\t}\r\n\tpartner.noparents = true;\r\n\r\n\t// Insert partner adjacent to the person, not at arbitrary position\r\n\t// Convention: male on left of female (male index < female index)\r\n\tlet idx = utils.getIdxByName(dataset, tree_node.data.name);\r\n\tif(tree_node.data.sex === 'F') {\r\n\t\t// person is female, insert male partner BEFORE (at person's position, shifting person right)\r\n\t\t// idx stays the same\r\n\t} else {\r\n\t\t// person is male, insert female partner AFTER\r\n\t\tidx++;\r\n\t}\r\n\tdataset.splice(idx, 0, partner);\r\n\r\n\t// CRITICAL: ALWAYS create a child to link the couple\r\n\t// PedigreeJS detects partners via shared children (get_partners() function)\r\n\t// Without a child, the partner won't be recognized as a partner → bad visual positioning\r\n\t// Even if person has children with OTHER partners, we need a child for THIS couple\r\n\tlet child_sex = Math.random() < 0.5 ? 'M' : 'F';\r\n\tlet child = {\"name\": utils.makeid(4), \"sex\": child_sex};\r\n\tchild.mother = (tree_node.data.sex === 'F' ? tree_node.data.name : partner.name);\r\n\tchild.father = (tree_node.data.sex === 'F' ? partner.name : tree_node.data.name);\r\n\r\n\t// Insert child right after the couple (after the rightmost partner)\r\n\t// Since we follow convention male-female, female is always to the right\r\n\tlet person_idx = utils.getIdxByName(dataset, tree_node.data.name);\r\n\tlet partner_idx = utils.getIdxByName(dataset, partner.name);\r\n\tlet child_idx = Math.max(person_idx, partner_idx) + 1;\r\n\tdataset.splice(child_idx, 0, child);\r\n\r\n\tif(opts.DEBUG) {\r\n\t\tconsole.log('Partner added with child: ' + child.name + ' (M:' + child.mother + ', F:' + child.father + ')');\r\n\t}\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// Helpers for deleting nodes and descendants from the dataset\r\nimport * as utils from './utils.js';\r\nimport {checkTwins} from './twins.js';\r\n\r\nfunction adjacent_nodes(root, node, excludes) {\r\n\tlet dnodes = utils.getNodesAtDepth(utils.flatten(root), node.depth, excludes);\r\n\tlet lhs_node, rhs_node;\r\n\tfor(let i=0; i<dnodes.length; i++) {\r\n\t\tif(dnodes[i].x < node.x)\r\n\t\t\tlhs_node = dnodes[i];\r\n\t\tif(!rhs_node && dnodes[i].x > node.x)\r\n\t\t\trhs_node = dnodes[i];\r\n\t}\r\n\treturn [lhs_node, rhs_node];\r\n}\r\n\r\nexport function delete_node_dataset(dataset, node, opts, onDone) {\r\n\tlet root = utils.roots[opts.targetDiv];\r\n\tlet fnodes = utils.flatten(root);\r\n\tlet deletes = [];\r\n\tlet i, j;\r\n\r\n\tif(node.id === undefined) {\r\n\t\tlet d3node = utils.getNodeByName(fnodes, node.name);\r\n\t\tif(d3node !== undefined)\r\n\t\t\tnode = d3node.data;\r\n\t}\r\n\r\n\tif(node.parent_node) {\r\n\t\tfor(i=0; i<node.parent_node.length; i++){\r\n\t\t\tlet parent = node.parent_node[i];\r\n\t\t\tlet ps = [utils.getNodeByName(dataset, parent.mother.name),\r\n\t\t\t\t\t  utils.getNodeByName(dataset, parent.father.name)];\r\n\t\t\tfor(j=0; j<ps.length; j++) {\r\n\t\t\t\tif(ps[j].name === node.name || ps[j].noparents !== undefined || ps[j].top_level) {\r\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ps[j].name), 1);\r\n\t\t\t\t\tdeletes.push(ps[j]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tlet children = parent.children;\r\n\t\t\tlet children_names = $.map(children, function(p, _i){return p.name;});\r\n\t\t\tfor(j=0; j<children.length; j++) {\r\n\t\t\t\tlet child = utils.getNodeByName(dataset, children[j].name);\r\n\t\t\t\tif(child){\r\n\t\t\t\t\tchild.noparents = true;\r\n\t\t\t\t\tlet ptrs = utils.get_partners(dataset, child);\r\n\t\t\t\t\tlet ptr;\r\n\t\t\t\t\tif(ptrs.length > 0)\r\n\t\t\t\t\t\tptr = utils.getNodeByName(dataset, ptrs[0]);\r\n\t\t\t\t\tif(ptr && ptr.mother !== child.mother) {\r\n\t\t\t\t\t\tchild.mother = ptr.mother;\r\n\t\t\t\t\t\tchild.father = ptr.father;\r\n\t\t\t\t\t} else if(ptr) {\r\n\t\t\t\t\t\tlet child_node  = utils.getNodeByName(fnodes, child.name);\r\n\t\t\t\t\t\tlet adj = adjacent_nodes(root, child_node, children_names);\r\n\t\t\t\t\t\tchild.mother = adj[0] ? adj[0].data.mother : (adj[1] ? adj[1].data.mother : null);\r\n\t\t\t\t\t\tchild.father = adj[0] ? adj[0].data.father : (adj[1] ? adj[1].data.father : null);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, child.name), 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t} else {\r\n\t\tlet idxToRemove = utils.getIdxByName(dataset, node.name);\r\n\t\tif(idxToRemove >= 0)\r\n\t\t\tdataset.splice(idxToRemove, 1);\r\n\t}\r\n\r\n\tfor(i=0; i<deletes.length; i++) {\r\n\t\tlet del = deletes[i];\r\n\t\tlet sibs = utils.getAllSiblings(dataset, del);\r\n\t\tif(sibs.length < 1) {\r\n\t\t\tlet data_node  = utils.getNodeByName(fnodes, del.name);\r\n\t\t\tlet ancestors = [];\r\n\t\t\tif(data_node && typeof data_node.ancestors === 'function')\r\n\t\t\t\tancestors = data_node.ancestors();\r\n\t\t\telse\r\n\t\t\t\tancestors = utils.ancestors(dataset, del);\r\n\t\t\tfor(j=0; j<ancestors.length; j++) {\r\n\t\t\t\tlet ancestor = ancestors[j];\r\n\t\t\t\tlet ancestorData = ancestor && ancestor.data ? ancestor.data : ancestor;\r\n\t\t\t\tif(opts.DEBUG)\r\n\t\t\t\t\tconsole.log(ancestorData);\r\n\t\t\t\tlet motherName = ancestorData && ancestorData.mother ? (ancestorData.mother.name ? ancestorData.mother.name : ancestorData.mother) : null;\r\n\t\t\t\tlet fatherName = ancestorData && ancestorData.father ? (ancestorData.father.name ? ancestorData.father.name : ancestorData.father) : null;\r\n\t\t\t\tif(motherName && fatherName) {\r\n\t\t\t\t\tif(opts.DEBUG)\r\n\t\t\t\t\t\tconsole.log('DELETE ', motherName, fatherName);\r\n\t\t\t\t\tlet mIdx = utils.getIdxByName(dataset, motherName);\r\n\t\t\t\t\tlet fIdx = utils.getIdxByName(dataset, fatherName);\r\n\t\t\t\t\tif(mIdx >= 0)\r\n\t\t\t\t\t\tdataset.splice(mIdx, 1);\r\n\t\t\t\t\tif(fIdx >= 0)\r\n\t\t\t\t\t\tdataset.splice(fIdx, 1);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tcheckTwins(dataset);\r\n\r\n\tlet uc;\r\n\t// Use injected messages function for testing, or default to utils.messages\r\n\tlet messagesFunc = opts.messages || utils.messages;\r\n\ttry\t{\r\n\t\tlet newopts = $.extend({}, opts);\r\n\t\tnewopts.dataset = utils.copy_dataset(dataset);\r\n\t\tutils.validate_pedigree(newopts);\r\n\t\tuc = utils.unconnected(dataset);\r\n\t} catch(err) {\r\n\t\tmessagesFunc('Warning', 'Deletion of this pedigree member is disallowed.')\r\n\t\tthrow err;\r\n\t}\r\n\tif(uc.length > 0) {\r\n\t\tif(utils.unconnected(opts.dataset).length === 0) {\r\n\t\t\tconsole.error(\"individuals unconnected to pedigree \", uc);\r\n\t\t\tmessagesFunc(\"Warning\", \"Deleting this will split the pedigree. Continue?\", onDone, opts, dataset);\r\n\t\t\treturn;\r\n\t\t}\r\n\t}\r\n\r\n\tif(onDone) {\r\n\t\tonDone(opts, dataset);\r\n\t}\r\n\treturn dataset;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// pedigree widgets\r\nimport * as utils from './utils.js';\r\nimport {save} from './popup_form.js';\r\nimport {current as pedcache_current} from './pedcache.js';\r\nimport {canChangeSex} from './validation.js';\r\nimport {addchild, addsibling, addparents, addpartner} from './widgets-add.js';\r\nimport {delete_node_dataset} from './widgets-delete.js';\r\n\r\nexport {addchild, addsibling, addparents, addpartner, delete_node_dataset};\r\n\r\n\r\nlet dragging;\r\nlet last_mouseover;\r\nlet shiftKeyPressed = false;  // Phase 3.2.2: Track Shift key for consanguineous drag feedback\r\n\r\n// Protection contre les double-clics qui créent des doublons\r\n// (Phase 3.1.3 - Correction UX/UI critique)\r\nlet _widgetClickInProgress = false;\r\n\r\n// Phase 3.2.2: Track Shift key for consanguineous partner drag visual feedback\r\n$(document).on('keydown keyup', function(e) {\r\n\tlet wasPressed = shiftKeyPressed;\r\n\tshiftKeyPressed = e.shiftKey;\r\n\r\n\t// Update cursor when Shift state changes\r\n\tif(wasPressed !== shiftKeyPressed) {\r\n\t\tif(shiftKeyPressed && last_mouseover && !dragging) {\r\n\t\t\t// Shift pressed while hovering node: show crosshair cursor\r\n\t\t\td3.select('.pedigree_form svg').style('cursor', 'crosshair');\r\n\t\t\t// Make drag handle more visible\r\n\t\t\td3.selectAll('.line_drag_selection').attr(\"stroke\", \"darkred\").attr(\"stroke-width\", 8);\r\n\t\t} else if(!shiftKeyPressed && !dragging) {\r\n\t\t\t// Shift released: restore normal cursor\r\n\t\t\td3.select('.pedigree_form svg').style('cursor', 'default');\r\n\t\t\td3.selectAll('.line_drag_selection').attr(\"stroke\", \"black\").attr(\"stroke-width\", 6);\r\n\t\t}\r\n\t}\r\n});\r\n\r\n/**\r\n * Add interactive widgets to pedigree nodes\r\n * Adds UI controls for:\r\n * - Adding individuals (male/female/unspecified)\r\n * - Adding partners\r\n * - Adding parents\r\n * - Editing person details\r\n * - Deleting individuals\r\n * - Setting proband status\r\n * @param {Object} opts - Pedigree options object\r\n * @param {Object} node - D3 selection of nodes to add widgets to\r\n */\r\nexport function addWidgets(opts, node) {\r\n\r\n\t// popup gender selection box\r\n\tlet font_size = parseInt($(\"body\").css('font-size'));\r\n\tlet popup_selection = d3.select('.diagram');\r\n\tpopup_selection.append(\"rect\").attr(\"class\", \"popup_selection\")\r\n\t\t\t\t\t\t\t.attr(\"rx\", 6)\r\n\t\t\t\t\t\t\t.attr(\"ry\", 6)\r\n\t\t\t\t\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t\t\t\t\t\t.attr(\"opacity\", 0)\r\n\t\t\t\t\t\t\t.attr(\"width\",  font_size*7.9)\r\n\t\t\t\t\t\t\t.attr(\"height\", font_size*2)\r\n\t\t\t\t\t\t\t.attr(\"stroke\", \"darkgrey\")\r\n\t\t\t\t\t\t\t.attr(\"fill\", \"white\");\r\n\r\n\tlet square = popup_selection.append(\"text\")  // male\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.attr(\"opacity\", 0)\r\n\t\t.attr(\"font-size\", \"1.1em\")\r\n\t\t.attr(\"class\", \"popup_selection fa-square persontype\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"x\", font_size/3)\r\n\t\t.attr(\"y\", font_size*1.5)\r\n\t\t.text(\"\\uf096 \");\r\n\tlet square_title = square.append(\"svg:title\").text(\"add male\");\r\n\r\n\tlet circle = popup_selection.append(\"text\")  // female\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.attr(\"opacity\", 0)\r\n\t\t.attr(\"font-size\", \"1.1em\")\r\n\t\t.attr(\"class\", \"popup_selection fa-circle persontype\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"x\", font_size*1.71)\r\n\t\t.attr(\"y\", font_size*1.5)\r\n\t\t.text(\"\\uf10c \");\r\n\tlet circle_title = circle.append(\"svg:title\").text(\"add female\");\r\n\r\n\tlet unspecified = popup_selection.append(\"text\")  // unspecified\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.attr(\"opacity\", 0)\r\n\t\t.attr(\"font-size\", \"1.1em\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"x\", font_size*0.065)\r\n\t\t.attr(\"y\", -font_size*0.065)\r\n\t\t.attr(\"class\", \"popup_selection fa-unspecified popup_selection_rotate45 persontype\")\r\n\t\t.text(\"\\uf096 \");\r\n\tunspecified.append(\"svg:title\").text(\"add unspecified\");\r\n\r\n\tlet dztwin = popup_selection.append(\"text\")  // dizygotic twins\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.attr(\"opacity\", 0)\r\n\t\t.attr(\"font-size\", \"1.6em\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"class\", \"popup_selection fa-angle-up persontype dztwin\")\r\n\t\t.attr(\"x\", font_size*4.62)\r\n\t\t.attr(\"y\", font_size*1.5)\r\n\t\t.text(\"\\uf106 \");\r\n\tdztwin.append(\"svg:title\").text(\"add dizygotic/fraternal twins\");\r\n\r\n\tlet mztwin = popup_selection.append(\"text\")  // monozygotic twins\r\n\t.attr('font-family', 'FontAwesome')\r\n\t.attr(\"opacity\", 0)\r\n\t.attr(\"font-size\", \"1.6em\")\r\n\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t.attr(\"class\", \"popup_selection fa-caret-up persontype mztwin\")\r\n\t.attr(\"x\", font_size*6.4)\r\n\t.attr(\"y\", font_size*1.5)\r\n\t.text(\"\\uf0d8 \");\r\n\tmztwin.append(\"svg:title\").text(\"add monozygotic/identical twins\");\r\n\r\n\tlet add_person = {};\r\n\t// click the person type selection\r\n\td3.selectAll(\".persontype\")\r\n\t  .on(\"click\", function () {\r\n\t\t// Protection contre les double-clics (Phase 3.1.3)\r\n\t\tif (_widgetClickInProgress) {\r\n\t\t\tif(opts.DEBUG) {\r\n\t\t\t\tconsole.log('Widget click ignored: action already in progress');\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t_widgetClickInProgress = true;\r\n\r\n\t\tlet newdataset = utils.copy_dataset(pedcache_current(opts));\r\n\t\tlet mztwin = d3.select(this).classed(\"mztwin\");\r\n\t\tlet dztwin = d3.select(this).classed(\"dztwin\");\r\n\t\tlet twin_type;\r\n\t\tlet sex;\r\n\t\t// Phase 3.2.4: Allow sex selection for dizygotic twins, force same sex for monozygotic\r\n\t\tif(mztwin) {\r\n\t\t\t// Monozygotic (identical) twins must have same sex as sibling\r\n\t\t\tsex = add_person.node.datum().data.sex;\r\n\t\t\ttwin_type = \"mztwin\";\r\n\t\t} else {\r\n\t\t\t// Dizygotic twins and regular persons: read sex from clicked button\r\n\t\t\tsex = d3.select(this).classed(\"fa-square\") ? 'M' : (d3.select(this).classed(\"fa-circle\") ? 'F' : 'U');\r\n\t\t\ttwin_type = dztwin ? \"dztwin\" : undefined;\r\n\t\t}\r\n\r\n\t\tif(add_person.type === 'addsibling')\r\n\t\t\taddsibling(newdataset, add_person.node.datum().data, sex, false, twin_type);\r\n\t\telse if(add_person.type === 'addchild')\r\n\t\t\taddchild(newdataset, add_person.node.datum().data, (twin_type ? 'U' : sex), (twin_type ? 2 : 1), twin_type);\r\n\t\telse {\r\n\t\t\t_widgetClickInProgress = false;\r\n\t\t\treturn;\r\n\t\t}\r\n\t\topts.dataset = newdataset;\r\n\t\t$(document).trigger('rebuild', [opts]);\r\n\t\td3.selectAll('.popup_selection').attr(\"opacity\", 0);\r\n\t\tadd_person = {};\r\n\r\n\t\t// Réactiver après un délai pour permettre le rebuild\r\n\t\tsetTimeout(() => {\r\n\t\t\t_widgetClickInProgress = false;\r\n\t\t}, 300);\r\n\t  })\r\n\t  .on(\"mouseover\", function() {\r\n\t\t  if(add_person.node)\r\n\t\t\t  add_person.node.select('rect').attr(\"opacity\", 0.2);\r\n\t\t  d3.selectAll('.popup_selection').attr(\"opacity\", 1);\r\n\t\t  // add tooltips to font awesome widgets\r\n\t\t  if(add_person.type === 'addsibling'){\r\n\t\t\t if(d3.select(this).classed(\"fa-square\"))\r\n\t\t\t\t  square_title.text(\"add brother\");\r\n\t\t\t  else\r\n\t\t\t\t  circle_title.text(\"add sister\");\r\n\t\t  } else if(add_person.type === 'addchild'){\r\n\t\t\t  if(d3.select(this).classed(\"fa-square\"))\r\n\t\t\t\t  square_title.text(\"add son\");\r\n\t\t\t  else\r\n\t\t\t\t  circle_title.text(\"add daughter\");\r\n\t\t  }\r\n\t  });\r\n\r\n\t// handle mouse out of popup selection\r\n\td3.selectAll(\".popup_selection\").on(\"mouseout\", function () {\r\n\t\t// hide rect and popup selection\r\n\t\tif(add_person.node !== undefined && highlight.indexOf(add_person.node.datum()) === -1)\r\n\t\t\tadd_person.node.select('rect').attr(\"opacity\", 0);\r\n\t\td3.selectAll('.popup_selection').attr(\"opacity\", 0);\r\n\t});\r\n\r\n\r\n\t// drag line between nodes to create partners\r\n\tdrag_handle(opts);\r\n\r\n\t// rectangle used to highlight on mouse over\r\n\tnode.filter(function (d) {\r\n\t\t    return d.data.hidden && !opts.DEBUG ? false : true;\r\n\t\t})\r\n\t\t.append(\"rect\")\r\n\t\t.attr(\"class\", 'indi_rect')\r\n\t\t.attr(\"rx\", 6)\r\n\t\t.attr(\"ry\", 6)\r\n\t\t.attr(\"x\", function(_d) { return - 0.75*opts.symbol_size; })\r\n\t\t.attr(\"y\", function(_d) { return - opts.symbol_size; })\r\n\t\t.attr(\"width\",  (1.5 * opts.symbol_size)+'px')\r\n\t\t.attr(\"height\", (2 * opts.symbol_size)+'px')\r\n\t\t.attr(\"stroke\", \"black\")\r\n\t\t.attr(\"stroke-width\", 0.7)\r\n\t\t.attr(\"opacity\", 0)\r\n\t\t.attr(\"fill\", \"lightgrey\");\r\n\r\n\t// widgets\r\n\tlet fx = function(_d) {return off - (0.75*opts.symbol_size);};\r\n\tlet fy = opts.symbol_size -2;\r\n\tlet off = 0;\r\n\tlet widgets = {\r\n\t\t'addchild':   {'text': '\\uf063', 'title': 'add child',   'fx': fx, 'fy': fy},\r\n\t\t'addsibling': {'text': '\\uf234', 'title': 'add sibling', 'fx': fx, 'fy': fy},\r\n\t\t'addpartner': {'text': '\\uf0c1', 'title': 'add partner', 'fx': fx, 'fy': fy},\r\n\t\t'addparents': {\r\n\t\t\t'text': '\\uf062', 'title': 'add parents',\r\n\t\t\t'fx': - 0.75*opts.symbol_size,\r\n\t\t\t'fy': - opts.symbol_size + 11\r\n\t\t},\r\n\t\t'delete': {\r\n\t\t\t'text': 'X', 'title': 'delete',\r\n\t\t\t'fx': (opts.symbol_size/2) - 1,\r\n\t\t\t'fy': - opts.symbol_size + 12,\r\n\t\t\t'styles': {\"font-weight\": \"bold\", \"fill\": \"darkred\", \"font-family\": \"monospace\"}\r\n\t\t}\r\n\t};\r\n\r\n\tif(opts.edit) {\r\n\t\twidgets.settings = {'text': '\\uf013', 'title': 'settings', 'fx': (-font_size/2)+2, 'fy': -opts.symbol_size + 11};\r\n\t}\r\n\r\n\tfor(let key in widgets) {\r\n\t\tlet widget = node.filter(function (d) {\r\n\t\t\t\t// Phase 3.1.4 - Supprimé la condition bloquante sur addpartner\r\n\t\t\t\t// Permet maintenant d'ajouter plusieurs partenaires (remariage, polygamie)\r\n\t\t\t\treturn  (d.data.hidden && !opts.DEBUG ? false : true) &&\r\n\t\t\t\t\t\t!((d.data.mother === undefined || d.data.noparents) && key === 'addsibling') &&\r\n\t\t\t\t\t\t!(d.data.parent_node === undefined && key === 'addchild') &&\r\n\t\t\t\t\t\t!((d.data.noparents === undefined && d.data.top_level === undefined) && key === 'addparents');\r\n\t\t\t})\r\n\t\t\t.append(\"text\")\r\n\t\t\t.attr(\"class\", key)\r\n\t\t\t.attr(\"opacity\", 0)\r\n\t\t\t.attr('font-family', 'FontAwesome')\r\n\t\t\t.attr(\"xx\", function(d){return d.x;})\r\n\t\t\t.attr(\"yy\", function(d){return d.y;})\r\n\t\t\t.attr(\"x\", widgets[key].fx)\r\n\t\t\t.attr(\"y\", widgets[key].fy)\r\n\t\t\t.attr('font-size', '0.85em' )\r\n\t\t\t.text(widgets[key].text);\r\n\r\n\t\tif('styles' in widgets[key])\r\n\t\t\tfor(let style in widgets[key].styles){\r\n\t\t\t\twidget.attr(style, widgets[key].styles[style]);\r\n\t\t\t}\r\n\r\n\t\twidget.append(\"svg:title\").text(widgets[key].title);\r\n\t\toff += 17;\r\n\t}\r\n\r\n\t// add sibling or child\r\n\td3.selectAll(\".addsibling, .addchild\")\r\n\t  .on(\"mouseover\", function () {\r\n\t\t  let type = d3.select(this).attr('class');\r\n\t\t  d3.selectAll('.popup_selection').attr(\"opacity\", 1);\r\n\t\t  add_person = {'node': d3.select(this.parentNode), 'type': type};\r\n\r\n\t\t  //let translate = getTranslation(d3.select('.diagram').attr(\"transform\"));\r\n\t\t  let x = parseInt(d3.select(this).attr(\"xx\")) + parseInt(d3.select(this).attr(\"x\"));\r\n\t\t  let y = parseInt(d3.select(this).attr(\"yy\")) + parseInt(d3.select(this).attr(\"y\"));\r\n\t\t  d3.selectAll('.popup_selection').attr(\"transform\", \"translate(\"+x+\",\"+(y+2)+\")\");\r\n\t\t  d3.selectAll('.popup_selection_rotate45')\r\n\t\t\t.attr(\"transform\", \"translate(\"+(x+(3*font_size))+\",\"+(y+(font_size*1.2))+\") rotate(45)\");\r\n\t  });\r\n\r\n\t// handle widget clicks\r\n\td3.selectAll(\".addchild, .addpartner, .addparents, .delete, .settings\")\r\n\t  .on(\"click\", function (e) {\r\n\t\t  e.stopPropagation();\r\n\r\n\t\t// Protection contre les double-clics (Phase 3.1.3)\r\n\t\tif (_widgetClickInProgress) {\r\n\t\t\tif(opts.DEBUG) {\r\n\t\t\t\tconsole.log('Widget action ignored: action already in progress');\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tlet opt = d3.select(this).attr('class');\r\n\t\tlet d = d3.select(this.parentNode).datum();\r\n\t\tif(opts.DEBUG) {\r\n\t\t\tconsole.log(opt);\r\n\t\t}\r\n\r\n\t\t// Bloquer les clics pendant l'action (sauf settings qui est instantané)\r\n\t\tif(opt !== 'settings') {\r\n\t\t\t_widgetClickInProgress = true;\r\n\t\t}\r\n\r\n\t\tlet newdataset;\r\n\t\tif(opt === 'settings') {\r\n\t\t\tif(typeof opts.edit === 'function') {\r\n\t\t\t\topts.edit(opts, d);\r\n\t\t\t} else {\r\n\t\t\t\topenEditDialog(opts, d);\r\n\t\t\t}\r\n\t\t} else if(opt === 'delete') {\r\n\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\r\n\t\t\tdelete_node_dataset(newdataset, d.data, opts, onDone);\r\n\t\t} else if(opt === 'addparents') {\r\n\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\r\n\t\t\topts.dataset = newdataset;\r\n\t\t\taddparents(opts, newdataset, d.data.name);\r\n\t\t\t$(document).trigger('rebuild', [opts]);\r\n\t\t} else if(opt === 'addpartner') {\r\n\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\r\n\t\t\topts.dataset = newdataset;  // Assign BEFORE calling addpartner\r\n\t\t\taddpartner(opts, newdataset, d.data.name);\r\n\t\t\t$(document).trigger('rebuild', [opts]);\r\n\t\t}\r\n\t\t// trigger fhChange event\r\n\t\t$(document).trigger('fhChange', [opts]);\r\n\r\n\t\t// Réactiver après un délai (sauf settings)\r\n\t\tif(opt !== 'settings') {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\t_widgetClickInProgress = false;\r\n\t\t\t}, 300);\r\n\t\t}\r\n\t});\r\n\r\n\t// other mouse events\r\n\tlet highlight = [];\r\n\r\n\tnode.filter(function (d) { return !d.data.hidden; })\r\n\t.on(\"click\", function (e, d) {\r\n\t\tif (e.ctrlKey) {\r\n\t\t\tif(highlight.indexOf(d) === -1)\r\n\t\t\t\thighlight.push(d);\r\n\t\t\telse\r\n\t\t\t\thighlight.splice(highlight.indexOf(d), 1);\r\n\t\t} else\r\n\t\t\thighlight = [d];\r\n\r\n\t\tif('nodeclick' in opts) {\r\n\t\t\topts.nodeclick(d.data);\r\n\t\t\td3.selectAll(\".indi_rect\").attr(\"opacity\", 0);\r\n\t\t\td3.selectAll('.indi_rect').filter(function(d) {return highlight.indexOf(d) !== -1;}).attr(\"opacity\", 0.5);\r\n\t\t}\r\n\t})\r\n\t.on(\"mouseover\", function(e, d){\r\n\t\te.stopPropagation();\r\n\t\tlast_mouseover = d;\r\n\t\tif(dragging) {\r\n\t\t\tif(dragging.data.name !== last_mouseover.data.name &&\r\n\t\t\t   dragging.data.sex !== last_mouseover.data.sex) {\r\n\t\t\t\td3.select(this).select('rect').attr(\"opacity\", 0.2);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\td3.select(this).select('rect').attr(\"opacity\", 0.2);\r\n\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').attr(\"opacity\", 1);\r\n\t\td3.select(this).selectAll('.indi_details').attr(\"opacity\", 0);\r\n\r\n\t\tsetLineDragPosition(opts.symbol_size-10, 0, opts.symbol_size-2, 0, d.x+\",\"+(d.y+2));\r\n\r\n\t\t// Phase 3.2.2: Enhanced visual feedback when Shift pressed\r\n\t\tif(shiftKeyPressed) {\r\n\t\t\td3.select('.pedigree_form svg').style('cursor', 'crosshair');\r\n\t\t\td3.selectAll('.line_drag_selection').attr(\"stroke\", \"darkred\").attr(\"stroke-width\", 8);\r\n\t\t}\r\n\t})\r\n\t.on(\"mouseout\", function(d){\r\n\t\tif(dragging)\r\n\t\t\treturn;\r\n\r\n\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').attr(\"opacity\", 0);\r\n\t\tif(highlight.indexOf(d) === -1)\r\n\t\t\td3.select(this).select('rect').attr(\"opacity\", 0);\r\n\t\td3.select(this).selectAll('.indi_details').attr(\"opacity\", 1);\r\n\r\n\t\t// Phase 3.2.2: Restore normal cursor when leaving node\r\n\t\tif(shiftKeyPressed) {\r\n\t\t\td3.select('.pedigree_form svg').style('cursor', 'default');\r\n\t\t\td3.selectAll('.line_drag_selection').attr(\"stroke\", \"black\").attr(\"stroke-width\", 6);\r\n\t\t}\r\n\t\tlast_mouseover = undefined;\r\n\r\n\t\t// hide popup if it looks like the mouse is moving north\r\n\t\tlet xcoord = d3.pointer(d)[0];\r\n\t\tlet ycoord = d3.pointer(d)[1];\r\n\t\tif(ycoord < 0.8*opts.symbol_size)\r\n\t\t\td3.selectAll('.popup_selection').attr(\"opacity\", 0);\r\n\t\tif(!dragging) {\r\n\t\t\t// hide popup if it looks like the mouse is moving north, south or west\r\n\t\t\tif( Math.abs(ycoord) > 0.25*opts.symbol_size ||\r\n\t\t\t\tMath.abs(ycoord) < -0.25*opts.symbol_size ||\r\n\t\t\t\txcoord < 0.2*opts.symbol_size){\r\n\t\t\t\t\tsetLineDragPosition(0, 0, 0, 0);\r\n\t\t\t}\r\n        }\r\n\t});\r\n}\r\n\r\nfunction onDone(opts, dataset) {\r\n\t// assign new dataset and rebuild pedigree\r\n\topts.dataset = dataset;\r\n\t$(document).trigger('rebuild', [opts]);\r\n}\r\n\r\n// drag line between nodes to create partners\r\nfunction drag_handle(opts) {\r\n\tlet line_drag_selection = d3.select('.diagram');\r\n\tlet dline = line_drag_selection.append(\"line\").attr(\"class\", 'line_drag_selection')\r\n        .attr(\"stroke-width\", 6)\r\n        .attr(\"stroke-dasharray\", (\"2, 1\"))\r\n        .attr(\"stroke\",\"black\")\r\n        .call(d3.drag()\r\n                .on(\"start\", dragstart)\r\n                .on(\"drag\", drag)\r\n                .on(\"end\", dragstop));\r\n\t// Phase 3.2.2: Enhanced tooltip with Shift key hint\r\n\tdline.append(\"svg:title\").text(\"Hold Shift and drag to create consanguineous partners (blood-related)\");\r\n\r\n\tsetLineDragPosition(0, 0, 0, 0);\r\n\r\n\tfunction dragstart() {\r\n\t\tdragging = last_mouseover;\r\n\t\td3.selectAll('.line_drag_selection')\r\n\t\t\t.attr(\"stroke\",\"darkred\");\r\n\t}\r\n\r\n\tfunction dragstop(_d) {\r\n\t\tif(last_mouseover &&\r\n\t\t   dragging.data.name !== last_mouseover.data.name &&\r\n\t\t   dragging.data.sex  !== last_mouseover.data.sex) {\r\n\t\t\t// make partners\r\n\t\t\tlet child = {\"name\": utils.makeid(4), \"sex\": 'U',\r\n\t\t\t\t     \"mother\": (dragging.data.sex === 'F' ? dragging.data.name : last_mouseover.data.name),\r\n\t\t\t         \"father\": (dragging.data.sex === 'F' ? last_mouseover.data.name : dragging.data.name)};\r\n\t\t\tlet newdataset = utils.copy_dataset(opts.dataset);\r\n\t\t\topts.dataset = newdataset;\r\n\r\n\t\t\tlet idx = utils.getIdxByName(opts.dataset, dragging.data.name)+1;\r\n\t\t\topts.dataset.splice(idx, 0, child);\r\n\t\t\t$(document).trigger('rebuild', [opts]);\r\n\t\t}\r\n\t\tsetLineDragPosition(0, 0, 0, 0);\r\n\t\td3.selectAll('.line_drag_selection')\r\n\t\t\t.attr(\"stroke\",\"black\");\r\n\t\tdragging = undefined;\r\n\t\treturn;\r\n\t}\r\n\r\n\tfunction drag(e) {\r\n\t\te.sourceEvent.stopPropagation();\r\n\t\tlet dx = e.dx;\r\n\t\tlet dy = e.dy;\r\n\t\tlet xnew = parseFloat(d3.select(this).attr('x2'))+ dx;\r\n        let ynew = parseFloat(d3.select(this).attr('y2'))+ dy;\r\n        setLineDragPosition(opts.symbol_size-10, 0, xnew, ynew);\r\n\t}\r\n}\r\n\r\n/**\r\n * Set the position and start and end of consanguineous widget.\r\n */\r\nfunction setLineDragPosition(x1, y1, x2, y2, translate) {\r\n\tif(translate) {\r\n\t\td3.selectAll('.line_drag_selection').attr(\"transform\", \"translate(\"+translate+\")\");\r\n\t}\r\n\td3.selectAll('.line_drag_selection')\r\n\t\t.attr(\"x1\", x1)\r\n\t\t.attr(\"y1\", y1)\r\n\t\t.attr(\"x2\", x2)\r\n\t\t.attr(\"y2\", y2);\r\n}\r\n\r\nfunction capitaliseFirstLetter(string) {\r\n    return string.charAt(0).toUpperCase() + string.slice(1);\r\n}\r\n\r\n// if opt.edit is set true (rather than given a function) this is called to edit node attributes\r\nfunction openEditDialog(opts, d) {\r\n\t$('#node_properties').dialog({\r\n\t    autoOpen: false,\r\n\t    title: d.data.display_name,\r\n\t    width: ($(window).width() > 400 ? 450 : $(window).width()- 30)\r\n\t});\r\n\r\n\tlet table = \"<table id='person_details' class='table'>\";\r\n\r\n\ttable += \"<tr><td style='text-align:right'>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value=\"+\r\n\t(d.data.name ? d.data.name : \"\")+\"></td></tr>\";\r\n\ttable += \"<tr><td style='text-align:right'>Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value=\"+\r\n\t\t\t(d.data.display_name ? d.data.display_name : \"\")+\"></td></tr>\";\r\n\r\n\ttable += \"<tr><td style='text-align:right'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:7em' value=\"+\r\n\t\t\t(d.data.age ? d.data.age : \"\")+\"></td></tr>\";\r\n\r\n\ttable += \"<tr><td style='text-align:right'>Year Of Birth</td><td><input class='form-control' type='number' id='id_yob' min='1900' max='2050' name='yob' style='width:7em' value=\"+\r\n\t\t(d.data.yob ? d.data.yob : \"\")+\"></td></tr>\";\r\n\r\n\t// check if sex can be changed (Phase 3.1.5)\r\n\tlet dataset = pedcache_current(opts);\r\n\tconst sexCanChange = canChangeSex(d.data, dataset);\r\n\tconst disableInp = (sexCanChange ? \"\" : \"disabled\")\r\n\tconst label = '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" ';\r\n\ttable += '<tr><td colspan=\"2\" id=\"id_sex\">' +\r\n\t\t\t label+'value=\"M\" '+(d.data.sex === 'M' ? \"checked \" : \" \")+disableInp+'>Male</label>' +\r\n\t\t\t label+'value=\"F\" '+(d.data.sex === 'F' ? \"checked \" : \" \")+disableInp+'>Female</label>' +\r\n\t\t\t label+'value=\"U\" '+disableInp+'>Unknown</label>' +\r\n\t\t\t '</td></tr>';\r\n\r\n\t// alive status = 0; dead status = 1\r\n\ttable += '<tr><td colspan=\"2\" id=\"id_status\">' +\r\n\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"0\" '+(parseInt(d.data.status) === 0 ? \"checked\" : \"\")+'>&thinsp;Alive</label>' +\r\n\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"1\" '+(parseInt(d.data.status) === 1 ? \"checked\" : \"\")+'>&thinsp;Deceased</label>' +\r\n\t\t\t '</td></tr>';\r\n\t$(\"#id_status input[value='\"+d.data.status+\"']\").prop('checked', true);\r\n\r\n\t// switches\r\n\tlet switches = [\"adopted_in\", \"adopted_out\", \"miscarriage\", \"stillbirth\", \"termination\"];\r\n\ttable += '<tr><td colspan=\"2\"><strong>Reproduction:</strong></td></tr>';\r\n\ttable += '<tr><td colspan=\"2\">';\r\n\tfor(let iswitch=0; iswitch<switches.length; iswitch++){\r\n\t\tlet attr = switches[iswitch];\r\n\t\tif(iswitch === 2)\r\n\t\t\ttable += '</td></tr><tr><td colspan=\"2\">';\r\n\t\ttable +=\r\n\t\t '<label class=\"checkbox-inline\"><input type=\"checkbox\" id=\"id_'+attr +\r\n\t\t    '\" name=\"'+attr+'\" value=\"0\" '+(d.data[attr] ? \"checked\" : \"\")+'>&thinsp;' +\r\n\t\t    capitaliseFirstLetter(attr.replace('_', ' '))+'</label>'\r\n\t}\r\n\ttable += '</td></tr>';\r\n\r\n\t//\r\n\tlet exclude = [\"children\", \"name\", \"parent_node\", \"top_level\", \"id\", \"noparents\",\r\n\t\t           \"level\", \"age\", \"sex\", \"status\", \"display_name\", \"mother\", \"father\",\r\n\t\t           \"yob\", \"mztwin\", \"dztwin\"];\r\n\t$.merge(exclude, switches);\r\n\ttable += '<tr><td colspan=\"2\"><strong>Age of Diagnosis:</strong></td></tr>';\r\n\t$.each(opts.diseases, function(k, v) {\r\n\t\texclude.push(v.type+\"_diagnosis_age\");\r\n\r\n\t\tlet disease_colour = '&thinsp;<span style=\"padding-left:5px;background:'+opts.diseases[k].colour+'\"></span>';\r\n\t\tlet diagnosis_age = d.data[v.type + \"_diagnosis_age\"];\r\n\r\n\t\ttable += \"<tr><td style='text-align:right'>\"+capitaliseFirstLetter(v.type.replace(\"_\", \" \"))+\r\n\t\t\t\t\tdisease_colour+\"&nbsp;</td><td>\" +\r\n\t\t\t\t\t\"<input class='form-control' id='id_\" +\r\n\t\t\t\t\tv.type + \"_diagnosis_age_0' max='110' min='0' name='\" +\r\n\t\t\t\t\tv.type + \"_diagnosis_age_0' style='width:5em' type='number' value='\" +\r\n\t\t\t\t\t(diagnosis_age !== undefined ? diagnosis_age : \"\") +\"'></td></tr>\";\r\n\t});\r\n\r\n\ttable += '<tr><td colspan=\"2\" style=\"line-height:1px;\"></td></tr>';\r\n\t$.each(d.data, function(k, v) {\r\n\t\tif($.inArray(k, exclude) === -1) {\r\n\t\t\tlet kk = capitaliseFirstLetter(k);\r\n\t\t\tif(v === true || v === false) {\r\n\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='checkbox' id='id_\" + k + \"' name='\" +\r\n\t\t\t\t\t\tk+\"' value=\"+v+\" \"+(v ? \"checked\" : \"\")+\"></td></tr>\";\r\n\t\t\t} else if(k.length > 0){\r\n\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='text' id='id_\" +\r\n\t\t\t\t\t\tk+\"' name='\"+k+\"' value=\"+v+\"></td></tr>\";\r\n\t\t\t}\r\n\t\t}\r\n    });\r\n\ttable += \"</table>\";\r\n\r\n\t$('#node_properties').html(table);\r\n\t$('#node_properties').dialog('open');\r\n\r\n\t$('#node_properties input[type=radio], #node_properties input[type=checkbox], #node_properties input[type=text], #node_properties input[type=number]').on('change', function() {\r\n\t\tsave(opts);\r\n    });\r\n\treturn;\r\n}\r\n\r\n\r\n\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\nimport {prefixInObj} from './utils.js';\r\nimport {validate_age_yob} from './validation.js';\r\n\r\nexport function addLabels(opts, node) {\r\n\t// names of individuals\r\n\taddLabel(opts, node, -(0.4 * opts.symbol_size), -(0.1 * opts.symbol_size),\r\n\t\t\tfunction(d) {\r\n\t\t\t\tif(opts.DEBUG)\r\n\t\t\t\t\treturn ('display_name' in d.data ? d.data.display_name : d.data.name) + '  ' + d.data.id;\r\n\t\t\t\treturn 'display_name' in d.data ? d.data.display_name : '';}, undefined, ['display_name']);\r\n\r\n\tlet font_size = parseInt(getPx(opts)) + 4;\r\n\r\n\t// Phase 3.3.4: Fonction de validation age/yob (sortie de la boucle pour éviter no-loop-func)\r\n\tlet validate_age_yob_data = function(d) {\r\n\t\t// Valider age/yob si les deux sont présents\r\n\t\tif(d.data.age && d.data.yob && d.data.status) {\r\n\t\t\treturn validate_age_yob(d.data.age, d.data.yob, d.data.status);\r\n\t\t}\r\n\t\treturn true; // Valide si données manquantes\r\n\t};\r\n\r\n\t// display age/yob label first\r\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\r\n\t\tlet label = opts.labels[ilab];\r\n\t\tlet arr = (Array.isArray(label) ? label : [label]);\r\n\t\tif(arr.indexOf('age') > -1 || arr.indexOf('yob') > -1) {\r\n\t\t\t// Phase 3.3.4: Ajouter indicateur visuel pour données age/yob invalides\r\n\t\t\taddLabel(opts, node, -opts.symbol_size,\r\n\t\t\t\tfunction(d) { return ypos(d, arr, font_size); },\r\n\t\t\t\tfunction(d) { return get_text(d, arr); }, 'indi_details', arr,\r\n\t\t\t\tvalidate_age_yob_data);\r\n\t\t}\r\n\t}\r\n\r\n\t// individuals disease details\r\n\tfor(let i=0;i<opts.diseases.length; i++) {\r\n\t\tlet disease = opts.diseases[i].type;\r\n\t\taddLabel(opts, node, -opts.symbol_size,\r\n\t\t\t\tfunction(d) { return ypos(d, [disease], font_size); },\r\n\t\t\t\tfunction(d) {\r\n\t\t\t\t\tlet dis = disease.replace('_', ' ').replace('cancer', 'ca.');\r\n\t\t\t\t\treturn disease+'_diagnosis_age' in d.data ? dis +\": \"+ d.data[disease+'_diagnosis_age'] : '';\r\n\t\t\t\t}, 'indi_details', [disease]);\r\n\t}\r\n\r\n\t// display other labels defined in opts.labels e.g. alleles/genotype data\r\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\r\n\t\tlet label = opts.labels[ilab];\r\n\t\tlet arr = (Array.isArray(label) ? label : [label]);\r\n\t\tif(arr.indexOf('age') === -1 && arr.indexOf('yob') === -1) {\r\n\t\t\taddLabel(opts, node, -opts.symbol_size,\r\n\t\t\t\tfunction(d) { return ypos(d, arr, font_size); },\r\n\t\t\t\tfunction(d) { return get_text(d, arr); }, 'indi_details', arr);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction get_text(d, arr) {\r\n\tlet txt = \"\";\r\n\tfor(let l=0; l<arr.length; l++) {\r\n\t\tlet this_label = arr[l];\r\n\t\tif(d.data[this_label]) {\r\n\t\t\tif(this_label === 'alleles') {\r\n\t\t\t\tlet vars = d.data.alleles.split(';');\r\n\t\t\t\tfor(let ivar = 0;ivar < vars.length;ivar++) {\r\n\t\t\t\t\tif(vars[ivar] !== \"\") txt += vars[ivar] + ';';\r\n\t\t\t\t}\r\n\t\t\t} else if(this_label === 'age') {\r\n\t\t\t\ttxt += d.data[this_label] +'y ';\r\n\t\t\t} else if(this_label === 'stillbirth') {\r\n\t\t\t\ttxt += \"SB\";\r\n\t\t\t} else if(this_label.match(\"_gene_test$\") && 'result' in d.data[this_label]) {\r\n\t\t\t\tlet r = d.data[this_label]['result'].toUpperCase();\r\n\t\t\t\t//let t = d.data[this_label]['type'];\r\n\t\t\t\tif(r !== \"-\") {\r\n\t\t\t\t\ttxt += this_label.replace('_gene_test', '').toUpperCase()\r\n\t\t\t\t\ttxt += (r === 'P' ? '+ ' : (r === 'N' ? '- ' : ' '));\r\n\t\t\t\t}\r\n\t\t\t} else if(this_label.match(\"_bc_pathology$\")) {\r\n\t\t\t\tlet r = d.data[this_label].toUpperCase();\r\n\t\t\t\ttxt += this_label.replace('_bc_pathology', '').toUpperCase()\r\n\t\t\t\ttxt += (r === 'P' ? '+ ' : (r === 'N' ? '- ' : ' '));\r\n\t\t\t} else {\r\n\t\t\t  txt += d.data[this_label];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tif(txt !== \"\") return txt;\r\n}\r\n\r\nfunction ypos(d, arr, font_size) {\r\n\tif(!node_has_label(d, arr)) return;\r\n\td.y_offset = (!d.y_offset ? font_size*2.35 : d.y_offset+font_size);\r\n\treturn d.y_offset;\r\n}\r\n\r\nfunction node_has_label(d, labels) {\r\n\tfor(let l=0; l<labels.length; l++) {\r\n\t\tif(prefixInObj(labels[l], d.data)) return true;\r\n\t}\r\n\treturn false;\r\n}\r\n\r\n// add label to node\r\nfunction addLabel(opts, node, fx, fy, ftext, class_label, labels, validate_fn) {\r\n\tlet labels_sel = node.filter(function (d) {\r\n\t\treturn !d.data.hidden && (!labels || node_has_label(d, labels));\r\n\t}).append(\"text\")\r\n\t.attr(\"class\", (class_label ? class_label + ' ped_label' : 'ped_label'))\r\n\t.attr(\"x\", fx)\r\n\t.attr(\"y\", fy)\r\n\t.attr(\"font-family\", opts.font_family)\r\n\t.attr(\"font-size\", opts.font_size)\r\n\t.attr(\"font-weight\", opts.font_weight)\r\n\t// Phase 3.3.4: Appliquer style visuel si données invalides\r\n\t.attr(\"fill\", function(d) {\r\n\t\tif(validate_fn && !validate_fn(d)) {\r\n\t\t\treturn \"#d32f2f\"; // Rouge pour données invalides\r\n\t\t}\r\n\t\treturn null; // Style par défaut\r\n\t})\r\n\t.text(ftext);\r\n\r\n\t// Ajouter tooltip pour les données invalides\r\n\tlabels_sel.append(\"title\")\r\n\t.text(function(d) {\r\n\t\tif(validate_fn && !validate_fn(d)) {\r\n\t\t\treturn \"Warning: Age and year of birth are inconsistent\";\r\n\t\t}\r\n\t\treturn \"\";\r\n\t});\r\n}\r\n\r\n// get height in pixels\r\nfunction getPx(opts){\r\n\tlet emVal = opts.font_size;\r\n\tif (emVal === parseInt(emVal, 10)) // test if integer\r\n\t\treturn emVal;\r\n\r\n\tif(emVal.indexOf(\"px\") > -1)\r\n\t\treturn emVal.replace('px', '');\r\n\telse if(emVal.indexOf(\"em\") === -1)\r\n\t\treturn emVal;\r\n\temVal = parseFloat(emVal.replace('em', ''));\r\n\treturn (parseFloat(getComputedStyle($('#'+opts.targetDiv).get(0)).fontSize)*emVal)-1.0;\r\n}\r\n","import  * as utils from './utils.js';\r\nimport {current as pedcache_current} from './pedcache.js';\r\n\r\n/**\r\n * Initialize drag-and-drop repositioning for pedigree nodes\r\n * Enables SHIFT + DRAG to reorder siblings horizontally within their generation\r\n * Updates dataset ordering and triggers rebuild to reflect new positions\r\n * @param {Object} opts - Pedigree options object\r\n * @param {Array} opts.dataset - Array of person objects\r\n * @param {string} opts.targetDiv - ID of the container div\r\n * @param {Object} node - D3 selection of nodes to make draggable\r\n * @example\r\n * // Hold SHIFT key and drag a person node left or right to reorder siblings\r\n */\r\nexport function init_dragging(opts, node) {\r\n\t// add drag\r\n\tnode.filter(function (d) {return !d.data.hidden;})\r\n\t    .call(d3.drag()\r\n\t\t\t\t.filter(function filter(event) {\r\n\t\t\t\t\treturn !event.ctrlKey && !event.button && event.shiftKey; \t// shift and drag\r\n\t\t\t\t})\r\n                .on(\"start\", dragstart)\r\n                .on(\"drag\", drag)\r\n                .on(\"end\", dragstop));\r\n\r\n\tlet xstart;\r\n\tlet xnew;\r\n\r\n    function dragstart() {\r\n\t\txstart = d3.select(this).select('.indi_rect').attr('x');\r\n\t}\r\n\t\r\n\tfunction drag(e) {\r\n\t\te.sourceEvent.stopPropagation();\r\n\t\tlet dx = e.dx;\r\n\t\tlet indir = d3.select(this).select('.indi_rect');\r\n\t\txnew = parseFloat(indir.attr('x'))+ dx;\r\n        indir.attr(\"x\", xnew);\r\n\t}\r\n\t\r\n\tfunction dragstop(_d) {\r\n\t\tlet me = d3.select(this).datum().data;\r\n\t\tlet pnrs = utils.get_partners(opts.dataset, me);\r\n\t\tlet pnrName = (pnrs.length === 1 ? utils.get_partners(opts.dataset, me)[0] : -1);\r\n\r\n\t\t// reset individuals rectangle\r\n\t\tlet indir = d3.select(this).select('.indi_rect');\r\n\t\tindir.attr(\"x\", xstart);\r\n\r\n\t\tconst isMovingRight = (xnew>xstart);\r\n\t\t\r\n\t\t// get depth of node being dragged\r\n\t\tlet root = utils.roots[opts.targetDiv];\r\n\t\tlet flat_tree = utils.flatten(root);\r\n\t\tlet meNode = utils.getNodeByName(flat_tree, me.name);\r\n\t\t\r\n\t\t// nodes at same depth\r\n\t\tlet dnodes = utils.getNodesAtDepth(utils.flatten(root), meNode.depth);\r\n\r\n\t\t// locate adjacent nodes\r\n\t\tlet lft_node, rgt_node, adj_node;\r\n\t\txnew += meNode.x;\r\n\t\tlet xlft = -Number.MAX_VALUE;\r\n\t\tlet xrgt =  Number.MAX_VALUE;\r\n\t\tfor(let i=0; i<dnodes.length; i++) {\r\n\t\t\tif(dnodes[i].x < xnew && dnodes[i].x > xlft) {\r\n\t\t\t\tlft_node = dnodes[i];\r\n\t\t\t\txlft = dnodes[i].x;\r\n\t\t\t} else if(dnodes[i].x > xnew && dnodes[i].x < xrgt) {\r\n\t\t\t\trgt_node = dnodes[i];\r\n\t\t\t\txrgt = dnodes[i].x;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(lft_node === undefined && rgt_node === undefined) return;\r\n\t\tlet adjIdx;\r\n\t\tif(isMovingRight) {\r\n\t\t\tadjIdx = utils.getIdxByName(opts.dataset, lft_node.data.name);\r\n\t\t\tadj_node = lft_node;\r\n\t\t} else {\r\n\t\t\tadjIdx = utils.getIdxByName(opts.dataset, rgt_node.data.name);\r\n\t\t\tadj_node = rgt_node;\r\n\t\t}\r\n\r\n\t\t// move node to new location in dataset\r\n        let newdataset = utils.copy_dataset(pedcache_current(opts));\r\n        let idx = utils.getIdxByName(opts.dataset, me.name);\r\n        el_move(newdataset, idx, adjIdx);\r\n        if(pnrName !== -1 && pnrName !== adj_node.data.name) {\r\n\t\t\tidx = utils.getIdxByName(newdataset, pnrName);\r\n\t\t\tel_move(newdataset, idx, adjIdx);\r\n        }\r\n        opts.dataset = newdataset;\r\n        $(document).trigger('rebuild', [opts]);\r\n\t}\r\n}\r\n\r\n// move element in array\r\nfunction el_move(arr, old_index, new_index) {\r\n    if (new_index >= arr.length) {\r\n        var k = new_index - arr.length + 1;\r\n        while (k--) {\r\n            arr.push(undefined);\r\n        }\r\n    }\r\n    arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);\r\n    return arr;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// Pedigree Tree Builder\r\nimport  * as utils from './utils.js';\r\nimport * as pbuttons from './pbuttons.js';\r\nimport * as pedcache from './pedcache.js';\r\nimport * as io from './io.js';\r\nimport {addWidgets} from './widgets.js';\r\nimport {init_zoom} from './zoom.js';\r\nimport {addLabels} from './labels.js';\r\nimport {init_dragging} from './dragging.js';\r\n\r\n// Protection contre les race conditions lors de rebuilds concurrents\r\n// (Phase 3.1.1 - Correction UX/UI critique)\r\nlet _isBuilding = false;\r\n\r\n/**\r\n * Build and render a pedigree diagram\r\n * @param {Object} options - Configuration options for the pedigree\r\n * @param {string} options.targetDiv - ID of the HTML element to render the pedigree into\r\n * @param {Array} options.dataset - Array of person objects representing the pedigree\r\n * @param {number} [options.width=600] - Width of the SVG diagram in pixels\r\n * @param {number} [options.height=400] - Height of the SVG diagram in pixels\r\n * @param {number} [options.symbol_size=35] - Size of person symbols in pixels\r\n * @param {Array} [options.zoomSrc=['wheel', 'button']] - Zoom sources ('wheel', 'button')\r\n * @param {number} [options.zoomIn=1.0] - Maximum zoom in level\r\n * @param {number} [options.zoomOut=1.0] - Maximum zoom out level\r\n * @param {boolean} [options.dragNode=true] - Enable dragging nodes (SHIFT + drag)\r\n * @param {boolean} [options.showWidgets=true] - Show interactive widgets\r\n * @param {Array} [options.diseases] - Disease types to display with colors\r\n * @param {boolean} [options.validate=true] - Enable pedigree validation\r\n * @param {boolean} [options.DEBUG=false] - Enable debug mode (shows hidden nodes and logs)\r\n * @returns {void}\r\n * @example\r\n * pedigreejs.build({\r\n *   targetDiv: 'my_pedigree',\r\n *   dataset: [\r\n *     {name: \"father\", sex: \"M\", top_level: true},\r\n *     {name: \"mother\", sex: \"F\", top_level: true},\r\n *     {name: \"child\", sex: \"F\", mother: \"mother\", father: \"father\", proband: true}\r\n *   ]\r\n * });\r\n */\r\nexport function build(options) {\r\n\tlet opts = $.extend({ // defaults\r\n\t\ttargetDiv: 'pedigree_edit',\r\n\t\tdataset: [ {\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\r\n\t\t\t\t   {\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\r\n\t\t\t\t   {\"name\": \"ch1\", \"display_name\": \"me\", \"sex\": \"F\", \"mother\": \"f21\", \"father\": \"m21\", \"proband\": true}],\r\n\t\twidth: 600,\r\n\t\theight: 400,\r\n\t\tsymbol_size: 35,\r\n\t\tzoomSrc: ['wheel', 'button'],\r\n\t\tzoomIn: 1.0,\r\n\t\tzoomOut: 1.0,\r\n\t\tdragNode: true,\r\n\t\tshowWidgets: true,\r\n\t\tdiseases: [\t{'type': 'breast_cancer', 'colour': '#F68F35'},\r\n\t\t\t\t\t{'type': 'breast_cancer2', 'colour': 'pink'},\r\n\t\t\t\t\t{'type': 'ovarian_cancer', 'colour': '#306430'},\r\n\t\t\t\t\t{'type': 'pancreatic_cancer', 'colour': '#4289BA'},\r\n\t\t\t\t\t{'type': 'prostate_cancer', 'colour': '#D5494A'}],\r\n\t\tlabels: ['stillbirth', ['age', 'yob'], 'alleles',\r\n\t\t\t\t\t\t\t   ['brca1_gene_test', 'brca2_gene_test', 'palb2_gene_test', 'chek2_gene_test', 'atm_gene_test'],\r\n\t\t\t\t\t\t\t   ['rad51d_gene_test', 'rad51c_gene_test', 'brip1_gene_test', 'hoxb13_gene_test'],\r\n\t\t\t\t\t\t\t   ['er_bc_pathology', 'pr_bc_pathology', 'her2_bc_pathology', 'ck14_bc_pathology', 'ck56_bc_pathology']],\r\n\t\tkeep_proband_on_reset: false,\r\n\t\tfont_size: '.75em',\r\n\t\tfont_family: 'Helvetica',\r\n\t\tfont_weight: 700,\r\n\t\tbackground: \"#FAFAFA\",\r\n\t\tnode_background: '#fdfdfd',\r\n\t\tvalidate: true,\r\n\t\tDEBUG: false,\r\n\t\tVERBOSE: false}, options );\r\n\r\n\tif ( $( \"#fullscreen\" ).length === 0 ) {\r\n\t\t// add undo, redo, fullscreen buttons and event listeners once\r\n\t\tpbuttons.addButtons(opts, rebuild, build);\r\n\t\tio.addIO(opts);\r\n\t}\r\n\r\n\tif(pedcache.nstore(opts) === -1)\r\n\t\tpedcache.init_cache(opts);\r\n\r\n\tpbuttons.updateButtons(opts);\r\n\r\n\t// validate pedigree data\r\n\tutils.validate_pedigree(opts);\r\n\t// group top level nodes by partners\r\n\topts.dataset = group_top_level(opts.dataset);\r\n\r\n\tif(opts.VERBOSE)\r\n\t\tutils.print_opts(opts);\r\n\tlet svg_dimensions = utils.get_svg_dimensions(opts);\r\n\tlet svg = d3.select(\"#\"+opts.targetDiv)\r\n\t\t\t\t .append(\"svg:svg\")\r\n\t\t\t\t .attr(\"width\", svg_dimensions.width)\r\n\t\t\t\t .attr(\"height\", svg_dimensions.height);\r\n\r\n\tsvg.append(\"rect\")\r\n\t\t.attr(\"width\", \"100%\")\r\n\t\t.attr(\"height\", \"100%\")\r\n\t\t.attr(\"rx\", 6)\r\n\t\t.attr(\"ry\", 6)\r\n\t\t.attr(\"stroke\", \"darkgrey\")\r\n\t\t.attr(\"fill\", opts.background) // or none\r\n\t\t.attr(\"stroke-width\", 1);\r\n\r\n\tlet ped = svg.append(\"g\")\r\n\t\t\t .attr(\"class\", \"diagram\");\r\n\r\n\t// Phase 3.3.2: Indicateur visuel mode DEBUG\r\n\tif(opts.DEBUG) {\r\n\t\tsvg.append(\"rect\")\r\n\t\t\t.attr(\"x\", svg_dimensions.width - 120)\r\n\t\t\t.attr(\"y\", 5)\r\n\t\t\t.attr(\"width\", 110)\r\n\t\t\t.attr(\"height\", 25)\r\n\t\t\t.attr(\"fill\", \"#ff9800\")\r\n\t\t\t.attr(\"stroke\", \"#f57c00\")\r\n\t\t\t.attr(\"stroke-width\", 2)\r\n\t\t\t.attr(\"rx\", 3);\r\n\t\tsvg.append(\"text\")\r\n\t\t\t.attr(\"x\", svg_dimensions.width - 65)\r\n\t\t\t.attr(\"y\", 22)\r\n\t\t\t.attr(\"text-anchor\", \"middle\")\r\n\t\t\t.attr(\"fill\", \"white\")\r\n\t\t\t.attr(\"font-weight\", \"bold\")\r\n\t\t\t.attr(\"font-size\", \"12px\")\r\n\t\t\t.text(\"DEBUG MODE\");\r\n\t}\r\n\r\n\tlet top_level = $.map(opts.dataset, function(val, _i){return 'top_level' in val && val.top_level ? val : null;});\r\n\tlet hidden_root = {\r\n\t\tname : 'hidden_root',\r\n\t\tid : 0,\r\n\t\thidden : true,\r\n\t\tchildren : top_level\r\n\t};\r\n\r\n\tlet partners = utils.buildTree(opts, hidden_root, hidden_root)[0];\r\n\tlet root = d3.hierarchy(hidden_root);\r\n\troot._dataset = opts.dataset;\r\n\tutils.roots[opts.targetDiv] = root;\r\n\r\n\t// / get score at each depth used to adjust node separation\r\n\tlet tree_dimensions = utils.get_tree_dimensions(opts);\r\n\tif(opts.DEBUG)\r\n\t\tconsole.log('opts.width='+svg_dimensions.width+' width='+tree_dimensions.width+\r\n\t\t\t\t\t' opts.height='+svg_dimensions.height+' height='+tree_dimensions.height);\r\n\r\n\tlet treemap = d3.tree().separation(function(a, b) {\r\n\t\treturn a.parent === b.parent || a.data.hidden || b.data.hidden ? 1.2 : 2.2;\r\n\t}).size([tree_dimensions.width, tree_dimensions.height]);\r\n\r\n\tlet nodes = treemap(root.sort(function(a, b) { return a.data.id - b.data.id; }));\r\n\tlet flattenNodes = nodes.descendants();\r\n\r\n\t// check the number of visible nodes equals the size of the pedigree dataset\r\n\tlet vis_nodes = $.map(opts.dataset, function(p, _i){return p.hidden ? null : p;});\r\n\tif(vis_nodes.length !== opts.dataset.length) {\r\n\t\tthrow utils.create_err('NUMBER OF VISIBLE NODES DIFFERENT TO NUMBER IN THE DATASET');\r\n\t}\r\n\r\n\tutils.adjust_coords(opts, nodes, flattenNodes);\r\n\r\n\tlet ptrLinkNodes = utils.linkNodes(flattenNodes, partners);\r\n\tlet clashes = check_ptr_links(opts, ptrLinkNodes);   // check for crossing of partner lines (Phase 3.1.2)\r\n\r\n\tlet node = ped.selectAll(\".node\")\r\n\t\t\t\t  .data(nodes.descendants())\r\n\t\t\t\t  .enter()\r\n\t\t\t\t  .append(\"g\")\r\n\t\t\t\t\t.attr(\"transform\", function(d, _i) {\r\n\t\t\t\t\t\treturn \"translate(\" + d.x + \",\" + d.y + \")\";\r\n\t\t\t\t\t});\r\n\r\n\t// provide a border to the node\r\n\tnode.filter(function (d) {return !d.data.hidden;})\r\n\t\t.append(\"path\")\r\n\t\t.attr(\"shape-rendering\", \"geometricPrecision\")\r\n\t\t.attr(\"transform\", function(d) {return !has_gender(d.data.sex) && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\r\n\t\t.attr(\"d\", d3.symbol().size(function(_d) { return (opts.symbol_size * opts.symbol_size) + 2;})\r\n\t\t\t\t.type(function(d) {\r\n\t\t\t\t\tif(d.data.miscarriage || d.data.termination)\r\n\t\t\t\t\t\treturn d3.symbolTriangle;\r\n\t\t\t\t\treturn d.data.sex === \"F\" ? d3.symbolCircle : d3.symbolSquare;}))\r\n\t\t.attr(\"stroke\", function (d) {\r\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\r\n\t\t})\r\n\t\t.attr(\"stroke-width\", function (d) {\r\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \".3em\" : \".1em\";\r\n\t\t})\r\n\t\t.attr(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\r\n\t\t.attr(\"fill\", \"none\");\r\n\r\n\t// set a clippath\r\n\tnode.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);})\r\n\t\t.append(\"clipPath\")\r\n\t\t.attr(\"id\", function (d) {return d.data.name;}).append(\"path\")\r\n\t\t.attr(\"class\", \"node\")\r\n\t\t.attr(\"transform\", function(d) {return !has_gender(d.data.sex) && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\r\n\t\t.attr(\"d\", d3.symbol().size(function(d) {\r\n\t\t\t\tif (d.data.hidden)\r\n\t\t\t\t\treturn opts.symbol_size * opts.symbol_size / 5;\r\n\t\t\t\treturn opts.symbol_size * opts.symbol_size;\r\n\t\t\t})\r\n\t\t\t.type(function(d) {\r\n\t\t\t\tif(d.data.miscarriage || d.data.termination)\r\n\t\t\t\t\treturn d3.symbolTriangle;\r\n\t\t\t\treturn d.data.sex === \"F\" ? d3.symbolCircle :d3.symbolSquare;}));\r\n\r\n\t// pie plots for disease colours\r\n\tlet pienode = node.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);}).selectAll(\"pienode\")\r\n\t   .data(function(d) {\t \t\t// set the disease data for the pie plot\r\n\t\t   let ncancers = 0;\r\n\t\t   let cancers = $.map(opts.diseases, function(_val, i){\r\n\t\t\t   if(utils.prefixInObj(opts.diseases[i].type, d.data)) {ncancers++; return 1;} else return 0;\r\n\t\t   });\r\n\t\t   if(ncancers === 0) cancers = [1];\r\n\t\t   return [$.map(cancers, function(val, _i){\r\n\t\t\t   return {'cancer': val, 'ncancers': ncancers, 'id': d.data.name,\r\n\t\t\t\t\t\t'sex': d.data.sex, 'proband': d.data.proband, 'hidden': d.data.hidden,\r\n\t\t\t\t\t\t'affected': d.data.affected,\r\n\t\t\t\t\t\t'exclude': d.data.exclude};})];\r\n\t   })\r\n\t   .enter()\r\n\t\t.append(\"g\");\r\n\r\n\tpienode.selectAll(\"path\")\r\n\t\t.data(d3.pie().value(function(d) {return d.cancer;}))\r\n\t\t.enter().append(\"path\")\r\n\t\t\t.attr(\"clip-path\", function(d) {return \"url(#\"+d.data.id+\")\";}) // clip the rectangle\r\n\t\t\t.attr(\"class\", \"pienode\")\r\n\t\t\t.attr(\"d\", d3.arc().innerRadius(0).outerRadius(opts.symbol_size))\r\n\t\t\t.attr(\"fill\", function(d, i) {\r\n\t\t\t\tif(d.data.exclude)\r\n\t\t\t\t\treturn 'lightgrey';\r\n\t\t\t\tif(d.data.ncancers === 0) {\r\n\t\t\t\t\tif(d.data.affected)\r\n\t\t\t\t\t\treturn 'darkgrey';\r\n\t\t\t\t\treturn opts.node_background;\r\n\t\t\t\t}\r\n\t\t\t\treturn opts.diseases[i].colour;\r\n\t\t\t});\r\n\r\n\t// adopted in/out brackets\r\n\tnode.filter(function (d) {return !d.data.hidden && (d.data.adopted_in || d.data.adopted_out);})\r\n\t\t.append(\"path\")\r\n\t\t.attr(\"d\", function(_d) {\r\n\t\t\tlet dx = -(opts.symbol_size * 0.66);\r\n\t\t\tlet dy = -(opts.symbol_size * 0.64);\r\n\t\t\tlet indent = opts.symbol_size/4;\r\n\t\t\treturn get_bracket(dx, dy, indent, opts)+get_bracket(-dx, dy, -indent, opts);\r\n\t\t\t})\r\n\t\t.attr(\"stroke\", function (d) {\r\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\r\n\t\t})\r\n\t\t.attr(\"stroke-width\", function (_d) {\r\n\t\t\treturn \".1em\";\r\n\t\t})\r\n\t\t.attr(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\r\n\t\t.attr(\"fill\", \"none\");\r\n\r\n\r\n\t// alive status = 0; dead status = 1\r\n\tnode.filter(function (d) {return d.data.status === \"1\" || d.data.status === 1;})\r\n\t\t.append('line')\r\n\t\t\t.attr(\"stroke\", \"black\")\r\n\t\t\t.attr(\"x1\", function(_d, _i) {return -0.6*opts.symbol_size;})\r\n\t\t\t.attr(\"y1\", function(_d, _i) {return 0.6*opts.symbol_size;})\r\n\t\t\t.attr(\"x2\", function(_d, _i) {return 0.6*opts.symbol_size;})\r\n\t\t\t.attr(\"y2\", function(_d, _i) {return -0.6*opts.symbol_size;});\r\n\r\n/*\r\n * let warn = node.filter(function (d) { return (!d.data.age || !d.data.yob) && !d.data.hidden; }).append(\"text\") .attr('font-family', 'FontAwesome')\r\n * .attr(\"x\", \".25em\") .attr(\"y\", -(0.4 * opts.symbol_size), -(0.2 * opts.symbol_size)) .html(\"\\uf071\"); warn.append(\"svg:title\").text(\"incomplete\");\r\n */\r\n\t// add display names and labels defined by opts.labels\r\n\taddLabels(opts, node);\r\n\r\n\t//\r\n\tif(opts.showWidgets) addWidgets(opts, node);\r\n\r\n\t// links between partners\r\n\tlet clash_depth = {};\r\n\r\n\t// get path looping over node(s)\r\n\tlet draw_path = function(clash, dx, dy1, dy2, parent_node, cshift) {\r\n\t\tlet extend = function(i, l) {\r\n\t\t\tif(i+1 < l)   // && Math.abs(clash[i] - clash[i+1]) < (opts.symbol_size*1.25)\r\n\t\t\t\treturn extend(++i);\r\n\t\t\treturn i;\r\n\t\t};\r\n\t\tlet path = \"\";\r\n\t\tfor(let j=0; j<clash.length; j++) {\r\n\t\t\tlet k = extend(j, clash.length);\r\n\t\t\tlet dx1 = clash[j] - dx - cshift;\r\n\t\t\tlet dx2 = clash[k] + dx + cshift;\r\n\t\t\tif(parent_node.x > dx1 && parent_node.x < dx2)\r\n\t\t\t\tparent_node.y = dy2;\r\n\r\n\t\t\tpath += \"L\" + dx1 + \",\" +  (dy1 - cshift) +\r\n\t\t\t\t\t\"L\" + dx1 + \",\" +  (dy2 - cshift) +\r\n\t\t\t\t\t\"L\" + dx2 + \",\" +  (dy2 - cshift) +\r\n\t\t\t\t\t\"L\" + dx2 + \",\" +  (dy1 - cshift);\r\n\t\t\tj = k;\r\n\t\t}\r\n\t\treturn path;\r\n\t}\r\n\r\n\r\n\tpartners = ped.selectAll(\".partner\")\r\n\t\t.data(ptrLinkNodes)\r\n\t\t.enter()\r\n\t\t\t.insert(\"path\", \"g\")\r\n\t\t\t.attr(\"fill\", \"none\")\r\n\t\t\t.attr(\"stroke\", \"#000\")\r\n\t\t\t.attr(\"shape-rendering\", \"auto\")\r\n\t\t\t.attr('d', function(d, _i) {\r\n\t\t\t\tlet node1 = utils.getNodeByName(flattenNodes, d.mother.data.name);\r\n\t\t\t\tlet node2 = utils.getNodeByName(flattenNodes, d.father.data.name);\r\n\t\t\t\tlet consanguity = utils.consanguity(node1, node2, opts);\r\n\t\t\t\tlet divorced = (d.mother.data.divorced &&  d.mother.data.divorced === d.father.data.name);\r\n\r\n\t\t\t\tlet x1 = (d.mother.x < d.father.x ? d.mother.x : d.father.x);\r\n\t\t\t\tlet x2 = (d.mother.x < d.father.x ? d.father.x : d.mother.x);\r\n\t\t\t\tlet dy1 = d.mother.y;\r\n\t\t\t\tlet dy2, dx, parent_node;\r\n\r\n\t\t\t\t// identify clashes with other nodes at the same depth\r\n\t\t\t\tlet clash = check_ptr_link_clashes(opts, d);\r\n\t\t\t\tlet path = \"\";\r\n\t\t\t\tif(clash) {\r\n\t\t\t\t\tif(d.mother.depth in clash_depth)\r\n\t\t\t\t\t\tclash_depth[d.mother.depth] += 4;\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tclash_depth[d.mother.depth] = 4;\r\n\r\n\t\t\t\t\tdy1 -= clash_depth[d.mother.depth];\r\n\t\t\t\t\tdx = clash_depth[d.mother.depth] + (opts.symbol_size/2) + 2;\r\n\r\n\t\t\t\t\tlet parent_nodes = d.mother.data.parent_node;\r\n\t\t\t\t\tlet parent_node_name = parent_nodes[0];\r\n\t\t\t\t\tfor(let ii=0; ii<parent_nodes.length; ii++) {\r\n\t\t\t\t\t\tif(parent_nodes[ii].father.name === d.father.data.name &&\r\n\t\t\t\t\t\t   parent_nodes[ii].mother.name === d.mother.data.name)\r\n\t\t\t\t\t\t\tparent_node_name = parent_nodes[ii].name;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tparent_node = utils.getNodeByName(flattenNodes, parent_node_name);\r\n\t\t\t\t\tparent_node.y = dy1; // adjust hgt of parent node\r\n\t\t\t\t\tclash.sort(function (a,b) {return a - b;});\r\n\r\n\t\t\t\t\tdy2 = (dy1-(opts.symbol_size/2)-3);\r\n\t\t\t\t\tpath = draw_path(clash, dx, dy1, dy2, parent_node, 0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet divorce_path = \"\";\r\n\t\t\t\tif(divorced && !clash)\r\n\t\t\t\t\tdivorce_path = \"M\" + (x1+((x2-x1)*.66)+6) + \",\" + (dy1-6) +\r\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-6) + \",\" + (dy1+6) +\r\n\t\t\t\t\t\t\t\t   \"M\" + (x1+((x2-x1)*.66)+10) + \",\" + (dy1-6) +\r\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-2)  + \",\" + (dy1+6);\r\n\t\t\t\tif(consanguity) {  // consanguinous, draw double line between partners\r\n\t\t\t\t\tdy1 = (d.mother.x < d.father.x ? d.mother.y : d.father.y);\r\n\t\t\t\t\tdy2 = (d.mother.x < d.father.x ? d.father.y : d.mother.y);\r\n\r\n\t\t\t\t\tlet cshift = 3;\r\n\t\t\t\t\tif(Math.abs(dy1-dy2) > 0.1) {\t  // DIFFERENT LEVEL\r\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + \"L\" + x2 + \",\" + dy2 +\r\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + \"L\" + x2 + \",\" + (dy2 - cshift);\r\n\t\t\t\t\t} else {\t\t\t\t\t\t   // SAME LEVEL\r\n\t\t\t\t\t\tlet path2 = (clash ? draw_path(clash, dx, dy1, dy2, parent_node, cshift) : \"\");\r\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 +\r\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + path2 + \"L\" + x2 + \",\" + (dy1 - cshift) + divorce_path;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 + divorce_path;\r\n\t\t\t});\r\n\r\n\t// Phase 3.1.2 - Appliquer feedback visuel aux liens qui clashent\r\n\tif(clashes.length > 0) {\r\n\t\tpartners.each(function(d) {\r\n\t\t\t// Vérifier si ce lien a un clash\r\n\t\t\tlet hasClash = clashes.some(c =>\r\n\t\t\t\t(c.node.mother.data.name === d.mother.data.name &&\r\n\t\t\t\t c.node.father.data.name === d.father.data.name)\r\n\t\t\t);\r\n\r\n\t\t\tif(hasClash) {\r\n\t\t\t\td3.select(this)\r\n\t\t\t\t\t.attr('stroke', '#D5494A')  // Rouge\r\n\t\t\t\t\t.attr('stroke-width', 2.5)\r\n\t\t\t\t\t.attr('stroke-dasharray', '5,5')\r\n\t\t\t\t\t.append('title')\r\n\t\t\t\t\t.text('⚠️ Avertissement : Ce lien croise d\\'autres liens de partenaires. Le tracé a été ajusté pour éviter les chevauchements.');\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// Ajouter un message d'avertissement global si clashes détectés\r\n\t\tif(!opts.DEBUG) {\r\n\t\t\t// Enlever l'ancien warning s'il existe\r\n\t\t\t$('#'+opts.targetDiv).parent().find('.pedigree-warning').remove();\r\n\t\t\t// Ajouter le nouveau warning\r\n\t\t\t$('#'+opts.targetDiv).parent().prepend(\r\n\t\t\t\t'<div class=\"pedigree-warning\" style=\"background:#FFF3CD;border:1px solid #FFC107;padding:10px;margin-bottom:10px;border-radius:4px;font-size:14px;\">' +\r\n\t\t\t\t'<strong>⚠️ Avertissement :</strong> ' + clashes.length +\r\n\t\t\t\t' lien(s) de partenaires se croisent. Les liens en <span style=\"color:#D5494A;font-weight:bold;\">rouge pointillé</span> ont été ajustés pour éviter les chevauchements.' +\r\n\t\t\t\t'</div>'\r\n\t\t\t);\r\n\t\t}\r\n\t} else {\r\n\t\t// Pas de clashes, enlever le warning s'il existe\r\n\t\t$('#'+opts.targetDiv).parent().find('.pedigree-warning').remove();\r\n\t}\r\n\r\n\t// links to children\r\n\tped.selectAll(\".link\")\r\n\t\t.data(root.links(nodes.descendants()))\r\n\t\t.enter()\r\n\t\t\t.filter(function (d) {\r\n\t\t\t\t// filter unless debug is set\r\n\t\t\t\treturn (opts.DEBUG ||\r\n\t\t\t\t\t\t(d.target.data.noparents === undefined && d.source.parent !== null && !d.target.data.hidden));\r\n\t\t\t})\r\n\t\t\t.insert(\"path\", \"g\")\r\n\t\t\t.attr(\"fill\", \"none\")\r\n\t\t\t.attr(\"stroke-width\", function(d, _i) {\r\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\r\n\t\t\t\t\treturn 1;\r\n\t\t\t\treturn (opts.DEBUG ? 2 : 1);\r\n\t\t\t})\r\n\t\t\t.attr(\"stroke\", function(d, _i) {\r\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\r\n\t\t\t\t\treturn 'pink';\r\n\t\t\t\treturn \"#000\";\r\n\t\t\t})\r\n\t\t\t.attr(\"stroke-dasharray\", function(d, _i) {\r\n\t\t\t\tif(!d.target.data.adopted_in) return null;\r\n\t\t\t\tlet dash_len = Math.abs(d.source.y-((d.source.y + d.target.y) / 2));\r\n\t\t\t\tlet dash_array = [dash_len, 0, Math.abs(d.source.x-d.target.x), 0];\r\n\t\t\t\tlet twins = utils.getTwins(opts.dataset, d.target.data);\r\n\t\t\t\tif(twins.length >= 1) dash_len = dash_len * 3;\r\n\t\t\t\tfor(let usedlen = 0; usedlen < dash_len; usedlen += 10)\r\n\t\t\t\t\t$.merge(dash_array, [5, 5]);\r\n\t\t\t\treturn dash_array;\r\n\t\t\t})\r\n\t\t\t.attr(\"shape-rendering\", function(d, _i) {\r\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin)\r\n\t\t\t\t\treturn \"geometricPrecision\";\r\n\t\t\t\treturn \"auto\";\r\n\t\t\t})\r\n\t\t\t.attr(\"d\", function(d, _i) {\r\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin) {\r\n\t\t\t\t\t// get twin position\r\n\t\t\t\t\tlet twins = utils.getTwins(opts.dataset, d.target.data);\r\n\t\t\t\t\tif(twins.length >= 1) {\r\n\t\t\t\t\t\tlet twinx = 0;\r\n\t\t\t\t\t\tlet xmin = d.target.x;\r\n\t\t\t\t\t\t//let xmax = d.target.x;\r\n\t\t\t\t\t\tfor(let t=0; t<twins.length; t++) {\r\n\t\t\t\t\t\t\tlet thisx = utils.getNodeByName(flattenNodes, twins[t].name).x;\r\n\t\t\t\t\t\t\tif(xmin > thisx) xmin = thisx;\r\n\t\t\t\t\t\t\t//if(xmax < thisx) xmax = thisx;\r\n\t\t\t\t\t\t\ttwinx += thisx;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tlet xmid = ((d.target.x + twinx) / (twins.length+1));\r\n\t\t\t\t\t\tlet ymid = ((d.source.y + d.target.y) / 2);\r\n\r\n\t\t\t\t\t\tlet xhbar = \"\";\r\n\t\t\t\t\t\tif(xmin === d.target.x && d.target.data.mztwin) {\r\n\t\t\t\t\t\t\t// horizontal bar for mztwins\r\n\t\t\t\t\t\t\tlet xx = (xmid + d.target.x)/2;\r\n\t\t\t\t\t\t\tlet yy = (ymid + (d.target.y-(opts.symbol_size/2)))/2;\r\n\t\t\t\t\t\t\txhbar = \"M\" + xx + \",\" + yy +\r\n\t\t\t\t\t\t\t\t\t\"L\" + (xmid + (xmid-xx)) + \" \" + yy;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\r\n\t\t\t\t\t\t\t   \"V\" + ymid +\r\n\t\t\t\t\t\t\t   \"H\" + xmid +\r\n\t\t\t\t\t\t\t   \"L\" + (d.target.x) + \" \" + (d.target.y-(opts.symbol_size/2)) +\r\n\t\t\t\t\t\t\t   xhbar;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\tif(d.source.data.mother && d.source.data.father) {   // check parents depth to see if they are at the same level in the tree\r\n\t\t\t\tlet motherName = typeof d.source.data.mother === 'string' ? d.source.data.mother : d.source.data.mother.name;\r\n\t\t\t\tlet fatherName = typeof d.source.data.father === 'string' ? d.source.data.father : d.source.data.father.name;\r\n\t\t\t\tif(motherName && fatherName) {\r\n\t\t\t\t\tlet ma = utils.getNodeByName(flattenNodes, motherName);\r\n\t\t\t\t\tlet pa = utils.getNodeByName(flattenNodes, fatherName);\r\n\r\n\t\t\t\t\tif(ma && pa && ma.depth !== pa.depth) {\r\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + ((ma.y + pa.y) / 2) +\r\n\t\t\t\t\t\t   \"H\" + (d.target.x) +\r\n\t\t\t\t\t\t   \"V\" + (d.target.y);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\r\n\t\t\t\t\t   \"V\" + ((d.source.y + d.target.y) / 2) +\r\n\t\t\t\t\t   \"H\" + (d.target.x) +\r\n\t\t\t\t\t   \"V\" + (d.target.y);\r\n\t\t\t});\r\n\r\n\t// draw proband arrow\r\n\tlet probandIdx  = utils.getProbandIndex(opts.dataset);\r\n\tif(typeof probandIdx !== 'undefined') {\r\n\t\tlet probandNode = utils.getNodeByName(flattenNodes, opts.dataset[probandIdx].name);\r\n\t\tlet triid = \"triangle\"+utils.makeid(3);\r\n\t\tped.append(\"svg:defs\").append(\"svg:marker\")\t// arrow head\r\n\t\t\t.attr(\"id\", triid)\r\n\t\t\t.attr(\"refX\", 6)\r\n\t\t\t.attr(\"refY\", 6)\r\n\t\t\t.attr(\"markerWidth\", 20)\r\n\t\t\t.attr(\"markerHeight\", 20)\r\n\t\t\t.attr(\"orient\", \"auto\")\r\n\t\t\t.append(\"path\")\r\n\t\t\t.attr(\"d\", \"M 0 0 12 6 0 12 3 6\")\r\n\t\t\t.attr(\"fill\", \"black\");\r\n\r\n\t\tped.append(\"line\")\r\n\t\t\t.attr(\"x1\", probandNode.x-(opts.symbol_size/0.7))\r\n\t\t\t.attr(\"y1\", probandNode.y+(opts.symbol_size/1.4))\r\n\t\t\t.attr(\"x2\", probandNode.x-(opts.symbol_size/1.4))\r\n\t\t\t.attr(\"y2\", probandNode.y+(opts.symbol_size/4))\r\n\t\t\t.attr(\"stroke-width\", 1)\r\n\t\t\t.attr(\"stroke\", \"black\")\r\n\t\t\t.attr(\"marker-end\", \"url(#\"+triid+\")\");\r\n\t}\r\n\r\n\t// drag and zoom\r\n\tinit_zoom(opts, svg);\r\n\t// drag nodes\r\n\tif(opts.dragNode) init_dragging(opts, node);\r\n\treturn opts;\r\n}\r\n\r\nfunction has_gender(sex) {\r\n\treturn sex === \"M\" || sex === \"F\";\r\n}\r\n\r\n//adopted in/out brackets\r\nfunction get_bracket(dx, dy, indent, opts) {\r\n\treturn \t\"M\" + (dx+indent) + \",\" + dy +\r\n\t\t\t\"L\" + dx + \" \" + dy +\r\n\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\r\n\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\r\n\t\t\t\"L\" + (dx+indent) + \",\" + (dy+(opts.symbol_size *  1.28))\r\n}\r\n\r\n// check for crossing of partner lines\r\n// Phase 3.1.2 - Modifié pour retourner les clashes pour feedback visuel\r\nfunction check_ptr_links(opts, ptrLinkNodes){\r\n\tlet clashes = [];\r\n\tfor(let a=0; a<ptrLinkNodes.length; a++) {\r\n\t\tlet clash = check_ptr_link_clashes(opts, ptrLinkNodes[a]);\r\n\t\tif(clash) {\r\n\t\t\tclashes.push({node: ptrLinkNodes[a], clash: clash});\r\n\t\t\tif(opts.DEBUG)\r\n\t\t\t\tconsole.log(\"CLASH :: \"+ptrLinkNodes[a].mother.data.name+\" \"+ptrLinkNodes[a].father.data.name, clash);\r\n\t\t}\r\n\t}\r\n\treturn clashes;\r\n}\r\n\r\nexport function check_ptr_link_clashes(opts, anode) {\r\n\tlet root = utils.roots[opts.targetDiv];\r\n\tlet flattenNodes = utils.flatten(root);\r\n\tlet mother, father;\r\n\tif('name' in anode) {\r\n\t\tanode = utils.getNodeByName(flattenNodes, anode.name);\r\n\t\tif(!anode || !('mother' in anode.data))\r\n\t\t\treturn null;\r\n\t\tlet motherName = (typeof anode.data.mother === 'string' ? anode.data.mother : anode.data.mother?.name);\r\n\t\tlet fatherName = (typeof anode.data.father === 'string' ? anode.data.father : anode.data.father?.name);\r\n\t\tif(!motherName || !fatherName)\r\n\t\t\treturn null;\r\n\t\tmother = utils.getNodeByName(flattenNodes, motherName);\r\n\t\tfather = utils.getNodeByName(flattenNodes, fatherName);\r\n\t} else {\r\n\t\tmother = anode.mother;\r\n\t\tfather = anode.father;\r\n\t}\r\n\tif(!mother || !father)\r\n\t\treturn null;\r\n\tif(mother.data === undefined || father.data === undefined) {\r\n\t\tmother = utils.getNodeByName(flattenNodes, mother.name || mother.data?.name);\r\n\t\tfather = utils.getNodeByName(flattenNodes, father.name || father.data?.name);\r\n\t}\r\n\tif(!mother || !father || mother.x === undefined || father.x === undefined)\r\n\t\treturn null;\r\n\r\n\tlet x1 = (mother.x < father.x ? mother.x : father.x);\r\n\tlet x2 = (mother.x < father.x ? father.x : mother.x);\r\n\tlet dy = mother.y;\r\n\r\n\t// identify clashes with other nodes at the same depth\r\n\tlet clash = $.map(flattenNodes, function(bnode, _i){\r\n\t\treturn !bnode.data.hidden &&\r\n\t\t\t\tbnode.data.name !== mother.data.name &&  bnode.data.name !== father.data.name &&\r\n\t\t\t\tbnode.y === dy && bnode.x > x1 && bnode.x < x2 ? bnode.x : null;\r\n\t});\r\n\treturn clash.length > 0 ? clash : null;\r\n}\r\n\r\n// group top_level nodes by their partners\r\nfunction group_top_level(dataset) {\r\n\t// let top_level = $.map(dataset, function(val, i){return 'top_level' in val && val.top_level ? val : null;});\r\n\t// calculate top_level nodes\r\n\tfor(let i=0;i<dataset.length;i++) {\r\n\t\tif(utils.getDepth(dataset, dataset[i].name) === 2)\r\n\t\t\tdataset[i].top_level = true;\r\n\t}\r\n\r\n\tlet top_level = [];\r\n\tlet top_level_seen = [];\r\n\tfor(let i=0;i<dataset.length;i++) {\r\n\t\tlet node = dataset[i];\r\n\t\tif('top_level' in node && $.inArray(node.name, top_level_seen) === -1){\r\n\t\t\ttop_level_seen.push(node.name);\r\n\t\t\ttop_level.push(node);\r\n\t\t\tlet ptrs = utils.get_partners(dataset, node);\r\n\t\t\tfor(let j=0; j<ptrs.length; j++){\r\n\t\t\t\tif($.inArray(ptrs[j], top_level_seen) === -1) {\r\n\t\t\t\t\ttop_level_seen.push(ptrs[j]);\r\n\t\t\t\t\ttop_level.push(utils.getNodeByName(dataset, ptrs[j]));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tlet newdataset = $.map(dataset, function(val, _i){return 'top_level' in val && val.top_level ? null : val;});\r\n\tfor (let i = top_level.length; i > 0; --i)\r\n\t\tnewdataset.unshift(top_level[i-1]);\r\n\treturn newdataset;\r\n}\r\n\r\n/**\r\n * Rebuild the pedigree diagram from scratch\r\n * Clears the target div, reinitializes the cache, and rebuilds the entire pedigree.\r\n * This function is called when the dataset changes or when user interactions require a full redraw.\r\n * @param {Object} opts - The same options object used in build()\r\n * @throws {Error} If build fails\r\n * @see build\r\n * @example\r\n * pedigreejs.rebuild(opts);\r\n */\r\nexport function rebuild(opts) {\r\n\t$(\"#\"+opts.targetDiv).empty();\r\n\tpedcache.init_cache(opts);\r\n\ttry {\r\n\t\tbuild(opts);\r\n\t} catch(e) {\r\n\t\tconsole.error(e);\r\n\t\tthrow e;\r\n\t}\r\n\r\n\ttry {\r\n\t\ttemplates.update(opts);\t\t// eslint-disable-line no-undef\r\n\t} catch(e) {\r\n\t\t// templates not declared\r\n\t}\r\n}\r\n\r\n$(document).on('rebuild', function(_e, opts){\r\n\t// Protection contre les race conditions (Phase 3.1.1)\r\n\tif (_isBuilding) {\r\n\t\tif(opts && opts.DEBUG) {\r\n\t\t\tconsole.log('Rebuild ignored: build already in progress');\r\n\t\t}\r\n\t\treturn;\r\n\t}\r\n\r\n\t_isBuilding = true;\r\n\ttry {\r\n\t\trebuild(opts);\r\n\t} finally {\r\n\t\t_isBuilding = false;\r\n\t}\r\n})\r\n\r\n$(document).on('build', function(_e, opts){\r\n\t// Protection contre les race conditions (Phase 3.1.1)\r\n\tif (_isBuilding) {\r\n\t\tif(opts && opts.DEBUG) {\r\n\t\t\tconsole.log('Build ignored: build already in progress');\r\n\t\t}\r\n\t\treturn;\r\n\t}\r\n\r\n\t_isBuilding = true;\r\n\ttry {\r\n\t\tbuild(opts);\r\n\t} finally {\r\n\t\t_isBuilding = false;\r\n\t}\r\n})\r\n","/**\r\n/* Functions used by 3rd party apps\r\n/*\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\nimport {copy_dataset, getNodeByName, getProbandIndex} from './utils.js';\r\nimport {rebuild} from './pedigree.js';\r\nimport {delete_node_dataset} from './widgets.js';\r\nimport {addchild} from './widgets.js';\r\nimport {syncTwins} from './twins.js';\r\nimport * as pedcache from './pedcache.js';\r\n\r\n\r\n// Set or remove node attributes.\r\n// If a value is not provided the attribute is removed.\r\n// 'key' can be a list of keys or a single key.\r\nexport function node_attr(opts, name, keys, value){\r\n\tlet newdataset = copy_dataset(pedcache.current(opts));\r\n\tlet node = getNodeByName(newdataset, name);\r\n\tif(!node){\r\n\t\tconsole.warn(\"No person defined\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tif(!Array.isArray(keys)) {\r\n\t\tkeys = [keys];\r\n\t}\r\n\r\n\tif(value) {\r\n\t\tfor(let i=0; i<keys.length; i++) {\r\n\t\t\tlet k = keys[i];\r\n\t\t\t//console.log('VALUE PROVIDED', k, value, (k in node));\r\n\t\t\tif(k in node && keys.length === 1) {\r\n\t\t\t\tif(node[k] === value)\r\n\t\t\t\t\treturn;\r\n\t\t\t\ttry {\r\n\t\t\t\t   if(JSON.stringify(node[k]) === JSON.stringify(value))\r\n\t\t\t\t\t   return;\r\n\t\t\t\t} catch(e){\r\n\t\t\t\t\t// continue regardless of error\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tnode[k] = value;\r\n\t\t}\r\n\t} else {\r\n\t\tlet found = false;\r\n\t\tfor(let i=0; i<keys.length; i++) {\r\n\t\t\tlet k = keys[i];\r\n\t\t\t//console.log('NO VALUE PROVIDED', k, (k in node));\r\n\t\t\tif(k in node) {\r\n\t\t\t\tdelete node[k];\r\n\t\t\t\tfound = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(!found)\r\n\t\t\treturn;\r\n\t}\r\n\tsyncTwins(newdataset, node);\r\n\topts.dataset = newdataset;\r\n\trebuild(opts);\r\n}\r\n\r\n// Set or remove proband attributes.\r\n// If a value is not provided the attribute is removed from the proband.\r\n// 'key' can be a list of keys or a single key.\r\nexport function proband_attr(opts, keys, value){\r\n\tlet proband = opts.dataset[ getProbandIndex(opts.dataset) ];\r\n\tnode_attr(opts, proband.name, keys, value);\r\n}\r\n\r\n// add a child to the proband; giveb sex, age, yob and breastfeeding months (optional)\r\nexport function proband_add_child(opts, sex, age, yob, breastfeeding){\r\n\tlet newdataset = copy_dataset(pedcache.current(opts));\r\n\tlet proband = newdataset[ getProbandIndex(newdataset) ];\r\n\tif(!proband){\r\n\t\tconsole.warn(\"No proband defined\");\r\n\t\treturn;\r\n\t}\r\n\tlet newchild = addchild(newdataset, proband, sex, 1)[0];\r\n\tnewchild.age = age;\r\n\tnewchild.yob = yob;\r\n\tif(breastfeeding !== undefined)\r\n\t\tnewchild.breastfeeding = breastfeeding;\r\n\topts.dataset = newdataset;\r\n\trebuild(opts);\r\n\treturn newchild.name;\r\n}\r\n\r\n// delete node using the name\r\nexport function delete_node_by_name(opts, name){\r\n\tfunction onDone(opts, dataset) {\r\n\t\t// assign new dataset and rebuild pedigree\r\n\t\topts.dataset = dataset;\r\n\t\trebuild(opts);\r\n\t}\r\n\tlet newdataset = copy_dataset(pedcache.current(opts));\r\n\tlet node = getNodeByName(pedcache.current(opts), name);\r\n\tif(!node){\r\n\t\tconsole.warn(\"No node defined\");\r\n\t\treturn;\r\n\t}\r\n\tdelete_node_dataset(newdataset, node, opts, onDone);\r\n}\r\n"],"names":["create_err","err","console","error","Error","validate_age_yob","age","yob","status","year","Date","getFullYear","sum","parseInt","Math","abs","validate_pedigree","opts","getIdxByName","arr","name","idx","$","each","i","p","validate","DEBUG","log","call","this","display_name","uniquenames","famids","dataset","length","hidden","mother","father","midx","fidx","sex","inArray","push","famid","join","uc","unconnected","warn","combineArrays","arr1","arr2","include_children","connected","get_partners","anode","ptrs","bnode","children","getAllChildren","person","map","_i","_child_idx","child","getNodeByName","nodes","data","target","proband","val","obj","attr","getProbandIndex","change","ii","nconnect","_idx","has_parent","noparents","names","canChangeSex","node","some","isIE","ua","navigator","userAgent","indexOf","isEdge","match","messages","title","msg","onConfirm","dialog","modal","width","buttons","Yes","No","text","click","errModalEl","document","getElementById","modalTitle","querySelector","modalBodyInput","removeClass","on","off","cancelBtn","hasClass","addClass","textContent","showDialog","print_opts","key","remove","append","undefined","is_fullscreen","fullscreenElement","mozFullScreenElement","webkitFullscreenElement","msFullscreenElement","get_svg_dimensions","window","innerWidth","height","innerHeight","get_tree_dimensions","getDepth","depth","top_level","svg_dimensions","maxscore","generation","score","max_depth","Object","keys","symbol_size","max_limit","dict_cache","serialize_dataset","JSON","stringify","e","cleanData","clean","Array","isArray","c","has_browser_storage","store_type","mod","localStorage","setItem","removeItem","get_prefix","btn_target","get_arr","get_browser_store","item","getItem","sessionStorage","set_browser_store","clear_pedigree_data","prefix","store","items","get_count","count","set_count","init_cache","shift","nstore","current","parse","previous","nst","next","clear","clear_browser_store","setposition","x","y","zoom","zoomName","getposition","pos","parseFloat","it","j","isProband","setProband","is_proband","exists","pedcache","getChildren","getTwins","sibs","getSiblings","twin_type","mztwin","getAllSiblings","getAdoptedSiblings","getNodesAtDepth","fnodes","exclude_names","sort","a","b","linkNodes","flattenNodes","partners","links","motherName","fatherName","motherNode","fatherNode","ancestors","recurse","consanguity","node1","node2","ancestors1","ancestors2","names1","ancestor","names2","_index","flatten","root","flat","forEach","_dataset","overlap","xnew","n","adjust_coords","xmid","descendants","diff","child1","child2","descendantsNames","descendant","nodesOverlap","updateParent","parent","id","parent_node","dztwins","twins","twin","setChildrenId","dztwin","makeid","len","possible","charAt","floor","random","buildTree","partnerLinks","_j","m","f","contains_parent","merge","ptr","gp","gmidx","gfidx","get_grandparents_idx","roots","copy_dataset","disallowed","newdataset","prefixInObj","found","k","_n","string","toUpperCase","slice","time","d","getHours","getMinutes","getSeconds","getMonth","getDate","results","RegExp","exec","location","href","zm","init_zoom","svg","xi","yi","d3","scaleExtent","zoomIn","zoomOut","filter","zoomSrc","type","button","transform","t","ped","select","targetDiv","zooming","xyk","zoomIdentity","scale","translate","btn_zoom","transition","duration","scaleBy","scale_to_fit","get_bounds","wid","xmax","xmin","hgt","ymax","ymin","get_dimensions","size","w","clientWidth","h","clientHeight","get_svg_size","max","get_pedigree_center","translateTo","setTimeout","scaleTo","Number","MAX_VALUE","sym","selectAll","g_elm","dg","getBBox","text_elements","_groups","txtsize","getTextSize","firstChild","nodeValue","font_family","font_size","getNodeSize","txt","font","fontSize","o","css","position","float","visibility","appendTo","s","addButtons","options","extend","btns","fa","disabled","lis","_e","local_dataset","trigger","exitFullscreen","msExitFullscreen","mozCancelFullScreen","webkitExitFullscreen","requestFullscreen","documentElement","mozRequestFullScreen","webkitRequestFullscreen","Element","ALLOW_KEYBOARD_INPUT","msRequestFullscreen","timeoutId","setInterval","clearInterval","stopPropagation","empty","reset","addPbuttonEvents","keep_proband_on_reset","selected","partner","daughter","son","cancers","breast_cancer","breast_cancer2","ovarian_cancer","prostate_cancer","pancreatic_cancer","genetic_test1","genetic_test2","genetic_test4","pathology_tests","RISK_FACTOR_STORE","hasInput","v","trim","isEmpty","myObj","prototype","hasOwnProperty","get_prs_values","prs","alpha","zscore","percent","getGeneticTest","version","readCanRisk","boadicea_lines","lines","split","hdr","regexp","gt","ncol","ln","ops","replace","delim","indi","cancer","diagnosis_age","ashkenazi","gene_test","result","path_test","localeCompare","get_mdensity","mdensity","test","get_pedigree","meta","isanon","ethnicity","isInteger","toString","excl","exclude","probandIdx","pedigree_util","menarche","get_risk_factor","parity","first_birth","oc_use","mht_use","bmi","alcohol","menopause","tl","endo","cmsg","risk_factor_name","store_name","pathname","el","pop","get_surgical_ops","breast_cancer_prs","ovarian_cancer_prs","prostate_cancer_prs","addIO","files","reader","FileReader","onload","load_data","onerror","utils","readAsText","value","load","content","save_file","save","print","get_printable_svg","svg_download","img_download","copyStylesInline","destinationNode","sourceNode","containerElements","destChildNodes","childNodes","srcChildNodes","cd","tagName","style","currentStyle","getComputedStyle","styleLength","childStyle","st","mySt","setProperty","getPropertyValue","resolution","img_type","deferred","svg2img","find","when","apply","done","arguments","grep","html","img","open","write","createElement","download","body","appendChild","removeChild","get_svg_as_data_url","svgCopy","get","cloneNode","svgStr","XMLSerializer","serializeToString","btoa","unescape","encodeURIComponent","deferred_name","defaults","iscanvg","Deferred","imgsrc","canvas","context","getContext","fillStyle","fillRect","drawImage","resolve","toDataURL","clearRect","src","promise","unique_urls","svg_html","matches","str","myRegexp","lastIndex","index","getMatches","quote","m1","m2","newval","svg_div","clone","a4","constructor","cssFiles","printWindow","headContent","close","focus","filename","file","Blob","msSaveOrOpenBlob","url","URL","createObjectURL","revokeObjectURL","canrisk_validation","risk_factors","readBoadiceaV4","canrisk_data","readCanRiskFile","to_process","process_ped","readLinkage","err1","message","acc_FamHist_ticked","acc_FamHist_Leave","RESULT","FLAG_FAMILY_MODAL","err3","err2","affected","alleles","unshift","_cancer","getLevel","updated","l","prt_lvl","level","fix_n_balance_levels","max_level","pidx","getPartnerIdx","update_parents_level","parents","ma","pa","svg_node","d3obj","setMzTwin","d1","d2","getUniqueTwinID","mz","splice","syncTwins","checkTwins","twin_types","updateStatus","update_ashkn","is","pedcache_current","switches","iswitch","update_cancer_by_sex","approx_diagnosis_age","substring","round5","checked","tres","hoxb13_result","valid","update_diagnosis_age_widget","prop","hide","show","ovarian_cancer_diagnosis_age","closest","prostate_cancer_diagnosis_age","x1","x2","round","sexInput","targetDivs","sexCanChange","getTreeNode","flat_tree","dataNode","addchild","nchild","ptr_name","twin_id","addsibling","newchildren","add_lhs","skip_parent_copy","newbie","addparents","tree_node","pid","ptr_node_meta","node_mother","node_father","node_sibs","rid","lid","sibNode","sid","faidx","moidx","tmpfa","orphans","nid","orphan_meta","oid","oidx","ptr_node","addpartner","partner_sex","child_sex","person_idx","partner_idx","child_idx","adjacent_nodes","excludes","lhs_node","rhs_node","dnodes","delete_node_dataset","onDone","deletes","d3node","ps","children_names","adj","idxToRemove","del","data_node","ancestorData","mIdx","fIdx","messagesFunc","newopts","dragging","last_mouseover","shiftKeyPressed","_widgetClickInProgress","addWidgets","popup_selection","square_title","circle_title","add_person","classed","datum","highlight","dragstart","dragstop","_d","setLineDragPosition","drag","sourceEvent","dx","dy","ynew","drag_handle","fx","fy","widgets","delete","styles","fill","edit","settings","widget","parentNode","opt","autoOpen","table","disableInp","label","capitaliseFirstLetter","diseases","disease_colour","colour","kk","openEditDialog","ctrlKey","nodeclick","xcoord","pointer","ycoord","y1","y2","wasPressed","shiftKey","addLabels","addLabel","emVal","getPx","validate_age_yob_data","ilab","labels","ypos","get_text","disease","dis","this_label","vars","ivar","r","node_has_label","y_offset","ftext","class_label","validate_fn","font_weight","init_dragging","xstart","event","indir","me","pnrName","isMovingRight","lft_node","rgt_node","adj_node","meNode","adjIdx","xlft","xrgt","el_move","old_index","new_index","_isBuilding","build","dragNode","showWidgets","background","node_background","VERBOSE","pbuttons","io","top_level_seen","group_top_level","hidden_root","hierarchy","tree_dimensions","tree","separation","treemap","ptrLinkNodes","clashes","clash","check_ptr_link_clashes","check_ptr_links","enter","has_gender","miscarriage","termination","symbol","symbolTriangle","symbolCircle","symbolSquare","pienode","ncancers","_val","pie","arc","innerRadius","outerRadius","adopted_in","adopted_out","indent","get_bracket","clash_depth","draw_path","dy1","dy2","cshift","path","dx1","dx2","insert","divorced","parent_nodes","parent_node_name","divorce_path","prepend","source","dash_len","dash_array","usedlen","twinx","thisx","ymid","xhbar","xx","yy","probandNode","triid","rebuild","templates","update","node_attr","breastfeeding","newchild"],"mappings":"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"}