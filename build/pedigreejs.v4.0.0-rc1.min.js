var pedigreejs=function(e){"use strict";function t(e){return console.error(e),new Error(e)}function a(e,t,a){let n=(new Date).getFullYear(),r=parseInt(e)+parseInt(t);return("1"===a||"0"===a)&&(("1"===a||Math.abs(n-r)<=2)&&n>=r)}function n(e){const a=(e,t)=>{let a=-1;return $.each(e,function(e,n){if(t===n.name)return a=e,a}),a};if(e.validate){if("function"==typeof e.validate)return e.DEBUG&&console.log("CALLING CONFIGURED VALIDATION FUNCTION"),e.validate.call(this,e);let n,r=[],i=[];for(let o=0;o<e.dataset.length;o++){if(!o.hidden&&(e.dataset[o].mother||e.dataset[o].father)){n=e.dataset[o].display_name,n||(n="unnamed"),n+=" (IndivID: "+e.dataset[o].name+")";let r=e.dataset[o].mother,i=e.dataset[o].father;if(!r||!i)throw t("Missing parent for "+n);let l=a(e.dataset,r),s=a(e.dataset,i);if(-1===l)throw t("The mother (IndivID: "+r+") of family member "+n+" is missing from the pedigree.");if(-1===s)throw t("The father (IndivID: "+i+") of family member "+n+" is missing from the pedigree.");if("F"!==e.dataset[l].sex)throw t("The mother of family member "+n+" is not specified as female. All mothers in the pedigree must have sex specified as 'F'.");if("M"!==e.dataset[s].sex)throw t("The father of family member "+n+" is not specified as male. All fathers in the pedigree must have sex specified as 'M'.")}if(!e.dataset[o].name)throw t(n+" has no IndivID.");if($.inArray(e.dataset[o].name,r)>-1)throw t("IndivID for family member "+n+" is not unique.");r.push(e.dataset[o].name),-1===$.inArray(e.dataset[o].famid,i)&&e.dataset[o].famid&&i.push(e.dataset[o].famid)}if(i.length>1)throw t("More than one family found: "+i.join(", ")+".");let l=o(e.dataset);l.length>0&&console.warn("individuals unconnected to pedigree ",l)}}function r(e,t){for(let a=0;a<t.length;a++)-1===$.inArray(t[a],e)&&e.push(t[a])}function i(e,t,a){const n=(e,t)=>{let a=[];for(let n=0;n<e.length;n++){let r=e[n];t.name===r.mother&&-1===$.inArray(r.father,a)?a.push(r.father):t.name===r.father&&-1===$.inArray(r.mother,a)&&a.push(r.mother)}return a};if(-1===$.inArray(t.name,e))return;r(e,n(a,t));let i=((e,t)=>$.map(e,function(e,a){return"noparents"in e||e.mother!==t.name&&e.father!==t.name?null:e}))(a,t);$.each(i,function(t,i){-1===$.inArray(i.name,e)&&(e.push(i.name),r(e,n(a,i)))})}function o(e){const t=(e,t)=>{for(let a=0;a<e.length;a++){if(e[a].data&&t===e[a].data.name)return e[a];if(t===e[a].name)return e[a]}},a=(e,t)=>{let a=[];for(let n=0;n<e.length;n++){let r=e[n];t.name===r.mother&&-1===$.inArray(r.father,a)?a.push(r.father):t.name===r.father&&-1===$.inArray(r.mother,a)&&a.push(r.mother)}return a};let n=e[(e=>{let t;return $.each(e,function(e,a){if(n=a,void 0!==$(n).attr("proband")&&!1!==$(n).attr("proband"))return t=e,t;var n}),t})(e)];if(!n){if(console.warn("No target defined"),0===e.length)throw new Error("empty pedigree data set");n=e[0]}let r=[n.name],o=!0,l=0;for(;o&&l<200;){l++;let s=r.length;$.each(e,function(o,l){if(-1!==$.inArray(l.name,r)){let i=a(e,l),o=l.name===n.name||!l.noparents;for(let a=0;a<i.length;a++)t(e,i[a]).noparents||(o=!0);o&&(l.mother&&-1===$.inArray(l.mother,r)&&r.push(l.mother),l.father&&-1===$.inArray(l.father,r)&&r.push(l.father))}else!l.noparents&&(l.mother&&-1!==$.inArray(l.mother,r)||l.father&&-1!==$.inArray(l.father,r))&&r.push(l.name);i(r,l,e)}),o=s!==r.length}let s=$.map(e,function(e,t){return e.name});return $.map(s,function(e,t){return-1===$.inArray(e,r)?e:null})}function l(e,t){if(!e||!t)return!0;if("U"===e.sex)return!0;return!t.some(t=>t.mother===e.name||t.father===e.name)||"U"===e.sex}var s=Object.freeze({__proto__:null,canChangeSex:l,create_err:t,unconnected:o,validate_age_yob:a,validate_pedigree:n});function d(){let e=navigator.userAgent;return e.indexOf("MSIE ")>-1||e.indexOf("Trident/")>-1}function c(){return navigator.userAgent.match(/Edge/g)}function u(e,t,a,n,r){try{a?$('<div id="msgDialog">'+t+"</div>").dialog({modal:!0,title:e,width:350,buttons:{Yes:function(){$(this).dialog("close"),a(n,r)},No:function(){$(this).dialog("close")}}}):$('<div id="msgDialog">'+t+"</div>").dialog({title:e,width:350,buttons:[{text:"OK",click:function(){$(this).dialog("close")}}]})}catch(i){!function(e,t,a,n,r){const i=document.getElementById("errModal"),o=i.querySelector(".modal-title"),l=i.querySelector(".modal-body");if(a)$("#errModal button.hidden").removeClass("hidden"),$('#errModal button:contains("OK")').on("click",function(){a(n,r),$('#errModal button:contains("OK")').off("click")});else{const e=$('#errModal button:contains("CANCEL")');e.hasClass("hidden")||e.addClass("hidden"),$('#errModal button:contains("OK")').off("click")}o.textContent=e,l.textContent=t,$("#errModal").modal("show")}(e,t,a,n,r)}}function f(e){let t;$("#pedigree_data").remove(),$("body").append("<div id='pedigree_data'></div>");for(let a=0;a<e.dataset.length;a++){let n="<div class='row'><strong class='col-md-1 text-right'>"+e.dataset[a].name+"</strong><div class='col-md-11'>";for(t in e.dataset[a])"name"!==t&&("parent"===t?n+="<span>"+t+":"+e.dataset[a][t].name+"; </span>":"children"===t?void 0!==e.dataset[a][t][0]&&(n+="<span>"+t+":"+e.dataset[a][t][0].name+"; </span>"):n+="<span>"+t+":"+e.dataset[a][t]+"; </span>");$("#pedigree_data").append(n+"</div></div>")}for(t in $("#pedigree_data").append("<br /><br />"),e)"dataset"!==t&&$("#pedigree_data").append("<span>"+t+":"+e[t]+"; </span>")}function h(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement)}function m(e){return{width:h()?window.innerWidth:e.width,height:h()?window.innerHeight:e.height}}function p(e){const t=(e,t)=>{const a=(e,t)=>{let a=-1;return $.each(e,function(e,n){if(t===n.name)return a=e,a}),a};let n=a(e,t),r=1;for(;n>=0&&("mother"in e[n]||e[n].top_level);)n=a(e,e[n].mother),r++;return r},a=(e,t,a)=>$.map(e,function(e,a){return"noparents"in e||e.mother!==t.name&&e.father!==t.name?null:e});let n=m(e),r=0,i={};for(let n=0;n<e.dataset.length;n++){let o=t(e.dataset,e.dataset[n].name),l=a(e.dataset,e.dataset[n]),s=1+(l.length>0?.55+.25*l.length:0)+(e.dataset[n].father?.25:0);o in i?i[o]+=s:i[o]=s,i[o]>r&&(r=i[o])}let o=Object.keys(i).length*e.symbol_size*3.5;return{width:n.width-e.symbol_size>r*e.symbol_size*1.65?n.width-e.symbol_size:r*e.symbol_size*1.65,height:n.height-e.symbol_size>o?n.height-e.symbol_size:o}}var g=Object.freeze({__proto__:null,get_svg_dimensions:m,get_tree_dimensions:p,isEdge:c,isIE:d,is_fullscreen:h,messages:u,print_opts:f});let _=25,y={};function b(e){try{return JSON.stringify(e)}catch(t){let a=e.map(function(e){let t={};for(let a in e)"parent"!==a&&"children"!==a&&"data"!==a&&"function"!=typeof e[a]&&"object"!=typeof e[a]?t[a]=e[a]:"children"===a&&Array.isArray(e[a])&&(t[a]=e[a].map(e=>e.name||e));return t});return JSON.stringify(a)}}function x(e){try{if("array"===e.store_type)return!1;if("local"!==e.store_type&&"session"!==e.store_type&&void 0!==e.store_type)return!1;let t="test";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(e){return!1}}function v(e){return"PEDIGREE_"+e.btn_target+"_"}function w(e){return y[v(e)]}function z(e,t){return"local"===e.store_type?localStorage.getItem(t):sessionStorage.getItem(t)}function k(e,t,a){return"local"===e.store_type?localStorage.setItem(t,a):sessionStorage.setItem(t,a)}function A(e){let t=v(e),a="local"===e.store_type?localStorage:sessionStorage,n=[];for(let e=0;e<a.length;e++)0===a.key(e).indexOf(t)&&n.push(a.key(e));for(let e=0;e<n.length;e++)a.removeItem(n[e])}function O(e){let t;return t=x(e)?z(e,v(e)+"COUNT"):y[v(e)+"COUNT"],null!=t?t:0}function E(e,t){x(e)?k(e,v(e)+"COUNT",t):y[v(e)+"COUNT"]=t}function F(e){if(!e.dataset)return;let t=O(e);if(x(e))k(e,v(e)+t,b(e.dataset));else{console.warn("Local storage not found/supported for this browser!",e.store_type),_=500,void 0===w(e)&&(y[v(e)]=[]);let a=w(e);a.length>=_&&(a.shift(),t>0&&t--),a.push(b(e.dataset))}t<_?t++:t=0,E(e,t)}function D(e){if(!x(e))return w(e)&&w(e).length>0?w(e).length:-1;for(let t=_;t>0;t--)if(null!==z(e,v(e)+(t-1)))return t;return-1}function I(e){let t=O(e)-1;return-1===t&&(t=_),x(e)?JSON.parse(z(e,v(e)+t)):w(e)?JSON.parse(w(e)[t]):void 0}function N(e,t){if(void 0===t&&(t=O(e)-2),t<0){let a=D(e);t=a<_?a-1:_-1}return E(e,t+1),x(e)?JSON.parse(z(e,v(e)+t)):JSON.parse(w(e)[t])}function M(e,t){return void 0===t&&(t=O(e)),t>=_&&(t=0),E(e,parseInt(t)+1),x(e)?JSON.parse(z(e,v(e)+t)):JSON.parse(w(e)[t])}function S(e){x(e)&&function(e){"local"===e.store_type?localStorage.clear():sessionStorage.clear()}(e),y={}}function C(e,t,a,n){if(x(e)){let r="local"===e.store_type?localStorage:sessionStorage;t?(k(e,v(e)+"_X",t),k(e,v(e)+"_Y",a)):(r.removeItem(v(e)+"_X"),r.removeItem(v(e)+"_Y"));let i=v(e)+"_ZOOM";n?k(e,i,n):r.removeItem(i)}else{t?(y[v(e)+"_X"]=t,y[v(e)+"_Y"]=a):(delete y[v(e)+"_X"],delete y[v(e)+"_Y"]);let r=v(e)+"_ZOOM";n?y[r]=n:delete y[r]}}function U(e){if(x(e)){if(null===localStorage.getItem(v(e)+"_X")&&null===sessionStorage.getItem(v(e)+"_X"))return[null,null];let t=[parseInt(z(e,v(e)+"_X")),parseInt(z(e,v(e)+"_Y"))];return null!==z(e,v(e)+"_ZOOM")&&t.push(parseFloat(z(e,v(e)+"_ZOOM"))),t}{if(null===y[v(e)+"_X"]||void 0===y[v(e)+"_X"])return[null,null];let t=[parseInt(y[v(e)+"_X"]),parseInt(y[v(e)+"_Y"])];return null!==y[v(e)+"_ZOOM"]&&void 0!==y[v(e)+"_ZOOM"]&&t.push(parseFloat(y[v(e)+"_ZOOM"])),t}}var T=Object.freeze({__proto__:null,clear:S,clear_pedigree_data:A,current:I,get_count:O,getposition:U,init_cache:F,last:function(e){if(x(e))for(let t=_;t>0;t--){let a=z(e,v(e)+(t-1));if(null!==a)return E(e,t),JSON.parse(a)}else{let t=w(e);if(t)return JSON.parse(t[t.length-1])}},next:M,nstore:D,previous:N,setposition:C});function R(e,t){let a=-1;return $.each(e,function(e,n){if(t===n.name)return a=e,a}),a}function B(e,t){for(let a=0;a<e.length;a++){if(e[a].data&&t===e[a].data.name)return e[a];if(t===e[a].name)return e[a]}if(e&&e.dataset)for(let a=0;a<e.dataset.length;a++)if(t===e.dataset[a].name)return{data:e.dataset[a]}}function L(e){return void 0!==$(e).attr("proband")&&!1!==$(e).attr("proband")}function P(e,t,a){$.each(e,function(e,n){t===n.name?n.proband=a:delete n.proband})}function G(e){let t;return $.each(e,function(e,a){if(L(a))return t=e,t}),t}function j(e,t){return void 0!==B(I(e),t)}function H(e,t){let a=[];for(let n=0;n<e.length;n++){let r=e[n];t.name===r.mother&&-1===$.inArray(r.father,a)?a.push(r.father):t.name===r.father&&-1===$.inArray(r.mother,a)&&a.push(r.mother)}return a}function X(e,t,a){let n=[],r=[];return"F"===t.sex&&$.each(e,function(e,i){t.name===i.mother&&(a&&a.name!==i.father||-1!==$.inArray(i.name,r)||i.noparents||(n.push(i),r.push(i.name)))}),n}function V(e,t,a){return $.map(e,function(e,n){return"noparents"in e||e.mother!==t.name&&e.father!==t.name||a&&e.sex!==a?null:e})}function Y(e,t){let a=q(e,t),n=t.mztwin?"mztwin":"dztwin";return $.map(a,function(e,a){return e.name!==t.name&&e[n]===t[n]?e:null})}function q(e,t,a){return void 0===t||!t.mother||t.noparents?[]:$.map(e,function(e,n){return e.name===t.name||"noparents"in e||!e.mother||e.mother!==t.mother||e.father!==t.father||a&&e.sex!==a?null:e})}function J(e,t,a){return $.map(e,function(e,n){return e.name===t.name||"noparents"in e||!e.mother||e.mother!==t.mother||e.father!==t.father||a&&e.sex!==a?null:e})}function W(e,t){return $.map(e,function(e,a){return e.name!==t.name&&"noparents"in e&&e.mother===t.mother&&e.father===t.father?e:null})}function K(e,t){let a=R(e,t),n=1;for(;a>=0&&("mother"in e[a]||e[a].top_level);)a=R(e,e[a].mother),n++;return n}function Z(e,t,a){return $.map(e,function(e,n){return e.depth!==t||e.data.hidden||-1!==$.inArray(e.data.name,a)?null:e}).sort(function(e,t){return e.x-t.x})}function Q(e,t){let a=[];for(let n=0;n<t.length;n++){let r=t[n].mother?.data?.name||t[n].mother?.name,i=t[n].father?.data?.name||t[n].father?.name;if(!r||!i)continue;let o=B(e,r),l=B(e,i);o&&l&&a.push({mother:o,father:l})}return a}function ee(e,t){let a=[];return function t(n){n.data&&(n=n.data),"mother"in n&&"father"in n&&!("noparents"in n)&&(t(B(e,n.mother)),t(B(e,n.father))),a.push(n)}(t),a}function te(e,t,a){if(e.depth!==t.depth)return!0;let n=ee(a.dataset,e),r=ee(a.dataset,t),i=$.map(n,function(e,t){return e.name}),o=$.map(r,function(e,t){return e.name}),l=!1;return $.each(i,function(e,t){if(-1!==$.inArray(t,o))return l=!0,!1}),l}function ae(e){let t=[];return function e(a){a.children&&a.children.forEach(e),t.push(a)}(e),e&&e._dataset&&(t.dataset=e._dataset),t}function ne(e,t,a,n,r){for(let i=0;i<t.length;i++)if(n===t[i].depth&&-1===$.inArray(t[i].data.name,r)&&Math.abs(a-t[i].x)<1.15*e.symbol_size)return!0;return!1}function re(e,t,a){function n(r){if(r.children&&(r.children.forEach(n),void 0!==r.data.father&&void 0!==r.data.mother)){let n="string"==typeof r.data.father?r.data.father:r.data.father.name,i="string"==typeof r.data.mother?r.data.mother:r.data.mother.name;if(!n||!i)return;let o=B(a,n),l=B(a,i);if(!o||!l)return;let s=(o.x+l.x)/2;if(ne(e,t.descendants(),s,r.depth,[r.data.name]))(r.x<o.x&&r.x<l.x||r.x>o.x&&r.x>l.x)&&(r.x=s);else{r.x=s;let a=r.x-s;if(2===r.children.length&&(r.children[0].data.hidden||r.children[1].data.hidden)){if(!r.children[0].data.hidden||!r.children[1].data.hidden){let a=r.children[0].data.hidden?r.children[1]:r.children[0],n=r.children[0].data.hidden?r.children[0]:r.children[1];(a.x<n.x&&s<n.x||a.x>n.x&&s>n.x)&&!ne(e,t.descendants(),s,a.depth,[a.data.name])&&(a.x=s)}}else if(1!==r.children.length||r.children[0].data.hidden){if(0!==a&&!function(e,t,a,n){let r=t.descendants(),i=$.map(r,function(e,t){return e.data.name}),o=n.descendants();for(let n=0;n<r.length;n++){let l=r[n];if(t.data.name!==l.data.name&&ne(e,o,l.x-a,l.depth,i))return!0}return!1}(e,r,a,t))if(1===r.children.length)r.children[0].x=s;else{let t=r.descendants();e.DEBUG&&console.log("ADJUSTING "+r.data.name+" NO. DESCENDANTS "+t.length+" diff="+a);for(let e=0;e<t.length;e++)r.data.name!==t[e].data.name&&(t[e].x-=a)}}else ne(e,t.descendants(),s,r.children[0].depth,[r.children[0].data.name])||(r.children[0].x=s)}}}n(t),n(t)}function ie(e,t,a,n,r){if("parent_node"in e?e.parent_node.push(t):e.parent_node=[t],e.mztwin||e.dztwins){let t=Y(r.dataset,e);for(let e=0;e<t.length;e++){let r=B(n,t[e].name);r&&(r.id=a++)}}return a}function oe(e,t){return e.sort(function(e,t){return e.mztwin&&t.mztwin&&e.mztwin===t.mztwin||e.dztwin&&t.dztwin&&e.dztwin===t.dztwin?0:e.mztwin||t.mztwin||e.dztwin||t.dztwin?1:0}),$.each(e,function(e,a){void 0===a.id&&(a.id=t++)}),t}function le(e){let t="",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";for(let n=0;n<e;n++)t+=a.charAt(Math.floor(52*Math.random()));return t}function se(e,t,a,n,r){void 0===t.children&&(t.children=X(e.dataset,t)),void 0===n&&(n=[],r=1);let i=ae(a),o=[];return $.each(t.children,function(t,a){$.each(e.dataset,function(t,n){if((a.name===n.mother||a.name===n.father)&&void 0===a.id){let t=B(i,n.mother),a=B(i,n.father);t=void 0!==t?t:B(e.dataset,n.mother),a=void 0!==a?a:B(e.dataset,n.father),function(e,t,a){for(let n=0;n<e.length;n++)if(e[n].mother===t&&e[n].father===a)return!0;return!1}(o,t,a)||o.push({mother:t,father:a})}})}),$.merge(n,o),$.each(o,function(a,n){let o=n.mother,l=n.father;o.children=[];let s={name:le(4),hidden:!0,parent:null,father:l,mother:o,children:X(e.dataset,o,l)},d=R(e.dataset,o.name),c=R(e.dataset,l.name);"id"in l||"id"in o||(r=oe(t.children,r));let u=function(e,t,a){let n=t,r=a;for(;"mother"in e[n]&&"mother"in e[r]&&!("noparents"in e[n])&&!("noparents"in e[r]);)n=R(e,e[n].mother),r=R(e,e[r].mother);return{midx:n,fidx:r}}(e.dataset,d,c);u.fidx<u.midx?(l.id=r++,s.id=r++,o.id=r++):(o.id=r++,s.id=r++,l.id=r++),r=ie(o,s,r,i,e),r=ie(l,s,r,i,e),t.children.push(s)}),r=oe(t.children,r),$.each(t.children,function(t,i){r=se(e,i,a,n,r)[1]}),[n,r]}var de=Object.freeze({__proto__:null,adjust_coords:re,ancestors:ee,buildTree:se,consanguity:te,exists:j,flatten:ae,getAdoptedSiblings:W,getAllChildren:V,getAllSiblings:J,getChildren:X,getDepth:K,getIdxByName:R,getNodeByName:B,getNodesAtDepth:Z,getProbandIndex:G,getSiblings:q,getTwins:Y,get_partners:H,isProband:L,linkNodes:Q,makeid:le,overlap:ne,setProband:P});let ce={};function ue(e){e[0].id&&e.sort(function(e,t){return e.id&&t.id?e.id>t.id?1:t.id>e.id?-1:0:0});let t=["id","parent_node"],a=[];for(let n=0;n<e.length;n++){let r={};for(let a in e[n])-1===t.indexOf(a)&&(r[a]=e[n][a]);a.push(r)}return a}function fe(e,t){let a=!1;return t&&$.each(t,function(t,n){if(0===t.indexOf(e+"_")||t===e)return a=!0,a}),a}var he=Object.freeze({__proto__:null,adjust_coords:re,ancestors:ee,buildTree:se,capitaliseFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},consanguity:te,copy_dataset:ue,create_err:t,exists:j,flatten:ae,getAdoptedSiblings:W,getAllChildren:V,getAllSiblings:J,getChildren:X,getDepth:K,getFormattedDate:function(e){let t=new Date;return e?("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2):t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)+" "+("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2)},getIdxByName:R,getNodeByName:B,getNodesAtDepth:Z,getProbandIndex:G,getSiblings:q,getTwins:Y,get_partners:H,get_svg_dimensions:m,get_tree_dimensions:p,isEdge:c,isIE:d,isProband:L,is_fullscreen:h,linkNodes:Q,makeid:le,messages:u,overlap:ne,prefixInObj:fe,print_opts:f,roots:ce,setProband:P,unconnected:o,urlParam:function(e){let t=new RegExp("[?&]"+e+"=([^&#]*)").exec(window.location.href);return null===t?null:t[1]||0},validate_age_yob:a,validate_pedigree:n});let me;function pe(e,t){let a=e.symbol_size/2,n=2.5*-e.symbol_size;me=d3.zoom().scaleExtent([e.zoomIn,e.zoomOut]).filter(function(t){return!((!e.zoomSrc||-1===e.zoomSrc.indexOf("wheel"))&&t.type&&"wheel"===t.type)&&("dblclick"!==t.type&&!t.button)}).on("zoom",function(t){!function(e,t){t.DEBUG&&console.log("zoom",e.transform);let a=e.transform,n=a.k&&1!==a.k?a.k:void 0;C(t,a.x,a.y,n);let r=d3.select("#"+t.targetDiv).select(".diagram");r.attr("transform","translate("+a.x+","+a.y+")"+(n?" scale("+n+")":""))}(t,e)}),t.call(me);let r=U(e),i=3===r.length?r[2]:1,o=null!==r[0]?r[0]/i:a*i,l=null!==r[1]?r[1]/i:n*i;var s=d3.zoomIdentity.scale(i).translate(o,l);t.call(me.transform,s)}function ge(e,t){d3.select("#"+e.targetDiv).select("svg").transition().duration(50).call(me.scaleBy,t)}function _e(e){let t=function(e){let t=ye(e);return{wid:Math.abs(t.xmax-t.xmin),hgt:Math.abs(t.ymax-t.ymin)}}(e),a=d3.select("#"+e.targetDiv).select("svg"),n=function(e){return{w:e.node().clientWidth,h:e.node().clientHeight}}(a),r=1/Math.max(t.wid/n.w,t.hgt/n.h);r<e.zoomIn&&me.scaleExtent([r,e.zoomOut]);let i=function(e){let t=ye(e);return{x:t.xmin+(t.xmax-t.xmin)/2,y:t.ymin+(t.ymax-t.ymin)/2}}(e);a.call(me.translateTo,i.x-e.symbol_size,i.y-e.symbol_size),setTimeout(function(){a.transition().duration(700).call(me.scaleTo,r)},400)}function ye(e){let t=d3.select("#"+e.targetDiv).select(".diagram"),a=Number.MAX_VALUE,n=-1e6,r=Number.MAX_VALUE,i=-1e6,o=e.symbol_size;return t.selectAll("g").each(function(t,l){if(t.x&&"hidden_root"!==t.data.name&&!t.data.hidden){let l=function(e,t,a){let n=d3.select(t).node().getBBox(),r=n.width,i=n.height;if(0===r&&0===i)try{r=2*a,i=2*a;let n=d3.select(t).selectAll(".indi_details");for(let t=0;t<n._groups[0].length;t++){let o=be(n._groups[0][t].firstChild.nodeValue,e.font_family,e.font_size);r=Math.max(o.w+a/2,r),i=Math.max(2*a+t*o.h,i)}}catch(e){console.error(e),r=2*a,i=2*a}return{w:r,h:i}}(e,this,o);t.x-o<a&&(a=t.x-o),t.x+l.w+o>n&&(n=t.x+l.w+o),t.y<r&&(r=t.y),t.y+l.h+o>i&&(i=t.y+l.h+o)}}),{xmin:a,xmax:n,ymin:r,ymax:i}}function be(e,t,a){let n=$("<div></div>").text(e).css({position:"absolute",float:"left","white-space":"nowrap",visibility:"hidden",font:t||"Helvetica",fontSize:a||"1em"}).appendTo($("body")),r={w:n.width(),h:n.height()};return n.remove(),r}var xe=Object.freeze({__proto__:null,btn_zoom:ge,get_bounds:ye,init_zoom:pe,scale_to_fit:_e});function ve(e){let t=$.extend({btn_target:"pedigree_history"},e),a=[{fa:"fa-file-image",title:"download PNG image"},{fa:"fa-undo",title:"undo"},{fa:"fa-redo",title:"redo"},{fa:"fa-refresh",title:"reset"}];a.push({fa:"fa-crosshairs",title:"scale-to-fit"}),t.zoomSrc&&t.zoomSrc.indexOf("button")>-1&&(a.push({fa:"fa-minus-circle",title:1===t.zoomOut?"zoom-out (disabled: already at minimum)":"zoom-out",disabled:1===t.zoomOut}),a.push({fa:"fa-plus-circle",title:1===t.zoomIn?"zoom-in (disabled: already at maximum)":"zoom-in",disabled:1===t.zoomIn})),a.push({fa:"fa-arrows-alt",title:"fullscreen"});let n="";for(let e=0;e<a.length;e++)n+="<span>",n+='<i class="fa fa-lg '+a[e].fa+" pe-2"+(a[e].disabled?" disabled-btn":"")+'" aria-hidden="true" title="'+a[e].title+'" '+("fa-arrows-alt"===a[e].fa?'id="fullscreen" ':"")+(a[e].disabled?'style="opacity: 0.3; cursor: not-allowed;" ':"")+"></i>",n+="</span>";$("#"+t.btn_target).append(n),function(e){$(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",function(t){let a=I(e);null!=a&&(e.dataset=a),$(document).trigger("rebuild",[e])}),$("#fullscreen").on("click",function(t){if(h())document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let t=$("#"+e.targetDiv)[0];t.requestFullscreen?t.requestFullscreen():document.documentElement.mozRequestFullScreen?t.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen?t.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):document.documentElement.msRequestFullscreen&&t.msRequestFullscreen()}});let t=0;function a(){ge(e,1.05)}function n(){ge(e,.95)}$(".fa-plus-circle, .fa-minus-circle").on("mousedown",function(){$(this).hasClass("disabled-btn")||(t=setInterval($(this).hasClass("fa-plus-circle")?a:n,50))}).on("mouseup mouseleave",function(){clearInterval(t)}),$("#"+e.btn_target).on("click",function(t){if(t.stopPropagation(),$(t.target).hasClass("fg-grey"))return!1;if($(t.target).hasClass("fa-undo"))e.dataset=N(e),$("#"+e.targetDiv).empty(),$(document).trigger("build",[e]);else if($(t.target).hasClass("fa-redo"))e.dataset=M(e),$("#"+e.targetDiv).empty(),$(document).trigger("build",[e]);else if($(t.target).hasClass("fa-refresh"))u("Pedigree Reset","This may result in loss of some data. Reset now?",$e,e);else if($(t.target).hasClass("fa-crosshairs"))_e(e);else if($(t.target).hasClass("fa-file-image"))return;$(document).trigger("fhChange",[e])})}(t)}function $e(e){let t;if(e.keep_proband_on_reset){let a=ue(I(e));t=a[G(a)],t.mother="f21",t.father="m21",A(e)}else t={name:"ch1",sex:"F",mother:"f21",father:"m21",proband:!0,status:"0",display_name:"me"},S(e);delete e.dataset;let a=$("input[name='default_fam']:checked");if(a.length>0&&a.val().indexOf("extended")>-1){let a={name:"Spj",mother:"f21",father:"m21",noparents:!0,status:"0",display_name:"partner"},n={name:"zhk",sex:"F",mother:"ch1",father:"Spj",status:"0",display_name:"daughter"},r={name:"Knx",sex:"M",mother:"ch1",father:"Spj",status:"0",display_name:"son"};a.sex="F"===t.sex?"M":"F",n.mother="F"===t.sex?t.name:a.name,n.father="F"===t.sex?a.name:t.name,r.mother="F"===t.sex?t.name:a.name,r.father="F"===t.sex?a.name:t.name,e.dataset=[t,a,n,r]}a.length>0&&"extended2"===a.val()?e.dataset.push({name:"wZA",sex:"M",top_level:!0,status:"0",display_name:"paternal grandfather"},{name:"MAk",sex:"F",top_level:!0,status:"0",display_name:"paternal grandmother"},{name:"zwB",sex:"M",top_level:!0,status:"0",display_name:"maternal grandfather"},{name:"dOH",sex:"F",top_level:!0,status:"0",display_name:"maternal grandmother"},{name:"MKg",sex:"F",mother:"MAk",father:"wZA",status:"0",display_name:"paternal aunt"},{name:"xsm",sex:"M",mother:"MAk",father:"wZA",status:"0",display_name:"paternal uncle"},{name:"m21",sex:"M",mother:"MAk",father:"wZA",status:"0",display_name:"father"},{name:"f21",sex:"F",mother:"dOH",father:"zwB",status:"0",display_name:"mother"},{name:"aOH",sex:"F",mother:"f21",father:"m21",status:"0",display_name:"sister"},{name:"Vha",sex:"M",mother:"f21",father:"m21",status:"0",display_name:"brother"},{name:"uuc",display_name:"maternal aunt",sex:"F",mother:"dOH",father:"zwB",status:"0"},{name:"xIw",display_name:"maternal uncle",sex:"M",mother:"dOH",father:"zwB",status:"0"}):a.length>0&&"extended1"===a.val()?e.dataset.push({name:"m21",sex:"M",mother:null,father:null,status:"0",display_name:"father",noparents:!0},{name:"f21",sex:"F",mother:null,father:null,status:"0",display_name:"mother",noparents:!0},{name:"aOH",sex:"F",mother:"f21",father:"m21",status:"0",display_name:"sister"},{name:"Vha",sex:"M",mother:"f21",father:"m21",status:"0",display_name:"brother"}):e.dataset=[{name:"m21",display_name:"father",sex:"M",top_level:!0},{name:"f21",display_name:"mother",sex:"F",top_level:!0},t],$(document).trigger("rebuild",[e])}let we={breast_cancer:"breast_cancer_diagnosis_age",breast_cancer2:"breast_cancer2_diagnosis_age",ovarian_cancer:"ovarian_cancer_diagnosis_age",prostate_cancer:"prostate_cancer_diagnosis_age",pancreatic_cancer:"pancreatic_cancer_diagnosis_age"},ze=["brca1","brca2","palb2","atm","chek2","rad51d","rad51c","brip1"],ke=["brca1","brca2","palb2","atm","chek2","bard1","rad51d","rad51c","brip1"],Ae=["brca1","brca2","palb2","atm","chek2","bard1","rad51d","rad51c","brip1","hoxb13"],Oe=["er","pr","her2","ck14","ck56"],Ee={};function Fe(e){const t=$("#"+e).val();return t&&0!==t.trim().length}let De=function(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0};function Ie(){let e={};return Fe("breast_prs_a")&&Fe("breast_prs_z")&&(e.breast_cancer_prs={alpha:parseFloat($("#breast_prs_a").val()),zscore:parseFloat($("#breast_prs_z").val()),percent:parseFloat($("#breast_prs_percent").val())}),Fe("ovarian_prs_a")&&Fe("ovarian_prs_z")&&(e.ovarian_cancer_prs={alpha:parseFloat($("#ovarian_prs_a").val()),zscore:parseFloat($("#ovarian_prs_z").val()),percent:parseFloat($("#ovarian_prs_percent").val())}),Fe("prostate_prs_a")&&Fe("prostate_prs_z")&&(e.prostate_cancer_prs={alpha:parseFloat($("#prostate_prs_a").val()),zscore:parseFloat($("#prostate_prs_z").val()),percent:parseFloat($("#prostate_prs_percent").val())}),console.log(e),De(e)?0:e}function Ne(e){return 1===(e=parseInt(e))?ze:2===e||3===e?ke:Ae}function Me(e){let t=e.trim().split("\n"),a=[],n=[];const r=/([0-9])/;let i=3,o=Ne(i),l=[26,27,27,28];for(let e=0;e<t.length;e++){let s=t[e].trim();if(0===s.indexOf("##")){if(0===s.indexOf("##CanRisk")){const e=s.match(r);if(i=parseInt(e[1]),o=Ne(i),console.log("CanRisk File Format version "+i),s.indexOf(";")>-1){let e=s.split(";");for(let t=1;t<e.length;t++){2===e[t].split("=").length&&n.push(e[t])}}}-1===s.indexOf("CanRisk")&&0!==s.indexOf("##FamID")&&n.push(s.replace("##",""));continue}let d=/\t/;s.indexOf("\t")<0&&(d=/\s+/,console.log("NOT TAB DELIM"));let c=$.map(s.split(d),function(e,t){return e.trim()});if(c.length>1){if(c.length!==l[i-1])throw console.error(s,c),new Error("Found number of columns "+c.length+"; expected "+l[i-1]+" for CanRisk version "+i);let t={famid:c[0],display_name:c[1],name:c[3],sex:c[6],status:c[8]};"1"===c[2]&&(t.proband=!0),"0"!==c[4]&&(t.father=c[4]),"0"!==c[5]&&(t.mother=c[5]),"0"!==c[7]&&(t.mztwin=c[7]),"0"!==c[9]&&(t.age=c[9]),"0"!==c[10]&&(t.yob=c[10]);let n=11;$.each(we,function(e,a){"0"!==c[n]&&(t[a]=c[n]),n++}),"0"!==c[n++]&&(t.ashkenazi=1);for(let a=0;a<o.length;a++){let r=c[n].split(":");"0"!==r[0]?"S"!==r[0]&&"T"!==r[0]||"P"!==r[1]&&"N"!==r[1]&&"HOM"!==r[1]&&"HET"!==r[1]?console.warn("UNRECOGNISED GENE TEST ON LINE "+(e+1)+": "+r[0]+" "+r[1]):t[o[a]+"_gene_test"]={type:r[0],result:r[1]}:"P"!==r[1]&&"N"!==r[1]||(t[o[a]+"_gene_test"]={type:r[0],result:r[1]}),n++}let r=c[n].split(":");for(let a=0;a<r.length;a++)"0"!==r[a]&&("N"===r[a]||"P"===r[a]?t[Oe[a]+"_bc_pathology"]=r[a]:console.warn("UNRECOGNISED PATHOLOGY ON LINE "+(e+1)+": "+Oe[a]+" "+r[a]));a.push(t)}}return a.sort(function(e,t){return void 0!==e.mztwin?e.mztwin.localeCompare(t.mztwin):0}),[n,a]}function Se(e){if(/^(birads|Volpara|Stratus)=/i.test(e))return"\n##"+e;return/^(1|2|3|4|a|b|c|d)$/i.test(e)?"\n##birads="+e:(console.error("Unrecognised mammographic density format :: "+e),"")}function Ce(e,t,a,n,r=3,i=void 0){let o="##CanRisk "+(Number.isInteger(r)?r+".0":r.toString());t||(t="XXXX"),a&&(o+=a),void 0===n&&(n=!0);let l=$.map(e,function(e,t){return"exclude"in e&&e.exclude?e.name:null}),s=G(e),d="F";if(s&&(d=e[s].sex),"M"!==d){let e=Ue("menarche_age"),t=Ue("parity"),a=Ue("age_of_first_live_birth"),n=Ue("oral_contraception"),r=Ue("mht"),i=Ue("bmi"),l=Ue("alcohol_intake"),s=Ue("age_of_menopause"),d=Ue("mammographic_density"),c=Ue("height"),u=Ue("Age_Tubal_ligation"),f=Ue("endometriosis");void 0!==e&&(o+="\n##menarche="+e),void 0!==t&&(o+="\n##parity="+t),void 0!==a&&(o+="\n##first_live_birth="+a),void 0!==n&&(o+="\n##oc_use="+n),void 0!==r&&(o+="\n##mht_use="+r),void 0!==i&&(o+="\n##BMI="+i),void 0!==l&&(o+="\n##alcohol="+l),void 0!==s&&(o+="\n##menopause="+s),void 0!==d&&(o+=Se(d)),void 0!==c&&(o+="\n##height="+c),void 0!==u&&(o+="n"!==u&&"N"!==u?"\n##TL=Y":"\n##TL=N"),void 0!==f&&(o+="\n##endo="+f)}r>2&&void 0!==i&&(o+="\n##ethnicity="+i),o+="\n##FamID\tName\tTarget\tIndivID\tFathID\tMothID\tSex\tMZtwin\tDead\tAge\tYob\tBC1\tBC2\tOC\tPRO\tPAN\tAshkn";let c=Ne(r);for(let e=0;e<c.length;e++)o+="\t"+c[e].toUpperCase();o+="\tER:PR:HER2:CK14:CK56";for(let a=0;a<e.length;a++){let r=e[a];if(-1!==$.inArray(r.name,l)){console.log("EXCLUDE: "+r.name);continue}o+="\n"+t+"\t",o+=n?a+"\t":(r.display_name?r.display_name:"NA")+"\t",o+=("proband"in r?"1":0)+"\t",o+=r.name+"\t",o+=("father"in r&&!("noparents"in r)&&-1===$.inArray(r.mother,l)?r.father:0)+"\t",o+=("mother"in r&&!("noparents"in r)&&-1===$.inArray(r.mother,l)?r.mother:0)+"\t",o+=r.sex+"\t",o+=("mztwin"in r?r.mztwin:0)+"\t",o+=("status"in r?r.status:0)+"\t",o+=("age"in r?r.age:0)+"\t",o+=("yob"in r?r.yob:0)+"\t";let i="";$.each(we,function(e,t){i+=t in r?(t in r?r[t]:"AU")+"\t":"0\t"}),o+=i,o+=("ashkenazi"in r?r.ashkenazi:0)+"\t";for(let e=0;e<c.length;e++)c[e]+"_gene_test"in r&&"-"!==r[c[e]+"_gene_test"].type&&"-"!==r[c[e]+"_gene_test"].result?(o+=r[c[e]+"_gene_test"].type+":",o+=r[c[e]+"_gene_test"].result+"\t"):o+="0:0\t";for(let e=0;e<Oe.length;e++)Oe[e]+"_bc_pathology"in r?(o+=r[Oe[e]+"_bc_pathology"],console.log("pathology "+r[Oe[e]+"_bc_pathology"]+" for "+r.display_name)):o+="0",e<Oe.length-1&&(o+=":")}return console.log(o,Ee),o}function Ue(e){let t=Te(e);if(t in Ee)return Ee[t]}function Te(e){return window.location.pathname.split("/").filter(function(e){return!!e}).pop()+"::"+e}var Re=Object.freeze({__proto__:null,cancers:we,genetic_test1:ze,genetic_test2:ke,genetic_test4:Ae,get_mdensity:Se,get_meta:function(){let e,t=function(){let e="";$("#A6_4_3_check").parent().hasClass("off")||(e+=";OVARY2=y");$("#A6_4_7_check").parent().hasClass("off")||(e+=";MAST2=y");return e}();try{e=Ie(),e.breast_cancer_prs&&0!==e.breast_cancer_prs.alpha&&0!==e.breast_cancer_prs.zscore&&(t+="\n##PRS_BC=alpha="+e.breast_cancer_prs.alpha+",zscore="+e.breast_cancer_prs.zscore),e.ovarian_cancer_prs&&0!==e.ovarian_cancer_prs.alpha&&0!==e.ovarian_cancer_prs.zscore&&(t+="\n##PRS_OC=alpha="+e.ovarian_cancer_prs.alpha+",zscore="+e.ovarian_cancer_prs.zscore),e.prostate_cancer_prs&&0!==e.prostate_cancer_prs.alpha&&0!==e.prostate_cancer_prs.zscore&&(t+="\n##PRS_PC=alpha="+e.prostate_cancer_prs.alpha+",zscore="+e.prostate_cancer_prs.zscore)}catch(t){console.warn("PRS",e)}return t},get_non_anon_pedigree:function(e,t,a=2,n=void 0){return Ce(e,void 0,t,!1,a,n)},get_pedigree:Ce,get_prs_values:Ie,get_risk_factor:Ue,hasInput:Fe,pathology_tests:Oe,readCanRisk:Me,remove_risk_factor:function(e){delete Ee[Te(e)]},save_risk_factor:function(e,t){Ee[Te(e)]=t},show_risk_factor_store:function(){console.log("RISK_FACTOR_STORE::"),$.each(Ee,function(e,t){console.log(e+" : "+t)})},store_name:Te});function Be(e){$("#load").on("change",function(t){!function(e,t){let a=e.target.files[0];if(a){let e=new FileReader;e.onload=function(e){We(e.target.result,t)},e.onerror=function(){u("File Error","File could not be read! Code "+e.error)},e.readAsText(a)}else console.error("File could not be read!");$("#load")[0].value=""}(t,e)}),$("#save").on("click",function(){!function(e){let t=JSON.stringify(I(e));qe(e,t)}(e)}),$("#print").on("click",function(){Ye(Xe(e))}),$("#svg_download").on("click",function(){Ve(Xe(e))}),$("#png_download, .fa-file-image").on("click",function(){Pe(e,4,"image/png")})}function Le(e,t){let a=["svg","g"],n=e.childNodes,r=t.childNodes;for(let e=0;e<n.length;e++){let t=n[e];if(-1===a.indexOf(t.tagName))try{let a=r[e].currentStyle||window.getComputedStyle(r[e]);if("undefined"===a||null===a)continue;let n=a.length,i=t.style;for(let e=0;e<n;e++){let t=a[e];(t.indexOf("text-")>-1||t.indexOf("font-")>-1)&&i.setProperty(t,a.getPropertyValue(t))}}catch(e){continue}else Le(t,r[e])}}function Pe(e,t,a){let n=je($("#"+e.targetDiv).find("svg"),"pedigree",{resolution:t,img_type:a});$.when.apply($,[n]).done(function(){let e=(t=arguments,a="pedigree",$.grep(t,function(e){return e&&e.name===a})[0]);var t,a;if(c()||d()){let t="<img src='"+e.img+"' alt='canvas image'/>";window.open().document.write(t)}else{let t=document.createElement("a");t.href=e.img,t.download="plot.png",t.target="_blank",document.body.appendChild(t),t.click(),document.body.removeChild(t)}})}function Ge(e){let t=e.get(0).cloneNode(!0);d3.select(t).selectAll("text").filter(function(){return 0===d3.select(this).text().length||d3.select(this),"FontAwesome"===d3.select(this).attr("font-family")}).remove(),Le(t,e.get(0));let a=(new XMLSerializer).serializeToString(t);return"data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(a)))}function je(e,t,a){let n={iscanvg:!1,resolution:1,img_type:"image/png"};a||(a=n),$.each(n,function(e,t){e in a||(a[e]=t)});let r=$.Deferred(),i=Ge(e),o=document.createElement("canvas");o.width=e.width()*a.resolution,o.height=e.height()*a.resolution;let l=o.getContext("2d");l.fillStyle="white",l.fillRect(0,0,o.width,o.height);let s=document.createElement("img");return s.onload=function(){l.drawImage(s,0,0,o.width,o.height),r.resolve({name:t,resolution:a.resolution,img:o.toDataURL(a.img_type,1),w:o.width,h:o.height}),l.clearRect(0,0,o.width,o.height)},s.src=i,r.promise()}function He(e){let t=function(e,t){let a=[],n=0;t.lastIndex=0;let r=t.exec(e);for(;r;){if(n++,n>400)return console.error("getMatches: counter exceeded 400"),-1;a.push(r),t.lastIndex===r.index&&t.lastIndex++,r=t.exec(e)}return a}(e,/url\((&quot;|"|'){0,1}#(.*?)(&quot;|"|'){0,1}\)/g);return-1===t?"ERROR DISPLAYING PEDIGREE":($.each(t,function(t,a){let n=a[1]?a[1]:"",r=a[2],i='id="'+r+'"',o="url\\("+n+"#"+r+n+"\\)",l=r+le(2);e=(e=e.replace(new RegExp(i,"g"),'id="'+l+'"')).replace(new RegExp(o,"g"),"url(#"+l+")")}),e)}function Xe(e){let t=I(e);null!=t&&(e.dataset=t);let a=$("<div></div>"),n=$("#"+e.targetDiv).find("svg").clone().appendTo(a),r=555,i=792,o=ye(e),l=Math.abs(o.xmax-o.xmin),s=Math.abs(o.ymax-o.ymin),d=1/Math.max(l/r,s/i),c=-(o.xmin-e.symbol_size)*d,u=-(o.ymin-e.symbol_size)*d;return n.attr("width",r),n.attr("height",s*d),n.find(".diagram").attr("transform","translate("+c+", "+u+") scale("+d+")"),a}function Ve(e){let t=document.createElement("a");t.href=Ge(e),t.download="plot.svg",t.target="_blank",document.body.appendChild(t),t.click(),document.body.removeChild(t)}function Ye(e,t){e.constructor!==Array&&(e=[e]);let a=.9*$(window).width(),n=$(window).height()-10,r=["/static/css/canrisk.css","https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"],i=window.open("","PrintMap","width="+a+",height="+n),o="";for(let e=0;e<r.length;e++)o+='<link href="'+r[e]+'" rel="stylesheet" type="text/css" media="all">';o+="<style>body {font-size: "+$("body").css("font-size")+";}</style>";let l="";for(let a=0;a<e.length;a++)0===a&&t&&(l+=t),l+=$(e[a]).html(),a<e.length-1&&(l+='<div class="page-break"> </div>');i.document.write(o),i.document.write(l),i.document.close(),i.focus(),setTimeout(function(){i.print(),i.close()},300)}function qe(e,t,a,n){e.DEBUG&&console.log(t),a||(a="ped.txt"),n||(n="text/plain");let r=new Blob([t],{type:n});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(r,a);else{let e=document.createElement("a"),t=URL.createObjectURL(r);e.href=t,e.download=a,document.body.appendChild(e),e.click(),setTimeout(function(){document.body.removeChild(e),window.URL.revokeObjectURL(t)},0)}}function Je(e){$.each(e.dataset,function(e,t){if(!t.hidden&&"M"===t.sex&&!L(t)&&t[we.breast_cancer2]){let e="Male family member ("+t.display_name+") with contralateral breast cancer found. Please note that as the risk models do not take this into account the second breast cancer is ignored.";console.error(e),delete t[we.breast_cancer2],u("Warning",e)}})}function We(e,t){let a;t.DEBUG&&console.log(e);try{if(0===e.indexOf("BOADICEA import pedigree file format 4.0"))t.dataset=Qe(e,4),Je(t);else if(0===e.indexOf("BOADICEA import pedigree file format 2.0"))t.dataset=Qe(e,2),Je(t);else if(0===e.indexOf("##")&&-1!==e.indexOf("CanRisk")){let n=Ze(e);a=n[0],t.dataset=n[1],Je(t)}else try{let a=JSON.parse(e),n=!0;for(let e=0;e<a.length;e++)a[e].top_level&&(n=!1);t.dataset=n?et(a):a}catch(a){t.dataset=Ke(e)}n(t)}catch(t){return console.error(t,e),void u("File Error",t.message?t.message:t)}t.DEBUG&&console.log(t.dataset);try{C(t),$(document).trigger("rebuild",[t]),console.log(a),$(document).trigger("riskfactorChange",[t,a]),$(document).trigger("fhChange",[t]);try{acc_FamHist_ticked(),acc_FamHist_Leave(),RESULT.FLAG_FAMILY_MODAL=!0}catch(e){}}catch(e){u("File Error",e.message?e.message:e)}}function Ke(e){let t,a=e.trim().split("\n"),n=[];for(let e=0;e<a.length;e++){let r=$.map(a[e].trim().split(/\s+/),function(e,t){return e.trim()});if(r.length<5)throw new Error("unknown format");let i="1"===r[4]?"M":"2"===r[4]?"F":"U",o={famid:r[0],display_name:r[1],name:r[1],sex:i};if("0"!==r[2]&&(o.father=r[2]),"0"!==r[3]&&(o.mother=r[3]),void 0!==t&&t!==o.famid){console.error("multiple family IDs found only using famid = "+t);break}if("2"===r[5]&&(o.affected=2),r.length>6){o.alleles="";for(let e=6;e<r.length;e+=2)o.alleles+=r[e]+"/"+r[e+1]+";"}n.unshift(o),t=r[0]}return et(n)}function Ze(e){let[t,a]=Me(e);try{return[t,et(a)]}catch(e){return console.error(e),[t,a]}}function Qe(e,t){let a=e.trim().split("\n"),n=[];for(let e=2;e<a.length;e++){let r=$.map(a[e].trim().split(/\s+/),function(e,t){return e.trim()});if(r.length>1){let a={famid:r[0],display_name:r[1],name:r[3],sex:r[6],status:r[8]};"1"===r[2]&&(a.proband=!0),"0"!==r[4]&&(a.father=r[4]),"0"!==r[5]&&(a.mother=r[5]),"0"!==r[7]&&(a.mztwin=r[7]),"0"!==r[9]&&(a.age=r[9]),"0"!==r[10]&&(a.yob=r[10]);let i=11;if($.each(we,function(e,t){"0"!==r[i]&&(a[t]=r[i]),i++}),4===t){"0"!==r[i++]&&(a.ashkenazi=1);for(let t=0;t<5;t++)i+=2,"0"!==r[i-2]&&("S"!==r[i-2]&&"T"!==r[i-2]||"P"!==r[i-1]&&"N"!==r[i-1]?console.warn("UNRECOGNISED GENE TEST ON LINE "+(e+1)+": "+r[i-2]+" "+r[i-1]):a[ze[t]+"_gene_test"]={type:r[i-2],result:r[i-1]})}else 2===t&&(i+=2,"0"!==r[i-2]&&("S"===r[i-2]||"T"===r[i-2]?"N"===r[i-1]?(a.brca1_gene_test={type:r[i-2],result:"N"},a.brca2_gene_test={type:r[i-2],result:"N"}):"1"===r[i-1]?(a.brca1_gene_test={type:r[i-2],result:"P"},a.brca2_gene_test={type:r[i-2],result:"N"}):"2"===r[i-1]?(a.brca1_gene_test={type:r[i-2],result:"N"},a.brca2_gene_test={type:r[i-2],result:"P"}):"3"===r[i-1]&&(a.brca1_gene_test={type:r[i-2],result:"P"},a.brca2_gene_test={type:r[i-2],result:"P"}):console.warn("UNRECOGNISED GENE TEST ON LINE "+(e+1)+": "+r[i-2]+" "+r[i-1])),"0"!==r[i++]&&(a.ashkenazi=1));for(let t=0;t<Oe.length;t++)"0"!==r[i]&&("N"===r[i]||"P"===r[i]?a[Oe[t]+"_bc_pathology"]=r[i]:console.warn("UNRECOGNISED PATHOLOGY ON LINE "+(e+1)+": "+Oe[t]+" "+r[i])),i++;n.unshift(a)}}try{return et(n)}catch(e){return console.error(e),n}}function et(e){for(let t=0;t<2;t++)for(let t=0;t<e.length;t++)at(e,e[t].name);!function(e){let t=!1,a=e.length;for(let n=0;n<a;n++){let a=X(e,e[n]),r=e[n].level;for(let n=0;n<a.length;n++)if(r-a[n].level>1){a[n].level=r-1;let i=H(e,a[n]);for(let t=0;t<i.length;t++){let a=B(e,i[t]);a.level=r-1;let n=B(e,a.mother),o=B(e,a.father);n&&(n.level=r),o&&(o.level=r)}t=!0}}}(e);let t=0;for(let a=0;a<e.length;a++)e[a].level&&e[a].level>t&&(t=e[a].level);for(let a=0;a<e.length;a++)if(1===K(e,e[a].name))if(e[a].level&&e[a].level===t)e[a].top_level=!0;else{e[a].noparents=!0;let t=tt(e,e[a]);if(t>-1&&e[t].mother&&(e[a].mother=e[t].mother,e[a].father=e[t].father),!e[a].mother)for(let n=0;n<e.length;n++)if(e[a].level===e[n].level-1&&(t=tt(e,e[n]),t>-1&&a!==t)){e[a].mother="F"===e[n].sex?e[n].name:e[t].name,e[a].father="M"===e[n].sex?e[n].name:e[t].name;break}}else delete e[a].top_level;return e}function tt(e,t){for(let a=0;a<e.length;a++){let n=e[a];if(t.name===n.mother)return R(e,n.father);if(t.name===n.father)return R(e,n.mother)}return-1}function at(e,t){let a=R(e,t);nt(a,e[a].level?e[a].level:0,e)}function nt(e,t,a){let n=["mother","father"];t++;for(let r=0;r<n.length;r++){let i=R(a,a[e][n[r]]);if(i>=0){let n=a[R(a,a[e].mother)],r=a[R(a,a[e].father)];(!a[i].level||a[i].level<t)&&(n.level=t,r.level=t),n.level<r.level?n.level=r.level:r.level<n.level&&(r.level=n.level),nt(i,t,a)}}}var rt=Object.freeze({__proto__:null,addIO:Be,copy_svg:function(e){let t=Xe(e),a=d3.select(t.get(0));return a.selectAll("text").filter(function(){return 0===d3.select(this).text().length||d3.select(this),"FontAwesome"===d3.select(this).attr("font-family")}).remove(),a.selectAll("[style]").attr("style",null),$(He(t.html()))},img_download:Pe,load_data:We,print:Ye,readBoadiceaV4:Qe,readCanRiskFile:Ze,readLinkage:Ke,save_file:qe,svg2img:je,svg_download:Ve});function it(e,t){let a=[1,2,3,4,5,6,7,8,9,"A"];for(let n=0;n<e.length;n++)if(e[n][t]){let r=a.indexOf(e[n][t]);r>-1&&a.splice(r,1)}if(a.length>0)return a[0]}function ot(e,t){if(!t.mztwin&&!t.dztwin)return;let a=t.mztwin?"mztwin":"dztwin";for(let n=0;n<e.length;n++){let r=e[n];r[a]&&t[a]===r[a]&&r.name!==t.name&&("mztwin"===a&&(r.sex=t.sex),t.yob&&(r.yob=t.yob),!t.age||0!==t.status&&t.status||(r.age=t.age))}}function lt(e){$("#age_yob_lock").removeClass("fa-lock fa-unlock-alt"),"1"===e?$("#age_yob_lock").addClass("fa-unlock-alt"):$("#age_yob_lock").addClass("fa-lock"),$("#id_age_"+e).removeClass("hidden"),$("#id_age_"+("1"===e?"0":"1")).addClass("hidden")}function st(e){$("#orig_ashk").is(":checked")?$.each(e,function(e,t){t.proband&&(t.ashkenazi=1)}):$.each(e,function(e,t){delete t.ashkenazi})}function dt(e){let t=I(e),a=$("#id_name").val(),n=ue(t),r=B(n,a);if(!r)return void console.warn("person not found when saving details");$("#"+e.targetDiv).empty();let i=$("#id_yob_0").val();i&&""!==i?r.yob=i:delete r.yob;let o=$("#id_status").find("input[type='radio']:checked");o.length>0&&(r.status=o.val());let l=["miscarriage","adopted_in","adopted_out","termination","stillbirth"];for(let e=0;e<l.length;e++){let t=l[e],a=$("#id_"+t);a.length>0&&(console.log(a.is(":checked")),a.is(":checked")?r[t]=!0:delete r[t])}let s=$("#id_sex").find("input[type='radio']:checked");s.length>0&&(r.sex=s.val(),ut(r)),st(n),$("#id_approx").is(":checked")?r.approx_diagnosis_age=!0:delete r.approx_diagnosis_age,$("#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible").each(function(){let e=this.name.indexOf("_diagnosis_age")>-1?this.name.substring(0,this.name.length-2):this.name;if($(this).val()){let t=$(this).val();if(e.indexOf("_diagnosis_age")>-1&&$("#id_approx").is(":checked")){t=ft(t);let e=parseInt($("#id_age").val());t>e&&t-e<=5&&(t=e)}r[e]=t}else delete r[e]}),$('#person_details input[type="checkbox"][name$="cancer"],input[type="checkbox"][name$="cancer2"]').each(function(){this.checked?r[$(this).attr("name")]=!0:delete r[$(this).attr("name")]}),$('#person_details select[name$="_bc_pathology"]').each(function(){"-"!==$(this).val()?r[$(this).attr("name")]=$(this).val():delete r[$(this).attr("name")]}),$('#person_details select[name$="_gene_test"]').each(function(){if("-"!==$(this).val()){let e=$('select[name="'+$(this).attr("name")+'_result"]');r[$(this).attr("name")]={type:$(this).val(),result:$(e).val()}}else delete r[$(this).attr("name")]});let d=$('#person_details select[name="hoxb13_gene_test_result"]').val();void 0!==d&&"-"!==d?r.hoxb13_gene_test={type:"T",result:d}:delete r.hoxb13_gene_test;try{$("#person_details").find("form").valid()}catch(e){console.warn("valid() not found")}ot(n,r),e.dataset=n,$(document).trigger("rebuild",[e])}function ct(){$("#id_approx").is(":checked")?($("[id$='_diagnosis_age_0']").each(function(e){if(""!==$(this).val()){let e=this.name.substring(0,this.name.length-2);$("#id_"+e+"_1").val(ft($(this).val())).prop("selected",!0)}}),$("[id$='_diagnosis_age_0']").hide(),$("[id$='_diagnosis_age_1']").show()):($("[id$='_diagnosis_age_1']").each(function(e){if(""!==$(this).val()){let e=this.name.substring(0,this.name.length-2);$("#id_"+e+"_0").val($(this).val())}}),$("[id$='_diagnosis_age_0']").show(),$("[id$='_diagnosis_age_1']").hide())}function ut(e){$("#cancer .row").show(),"M"===e.sex?(delete e.ovarian_cancer_diagnosis_age,$("[id^='id_ovarian_cancer_diagnosis_age']").closest(".row").hide(),$("[id^='id_breast_cancer2_diagnosis_age']").prop("disabled",!0)):"F"===e.sex&&(delete e.prostate_cancer_diagnosis_age,$("[id^='id_prostate_cancer_diagnosis_age']").closest(".row").hide(),$("[id^='id_breast_cancer2_diagnosis_age']").prop("disabled",!1))}function ft(e){let t=10*Math.round((e-1)/10);return e<t?t-5:t+5}$(document).on("fhChange",function(e,t){try{let e=$("#id_name").val();void 0===B(I(t),e)?$("form > fieldset").prop("disabled",!0):$("form > fieldset").prop("disabled",!1)}catch(e){console.warn(e)}}),$(document).on("change input","[id^='id_breast_cancer_diagnosis_age']",function(){let e=$(this).val(),t=$("input[name='sex']:checked");e&&""!==e&&"F"===t.val()&&$("select[id$='_bc_pathology']").prop("disabled",!1)});var ht=Object.freeze({__proto__:null,nodeclick:function(e){$("form > fieldset").prop("disabled",!1),$("#person_details").find("input[type=text], input[type=number]").val(""),$("#person_details select").val("").prop("selected",!0),"M"===e.sex||"F"===e.sex?$('input[name=sex][value="'+e.sex+'"]').prop("checked",!0):$("input[name=sex]").prop("checked",!1),ut(e),"status"in e||(e.status=0),$('input[name=status][value="'+e.status+'"]').prop("checked",!0),lt(e.status),"proband"in e?($("#id_proband").prop("checked",e.proband),$("#id_proband").prop("disabled",!0)):($("#id_proband").prop("checked",!1),$("#id_proband").prop("disabled",!("yob"in e))),"exclude"in e?$("#id_exclude").prop("checked",e.exclude):$("#id_exclude").prop("checked",!1),"yob"in e?$("#id_yob_0").val(e.yob):$("#id_yob_0").val("-"),$('select[name$="_bc_pathology"]').val("-"),$('select[name*="_gene_test"]').val("-");let t=null;try{let e=Object.keys(ce||{});e.length>0&&(t=ce[e[0]]._dataset)}catch(e){}let a=l(e,t);$("input[id^='id_sex_']").prop("disabled",!a),$("select[id$='_bc_pathology']").prop("disabled","M"===e.sex||"F"===e.sex&&!("breast_cancer_diagnosis_age"in e)),$("#id_approx").prop("checked",!!e.approx_diagnosis_age),ct();for(let t in e)"proband"!==t&&"sex"!==t&&($("#id_"+t).length?-1!==t.indexOf("_gene_test")&&null!==e[t]&&"object"==typeof e[t]?($("#id_"+t).val(e[t].type),$("#id_"+t+"_result").val(e[t].result)):$("#id_"+t).val(e[t]):-1!==t.indexOf("_diagnosis_age")&&($("#id_approx").is(":checked")?$("#id_"+t+"_1").val(ft(e[t])).prop("selected",!0):$("#id_"+t+"_0").val(e[t])));try{$("#person_details").find("form").valid()}catch(e){console.warn("valid() not found")}},save:dt,save_ashkn:function(e){let t=ue(I(e));st(t),e.dataset=t,$(document).trigger("rebuild",[e])},updateStatus:lt,update_diagnosis_age_widget:ct});function mt(e,t,a){if(!a)return;let n=e&&e.length?B(e,a):void 0;if(n)return n;let r=B(t,a);return r?(void 0===r.id&&(r.id=R(t,a)),{data:r,depth:K(t,a)}):void 0}function pt(e,t,a,n,r){if(r&&-1===$.inArray(r,["mztwin","dztwin"]))return new Error("INVALID TWIN TYPE SET: "+r);void 0===n&&(n=1);let i,o,l,s=V(e,t);if(0===s.length){let a=gt(e,t,"F"===t.sex?"M":"F","F"===t.sex);a.noparents=!0,i=a.name,o=R(e,t.name)+1}else{let a=s[0];i=a.father===t.name?a.mother:a.father,o=R(e,a.name)}r&&(l=it(e,r));let d=[];for(let s=0;s<n;s++){let n={name:le(4),sex:a,mother:"F"===t.sex?t.name:i,father:"F"===t.sex?i:t.name};e.splice(o,0,n),r&&(n[r]=l),d.push(n)}return d}function gt(e,t,a,n,r,i=!1){if(r&&-1===$.inArray(r,["mztwin","dztwin"]))return new Error("INVALID TWIN TYPE SET: "+r);let o={name:le(4),sex:a};t.top_level?o.top_level=!0:i||(o.mother=t.mother,o.father=t.father);let l=R(e,t.name);return r&&function(e,t,a,n){!t[n]&&(t[n]=it(e,n),!t[n])||(a[n]=t[n],t.yob&&(a.yob=t.yob),!t.age||"0"!==t.status&&t.status||(a.age=t.age))}(e,e[l],o,r),n?l>0&&l--:l++,e.splice(l,0,o),o}function _t(e,a,n){let r,i,o=ce[e.targetDiv],l=o?ae(o):[],s=mt(l,a,n);if(!s)throw t("Person "+n+" not found when adding parents");let d,c,u=s.data,f=s.depth||K(a,u.name),h=-101,m=V(a,u);if(m.length>0){d=m[0].mother===u.name?m[0].father:m[0].mother;let e=mt(l,a,d);h=e&&void 0!==e.data.id?e.data.id:R(a,d)}if(1===f)for(r={name:le(4),sex:"F",top_level:!0},i={name:le(4),sex:"M",top_level:!0},a.splice(0,0,r),a.splice(0,0,i),c=0;c<a.length;c++)!a[c].top_level&&2!==K(a,a[c].name)||a[c].name===r.name||a[c].name===i.name||(delete a[c].top_level,a[c].noparents=!0,a[c].mother=r.name,a[c].father=i.name);else{let t=(s.data.mother,s.data.mother);t=t&&t.name?t.name:t;let n=(s.data.father,s.data.father);n=n&&n.name?n.name:n;let o=mt(l,a,t),d=mt(l,a,n),f=J(a,u),m=1e4,p=s.data.id;for(c=0;c<f.length;c++){let e=mt(l,a,f[c].name),t=e&&void 0!==e.data.id?e.data.id:R(a,f[c].name);t<m&&t>s.data.id&&(m=t),t<p&&(p=t)}let g,_=p>=s.data.id||h===p&&m<1e4;e.DEBUG&&console.log("lid="+p+" rid="+m+" nid="+s.data.id+" ADD_LHS="+_),g=!_&&d.data.id>o.data.id||_&&d.data.id<o.data.id?R(a,u.father):R(a,u.mother);let y=a[g];i=gt(a,y,"M",_),r=gt(a,y,"F",_);let b=R(a,i.name),x=R(a,r.name);if(b>x){let e=a[b];a[b]=a[x],a[x]=e}let v=W(a,u),$=s.data.id;for(c=0;c<v.length;c++){let t=mt(l,a,v[c].name),n=t&&void 0!==t.data.id?t.data.id:R(a,v[c].name);if(e.DEBUG&&console.log("ORPHAN="+c+" "+v[c].name+" "+($<n&&n<m)+" nid="+$+" oid="+n+" rid="+m),(_||$<n)&&n<m){let e=R(a,v[c].name);a[e].mother=r.name,a[e].father=i.name}}}2===f&&(r.top_level=!0,i.top_level=!0);let p=R(a,u.name);if(a[p].mother=r.name,a[p].father=i.name,delete a[p].noparents,"parent_node"in u){let e=a[R(a,d)];"noparents"in e&&(e.mother=r.name,e.father=i.name)}}function yt(e,a,n){let r=ce[e.targetDiv],i=mt(r?ae(r):[],a,n);if(!i)throw t("Person "+n+" not found when adding partner");let o={name:le(4),sex:"F"===i.data.sex?"M":"F"};i.data.top_level?o.top_level=!0:(o.mother=i.data.mother,o.father=i.data.father),o.noparents=!0;let l=R(a,i.data.name);"F"===i.data.sex?l>0&&l--:l++,a.splice(l,0,o);let s={name:le(4),sex:"M"};s.mother="F"===i.data.sex?i.data.name:o.name,s.father="F"===i.data.sex?o.name:i.data.name;let d=R(a,i.data.name)+2;a.splice(d,0,s)}function bt(e,t,a){let n,r,i=Z(ae(e),t.depth,a);for(let e=0;e<i.length;e++)i[e].x<t.x&&(n=i[e]),!r&&i[e].x>t.x&&(r=i[e]);return[n,r]}function xt(e,t,a,r){let i,l,s,d=ce[a.targetDiv],c=ae(d),f=[];if(void 0===t.id){let e=B(c,t.name);void 0!==e&&(t=e.data)}if(t.parent_node)for(i=0;i<t.parent_node.length;i++){let a=t.parent_node[i],n=[B(e,a.mother.name),B(e,a.father.name)];for(l=0;l<n.length;l++)(n[l].name===t.name||void 0!==n[l].noparents||n[l].top_level)&&(e.splice(R(e,n[l].name),1),f.push(n[l]));let r=a.children,o=$.map(r,function(e,t){return e.name});for(l=0;l<r.length;l++){let t=B(e,r[l].name);if(t){t.noparents=!0;let a,n=H(e,t);if(n.length>0&&(a=B(e,n[0])),a&&a.mother!==t.mother)t.mother=a.mother,t.father=a.father;else if(a){let e=bt(d,B(c,t.name),o);t.mother=e[0]?e[0].data.mother:e[1]?e[1].data.mother:null,t.father=e[0]?e[0].data.father:e[1]?e[1].data.father:null}else e.splice(R(e,t.name),1)}}}else{let a=R(e,t.name);a>=0&&e.splice(a,1)}for(i=0;i<f.length;i++){let t=f[i];if(J(e,t).length<1){let n=B(c,t.name),r=[];for(r=n&&"function"==typeof n.ancestors?n.ancestors():ee(e,t),l=0;l<r.length;l++){let t=r[l],n=t&&t.data?t.data:t;a.DEBUG&&console.log(n);let i=n&&n.mother?n.mother.name?n.mother.name:n.mother:null,o=n&&n.father?n.father.name?n.father.name:n.father:null;if(i&&o){a.DEBUG&&console.log("DELETE ",i,o);let t=R(e,i),n=R(e,o);t>=0&&e.splice(t,1),n>=0&&e.splice(n,1)}}}}!function(e){let t=["mztwin","dztwin"];for(let a=0;a<e.length;a++)for(let n=0;n<t.length;n++){let r=t[n];if(e[a][r]){let t=0;for(let n=0;n<e.length;n++)e[n][r]===e[a][r]&&t++;t<2&&delete e[a][r]}}}(e);let h=a.messages||u;try{let t=$.extend({},a);t.dataset=ue(e),n(t),s=o(e)}catch(e){throw h("Warning","Deletion of this pedigree member is disallowed."),e}return s.length>0&&0===o(a.dataset).length?(console.error("individuals unconnected to pedigree ",s),void h("Warning","Deleting this will split the pedigree. Continue?",r,a,e)):(r&&r(a,e),e)}let vt,$t,wt=!1,zt=!1;function kt(e,t){let a=parseInt($("body").css("font-size")),n=d3.select(".diagram");n.append("rect").attr("class","popup_selection").attr("rx",6).attr("ry",6).attr("transform","translate(-1000,-100)").attr("opacity",0).attr("width",7.9*a).attr("height",2*a).attr("stroke","darkgrey").attr("fill","white");let r=n.append("text").attr("font-family","FontAwesome").attr("opacity",0).attr("font-size","1.1em").attr("class","popup_selection fa-square persontype").attr("transform","translate(-1000,-100)").attr("x",a/3).attr("y",1.5*a).text(" ").append("svg:title").text("add male"),i=n.append("text").attr("font-family","FontAwesome").attr("opacity",0).attr("font-size","1.1em").attr("class","popup_selection fa-circle persontype").attr("transform","translate(-1000,-100)").attr("x",1.71*a).attr("y",1.5*a).text(" ").append("svg:title").text("add female");n.append("text").attr("font-family","FontAwesome").attr("opacity",0).attr("font-size","1.1em").attr("transform","translate(-1000,-100)").attr("x",.065*a).attr("y",.065*-a).attr("class","popup_selection fa-unspecified popup_selection_rotate45 persontype").text(" ").append("svg:title").text("add unspecified"),n.append("text").attr("font-family","FontAwesome").attr("opacity",0).attr("font-size","1.6em").attr("transform","translate(-1000,-100)").attr("class","popup_selection fa-angle-up persontype dztwin").attr("x",4.62*a).attr("y",1.5*a).text(" ").append("svg:title").text("add dizygotic/fraternal twins"),n.append("text").attr("font-family","FontAwesome").attr("opacity",0).attr("font-size","1.6em").attr("transform","translate(-1000,-100)").attr("class","popup_selection fa-caret-up persontype mztwin").attr("x",6.4*a).attr("y",1.5*a).text(" ").append("svg:title").text("add monozygotic/identical twins");let o={};d3.selectAll(".persontype").on("click",function(){if(zt)return void(e.DEBUG&&console.log("Widget click ignored: action already in progress"));zt=!0;let t,a,n=ue(I(e)),r=d3.select(this).classed("mztwin"),i=d3.select(this).classed("dztwin");if(r?(a=o.node.datum().data.sex,t="mztwin"):(a=d3.select(this).classed("fa-square")?"M":d3.select(this).classed("fa-circle")?"F":"U",t=i?"dztwin":void 0),"addsibling"===o.type)gt(n,o.node.datum().data,a,!1,t);else{if("addchild"!==o.type)return void(zt=!1);pt(n,o.node.datum().data,t?"U":a,t?2:1,t)}e.dataset=n,$(document).trigger("rebuild",[e]),d3.selectAll(".popup_selection").attr("opacity",0),o={},setTimeout(()=>{zt=!1},300)}).on("mouseover",function(){o.node&&o.node.select("rect").attr("opacity",.2),d3.selectAll(".popup_selection").attr("opacity",1),"addsibling"===o.type?d3.select(this).classed("fa-square")?r.text("add brother"):i.text("add sister"):"addchild"===o.type&&(d3.select(this).classed("fa-square")?r.text("add son"):i.text("add daughter"))}),d3.selectAll(".popup_selection").on("mouseout",function(){void 0!==o.node&&-1===f.indexOf(o.node.datum())&&o.node.select("rect").attr("opacity",0),d3.selectAll(".popup_selection").attr("opacity",0)}),function(e){function t(){vt=$t,d3.selectAll(".line_drag_selection").attr("stroke","darkred")}function a(t){if($t&&vt.data.name!==$t.data.name&&vt.data.sex!==$t.data.sex){let t={name:le(4),sex:"U",mother:"F"===vt.data.sex?vt.data.name:$t.data.name,father:"F"===vt.data.sex?$t.data.name:vt.data.name},a=ue(e.dataset);e.dataset=a;let n=R(e.dataset,vt.data.name)+1;e.dataset.splice(n,0,t),$(document).trigger("rebuild",[e])}Ot(0,0,0,0),d3.selectAll(".line_drag_selection").attr("stroke","black"),vt=void 0}function n(t){t.sourceEvent.stopPropagation();let a=t.dx,n=t.dy,r=parseFloat(d3.select(this).attr("x2"))+a,i=parseFloat(d3.select(this).attr("y2"))+n;Ot(e.symbol_size-10,0,r,i)}d3.select(".diagram").append("line").attr("class","line_drag_selection").attr("stroke-width",6).attr("stroke-dasharray","2, 1").attr("stroke","black").call(d3.drag().on("start",t).on("drag",n).on("end",a)).append("svg:title").text("Hold Shift and drag to create consanguineous partners (blood-related)"),Ot(0,0,0,0)}(e),t.filter(function(t){return!(t.data.hidden&&!e.DEBUG)}).append("rect").attr("class","indi_rect").attr("rx",6).attr("ry",6).attr("x",function(t){return-.75*e.symbol_size}).attr("y",function(t){return-e.symbol_size}).attr("width",1.5*e.symbol_size+"px").attr("height",2*e.symbol_size+"px").attr("stroke","black").attr("stroke-width",.7).attr("opacity",0).attr("fill","lightgrey");let s=function(t){return c-.75*e.symbol_size},d=e.symbol_size-2,c=0,u={addchild:{text:"",title:"add child",fx:s,fy:d},addsibling:{text:"",title:"add sibling",fx:s,fy:d},addpartner:{text:"",title:"add partner",fx:s,fy:d},addparents:{text:"",title:"add parents",fx:-.75*e.symbol_size,fy:11-e.symbol_size},delete:{text:"X",title:"delete",fx:e.symbol_size/2-1,fy:12-e.symbol_size,styles:{"font-weight":"bold",fill:"darkred","font-family":"monospace"}}};e.edit&&(u.settings={text:"",title:"settings",fx:-a/2+2,fy:11-e.symbol_size});for(let a in u){let n=t.filter(function(t){return!(t.data.hidden&&!e.DEBUG||(void 0===t.data.mother||t.data.noparents)&&"addsibling"===a||void 0===t.data.parent_node&&"addchild"===a||void 0===t.data.noparents&&void 0===t.data.top_level&&"addparents"===a)}).append("text").attr("class",a).attr("opacity",0).attr("font-family","FontAwesome").attr("xx",function(e){return e.x}).attr("yy",function(e){return e.y}).attr("x",u[a].fx).attr("y",u[a].fy).attr("font-size","0.85em").text(u[a].text);if("styles"in u[a])for(let e in u[a].styles)n.attr(e,u[a].styles[e]);n.append("svg:title").text(u[a].title),c+=17}d3.selectAll(".addsibling, .addchild").on("mouseover",function(){let e=d3.select(this).attr("class");d3.selectAll(".popup_selection").attr("opacity",1),o={node:d3.select(this.parentNode),type:e};let t=parseInt(d3.select(this).attr("xx"))+parseInt(d3.select(this).attr("x")),n=parseInt(d3.select(this).attr("yy"))+parseInt(d3.select(this).attr("y"));d3.selectAll(".popup_selection").attr("transform","translate("+t+","+(n+2)+")"),d3.selectAll(".popup_selection_rotate45").attr("transform","translate("+(t+3*a)+","+(n+1.2*a)+") rotate(45)")}),d3.selectAll(".addchild, .addpartner, .addparents, .delete, .settings").on("click",function(t){if(t.stopPropagation(),zt)return void(e.DEBUG&&console.log("Widget action ignored: action already in progress"));let a,n=d3.select(this).attr("class"),r=d3.select(this.parentNode).datum();e.DEBUG&&console.log(n),"settings"!==n&&(zt=!0),"settings"===n?"function"==typeof e.edit?e.edit(e,r):function(e,t){$("#node_properties").dialog({autoOpen:!1,title:t.data.display_name,width:$(window).width()>400?450:$(window).width()-30});let a="<table id='person_details' class='table'>";a+="<tr><td style='text-align:right'>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value="+(t.data.name?t.data.name:"")+"></td></tr>",a+="<tr><td style='text-align:right'>Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value="+(t.data.display_name?t.data.display_name:"")+"></td></tr>",a+="<tr><td style='text-align:right'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:7em' value="+(t.data.age?t.data.age:"")+"></td></tr>",a+="<tr><td style='text-align:right'>Year Of Birth</td><td><input class='form-control' type='number' id='id_yob' min='1900' max='2050' name='yob' style='width:7em' value="+(t.data.yob?t.data.yob:"")+"></td></tr>";let n=I(e);const r=l(t.data,n),i=r?"":"disabled",o='<label class="radio-inline"><input type="radio" name="sex" ';a+='<tr><td colspan="2" id="id_sex">'+o+'value="M" '+("M"===t.data.sex?"checked ":" ")+i+">Male</label>"+o+'value="F" '+("F"===t.data.sex?"checked ":" ")+i+">Female</label>"+o+'value="U" '+i+">Unknown</label></td></tr>",a+='<tr><td colspan="2" id="id_status"><label class="checkbox-inline"><input type="radio" name="status" value="0" '+(0===parseInt(t.data.status)?"checked":"")+'>&thinsp;Alive</label><label class="checkbox-inline"><input type="radio" name="status" value="1" '+(1===parseInt(t.data.status)?"checked":"")+">&thinsp;Deceased</label></td></tr>",$("#id_status input[value='"+t.data.status+"']").prop("checked",!0);let s=["adopted_in","adopted_out","miscarriage","stillbirth","termination"];a+='<tr><td colspan="2"><strong>Reproduction:</strong></td></tr>',a+='<tr><td colspan="2">';for(let e=0;e<s.length;e++){let n=s[e];2===e&&(a+='</td></tr><tr><td colspan="2">'),a+='<label class="checkbox-inline"><input type="checkbox" id="id_'+n+'" name="'+n+'" value="0" '+(t.data[n]?"checked":"")+">&thinsp;"+Et(n.replace("_"," "))+"</label>"}a+="</td></tr>";let d=["children","name","parent_node","top_level","id","noparents","level","age","sex","status","display_name","mother","father","yob","mztwin","dztwin"];$.merge(d,s),a+='<tr><td colspan="2"><strong>Age of Diagnosis:</strong></td></tr>',$.each(e.diseases,function(n,r){d.push(r.type+"_diagnosis_age");let i='&thinsp;<span style="padding-left:5px;background:'+e.diseases[n].colour+'"></span>',o=t.data[r.type+"_diagnosis_age"];a+="<tr><td style='text-align:right'>"+Et(r.type.replace("_"," "))+i+"&nbsp;</td><td><input class='form-control' id='id_"+r.type+"_diagnosis_age_0' max='110' min='0' name='"+r.type+"_diagnosis_age_0' style='width:5em' type='number' value='"+(void 0!==o?o:"")+"'></td></tr>"}),a+='<tr><td colspan="2" style="line-height:1px;"></td></tr>',$.each(t.data,function(e,t){if(-1===$.inArray(e,d)){let n=Et(e);!0===t||!1===t?a+="<tr><td style='text-align:right'>"+n+"&nbsp;</td><td><input type='checkbox' id='id_"+e+"' name='"+e+"' value="+t+" "+(t?"checked":"")+"></td></tr>":e.length>0&&(a+="<tr><td style='text-align:right'>"+n+"&nbsp;</td><td><input type='text' id='id_"+e+"' name='"+e+"' value="+t+"></td></tr>")}}),a+="</table>",$("#node_properties").html(a),$("#node_properties").dialog("open"),$("#node_properties input[type=radio], #node_properties input[type=checkbox], #node_properties input[type=text], #node_properties input[type=number]").on("change",function(){dt(e)})}(e,r):"delete"===n?(a=ue(I(e)),xt(a,r.data,e,At)):"addparents"===n?(a=ue(I(e)),e.dataset=a,_t(e,a,r.data.name),$(document).trigger("rebuild",[e])):"addpartner"===n&&(a=ue(I(e)),yt(e,a,r.data.name),e.dataset=a,$(document).trigger("rebuild",[e])),$(document).trigger("fhChange",[e]),"settings"!==n&&setTimeout(()=>{zt=!1},300)});let f=[];t.filter(function(e){return!e.data.hidden}).on("click",function(t,a){t.ctrlKey?-1===f.indexOf(a)?f.push(a):f.splice(f.indexOf(a),1):f=[a],"nodeclick"in e&&(e.nodeclick(a.data),d3.selectAll(".indi_rect").attr("opacity",0),d3.selectAll(".indi_rect").filter(function(e){return-1!==f.indexOf(e)}).attr("opacity",.5))}).on("mouseover",function(t,a){t.stopPropagation(),$t=a,vt?vt.data.name!==$t.data.name&&vt.data.sex!==$t.data.sex&&d3.select(this).select("rect").attr("opacity",.2):(d3.select(this).select("rect").attr("opacity",.2),d3.select(this).selectAll(".addchild, .addsibling, .addpartner, .addparents, .delete, .settings").attr("opacity",1),d3.select(this).selectAll(".indi_details").attr("opacity",0),Ot(e.symbol_size-10,0,e.symbol_size-2,0,a.x+","+(a.y+2)),wt&&(d3.select(".pedigree_form svg").style("cursor","crosshair"),d3.selectAll(".line_drag_selection").attr("stroke","darkred").attr("stroke-width",8)))}).on("mouseout",function(t){if(vt)return;d3.select(this).selectAll(".addchild, .addsibling, .addpartner, .addparents, .delete, .settings").attr("opacity",0),-1===f.indexOf(t)&&d3.select(this).select("rect").attr("opacity",0),d3.select(this).selectAll(".indi_details").attr("opacity",1),wt&&(d3.select(".pedigree_form svg").style("cursor","default"),d3.selectAll(".line_drag_selection").attr("stroke","black").attr("stroke-width",6)),$t=void 0;let a=d3.pointer(t)[0],n=d3.pointer(t)[1];n<.8*e.symbol_size&&d3.selectAll(".popup_selection").attr("opacity",0),vt||(Math.abs(n)>.25*e.symbol_size||Math.abs(n)<-.25*e.symbol_size||a<.2*e.symbol_size)&&Ot(0,0,0,0)})}function At(e,t){e.dataset=t,$(document).trigger("rebuild",[e])}function Ot(e,t,a,n,r){r&&d3.selectAll(".line_drag_selection").attr("transform","translate("+r+")"),d3.selectAll(".line_drag_selection").attr("x1",e).attr("y1",t).attr("x2",a).attr("y2",n)}function Et(e){return e.charAt(0).toUpperCase()+e.slice(1)}$(document).on("keydown keyup",function(e){let t=wt;wt=e.shiftKey,t!==wt&&(wt&&$t&&!vt?(d3.select(".pedigree_form svg").style("cursor","crosshair"),d3.selectAll(".line_drag_selection").attr("stroke","darkred").attr("stroke-width",8)):wt||vt||(d3.select(".pedigree_form svg").style("cursor","default"),d3.selectAll(".line_drag_selection").attr("stroke","black").attr("stroke-width",6)))});var Ft=Object.freeze({__proto__:null,addWidgets:kt,addchild:pt,addparents:_t,addpartner:yt,addsibling:gt,delete_node_dataset:xt});function Dt(e,t){St(e,t,-.4*e.symbol_size,-.1*e.symbol_size,function(t){return e.DEBUG?("display_name"in t.data?t.data.display_name:t.data.name)+"  "+t.data.id:"display_name"in t.data?t.data.display_name:""},void 0,["display_name"]);let n=parseInt(function(e){let t=e.font_size;if(t===parseInt(t,10))return t;if(t.indexOf("px")>-1)return t.replace("px","");if(-1===t.indexOf("em"))return t;return t=parseFloat(t.replace("em","")),parseFloat(getComputedStyle($("#"+e.targetDiv).get(0)).fontSize)*t-1}(e))+4,r=function(e){return!(e.data.age&&e.data.yob&&e.data.status)||a(e.data.age,e.data.yob,e.data.status)};for(let a=0;a<e.labels.length;a++){let i=e.labels[a],o=Array.isArray(i)?i:[i];(o.indexOf("age")>-1||o.indexOf("yob")>-1)&&St(e,t,-e.symbol_size,function(e){return Nt(e,o,n)},function(e){return It(e,o)},"indi_details",o,r)}for(let a=0;a<e.diseases.length;a++){let r=e.diseases[a].type;St(e,t,-e.symbol_size,function(e){return Nt(e,[r],n)},function(e){let t=r.replace("_"," ").replace("cancer","ca.");return r+"_diagnosis_age"in e.data?t+": "+e.data[r+"_diagnosis_age"]:""},"indi_details",[r])}for(let a=0;a<e.labels.length;a++){let r=e.labels[a],i=Array.isArray(r)?r:[r];-1===i.indexOf("age")&&-1===i.indexOf("yob")&&St(e,t,-e.symbol_size,function(e){return Nt(e,i,n)},function(e){return It(e,i)},"indi_details",i)}}function It(e,t){let a="";for(let n=0;n<t.length;n++){let r=t[n];if(e.data[r])if("alleles"===r){let t=e.data.alleles.split(";");for(let e=0;e<t.length;e++)""!==t[e]&&(a+=t[e]+";")}else if("age"===r)a+=e.data[r]+"y ";else if("stillbirth"===r)a+="SB";else if(r.match("_gene_test$")&&"result"in e.data[r]){let t=e.data[r].result.toUpperCase();"-"!==t&&(a+=r.replace("_gene_test","").toUpperCase(),a+="P"===t?"+ ":"N"===t?"- ":" ")}else if(r.match("_bc_pathology$")){let t=e.data[r].toUpperCase();a+=r.replace("_bc_pathology","").toUpperCase(),a+="P"===t?"+ ":"N"===t?"- ":" "}else a+=e.data[r]}if(""!==a)return a}function Nt(e,t,a){if(Mt(e,t))return e.y_offset=e.y_offset?e.y_offset+a:2.35*a,e.y_offset}function Mt(e,t){for(let a=0;a<t.length;a++)if(fe(t[a],e.data))return!0;return!1}function St(e,t,a,n,r,i,o,l){t.filter(function(e){return!e.data.hidden&&(!o||Mt(e,o))}).append("text").attr("class",i?i+" ped_label":"ped_label").attr("x",a).attr("y",n).attr("font-family",e.font_family).attr("font-size",e.font_size).attr("font-weight",e.font_weight).attr("fill",function(e){return l&&!l(e)?"#d32f2f":null}).text(r).append("title").text(function(e){return l&&!l(e)?"Warning: Age and year of birth are inconsistent":""})}function Ct(e,t,a){if(a>=e.length)for(var n=a-e.length+1;n--;)e.push(void 0);return e.splice(a,0,e.splice(t,1)[0]),e}let Ut=!1;function Tt(e){let a=$.extend({targetDiv:"pedigree_edit",dataset:[{name:"m21",display_name:"father",sex:"M",top_level:!0},{name:"f21",display_name:"mother",sex:"F",top_level:!0},{name:"ch1",display_name:"me",sex:"F",mother:"f21",father:"m21",proband:!0}],width:600,height:400,symbol_size:35,zoomSrc:["wheel","button"],zoomIn:1,zoomOut:1,dragNode:!0,showWidgets:!0,diseases:[{type:"breast_cancer",colour:"#F68F35"},{type:"breast_cancer2",colour:"pink"},{type:"ovarian_cancer",colour:"#306430"},{type:"pancreatic_cancer",colour:"#4289BA"},{type:"prostate_cancer",colour:"#D5494A"}],labels:["stillbirth",["age","yob"],"alleles",["brca1_gene_test","brca2_gene_test","palb2_gene_test","chek2_gene_test","atm_gene_test"],["rad51d_gene_test","rad51c_gene_test","brip1_gene_test","hoxb13_gene_test"],["er_bc_pathology","pr_bc_pathology","her2_bc_pathology","ck14_bc_pathology","ck56_bc_pathology"]],keep_proband_on_reset:!1,font_size:".75em",font_family:"Helvetica",font_weight:700,background:"#FAFAFA",node_background:"#fdfdfd",validate:!0,DEBUG:!1,VERBOSE:!1},e);0===$("#fullscreen").length&&(ve(a),Be(a)),-1===D(a)&&F(a),function(e){let t=O(e),a=D(e),n="#"+e.btn_target;a<=t?$(n+" .fa-redo").addClass("fg-grey"):$(n+" .fa-redo").removeClass("fg-grey"),t>1?$(n+" .fa-undo").removeClass("fg-grey"):$(n+" .fa-undo").addClass("fg-grey")}(a),n(a),a.dataset=function(e){for(let t=0;t<e.length;t++)2===K(e,e[t].name)&&(e[t].top_level=!0);let t=[],a=[];for(let n=0;n<e.length;n++){let r=e[n];if("top_level"in r&&-1===$.inArray(r.name,a)){a.push(r.name),t.push(r);let n=H(e,r);for(let r=0;r<n.length;r++)-1===$.inArray(n[r],a)&&(a.push(n[r]),t.push(B(e,n[r])))}}let n=$.map(e,function(e,t){return"top_level"in e&&e.top_level?null:e});for(let e=t.length;e>0;--e)n.unshift(t[e-1]);return n}(a.dataset),a.VERBOSE&&f(a);let r=m(a),i=d3.select("#"+a.targetDiv).append("svg:svg").attr("width",r.width).attr("height",r.height);i.append("rect").attr("width","100%").attr("height","100%").attr("rx",6).attr("ry",6).attr("stroke","darkgrey").attr("fill",a.background).attr("stroke-width",1);let o=i.append("g").attr("class","diagram");a.DEBUG&&(i.append("rect").attr("x",r.width-120).attr("y",5).attr("width",110).attr("height",25).attr("fill","#ff9800").attr("stroke","#f57c00").attr("stroke-width",2).attr("rx",3),i.append("text").attr("x",r.width-65).attr("y",22).attr("text-anchor","middle").attr("fill","white").attr("font-weight","bold").attr("font-size","12px").text("DEBUG MODE"));let l={name:"hidden_root",id:0,hidden:!0,children:$.map(a.dataset,function(e,t){return"top_level"in e&&e.top_level?e:null})},s=se(a,l,l)[0],d=d3.hierarchy(l);d._dataset=a.dataset,ce[a.targetDiv]=d;let c=p(a);a.DEBUG&&console.log("opts.width="+r.width+" width="+c.width+" opts.height="+r.height+" height="+c.height);let u=d3.tree().separation(function(e,t){return e.parent===t.parent||e.data.hidden||t.data.hidden?1.2:2.2}).size([c.width,c.height])(d.sort(function(e,t){return e.data.id-t.data.id})),h=u.descendants();if($.map(a.dataset,function(e,t){return e.hidden?null:e}).length!==a.dataset.length)throw t("NUMBER OF VISIBLE NODES DIFFERENT TO NUMBER IN THE DATASET");re(a,u,h);let g=Q(h,s),_=function(e,t){let a=[];for(let n=0;n<t.length;n++){let r=Lt(e,t[n]);r&&(a.push({node:t[n],clash:r}),e.DEBUG&&console.log("CLASH :: "+t[n].mother.data.name+" "+t[n].father.data.name,r))}return a}(a,g),y=o.selectAll(".node").data(u.descendants()).enter().append("g").attr("transform",function(e,t){return"translate("+e.x+","+e.y+")"});y.filter(function(e){return!e.data.hidden}).append("path").attr("shape-rendering","geometricPrecision").attr("transform",function(e){return Rt(e.data.sex)||e.data.miscarriage||e.data.termination?"":"rotate(45)"}).attr("d",d3.symbol().size(function(e){return a.symbol_size*a.symbol_size+2}).type(function(e){return e.data.miscarriage||e.data.termination?d3.symbolTriangle:"F"===e.data.sex?d3.symbolCircle:d3.symbolSquare})).attr("stroke",function(e){return e.data.age&&e.data.yob&&!e.data.exclude?"#303030":"grey"}).attr("stroke-width",function(e){return e.data.age&&e.data.yob&&!e.data.exclude?".3em":".1em"}).attr("stroke-dasharray",function(e){return e.data.exclude?"3, 3":null}).attr("fill","none"),y.filter(function(e){return!(e.data.hidden&&!a.DEBUG)}).append("clipPath").attr("id",function(e){return e.data.name}).append("path").attr("class","node").attr("transform",function(e){return Rt(e.data.sex)||e.data.miscarriage||e.data.termination?"":"rotate(45)"}).attr("d",d3.symbol().size(function(e){return e.data.hidden?a.symbol_size*a.symbol_size/5:a.symbol_size*a.symbol_size}).type(function(e){return e.data.miscarriage||e.data.termination?d3.symbolTriangle:"F"===e.data.sex?d3.symbolCircle:d3.symbolSquare}));let b=y.filter(function(e){return!(e.data.hidden&&!a.DEBUG)}).selectAll("pienode").data(function(e){let t=0,n=$.map(a.diseases,function(n,r){return fe(a.diseases[r].type,e.data)?(t++,1):0});return 0===t&&(n=[1]),[$.map(n,function(a,n){return{cancer:a,ncancers:t,id:e.data.name,sex:e.data.sex,proband:e.data.proband,hidden:e.data.hidden,affected:e.data.affected,exclude:e.data.exclude}})]}).enter().append("g");b.selectAll("path").data(d3.pie().value(function(e){return e.cancer})).enter().append("path").attr("clip-path",function(e){return"url(#"+e.data.id+")"}).attr("class","pienode").attr("d",d3.arc().innerRadius(0).outerRadius(a.symbol_size)).attr("fill",function(e,t){return e.data.exclude?"lightgrey":0===e.data.ncancers?e.data.affected?"darkgrey":a.node_background:a.diseases[t].colour}),y.filter(function(e){return!e.data.hidden&&(e.data.adopted_in||e.data.adopted_out)}).append("path").attr("d",function(e){let t=-.66*a.symbol_size,n=-.64*a.symbol_size,r=a.symbol_size/4;return Bt(t,n,r,a)+Bt(-t,n,-r,a)}).attr("stroke",function(e){return e.data.age&&e.data.yob&&!e.data.exclude?"#303030":"grey"}).attr("stroke-width",function(e){return".1em"}).attr("stroke-dasharray",function(e){return e.data.exclude?"3, 3":null}).attr("fill","none"),y.filter(function(e){return"1"===e.data.status||1===e.data.status}).append("line").attr("stroke","black").attr("x1",function(e,t){return-.6*a.symbol_size}).attr("y1",function(e,t){return.6*a.symbol_size}).attr("x2",function(e,t){return.6*a.symbol_size}).attr("y2",function(e,t){return-.6*a.symbol_size}),Dt(a,y),a.showWidgets&&kt(a,y);let x={},v=function(e,t,a,n,r,i){let o=function(e,t){return e+1<t?o(++e):e},l="";for(let s=0;s<e.length;s++){let d=o(s,e.length),c=e[s]-t-i,u=e[d]+t+i;r.x>c&&r.x<u&&(r.y=n),l+="L"+c+","+(a-i)+"L"+c+","+(n-i)+"L"+u+","+(n-i)+"L"+u+","+(a-i),s=d}return l};s=o.selectAll(".partner").data(g).enter().insert("path","g").attr("fill","none").attr("stroke","#000").attr("shape-rendering","auto").attr("d",function(e,t){let n,r,i,o=te(B(h,e.mother.data.name),B(h,e.father.data.name),a),l=e.mother.data.divorced&&e.mother.data.divorced===e.father.data.name,s=e.mother.x<e.father.x?e.mother.x:e.father.x,d=e.mother.x<e.father.x?e.father.x:e.mother.x,c=e.mother.y,u=Lt(a,e),f="";if(u){e.mother.depth in x?x[e.mother.depth]+=4:x[e.mother.depth]=4,c-=x[e.mother.depth],r=x[e.mother.depth]+a.symbol_size/2+2;let t=e.mother.data.parent_node,o=t[0];for(let a=0;a<t.length;a++)t[a].father.name===e.father.data.name&&t[a].mother.name===e.mother.data.name&&(o=t[a].name);i=B(h,o),i.y=c,u.sort(function(e,t){return e-t}),n=c-a.symbol_size/2-3,f=v(u,r,c,n,i,0)}let m="";if(l&&!u&&(m="M"+(s+.66*(d-s)+6)+","+(c-6)+"L"+(s+.66*(d-s)-6)+","+(c+6)+"M"+(s+.66*(d-s)+10)+","+(c-6)+"L"+(s+.66*(d-s)-2)+","+(c+6)),o){c=e.mother.x<e.father.x?e.mother.y:e.father.y,n=e.mother.x<e.father.x?e.father.y:e.mother.y;let t=3;if(Math.abs(c-n)>.1)return"M"+s+","+c+"L"+d+","+n+"M"+s+","+(c-t)+"L"+d+","+(n-t);return"M"+s+","+c+f+"L"+d+","+c+"M"+s+","+(c-t)+(u?v(u,r,c,n,i,t):"")+"L"+d+","+(c-t)+m}return"M"+s+","+c+f+"L"+d+","+c+m}),_.length>0?(s.each(function(e){_.some(t=>t.node.mother.data.name===e.mother.data.name&&t.node.father.data.name===e.father.data.name)&&d3.select(this).attr("stroke","#D5494A").attr("stroke-width",2.5).attr("stroke-dasharray","5,5").append("title").text(" Avertissement : Ce lien croise d'autres liens de partenaires. Le trac a t ajust pour viter les chevauchements.")}),a.DEBUG||($("#"+a.targetDiv).parent().find(".pedigree-warning").remove(),$("#"+a.targetDiv).parent().prepend('<div class="pedigree-warning" style="background:#FFF3CD;border:1px solid #FFC107;padding:10px;margin-bottom:10px;border-radius:4px;font-size:14px;"><strong> Avertissement :</strong> '+_.length+' lien(s) de partenaires se croisent. Les liens en <span style="color:#D5494A;font-weight:bold;">rouge pointill</span> ont t ajusts pour viter les chevauchements.</div>'))):$("#"+a.targetDiv).parent().find(".pedigree-warning").remove(),o.selectAll(".link").data(d.links(u.descendants())).enter().filter(function(e){return a.DEBUG||void 0===e.target.data.noparents&&null!==e.source.parent&&!e.target.data.hidden}).insert("path","g").attr("fill","none").attr("stroke-width",function(e,t){return void 0!==e.target.data.noparents||null===e.source.parent||e.target.data.hidden?1:a.DEBUG?2:1}).attr("stroke",function(e,t){return void 0!==e.target.data.noparents||null===e.source.parent||e.target.data.hidden?"pink":"#000"}).attr("stroke-dasharray",function(e,t){if(!e.target.data.adopted_in)return null;let n=Math.abs(e.source.y-(e.source.y+e.target.y)/2),r=[n,0,Math.abs(e.source.x-e.target.x),0];Y(a.dataset,e.target.data).length>=1&&(n*=3);for(let e=0;e<n;e+=10)$.merge(r,[5,5]);return r}).attr("shape-rendering",function(e,t){return e.target.data.mztwin||e.target.data.dztwin?"geometricPrecision":"auto"}).attr("d",function(e,t){if(e.target.data.mztwin||e.target.data.dztwin){let t=Y(a.dataset,e.target.data);if(t.length>=1){let n=0,r=e.target.x;for(let e=0;e<t.length;e++){let a=B(h,t[e].name).x;r>a&&(r=a),n+=a}let i=(e.target.x+n)/(t.length+1),o=(e.source.y+e.target.y)/2,l="";if(r===e.target.x&&e.target.data.mztwin){let t=(i+e.target.x)/2,n=(o+(e.target.y-a.symbol_size/2))/2;l="M"+t+","+n+"L"+(i+(i-t))+" "+n}return"M"+e.source.x+","+e.source.y+"V"+o+"H"+i+"L"+e.target.x+" "+(e.target.y-a.symbol_size/2)+l}}if(e.source.data.mother&&e.source.data.father){let t="string"==typeof e.source.data.mother?e.source.data.mother:e.source.data.mother.name,a="string"==typeof e.source.data.father?e.source.data.father:e.source.data.father.name;if(t&&a){let n=B(h,t),r=B(h,a);if(n&&r&&n.depth!==r.depth)return"M"+e.source.x+","+(n.y+r.y)/2+"H"+e.target.x+"V"+e.target.y}}return"M"+e.source.x+","+e.source.y+"V"+(e.source.y+e.target.y)/2+"H"+e.target.x+"V"+e.target.y});let w=G(a.dataset);if(void 0!==w){let e=B(h,a.dataset[w].name),t="triangle"+le(3);o.append("svg:defs").append("svg:marker").attr("id",t).attr("refX",6).attr("refY",6).attr("markerWidth",20).attr("markerHeight",20).attr("orient","auto").append("path").attr("d","M 0 0 12 6 0 12 3 6").attr("fill","black"),o.append("line").attr("x1",e.x-a.symbol_size/.7).attr("y1",e.y+a.symbol_size/1.4).attr("x2",e.x-a.symbol_size/1.4).attr("y2",e.y+a.symbol_size/4).attr("stroke-width",1).attr("stroke","black").attr("marker-end","url(#"+t+")")}return pe(a,i),a.dragNode&&function(e,t){let a,n;t.filter(function(e){return!e.data.hidden}).call(d3.drag().filter(function(e){return!e.ctrlKey&&!e.button&&e.shiftKey}).on("start",function(){a=d3.select(this).select(".indi_rect").attr("x")}).on("drag",function(e){e.sourceEvent.stopPropagation();let t=e.dx,a=d3.select(this).select(".indi_rect");n=parseFloat(a.attr("x"))+t,a.attr("x",n)}).on("end",function(t){let r=d3.select(this).datum().data,i=1===H(e.dataset,r).length?H(e.dataset,r)[0]:-1;d3.select(this).select(".indi_rect").attr("x",a);const o=n>a;let l,s,d,c=ce[e.targetDiv],u=B(ae(c),r.name),f=Z(ae(c),u.depth);n+=u.x;let h,m=-Number.MAX_VALUE,p=Number.MAX_VALUE;for(let e=0;e<f.length;e++)f[e].x<n&&f[e].x>m?(l=f[e],m=f[e].x):f[e].x>n&&f[e].x<p&&(s=f[e],p=f[e].x);if(void 0===l&&void 0===s)return;o?(h=R(e.dataset,l.data.name),d=l):(h=R(e.dataset,s.data.name),d=s);let g=ue(I(e)),_=R(e.dataset,r.name);Ct(g,_,h),-1!==i&&i!==d.data.name&&(_=R(g,i),Ct(g,_,h)),e.dataset=g,$(document).trigger("rebuild",[e])}))}(a,y),a}function Rt(e){return"M"===e||"F"===e}function Bt(e,t,a,n){return"M"+(e+a)+","+t+"L"+e+" "+t+"L"+e+" "+(t+1.28*n.symbol_size)+"L"+e+" "+(t+1.28*n.symbol_size)+"L"+(e+a)+","+(t+1.28*n.symbol_size)}function Lt(e,t){let a,n,r=ae(ce[e.targetDiv]);if("name"in t){if(!(t=B(r,t.name))||!("mother"in t.data))return null;let e="string"==typeof t.data.mother?t.data.mother:t.data.mother?.name,i="string"==typeof t.data.father?t.data.father:t.data.father?.name;if(!e||!i)return null;a=B(r,e),n=B(r,i)}else a=t.mother,n=t.father;if(!a||!n)return null;if(void 0!==a.data&&void 0!==n.data||(a=B(r,a.name||a.data?.name),n=B(r,n.name||n.data?.name)),!a||!n||void 0===a.x||void 0===n.x)return null;let i=a.x<n.x?a.x:n.x,o=a.x<n.x?n.x:a.x,l=a.y,s=$.map(r,function(e,t){return!e.data.hidden&&e.data.name!==a.data.name&&e.data.name!==n.data.name&&e.y===l&&e.x>i&&e.x<o?e.x:null});return s.length>0?s:null}function Pt(e){$("#"+e.targetDiv).empty(),F(e);try{Tt(e)}catch(e){throw console.error(e),e}try{templates.update(e)}catch(e){}}$(document).on("rebuild",function(e,t){if(Ut)t&&t.DEBUG&&console.log("Rebuild ignored: build already in progress");else{Ut=!0;try{Pt(t)}finally{Ut=!1}}}),$(document).on("build",function(e,t){if(Ut)t&&t.DEBUG&&console.log("Build ignored: build already in progress");else{Ut=!0;try{Tt(t)}finally{Ut=!1}}});var Gt=Object.freeze({__proto__:null,build:Tt,check_ptr_link_clashes:Lt,rebuild:Pt});function jt(e,t,a,n){let r=ue(I(e)),i=B(r,t);if(i){if(Array.isArray(a)||(a=[a]),n)for(let e=0;e<a.length;e++){let t=a[e];if(t in i&&1===a.length){if(i[t]===n)return;try{if(JSON.stringify(i[t])===JSON.stringify(n))return}catch(e){}}i[t]=n}else{let e=!1;for(let t=0;t<a.length;t++){let n=a[t];n in i&&(delete i[n],e=!0)}if(!e)return}ot(r,i),e.dataset=r,Pt(e)}else console.warn("No person defined")}var Ht=Object.freeze({__proto__:null,delete_node_by_name:function(e,t){let a=ue(I(e)),n=B(I(e),t);n?xt(a,n,e,function(e,t){e.dataset=t,Pt(e)}):console.warn("No node defined")},node_attr:jt,proband_add_child:function(e,t,a,n,r){let i=ue(I(e)),o=i[G(i)];if(!o)return void console.warn("No proband defined");let l=pt(i,o,t,1)[0];return l.age=a,l.yob=n,void 0!==r&&(l.breastfeeding=r),e.dataset=i,Pt(e),l.name},proband_attr:function(e,t,a){jt(e,e.dataset[G(e.dataset)].name,t,a)}});return e.pedigreejs=Gt,e.pedigreejs__extras=Ht,e.pedigreejs_canrisk_file=Re,e.pedigreejs_dom=g,e.pedigreejs_form=ht,e.pedigreejs_io=rt,e.pedigreejs_pedcache=T,e.pedigreejs_tree_utils=de,e.pedigreejs_utils=he,e.pedigreejs_validation=s,e.pedigreejs_widgets=Ft,e.pedigreejs_zooming=xe,e}({});
//# sourceMappingURL=pedigreejs.v4.0.0-rc1.min.js.map
