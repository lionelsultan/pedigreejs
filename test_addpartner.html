<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Add Partner Bug</title>
    <link href="https://code.jquery.com/ui/1.12.1/themes/cupertino/jquery-ui.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="build/pedigreejs.v4.0.0-rc1.min.css">

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="build/pedigreejs.v4.0.0-rc1.js"></script>

    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #pedigree { border: 1px solid #ccc; margin: 20px 0; }
        .debug-log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Test Add Partner Bug</h1>
    <div id="pedigree"></div>
    <div id="buttons"></div>

    <h2>Debug Log</h2>
    <div id="debug-log" class="debug-log"></div>

    <script>
        // Override console.log to capture in page
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        function logToPage(level, ...args) {
            const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
            const log = document.getElementById('debug-log');
            const entry = document.createElement('div');
            entry.style.color = level === 'error' ? 'red' : level === 'warn' ? 'orange' : 'black';
            entry.textContent = `[${level.toUpperCase()}] ${new Date().toLocaleTimeString()} - ${msg}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        console.log = function(...args) {
            logToPage('log', ...args);
            originalLog.apply(console, args);
        };

        console.warn = function(...args) {
            logToPage('warn', ...args);
            originalWarn.apply(console, args);
        };

        console.error = function(...args) {
            logToPage('error', ...args);
            originalError.apply(console, args);
        };

        // Simple dataset
        const dataset = [
            {"name": "m1", "sex": "M", "top_level": true},
            {"name": "f1", "sex": "F", "top_level": true},
            {"name": "ch1", "sex": "F", "mother": "f1", "father": "m1", "proband": true}
        ];

        console.log('Starting pedigree build with dataset:', dataset);

        const opts = {
            targetDiv: 'pedigree',
            btn_target: 'buttons',
            width: 800,
            height: 500,
            symbol_size: 35,
            edit: true,
            DEBUG: true,  // Enable debug mode
            diseases: [
                {'type': 'cancer', 'colour': '#F68F35'}
            ]
        };

        console.log('Options:', opts);

        try {
            opts.dataset = dataset;
            const result = pedigreejs.pedigreejs.build(opts);
            console.log('Pedigree built successfully');
            console.log('Result:', result);
        } catch(e) {
            console.error('Error building pedigree:', e);
            console.error('Stack:', e.stack);
        }

        // Monitor widget clicks
        $(document).on('click', '.addpartner', function(e) {
            console.log('CLICK DETECTED on addpartner widget');
            console.log('Event:', e);
            console.log('Target:', e.target);
        });

        // Monitor rebuild events
        $(document).on('rebuild', function(e, opts) {
            console.log('REBUILD EVENT TRIGGERED');
            console.log('Opts:', opts);
        });

        // Check if widgets are rendered
        setTimeout(() => {
            const widgets = d3.selectAll('.addpartner');
            console.log('Number of addpartner widgets found:', widgets.size());
            widgets.each(function(d, i) {
                console.log('Widget', i, ':', this);
            });
        }, 1000);
    </script>
</body>
</html>
